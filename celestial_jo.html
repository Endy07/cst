<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Chart Editor</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s&libraries=places"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script type="text/javascript" src="d3.js"></script>
    <script type="text/javascript" src="d3.geo.projection.min.js"></script>
    <link rel="stylesheet" href="celestial.css">
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-datepicker/1.13.2/i18n/jquery.ui.datepicker-hu.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-hu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-addon-i18n.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <!-- <script src="gemini_fragment5_impl_v10_e.js"></script>  -->
    <script src="fragment5_jo.js"></script> 
    

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Allura&family=Cinzel:wght@400..900&family=Cormorant:ital,wght@0,300..700;1,300..700&family=Dancing+Script:wght@400..700&family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Great+Vibes&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Maven+Pro:wght@400..900&family=MedievalSharp&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Parisienne&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Quicksand:wght@300..700&family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Rye&family=Sacramento&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&family=Special+Elite&family=Tangerine:wght@400;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <style type="text/css">
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Space+Grotesk:wght@300;400;500;600&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
      
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary-bg: #0a0e27;
      --secondary-bg: #111633;
      --accent-blue: #4a9eff;
      --accent-purple: #b24aff;
      --accent-cyan: #00d4ff;
      --text-primary: #e8edf5;
      --text-secondary: #8a9bb5;
      --border-color: #1e2849;
      --glow-blue: rgba(74, 158, 255, 0.3);
      --glow-purple: rgba(178, 74, 255, 0.3);
    }
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(74, 158, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(178, 74, 255, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      position: relative;
      z-index: 1;
    }
    
    /* Desktop layout */
    @media (min-width: 769px) {
      .layout {
        flex-direction: row;
      }
      
      /*.mapwrap {
        flex: 0 0 70%;
        position: relative;
        overflow: hidden;
        border-right: 2px solid var(--border-color);
        box-shadow: inset -10px 0 30px rgba(0, 0, 0, 0.3);
      }*/
      .mapwrap {
        flex: 0 0 70%;
        position: relative;
        overflow: hidden;
        border-right: 2px solid var(--border-color);
        box-shadow: inset -10px 0 30px rgba(0, 0, 0, 0.3);
        
        /* --- √öJ SOROK A K√ñZ√âPRE IGAZ√çT√ÅSHOZ --- */
        display: flex;
        justify-content: center;
        align-items: center;
        /* ------------------------------------ */
      }
      .settingswrap {
        flex: 0 0 30%;
        background: var(--secondary-bg);
        overflow-y: auto;
        padding: 24px;
        backdrop-filter: blur(10px);
      }
    }
    
    /* Mobile layout */
    @media (max-width: 768px) {
      .mapwrap {
        height: 55vh;
        position: relative;
        overflow: hidden;
        border-bottom: 2px solid var(--border-color);
        align-content: center;
        justify-content: center;
        align-items: center;
        display: flex;
      }
      
      .settingswrap {
        height: 45vh;
        background: var(--secondary-bg);
        overflow-y: auto;
        padding: 16px;
      }
    }
    
    /*.map {
      width: 100%;
      height: 100%;
      position: relative;
    }*/

    .map {
      /* EREDETI: width: 100%; height: 100%; */
      
      /* √öJ BE√ÅLL√çT√ÅS: */
      width: auto;
      height: auto;
      
      position: relative;
    }

    .map::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
/*      background: radial-gradient(circle at center, transparent 40%, rgba(10, 14, 39, 0.3) 100%);*/
      pointer-events: none;
    }
    
    /* Custom Scrollbar */
    .settingswrap::-webkit-scrollbar {
      width: 8px;
    }

    .settingswrap::-webkit-scrollbar-track {
      background: rgba(30, 40, 73, 0.3);
      border-radius: 10px;
    }

    .settingswrap::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
      border-radius: 10px;
      box-shadow: 0 0 10px var(--glow-blue);
    }

    .settingswrap::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--accent-cyan), var(--accent-blue));
    }

    /* Tabs */
    #tabs {
      border: none;
      background: transparent;
    }
    /* Tabs_r */
/*    #tabs_r {
      border: none;
      background: transparent;
    }*/
    /* F√ºlek st√≠lusa a jobb oldalon */
    #tabs_r {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    /* Tabs */
    #tabss {
      border: none;
      background: transparent;
    }

    #mobile_tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 0;
      list-style: none;
      border: none;
      background: rgba(30, 40, 73, 0.3);
      border-radius: 16px;
      padding: 6px;
      backdrop-filter: blur(10px);
      align-items: center;
    }

    #mobile_tabs li {
      flex: 1;
      margin: 0;
    }

    #mobile_tabs li a {
      display: block;
      padding: 12px 8px;
      text-align: center;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    #mobile_tabs li a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(74, 158, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    #mobile_tabs li a:hover::before {
      left: 100%;
    }

    #mobile_tabs li.ui-tabs-active a {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px var(--glow-blue), 0 0 40px var(--glow-purple);
      transform: translateY(-2px);
    }


    #mobile_tabs_r {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 0;
      list-style: none;
      border: none;
      background: rgba(30, 40, 73, 0.3);
      border-radius: 16px;
      padding: 6px;
      backdrop-filter: blur(10px);
      align-items: center;
    }

    #mobile_tabs_r li {
      flex: 1;
      margin: 0;
    }

    #mobile_tabs_r li a {
      display: block;
      padding: 12px 8px;
      text-align: center;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    #mobile_tabs_r li a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(74, 158, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    #mobile_tabs_r li a:hover::before {
      left: 100%;
    }

    #mobile_tabs_r li.ui-tabs-active a {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px var(--glow-blue), 0 0 40px var(--glow-purple);
      transform: translateY(-2px);
    }

/*    #mobile_tabs_r {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 0;
      list-style: none;
      border: none;
      background: rgba(30, 40, 73, 0.3);
      border-radius: 16px;
      padding: 6px;
      backdrop-filter: blur(10px);
      align-items: center;
    }*/
/*    #mobile_tabs_r {
        background: #2c3e50; / * S√∂t√©t fejl√©c * /
        padding: 10px;
        border-radius: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }*/
/*    #mobile_tabs_r {
        display: flex; 
        gap: 5px; 
        padding: 10px; 
        margin: 0;
        list-style: none; 
        background: rgba(0,0,0,0.2); / *  S√∂t√©t h√°tt√©r * /
        border-bottom: 1px solid var(--border-color); 
        flex-shrink: 0; 
        flex-wrap: wrap;
    }*/
/*    #mobile_tabs_r li {
      flex: 1;
      margin: 0;
    }*/

/*    #mobile_tabs_r li a {
      display: block;
      padding: 12px 8px;
      text-align: center;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }*/
/*    #mobile_tabs_r li a {
        color: #ddd;
        background: rgba(255,255,255,0.1);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
    }*/
    /*#mobile_tabs_r li { flex: 1; min-width: fit-content; text-align: center; }
    
    #mobile_tabs_r li a {
        display: block; 
        padding: 10px 12px; 
        text-decoration: none; 
        color: var(--text-secondary); / * Sz√ºrke sz√∂veg * /
        font-size: 12px; 
        font-weight: 500; 
        border-radius: 6px; 
        transition: all 0.2s; 
        white-space: nowrap;
        background: rgba(255,255,255,0.05); / * Halv√°ny √°ttetsz≈ë * /
    }

    #mobile_tabs_r li a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(74, 158, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    #mobile_tabs_r li a:hover::before {
      left: 100%;
    }*/

/*    #mobile_tabs_r li.ui-tabs-active a {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px var(--glow-blue), 0 0 40px var(--glow-purple);
      transform: translateY(-2px);
    }*/
    /*#mobile_tabs_r li.ui-tabs-active a {
        background: var(--accent-blue);
        color: white;
        font-weight: bold;
    }*/
/*#mobile_tabs_r li.ui-tabs-active a {
        background: var(--accent-blue); / * K√©k akt√≠v √°llapot * /
        color: white; 
        font-weight: bold;
        box-shadow: 0 0 10px var(--glow-blue);
    }*/

    #mobile_tabss {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 0;
      list-style: none;
      border: none;
      background: rgba(30, 40, 73, 0.3);
      border-radius: 16px;
      padding: 6px;
      backdrop-filter: blur(10px);
    }

    #mobile_tabss li {
      flex: 1;
      margin: 0;
    }

    #mobile_tabss li a {
      display: block;
      padding: 12px 8px;
      text-align: center;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    #mobile_tabss li a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(74, 158, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    #mobile_tabss li a:hover::before {
      left: 100%;
    }

    #mobile_tabss li.ui-tabs-active a {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px var(--glow-blue), 0 0 40px var(--glow-purple);
      transform: translateY(-2px);
    }



    #mobile_tabsss {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 0;
      list-style: none;
      border: none;
      background: rgba(30, 40, 73, 0.3);
      border-radius: 16px;
      padding: 6px;
      backdrop-filter: blur(10px);
    }

    #mobile_tabsss button {
      flex: 1;
      margin: 0;
    }

    #mobile_tabsss button {
      display: block;
      padding: 12px 8px;
      text-align: center;
      text-decoration: none;
      font-weight: 500;
      font-size: 13px;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      background: none; 
      border: none; 
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    #mobile_tabsss button:hover {
        color: var(--text-primary);
    }

    /* Csak az akt√≠v gomb legyen kiemelt (ha van ilyen) */
    #mobile_tabsss button.active-button {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px var(--glow-blue), 0 0 40px var(--glow-purple);
      transform: translateY(-2px);
    }

/* Panel tartalmak */
    .ui-tabs-panel {
        padding: 15px !important;
        overflow-y: auto;
        flex: 1;
    }
    /*.ui-tabs .ui-tabs-panel {
      padding: 0;
      border: none;
      background: transparent;
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }*/
    .ui-tabs {
      padding: 0;
      border: none;
      background: transparent;
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      padding-left: 12px;
    }

    h2::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 70%;
      background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
      border-radius: 2px;
      box-shadow: 0 0 10px var(--glow-blue);
    }

    h3.small {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-cyan);
      margin: 20px 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Section styling */
    .section {
      background: rgba(30, 40, 73, 0.2);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    .section:hover {
      border-color: var(--accent-blue);
      box-shadow: 0 4px 20px rgba(74, 158, 255, 0.1);
      transform: translateY(-2px);
    }

    /* Collapsible sections */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(178, 74, 255, 0.1));
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      user-select: none;
    }

    .collapsible-header:hover {
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.2), rgba(178, 74, 255, 0.2));
      border-color: var(--accent-blue);
      box-shadow: 0 0 20px var(--glow-blue);
    }

    .collapsible-header h2 {
      margin: 0;
      font-size: 16px;
      padding-left: 0;
    }

    .collapsible-header h2::before {
      display: none;
    }

    .collapsible-icon {
      font-size: 18px;
      transition: transform 0.3s ease;
      color: var(--accent-blue);

      display: flex;
      flex: 1 1 0%;
          transform: rotate(0deg);
      place-content: flex-end;

    }
    
    .collapsible-header.collapsed .collapsible-icon-icon {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 1;
    }

    .collapsible-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .setting-group {
      margin-bottom: 16px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    label {
      display: block;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    label:hover {
      color: var(--text-primary);
    }

    /* Checkbox labels */
    label:has(input[type="checkbox"]) {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(30, 40, 73, 0.2);
      margin-bottom: 8px;
    }

    label:has(input[type="checkbox"]):hover {
      background: rgba(74, 158, 255, 0.1);
      transform: translateX(4px);
    }

    input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent-blue);
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    input[type="checkbox"]:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 10px var(--glow-blue);
    }

    input[type="checkbox"]:checked {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-color: var(--accent-purple);
      box-shadow: 0 0 15px var(--glow-purple);
    }

    input[type="checkbox"]:checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
      animation: checkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes checkPop {
      0% {
        transform: translate(-50%, -50%) scale(0);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    /* INPUT, SELECT, TEXTAREA STYLES - √ÅTV√âVE AZ √ñN F√ÅJL√ÅB√ìL */
    input[type=text], select, input[type=number], textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: rgba(17, 22, 51, 0.6);
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
      outline: none;
      resize: vertical; /* Textarea enged√©lyez√©se */
    }

    input[type=text]:focus, select:focus, input[type=number]:focus, textarea:focus {
      border-color: var(--accent-blue);
      background: rgba(17, 22, 51, 0.9);
      box-shadow: 0 0 20px var(--glow-blue), inset 0 0 10px rgba(74, 158, 255, 0.1);
      transform: translateY(-2px);
    }

    input[type=text]:hover, select:hover, input[type=number]:hover, textarea:hover {
      border-color: var(--accent-cyan);
    }

    input[type=color] {
      width: 100%;
      height: 45px;
      border-radius: 10px;
      border: 2px solid var(--border-color);
      background: rgba(17, 22, 51, 0.6);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type=color]:hover {
      border-color: var(--accent-blue);
      box-shadow: 0 0 20px var(--glow-blue);
      transform: scale(1.02);
    }

    /* Range slider */
    input[type=range] {
      width: 100%;
      height: 6px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--border-color), var(--accent-blue));
      outline: none;
      appearance: none;
    }

    input[type=range]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      cursor: pointer;
      box-shadow: 0 0 10px var(--glow-blue);
      transition: all 0.3s ease;
    }

    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.3);
      box-shadow: 0 0 20px var(--glow-purple);
    }

    input[type=range]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px var(--glow-blue);
    }

    /* Settings visibility animations */
    .settings-panel {
      animation: expandIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: top;
    }

    @keyframes expandIn {
      from {
        max-height: 0;
        opacity: 0;
        transform: scaleY(0.8);
      }
      to {
        max-height: 1000px;
        opacity: 1;
        transform: scaleY(1);
      }
    }

    /* Pulse animation for active elements */
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 10px var(--glow-blue);
      }
      50% {
        box-shadow: 0 0 20px var(--glow-purple), 0 0 30px var(--glow-blue);
      }
    } 
    .active-indicator { animation: pulse 2s infinite; } 
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      h2 { font-size: 16px; } 
      .section { padding: 12px; } 
      #mobile_tabs li a { font-size: 11px; padding: 10px 6px; } 
      #mobile_tabs_r li a { font-size: 11px; padding: 10px 6px; } 
      #mobile_tabss li a { font-size: 11px; padding: 10px 6px; } 
      #mobile_tabsss li a { font-size: 11px; padding: 10px 6px; } 
      input[type=text], select, input[type=number] { padding: 10px 12px; font-size: 13px; } 
    } 
    
    /* Loading animation */
    @keyframes shimmer { 
      0% { background-position: -1000px 0; } 
      100% { background-position: 1000px 0; } 
    } 
    
    .loading { 
      background: linear-gradient(90deg, transparent, rgba(74, 158, 255, 0.1), transparent); 
      background-size: 1000px 100%; 
      animation: shimmer 2s infinite; 
    } 
    
    .checkbox-header label { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      cursor: pointer; 
    } 
    
    .collapsible-icon:hover { 
      background: rgba(74, 158, 255, 0.1); 
      transform: translateX(4px); 
    }
    
    /* ======================================= */
    /* === fragment-6 DESIGNER EGYEDI ST√çLUS === */
    /* ======================================= */
    
    /* F≈ë Designer Kont√©ner, ami fel√ºl√≠rja a .layout-ot, ha akt√≠v */
/*    #full-screen-designer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none; / * JS vez√©rli a l√°that√≥s√°g√°t * /
        z-index: 10;
        background: var(--primary-bg); / * S√∂t√©t h√°tt√©r * /
    }*/
    /* === √öJ DESIGNER LAYOUT (TELJES K√âPERNY≈êS KIT√ñLT√âS) === */
/*    #full-screen-designer {
        position: fixed; / * Absolute helyett Fixed, hogy biztosan fedjen * /
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: #eef2f5; / * Vil√°gos h√°tt√©r, mint a mint√°ban * /
        z-index: 9999;
        display: none;
        flex-direction: row;
    }*/
    #full-screen-designer {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: var(--primary-bg); /* S√ñT√âT H√ÅTT√âR */
        z-index: 9999;
        display: none;
        flex-direction: row;
    }
    #designer-content-wrapper {
        display: flex;
        height: 100%;
    }
    
    /* Bal oldali v√°szon (70%) */
    #designer-canvas-area {
        flex: 0 0 70%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        border-right: 2px solid var(--border-color);
        background: var(--primary-bg);
        position: relative;
    }
    /* Bal oldali el≈ën√©zeti ter√ºlet */
/*    #designer-canvas-area {
        flex: 1; / * Kit√∂lti a marad√©k helyet * /
        background: #dcdde1; / * Sz√ºrke h√°tt√©r a v√°szon m√∂g√∂tt * /
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        overflow: auto; / * Ha kil√≥gna a v√°szon * /
        position: relative;
    }*/
    /*#designer-canvas-area {
        flex: 1;
        background: #050714; / * S√∂t√©tebb √°rnyalat a v√°szon m√∂g√∂tt * /
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
        overflow: hidden;
        position: relative;
    } */
    /* Jobb oldali vez√©rl≈ëk (30%) */
    #designer-controls {
        flex: 0 0 30%;
        background: var(--secondary-bg);
        overflow-y: auto;
        padding: 24px;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
/*
    @media (max-width: 768px) {
        #designer-content-wrapper { flex-direction: column; }
        #designer-canvas-area { flex: 0 0 55vh; border-right: none; border-bottom: 2px solid var(--border-color); }
        #designer-controls { flex: 0 0 45vh; padding: 16px; }
    }*/
    @media (max-width: 768px) {
        #full-screen-designer { flex-direction: column; }
        #settings-wrap { width: 100%; height: 50%; }
        #designer-canvas-area { height: 50%; padding: 10px; }
    }
    
    /* V√°szon kont√©ner st√≠lusa (Aspect Ratio Trick) */
/*    #canvas-wrapper {
/ *        width: 100%;* /
        max-width: 500px; 
        box-shadow: 0 0 40px var(--glow-blue); / * Ugyanaz a glow hat√°s * /
        border-radius: 8px;
        overflow: hidden;
/ *        max-height: 700px;* /
        max-height: 80vh;
    }*/
    /* Maga a V√°szon doboz (√°rny√©kkal) */
 /*   #canvas-wrapper {
        background: white;
        box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        / * Nem fix width, hanem aspect-ratio alapj√°n * /
        height: auto;
        width: auto;
        max-width: 90%;
        max-height: 90%;
        / * Fontos: aspect-ratio-t JS √°ll√≠tja majd, de alapnak j√≥ * /
        display: flex; 
    }*/
/* A V√°szon keret */
    #canvas-wrapper {
        background: white; /* Maga a pap√≠r marad feh√©r (vagy amit a JS be√°ll√≠t) */
        box-shadow: 0 0 50px rgba(0,0,0,0.5); /* Er≈ësebb s√∂t√©t √°rny√©k */
        max-width: 95%;
        max-height: 95%;
        aspect-ratio: 21 / 30;
        height: auto;
        width: auto;
        display: flex;
    }
    #canvas-container {
        /* Kezdeti A4 (30/21) ar√°ny */
        padding-bottom: 142.85714%; 
        background-color: var(--primary-bg); 
        position: relative;
        width: 100%;
    }
    
    /* R√©tegek elhelyez√©se a v√°sznon */
    #celestial-map-container, #text-overlay-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    /* R√©tegek elhelyez√©se a v√°sznon */
    #celestial-map-container {
        align-content: center;
        justify-content: center;
        align-items: center;
        display: flex;
    }
    
    #text-overlay-svg {
        pointer-events: none; /* Alap√©rtelmezetten ne fogjon meg kattint√°st/h√∫z√°st */
    }
    
    #text-overlay-svg text {
        cursor: move;
        transition: all 0.1s ease-in-out;
    }
    
    /* Kijel√∂lt sz√∂veg st√≠lusa */
    .selected-text {
        stroke: var(--accent-cyan);
        stroke-width: 2px;
        stroke-dasharray: 5, 5;
    }
    
    /* Sz√∂veg Hozz√°ad√°sa Gomb (√öj, de st√≠lusban illeszked≈ë) */
    #add-text-btn {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        color: white;
        padding: 12px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px var(--glow-purple);
    }
    #add-text-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    /* Sz√∂vegelem lista */
    #text-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: rgba(17, 22, 51, 0.4);
    }
    
    .list-item {
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.2s ease-in-out;
        border: 1px solid transparent;
        background: rgba(74, 158, 255, 0.05);
    }

    .active-list-item {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 10px var(--glow-blue);
        transform: translateX(2px);
    }
    
    .delete-btn {
        background: linear-gradient(135deg, #ef4444, #dc2626); /* Piros sz√≠n */
        color: white;
        padding: 10px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }
    .delete-btn:hover {
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        opacity: 0.9;
    }

    .grid-2-cols {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .export-btns {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    .export-btns button {
        background: var(--accent-blue);
        color: white;
        padding: 10px 0;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .export-btns button:hover {
        box-shadow: 0 0 10px var(--glow-blue);
        opacity: 0.8;
    }
    
    /* St√≠lusvez√©rl≈ëk rejt√©se */
    #style-controls {
        display: none;
        /* Alap√©rtelmezett be√°ll√≠t√°s, JS √°t√≠rja flex-re, ha van kijel√∂lt elem */
    }
    /* St√≠lus a Vissza Gombhoz (illik a t√©m√°hoz) */
    #back-to-editor-btn {
        background: var(--accent-cyan);
        color: var(--secondary-bg); /* S√∂t√©t sz√∂veg a vil√°gos k√©ken */
        padding: 12px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    #back-to-editor-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
        box-shadow: 0 4px 20px var(--glow-blue), 0 0 40px var(--glow-cyan); /* √öj glow-cyan CSS v√°ltoz√≥t felt√©telezve */
    }
    

    /* A celestial-map-container st√≠lusai */
/*#celestial-map-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}*/

#celestial-map-container svg {
    position: absolute;
    transition: all 0.3s ease;
}
/*#designer-svg {
    display: block;
    width: 100%;
    height: 100%;
}*/
/*#designer-svg {
        display: block;
        width: 100%;
        height: 100%;
        / * background-color felel a v√°szon sz√≠n√©√©rt * /
    }*/
    #designer-svg {
        display: block;
        width: 100%;
        height: 100%;
    }
#text-overlay-svg {
    display: block;
    width: 100%;
    height: 100%;
}
/* A sz√∂vegek foghat√≥k legyenek */
#text-layer text {
/*    cursor: move;*/
    cursor: default;
}

/* A t√©rk√©p ne zavarja a sz√∂vegek mozgat√°s√°t, ha m√∂g√∂tte van */
#celestial-map-layer {
    pointer-events: none; 
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    height: 30px; /* Magass√°g n√∂vel√©se, hogy biztosan l√°tsz√≥djon */
    background-color: var(--accent-cyan); /* Saj√°t sz√≠n */
    filter: brightness(1.5); /* Vil√°gosabb√° teszi a b√∂ng√©sz≈ë alap√©rtelmezett nyil√°t */
}

.add-btn {
    padding: 8px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 12px;
    width: 100%;
    transition: all 0.2s;
}
.add-btn.primary { background: var(--accent-blue); color: white; }
.add-btn.secondary { background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--border-color); }
.add-btn.accent { background: var(--accent-purple); color: white; }
.add-btn:hover { opacity: 0.9; transform: translateY(-1px); }

.block-card {
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    position: relative;
}
.block-card.inline {
    border-left: 3px solid var(--accent-purple);
    margin-left: 20px; /* Beh√∫z√°s, hogy l√°tsszon: ez inline */
}
.block-card.newline {
    border-left: 3px solid var(--accent-blue);
}
.remove-block {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: #ff4444;
    cursor: pointer;
    font-size: 16px;
}

/* --- T√âMA V√ÅLASZT√ì ST√çLUSOK --- */
/*.theme-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); / * Reszponz√≠v r√°cs * /
    gap: 15px;
    padding: 10px;
}

.theme-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    background: #fff;
    cursor: pointer;
}*/
/* --- T√âMA V√ÅLASZT√ì ST√çLUSOK JAV√çT√ÅSA --- */
.theme-grid {
    display: grid;
    /* Reszponz√≠v r√°cs: minimum 140px sz√©les k√°rty√°k, amennyi kif√©r */
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap: 15px;
    padding: 10px;
    /* Fontos: engedj√ºk a g√∂rget√©st, ha nem f√©r ki */
    max-height: 80vh; 
    overflow-y: auto;
}

/* Egy kis vizu√°lis tuning a k√°rty√°khoz */
.theme-item {
    position: relative;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

/* A kiv√°lasztott k√°rtya kerete */
.theme-item.active-theme {
    border-color: #4a9eff;
    box-shadow: 0 0 15px rgba(74, 158, 255, 0.4);
    transform: scale(1.02);
}
.theme-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.theme-btn {
    width: 100%;
    padding: 10px 5px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    /* A sz√≠neket a JS √°ll√≠tja be */
}

.theme-preview-img {
    width: 100%;
    height: 120px; /* Fix magass√°g a k√©peknek */
    object-fit: cover; /* Lev√°gja a kil√≥g√≥ r√©szeket, de kit√∂lti a keretet */
    border-top: 1px solid #ddd;
}
/* Modal st√≠lusok a k√©pv√°g√≥hoz */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: #222;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--accent-blue);
    }
    .img-container {
        max-height: 60vh;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .img-container img {
        max-width: 100%;
    }
    
    /* F√ºlek a sz√∂vegszerkeszt≈ëh√∂z */
    .text-mode-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
        background: rgba(0,0,0,0.2);
        padding: 5px;
        border-radius: 8px;
    }
    .text-mode-tab {
        flex: 1;
        padding: 8px;
        border: none;
        background: transparent;
        color: #aaa;
        cursor: pointer;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }
    .text-mode-tab.active {
        background: var(--accent-blue);
        color: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .text-mode-tab.common-tab.active {
        background: var(--accent-purple); /* K√ºl√∂n sz√≠n a k√∂z√∂snek */
    }
    /* --- CROPPER K√ñR ALAK --- */
    /*.cropper-view-box,
    .cropper-face {
        border-radius: 50%;
    }*/
    /* Hogy a s√∂t√©t√≠t≈ë r√©teg is k√∂r legyen */
    /*.cropper-view-box {
        outline: 0;
        box-shadow: 0 0 0 1px #39f;
    }*/
    /* Cropper */
    .cropper-view-box, .cropper-face { border-radius: 50%; }
    .cropper-view-box { outline: 0; box-shadow: 0 0 0 1px #39f; }
    /* Jobb oldali be√°ll√≠t√°sok s√°v */
  /*  #settings-wrap {
        width: 400px;
        background: white;
        border-left: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        z-index: 10;
        padding: 0; / * Reset * /
    }*/
    /* JOBB OLDALI BE√ÅLL√çT√ÅSOK S√ÅV - VISSZA√ÅLL√çTVA S√ñT√âTRE */
    #settings-wrap {
        width: 400px;
        background: var(--secondary-bg); /* S√∂t√©tk√©k */
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        height: 100%;
        box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        z-index: 10;
        padding: 0;
        color: var(--text-primary); /* Vil√°gos sz√∂veg */
    }
    /* Lista elem akt√≠v √°llapota */
    .photo-list-item {
        padding: 8px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .photo-list-item:hover { background: rgba(255,255,255,0.05); }
    .photo-list-item.active { background: rgba(74, 158, 255, 0.2); border-left: 3px solid var(--accent-blue); }
    </style>
</head>
<body>
    
    <div id="full-screen-designer">
        <div id="designer-content-wrapper">
            
            <div id="designer-canvas-area">
                <div id="canvas-wrapper">
                    <div id="canvas-container celestial-map-container">
                        <!-- <div id="celestial-map-container"></div>
                        <svg id="text-overlay-svg"></svg> -->
                        <!-- <svg id="designer-svg text-overlay-svg" viewBox="0 0 900 1272" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="background-color: #0a0e27;"> -->
                        <!-- <svg id="designer-svg" viewBox="0 0 1026 1272" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="background-color: #0a0e27;">
                          < ! - - <defs>
                          </defs> - - >
                          <defs>
                              <clipPath id="photo-clip">
                                  <rect id="photo-clip-rect" x="0" y="0" width="100%" height="100%" />
                              </clipPath>
                          </defs>
                            <g id="photo-layer" style="display: none;"></g>
                            <g id="map-transform-group">
                                <g id="celestial-map-layer"></g>
                            </g>
                            <g id="text-layer"></g>
                        </svg> -->
                        <svg id="designer-svg" viewBox="0 0 1026 1272" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="background-color: #0a0e27;">
                          <defs>
                              <clipPath id="photo-circle-clip">
                                  <circle id="photo-clip-circle" cx="500" cy="500" r="500" />
                              </clipPath>
                          </defs>
                
                            <g id="photo-transform-group" style="display:none;">
                                <image id="user-photo-img" width="1000" height="1000" preserveAspectRatio="xMidYMid slice" clip-path="url(#photo-circle-clip)" />
                            </g>

                            <g id="map-transform-group">
                                <g id="celestial-map-layer"></g>
                            </g>
                            
                            <g id="text-layer"></g>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="settingswrap" id="settings-wrap">
                <div id="tabs_r">
                    <ul id="mobile_tabs_r">
                        <li><a href="#fragment_r-1">Csillagt√©rk√©p be√°ll√≠t√°sok</a></li>
                        <li><a href="#fragment_r-2">Sz√∂veg be√°ll√≠t√°sok</a></li>
                        <li><a href="#fragment_r-3">K√©p be√°ll√≠t√°sok</a></li>
                        <li><a href="#fragment_r-4">Sablonok</a></li>
                        <li><a href="#fragment_r-5">Csillagt√©rk√©p szerkeszt≈ë</a></li>
                        <!-- <li><a href="#fragment_r-4" onclick="switchToMainEditor()" id="back-to-editor-btn"> -->
                          <!-- <button onclick="switchToMainEditor()" id="back-to-editor-btn"> -->
                              <!-- ‚Üê Vissza a T√©rk√©p Szerkeszt√©shez -->
                          <!-- </button> -->
                        <!-- </a></li> -->
                        <!-- <li><a href="#fragment_r-5">Tervez≈ë</a></li> -->
                    </ul>
                    <div id="fragment_r-1">
                        <div id="designer-controls">
                            <!-- <button onclick="switchToMainEditor()" id="back-to-editor-btn">
                                ‚Üê Vissza a T√©rk√©p Szerkeszt√©shez
                            </button> -->
                            <!-- <h2 style="margin-top: 0;">TERVEZ≈ê ESZK√ñZ√ñK</h2> -->


                            <!-- <div class="collapsible-header" data-target="size-settings">
                                <h2>üìè M√©ret be√°ll√≠t√°sa</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div> -->

                            <!-- <div class="collapsible-content" id="size-settings"> -->
                              <!-- <div class="section" style="margin-top: 16px; margin-bottom: 0;"> -->
                              <!-- <div class="section" style="margin-top: 0px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">V√ÅSZONK√âP M√âRETE</h3>
                                
                                < ! - - <label style="margin-bottom: 4px;">M√©retek (cm):</label> - - >
                                < ! - - <div class="grid-2-cols" style="margin-bottom: 16px;"> - - >
                                <div class="grid-2-cols" >
                                  <label for="canvas-width">Sz√©less√©g: <input type="number" id="canvas-width" value="21" min="1" oninput="updateCanvasSize()" placeholder="Sz√©less√©g (cm)"></label>
                                  <label for="canvas-height">Magass√°g: <input type="number" id="canvas-height" value="30" min="1" oninput="updateCanvasSize()" placeholder="Magass√°g (cm)"></label>
                                </div>
                              </div> -->
                                <div class="section" style="margin-top: 0px; margin-bottom: 0;">
                                    <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">V√ÅSZON BE√ÅLL√çT√ÅSOK</h3>
                    
                                    <div class="grid-2-cols" style="margin-bottom: 10px;">
                                        <label for="canvas-width">Sz√©less√©g (cm): <input type="number" id="canvas-width" value="21" min="1" oninput="updateCanvasSize()"></label>
                                        <label for="canvas-height">Magass√°g (cm): <input type="number" id="canvas-height" value="30" min="1" oninput="updateCanvasSize()"></label>
                                    </div>

                                    <div class="setting-group" style="margin-bottom: 5px;">
                                        <label for="canvas-bg-color">H√°tt√©rsz√≠n:</label>
                                        <input type="color" id="canvas-bg-color" value="#0a0e27" oninput="window.updateCanvasBackground(this.value)">
                                    </div>
                                    <!-- <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                      <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">üñºÔ∏è K√âP & ELRENDEZ√âS</h3>
                                      
                                      <div class="setting-group" style="margin-bottom: 10px;">
                                          <label>Elrendez√©s:</label>
                                          <div class="export-btns"> <button onclick="changeLayout('single')" title="Teljes m√©ret≈± t√©rk√©p">Teljes</button>
                                              <button onclick="changeLayout('split-left')" title="K√©p balra, T√©rk√©p jobbra">K√©p Balra</button>
                                              <button onclick="changeLayout('split-right')" title="K√©p jobbra, T√©rk√©p balra">K√©p Jobbra</button>
                                          </div>
                                      </div>

                                      <div class="setting-group">
                                          <label>Saj√°t fot√≥ felt√∂lt√©se:</label>
                                          <input type="file" id="photo-upload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this)">
                                          <button onclick="document.getElementById('photo-upload').click()" class="add-btn accent" style="width: 100%;">
                                              üì∏ Fot√≥ Kiv√°laszt√°sa
                                          </button>
                                          <div id="photo-controls" style="display:none; margin-top: 5px;">
                                              <button onclick="removePhoto()" class="add-btn secondary" style="font-size: 11px; padding: 4px;">Fot√≥ T√∂rl√©se</button>
                                          </div>
                                      </div>
                                  </div> -->
                                </div>
                            <!-- </div> -->
                            <!-- <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">T√âRK√âP M√âRETE</h3>
                                
                                <div class="setting-group" style="margin-bottom: 5px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <label for="map-scale-slider" style="margin:0;">M√©retez√©s:</label>
                                        <span id="map-scale-value" style="color: var(--accent-cyan); font-weight: bold;">100%</span>
                                    </div>
                                    <input type="range" id="map-scale-slider" min="50" max="250" value="100" step="1" oninput="updateMapScale(this.value)">
                                </div>
                            </div> -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">T√âRK√âP M√âRETE</h3>
                                
                                <div class="setting-group" style="margin-bottom: 5px;">
                                    <label for="map-width-cm-input">Sz√©less√©g (cm):</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" id="map-width-cm-input" value="20" min="1" step="0.1" oninput="window.setMapWidth(this.value)">
                                        <button onclick="window.fitMapToCanvas()" style="width: auto; padding: 0 10px; font-size: 12px; background: var(--secondary-bg); border: 1px solid var(--accent-blue); color: var(--accent-blue); cursor: pointer; border-radius: 8px;">Max</button>
                                    </div>
                                    <small style="color: var(--text-secondary); font-size: 11px;">Nem lehet nagyobb a v√°szonn√°l.</small>
                                </div>
                            </div>
                            
                            <!-- <div class="section" style="margin-top: 16px; margin-bottom: 0;"> -->
                            <div class="section" style="margin-top: 0px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">CSILLAGT√âRK√âP POZ√çCI√ìJA</h3>
                                
                                <div class="export-btns">
                                    <button onclick="alignCelestialMap('center')">K√∂z√©pen</button>
                                    <button onclick="alignCelestialMap('top')">Fent</button>
                                    <button onclick="alignCelestialMap('bottom')">Lent</button>
                                </div>
                            </div>

                            <!-- <div class="collapsible-header" data-target="text-settings">
                                <h2>üìù Sz√∂veg be√°ll√≠t√°sok</h2>
                                < ! - - <span class="collapsible-icon">‚ñº</span> - - >
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="text-settings">
                                <div class="setting-group">
                                  <button onclick="addTextElement('√öj Sz√∂veg')" id="add-text-btn">
                                      ‚ûï Sz√∂veg Hozz√°ad√°sa
                                  </button>
                                </div>
                                <div class="setting-group">
                                  <div class="section" style="padding: 12px; margin-bottom: 0;">
                                      <label style="margin-bottom: 4px; color: var(--accent-cyan);">Sz√∂vegelemek list√°ja:</label>
                                      <div id="text-list">
                                          <p style="font-size: 13px; text-align: center; color: var(--text-secondary); margin: 0;">Kattintson a gombra a kezd√©shez.</p>
                                      </div>
                                  </div>
                                  <div id="style-controls" class="section" style="margin-bottom: 0;">
                                      <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">KIJEL√ñLT ELEM ST√çLUSA</h3>
                                      <div class="setting-group">
                                          <label for="text-content">Tartalom:</label>
                                          <textarea id="text-content" oninput="updateTextContent(this.value)" rows="2"></textarea>
                                      </div>


                                      <div class="setting-group">
                                          <label for="font_">Bet≈±t√≠pus</label>

                                              <select id="text-anchor__" onchange="updateStyle('font-family', this.value)">
                                                  <option value="start">Balra</option>
                                                  <option value="middle">K√∂z√©pre</option>
                                                  <option value="end">Jobbra</option>
                                              </select>
                                          <select id="font_" onchange="updateStyle('font-family', this.value)">
                                                  <option value="start">Balra</option>
                                              < ! - - <option value="orthographic">Orthographic</option>
                                              <option value="stereo">Stereographic</option>
                                              <option value="gnomonic">Gnomonic</option>
                                              <option value="equirectangular">Equirectangular</option> - - >
                                              < ! - - <option value="Montserrat">Montserrat</option>
                                              <option value="Roboto">Roboto</option>
                                              <option value="Open Sans">Open Sans</option>
                                              <option value="Merriweather">Merriweather</option>
                                              <option value="Playfair Display">Playfair Display</option>
                                              <option value="Raleway">Raleway</option>
                                              <option value="Inter">Inter</option>
                                              <option value="Source Sans Pro">Source Sans Pro</option>
                                              <option value="Source Sans 3">Source Sans 3</option>
                                              <option value="Source Code Pro">Source Code Pro</option>
                                              <option value="Noto Sans">Noto Sans</option>
                                              <option value="Abril Fatface">Abril Fatface</option>
                                              <option value="Cormorant">Cormorant</option>
                                              <option value="JetBrains Mono">JetBrains Mono</option>
                                              <option value="EB Garamond">EB Garamond</option>
                                              <option value="Cinzel">Cinzel</option>
                                              <option value="MedievalSharp">MedievalSharp</option>
                                              <option value="Uncial Antiqua">Uncial Antiqua</option>
                                              <option value="Great Vibes">Great Vibes</option>
                                              <option value="Tangerine">Tangerine</option>
                                              <option value="Special Elite">Special Elite</option>
                                              <option value="Dancing Script">Dancing Script</option> - - >
                                          </select>
                                      </div>


                                      <div class="grid-2-cols" style="margin-bottom: 16px;">
                                          <div class="setting-group" style="margin-bottom: 0;">
                                              <label for="font-size">Bet≈±m√©ret (px):</label>
                                              <input type="number" id="font-size" oninput="updateStyle('font-size', this.value)" placeholder="24" min="10">
                                          </div>
                                           <div class="setting-group" style="margin-bottom: 0;">
                                              <label for="text-anchor">Igaz√≠t√°s:</label>
                                              <select id="text-anchor" onchange="updateStyle('text-anchor', this.value)">
                                                  <option value="start">Balra</option>
                                                  <option value="middle">K√∂z√©pre</option>
                                                  <option value="end">Jobbra</option>
                                              </select>
                                          </div>
                                          <div class="setting-group" style="margin-bottom: 0;">
                                              <label for="font-weight">S√∫ly:</label>
                                              <select id="font-weight" onchange="updateStyle('font-weight', this.value)">
                                                  <option value="normal">Norm√°l</option>
                                                  <option value="bold">F√©lk√∂v√©r</option>
                                              </select>
                                          </div>
                                          <div class="setting-group" style="margin-bottom: 0;">
                                              <label for="font-style">St√≠lus:</label>
                                              <select id="font-style" onchange="updateStyle('font-style', this.value)">
                                                  <option value="normal">Norm√°l</option>
                                                  <option value="italic">D≈ëlt</option>
                                              </select>
                                          </div>
                                      </div>
                                      <div class="setting-group">
                                          <label for="fill-color">Sz√≠n:</label>
                                          <input type="color" id="fill-color" oninput="updateStyle('fill', this.value)" value="#e8edf5">
                                      </div>
                                      <button onclick="deleteSelectedElement()" class="delete-btn">
                                          üóëÔ∏è Kijel√∂lt Elem T√∂rl√©se
                                      </button>
                                  </div>
                                </div>
                            </div> -->

                            <!-- <div class="collapsible-header" data-target="top-text-settings">
                                <h2>üìù FELS≈ê SZ√ñVEG</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="top-text-settings">
                                <div class="section" style="margin-bottom: 0;">
                                    <div class="setting-group">
                                        <textarea id="top-text-content" rows="2" placeholder="√çrd ide a fels≈ë sz√∂veget..." oninput="updateFixedText('top')"></textarea>
                                    </div>
                                    
                                    <div class="grid-2-cols" style="margin-bottom: 8px;">
                                        <div class="setting-group">
                                            <label>Bet≈±t√≠pus:</label>
                                            <select id="top-text-font" onchange="updateFixedText('top')">
                                                <option value="Space Grotesk">Space Grotesk</option>
                                                <option value="Montserrat">Montserrat</option>
                                                <option value="Merriweather">Merriweather</option>
                                                <option value="Playfair Display">Playfair Display</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label>M√©ret (px):</label>
                                            <input type="number" id="top-text-size" value="48" min="10" oninput="updateFixedText('top')">
                                        </div>
                                    </div>

                                    <div class="grid-2-cols" style="margin-bottom: 8px;">
                                        <div class="setting-group">
                                            <label>V√≠zszintes Igaz√≠t√°s:</label>
                                            <select id="top-text-align-h" onchange="updateFixedText('top')">
                                                <option value="start">Balra</option>
                                                <option value="middle" selected>K√∂z√©pre</option>
                                                <option value="end">Jobbra</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label>F√ºgg≈ëleges Igaz√≠t√°s:</label>
                                            <select id="top-text-align-v" onchange="updateFixedText('top')">
                                                <option value="top">Tetej√©re</option>
                                                <option value="center" selected>K√∂z√©pre</option>
                                                <option value="bottom">T√©rk√©phez</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid-2-cols" style="margin-bottom: 8px;">
                                        <div class="setting-group">
                                            <label>S√∫ly:</label>
                                            <select id="top-text-weight" onchange="updateFixedText('top')">
                                                <option value="normal">Norm√°l</option>
                                                <option value="bold" selected>F√©lk√∂v√©r</option>
                                                <option value="300">V√©kony</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label>St√≠lus:</label>
                                            <select id="top-text-style" onchange="updateFixedText('top')">
                                                <option value="normal">Norm√°l</option>
                                                <option value="italic">D≈ëlt</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-group">
                                        <label>Sz√≠n:</label>
                                        <input type="color" id="top-text-color" value="#e8edf5" oninput="updateFixedText('top')">
                                    </div>
                                </div>
                            </div>
                            <div class="collapsible-header" data-target="bottom-text-settings">
                                <h2>üìù ALS√ì SZ√ñVEG</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="bottom-text-settings">
                                <div class="section" style="margin-bottom: 0;">
                                    <div class="setting-group">
                                        <textarea id="bottom-text-content" rows="2" placeholder="√çrd ide az als√≥ sz√∂veget..." oninput="updateFixedText('bottom')"></textarea>
                                    </div>
                                    
                                    <div class="grid-2-cols" style="margin-bottom: 8px;">
                                        <div class="setting-group">
                                            <label>Bet≈±t√≠pus:</label>
                                            <select id="bottom-text-font" onchange="updateFixedText('bottom')">
                                                <option value="Space Grotesk">Space Grotesk</option>
                                                <option value="Montserrat">Montserrat</option>
                                                <option value="Merriweather">Merriweather</option>
                                                <option value="Playfair Display">Playfair Display</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label>M√©ret (px):</label>
                                            <input type="number" id="bottom-text-size" value="32" min="10" oninput="updateFixedText('bottom')">
                                        </div>
                                    </div>

                                    <div class="grid-2-cols" style="margin-bottom: 8px;">
                                        <div class="setting-group">
                                            <label>V√≠zszintes Igaz√≠t√°s:</label>
                                            <select id="bottom-text-align-h" onchange="updateFixedText('bottom')">
                                                <option value="start">Balra</option>
                                                <option value="middle" selected>K√∂z√©pre</option>
                                                <option value="end">Jobbra</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label>F√ºgg≈ëleges Igaz√≠t√°s:</label>
                                            <select id="bottom-text-align-v" onchange="updateFixedText('bottom')">
                                                <option value="top">T√©rk√©phez</option>
                                                <option value="center" selected>K√∂z√©pre</option>
                                                <option value="bottom">Alj√°ra</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid-2-cols" style="margin-bottom: 8px;">
                                        <div class="setting-group">
                                            <label>S√∫ly:</label>
                                            <select id="bottom-text-weight" onchange="updateFixedText('bottom')">
                                                <option value="normal" selected>Norm√°l</option>
                                                <option value="bold">F√©lk√∂v√©r</option>
                                                <option value="300">V√©kony</option>
                                            </select>
                                        </div>
                                        <div class="setting-group">
                                            <label>St√≠lus:</label>
                                            <select id="bottom-text-style" onchange="updateFixedText('bottom')">
                                                <option value="normal">Norm√°l</option>
                                                <option value="italic">D≈ëlt</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-group">
                                        <label>Sz√≠n:</label>
                                        <input type="color" id="bottom-text-color" value="#e8edf5" oninput="updateFixedText('bottom')">
                                    </div>
                                </div>
                            </div> -->
                            <label style="margin-bottom: 4px;">Export:</label>
                            <div class="export-btns">
                                <button onclick="exportCanvas('svg')">SVG (Vektoros)</button>
                                <button onclick="exportCanvas('png')">PNG (Raster)</button>
                                <button onclick="exportCanvas('jpeg')">JPEG (Raster)</button>
                                <button id="copy-button">copy-button</button>
                                <button id="dl-button">dl-button original celestial svg dl</button>
                                    
                            </div>
                            <a id="download-link" style="display: none;"></a>
                            
                            <div style="flex-grow: 1;"></div>
                        </div>
                    </div>

                    <!-- <div id="fragment_r-2">
                        <div id="designer-controls">
                            <div class="collapsible-header" data-target="top-text-settings">
                                <h2>üìù FELS≈ê Z√ìNA</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="top-text-settings">
                                <div class="section" style="margin-bottom: 0;">
                                    <div class="setting-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
                                        <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                        <select id="top-zone-align-v" onchange="updateZoneAlign('top')">
                                            <option value="top">Tetej√©re</option>
                                            <option value="center" selected>K√∂z√©pre</option>
                                            <option value="bottom">T√©rk√©phez</option>
                                        </select>
                                    </div>
                                    <div id="top-blocks-container"></div>
                                    < ! - - <div class="grid-2-cols" style="margin-top: 10px;">
                                        <button onclick="addNewBlock('top', true)" class="add-btn primary">‚èé √öj Sor</button>
                                        <button onclick="addNewBlock('top', false)" class="add-btn secondary">Hozz√°f≈±z√©s (Inline)</button>
                                    </div> - - >
                                    <div class="grid-2-cols" style="margin-top: 10px; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                                        <button onclick="addNewBlock('top', true)" class="add-btn primary">‚èé √öj Sor</button>
                                        <button onclick="addNewBlock('top', false)" class="add-btn secondary">Inline</button>
                                        <button onclick="openSymbolPicker(event, 'top')" class="add-btn accent">‚ô• Szimb√≥lum</button>
                                    </div>
                                    < ! - - <div style="margin-top: 8px;">
                                         <button onclick="addSymbol('top')" class="add-btn accent">‚ô• ‚òÖ „Ä∞ Szimb√≥lum</button>
                                    </div> - - >
                                </div>
                            </div>
                            <div class="collapsible-header" data-target="bottom-text-settings">
                                <h2>üìù ALS√ì Z√ìNA</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="bottom-text-settings">
                                <div class="section" style="margin-bottom: 0;">
                                    <div class="setting-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
                                        <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                        <select id="bottom-zone-align-v" onchange="updateZoneAlign('bottom')">
                                            <option value="top">T√©rk√©phez</option>
                                            <option value="center" selected>K√∂z√©pre</option>
                                            <option value="bottom">Alj√°ra</option>
                                        </select>
                                    </div>

                                    <div id="bottom-blocks-container"></div>

                                    < ! - - <div class="grid-2-cols" style="margin-top: 10px;">
                                        <button onclick="addNewBlock('bottom', true)" class="add-btn primary">‚èé √öj Sor</button>
                                        <button onclick="addNewBlock('bottom', false)" class="add-btn secondary">Hozz√°f≈±z√©s (Inline)</button>
                                    </div>
                                    <div style="margin-top: 8px;">
                                         <button onclick="addSymbol('bottom')" class="add-btn accent">‚ô• ‚òÖ „Ä∞ Szimb√≥lum</button>
                                    </div> - - >
                                    <div class="grid-2-cols" style="margin-top: 10px; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                                        <button onclick="addNewBlock('bottom', true)" class="add-btn primary">‚èé √öj Sor</button>
                                        <button onclick="addNewBlock('bottom', false)" class="add-btn secondary">Inline</button>
                                        <button onclick="openSymbolPicker(event, 'bottom')" class="add-btn accent">‚ô• Szimb√≥lum</button>
                                    </div>
                                </div>
                            </div>

                            <div id="symbol-picker" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--secondary-bg); padding:20px; border:1px solid var(--accent-blue); z-index:1000; border-radius:10px; box-shadow: 0 0 20px #000;">
                                <h3 style="margin-top:0;">V√°lassz Szimb√≥lumot</h3>
                                <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; font-size:20px;">
                                    <button onclick="insertSymbol('‚ô•')">‚ô•</button>
                                    <button onclick="insertSymbol('‚ô°')">‚ô°</button>
                                    <button onclick="insertSymbol('‚òÖ')">‚òÖ</button>
                                    <button onclick="insertSymbol('‚òÜ')">‚òÜ</button>
                                    <button onclick="insertSymbol('‚ú¶')">‚ú¶</button>
                                    <button onclick="insertSymbol('‚Äî')">‚Äî</button>
                                    <button onclick="insertSymbol('„Ä∞')">„Ä∞</button>
                                    <button onclick="insertSymbol('‚Ä¢')">‚Ä¢</button>
                                    <button onclick="insertSymbol('‚àû')">‚àû</button>
                                    <button onclick="insertSymbol('‚òæ')">‚òæ</button>
                                    <button onclick="insertSymbol('‚òÄ')">‚òÄ</button>
                                    <button onclick="insertSymbol('‚öî')">‚öî</button>
                                    <button onclick="insertSymbol('{')">{</button>
                                    <button onclick="insertSymbol('}')">}</button>
                                    <button onclick="insertSymbol('~')">~</button>
                                </div>
                                <button onclick="$('#symbol-picker').fadeOut()" style="margin-top:15px; width:100%;">M√©gse</button>
                            </div>
                        </div>
                    </div> -->
                    <div id="fragment_r-2">
                        <div id="designer-controls">
                            
                            <div class="text-mode-tabs">
                                <button class="text-mode-tab active" onclick="switchTextContext('map')" id="tab-context-map">Csillagt√©rk√©p</button>
                                <button class="text-mode-tab" onclick="switchTextContext('photo')" id="tab-context-photo" style="display:none;">Fot√≥ Oldal</button>
                                <button class="text-mode-tab common-tab" onclick="switchTextContext('common')" id="tab-context-common" style="display:none;">K√∂z√∂s (Sz√©les)</button>
                            </div>

                            <div class="collapsible-header" data-target="top-text-settings">
                                <h2 id="top-zone-title">üìù FELS≈ê Z√ìNA (T√©rk√©p)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="top-text-settings">
                                <div class="section" style="margin-bottom: 0;">
                                    
                                    <div id="top-common-toggle-container" style="display:none; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #444;">
                                        <label><input type="checkbox" id="chk-common-top" onchange="toggleCommonZone('top', this.checked)"> üîó K√∂z√∂s Fels≈ë Sz√∂vegdoboz haszn√°lata</label>
                                    </div>

                                    <div class="setting-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
                                        <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                        <select id="top-zone-align-v" onchange="updateZoneAlign('top')">
                                            <option value="top">Tetej√©re</option>
                                            <option value="center" selected>K√∂z√©pre</option>
                                            <option value="bottom">Alj√°ra (T√©rk√©phez)</option>
                                        </select>
                                    </div>

                                    <div id="top-blocks-container"></div>

                                    <div class="grid-2-cols" style="margin-top: 10px; grid-template-columns: 1fr 1fr ; gap: 5px;">
                                        <button onclick="addNewBlock('top', true)" class="add-btn primary">‚èé √öj Sor</button>
                                        <button onclick="addNewBlock('top', false)" class="add-btn secondary">Inline</button>
                                        <!-- <button onclick="window.openSymbolPicker(event, 'top', this)" class="add-btn accent">‚ô• Jel</button> -->
                                    </div>
                                </div>
                            </div>

                            <div class="collapsible-header" data-target="bottom-text-settings">
                                <h2 id="bottom-zone-title">üìù ALS√ì Z√ìNA (T√©rk√©p)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="bottom-text-settings">
                                <div class="section" style="margin-bottom: 0;">
                                    
                                    <div id="bottom-common-toggle-container" style="display:none; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #444;">
                                        <label><input type="checkbox" id="chk-common-bottom" onchange="toggleCommonZone('bottom', this.checked)"> üîó K√∂z√∂s Als√≥ Sz√∂vegdoboz haszn√°lata</label>
                                    </div>

                                    <div class="setting-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
                                        <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                        <select id="bottom-zone-align-v" onchange="updateZoneAlign('bottom')">
                                            <option value="top">Tetej√©re (T√©rk√©phez)</option>
                                            <option value="center" selected>K√∂z√©pre</option>
                                            <option value="bottom">Alj√°ra</option>
                                        </select>
                                    </div>

                                    <div id="bottom-blocks-container"></div>

                                    <div class="grid-2-cols" style="margin-top: 10px; grid-template-columns: 1fr 1fr ; gap: 5px;">
                                        <button onclick="addNewBlock('bottom', true)" class="add-btn primary">‚èé √öj Sor</button>
                                        <button onclick="addNewBlock('bottom', false)" class="add-btn secondary">Inline</button>
                                        <!-- <button onclick="window.openSymbolPicker(event, 'bottom', this)" class="add-btn accent">‚ô• Jel</button> -->
                                    </div>
                                </div>
                            </div>
                            
                            <div id="symbol-picker" style="display:none; position:fixed; z-index:1000; background:var(--secondary-bg); padding:10px; border:1px solid var(--accent-blue); border-radius:10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
                                <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; font-size:20px;">
                                    <button onclick="window.insertSymbol('‚ô•')">‚ô•</button>
                                    <button onclick="window.insertSymbol('‚ô°')">‚ô°</button>
                                    <button onclick="window.insertSymbol('‚òÖ')">‚òÖ</button>
                                    <button onclick="window.insertSymbol('‚òÜ')">‚òÜ</button>
                                    <button onclick="window.insertSymbol('‚Äî')">‚Äî</button>
                                    <button onclick="window.insertSymbol('‚Ä¢')">‚Ä¢</button>
                                    <button onclick="window.insertSymbol('‚àû')">‚àû</button>
                                    <button onclick="window.insertSymbol('&')">&</button>
                                    <button onclick="window.insertSymbol('+')">+</button>
                                    <button onclick="window.insertSymbol('|')">|</button>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div id="fragment_r-3">

                        <div id="designer-controls">
                          
                                <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                      <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">üñºÔ∏è K√âPES ELRENDEZ√âS (DUPLA)</h3>
                                      
                                      <p style="font-size:11px; color:#aaa; margin-bottom:10px;">
                                          K√©p hozz√°ad√°sakor a v√°szon sz√©less√©ge megdupl√°z√≥dik!
                                      </p>

                                      <div class="grid-2-cols" style="margin-bottom: 10px;">
                                          <input type="file" id="photo-upload" accept="image/*" style="display: none;" onchange="initCropperFromFile(this)">
                                          
                                          <button onclick="triggerPhotoUpload('left')" class="add-btn secondary" style="border: 1px dashed #666;">
                                              üì∏ K√©p BALRA<br>+ T√©rk√©p Jobbra
                                          </button>
                                          <button onclick="triggerPhotoUpload('right')" class="add-btn secondary" style="border: 1px dashed #666;">
                                              üì∏ K√©p JOBBRA<br>T√©rk√©p Balra +
                                          </button>
                                      </div>
                                      
                                      <!-- <div id="active-photo-controls" style="display:none;">
                                          <div class="setting-group">
                                              <label>K√©p Poz√≠ci√≥ja:</label>
                                              <div class="export-btns">
                                                  <button onclick="alignPhoto('center')">K√∂z√©p</button>
                                                  <button onclick="alignPhoto('top')">Fent</button>
                                                  <button onclick="alignPhoto('bottom')">Lent</button>
                                              </div>
                                          </div>
                                          <button onclick="removePhotoLayout()" class="add-btn accent" style="background:#ff4444; margin-top:10px;">
                                              Vissza az Egyszimpla N√©zethez
                                          </button>
                                      </div> -->
                                      <!-- <div id="active-photo-controls" style="display:none;">
                                          <div class="setting-group">
                                              <label>K√©pek kezel√©se:</label>
                                              <div id="photo-list-container" style="margin-bottom:10px; max-height:100px; overflow-y:auto; border:1px solid #444; padding:5px;">
                                                  </div>
                                              
                                              <label>Akt√≠v K√©p Poz√≠ci√≥ja:</label>
                                              <div class="export-btns">
                                                  <button onclick="alignActivePhoto('center')">K√∂z√©p</button>
                                                  <button onclick="alignActivePhoto('top')">Fent</button>
                                                  <button onclick="alignActivePhoto('bottom')">Lent</button>
                                              </div>
                                          </div>
                                          <div class="grid-2-cols">
                                              <button onclick="document.getElementById('photo-upload').click()" class="add-btn secondary">
                                                  ‚ûï √öjabb k√©p
                                              </button>
                                              <button onclick="removePhotoLayout()" class="add-btn accent" style="background:#ff4444;">
                                                  T√∂rl√©s & Vissza
                                              </button>
                                          </div>
                                      </div> -->
                                      <div id="active-photo-controls" style="display:none; margin-top:15px; border-top:1px solid #444; padding-top:10px;">
                                          <h4 style="margin:0 0 10px 0; color:var(--accent-blue);">K√©p Be√°ll√≠t√°sok</h4>
                                          
                                          <div class="setting-group">
                                              <label>Akt√≠v K√©p List√°ja:</label>
                                              <div id="photo-list-container" style="margin-bottom:10px; max-height:120px; overflow-y:auto; border:1px solid #444; background:rgba(0,0,0,0.2); border-radius:4px;">
                                                  </div>
                                          </div>

                                          <div id="single-photo-settings" style="display:none;">
                                              <div class="setting-group">
                                                  <label>M√©ret (%): <span id="photo-scale-disp" style="float:right; color:#aaa;">100%</span></label>
                                                  <input type="range" id="photo-scale-input" min="50" max="150" value="100" oninput="updateActivePhotoProp('scale', this.value)">
                                              </div>

                                              <div class="setting-group">
                                                  <label>K√∂rvonal Vastags√°g: <span id="photo-border-disp" style="float:right; color:#aaa;">0px</span></label>
                                                  <input type="range" id="photo-border-input" min="0" max="50" value="0" oninput="updateActivePhotoProp('border', this.value)">
                                              </div>

                                              <!-- <div class="setting-group">
                                                <input type="checkbox" id="photo-border-check" onchange="updateActivePhotoProp('borderEnabled', this.checked)" style="width:16px; height:16px; margin:0;">
                                                  <label for="photo-border-check" style="margin:0; cursor:pointer; font-size: 12px; flex: 1;">Keret bekapcsol√°sa</label>
                                                  <label>K√∂rvonal Sz√≠ne:</label>
                                                  <input type="color" id="photo-border-color" value="#ffffff" oninput="updateActivePhotoProp('borderColor', this.value)">
                                              </div> -->
                                              <div class="setting-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">
                                                  <input type="checkbox" id="photo-border-check" onchange="updateActivePhotoProp('borderEnabled', this.checked)" style="width:16px; height:16px; margin:0;">
                                                  <label for="photo-border-check" style="margin:0; cursor:pointer; font-size: 12px; flex: 1;">Keret bekapcsol√°sa</label>
                                                  <input type="color" id="photo-border-color" value="#ffffff" oninput="updateActivePhotoProp('borderColor', this.value)" style="width:30px; height:25px; padding:0; margin:0; border:none;">
                                              </div>

                                              <label>Poz√≠ci√≥ a s√°vban:</label>
                                              <div class="export-btns" style="margin-bottom:15px;">
                                                  <button onclick="updateActivePhotoProp('align', 'center')">K√∂z√©p</button>
                                                  <button onclick="updateActivePhotoProp('align', 'top')">Fent</button>
                                                  <button onclick="updateActivePhotoProp('align', 'bottom')">Lent</button>
                                              </div>
                                          </div>

                                          <div class="grid-2-cols">
                                              <button onclick="removePhotoLayout()" class="add-btn accent" style="background:#ff4444;">
                                                  üóëÔ∏è Minden T√∂rl√©se
                                              </button>
                                          </div>
                                      </div>
                                </div>
                        </div>
                            <!-- <button onclick="switchToMainEditor()" id="back-to-editor-btn">
                                ‚Üê Vissza a T√©rk√©p Szerkeszt√©shez
                            </button> -->
                    </div>
                    <div id="fragment_r-4">
                        <!-- <div id="designer-controls">

                          <div id="designer-tab-templates">
                              <h3>V√°lassz St√≠lust</h3>
                              <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Ez be√°ll√≠tja a t√©rk√©p sz√≠neit √©s a poszter h√°tter√©t is.</p>
                              
                              <div class="theme-grid" id="designer-templates-grid"></div>
                          </div> -->
                          <!-- <div id="designer-tab-templates">
                              <h3>V√°lassz St√≠lust</h3>
                              <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Ez be√°ll√≠tja a t√©rk√©p sz√≠neit √©s a poszter h√°tter√©t is.</p>
                              
                              <div class="theme-grid" id="designer-templates-grid"></div>
                          </div> -->
                            <!-- <div class="collapsible-header" data-target="theme-settings">
                                <h2>üé® T√©m√°k (Presets)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="theme-settings">
                                <div class="section">
                                    <div class="grid-2-cols" id="theme-buttons-container" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                    </div>
                                </div>
                            </div> -->
                        <!-- </div> -->
                        <div id="designer-tab-templates">
                            <h3 style="margin-top:0;">St√≠lus & H√°tt√©r</h3>
                            <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">
                                V√°lassz st√≠lust! Ez egyszerre √°ll√≠tja be a csillagt√©rk√©p sz√≠neit √©s a poszter h√°tter√©t.
                            </p>
                            
                            <div id="designer-templates-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                        </div>
                    </div>
                    <div id="fragment_r-5">
                            <!-- <button onclick="switchToMainEditor()" id="back-to-editor-btn">
                                ‚Üê Vissza a T√©rk√©p Szerkeszt√©shez
                            </button> -->
                    </div>
                </div>
            </div>
            
        </div>
    </div>


    <div class="layout" id="main-layout"> 
        <div class="mapwrap" id="map-wrap">
            <div class="map" id="celestial-map">
            </div>
        </div>
        
        <div class="settingswrap" id="settings-wrap">
            <div id="tabs">
                <ul id="mobile_tabs">
                    <li><a href="#fragment-1">T√©rk√©p Be√°ll√≠t√°s</a></li>
                    <li><a href="#fragment-2">Tej√∫t & √âgbolt</a></li>
                    <li><a href="#fragment-3">Csillagok & Csillagk√©pek</a></li>
                    <li><a href="#fragment-4">H√°l√≥ & Vonalak</a></li>
                    <li><a href="#fragment-5">Sablonok</a></li>
                    <li><a href="#fragment-6">Tervez≈ë</a></li>
                </ul>

                <div id="fragment-1">
                    <div class="collapsible-header" data-target="location-settings">
                        <h2>üìç HELY & ID≈ê</h2>
                        <div id="font-tests"></div>
                        <!-- <span class="collapsible-icon">‚ñº</span> -->
                        <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                    </div>
                            <!-- <button id="copy2-button">copy2-button</button> -->
                            <!-- <button id="width-button">width-button</button> -->
                    <div class="collapsible-content" id="location-settings">
                        <div class="setting-group">
                            <!-- <label for="city" style="text-align: center;">Helysz√≠n</label> -->
                            <label for="city" style="">Helysz√≠n</label>
                            <input type="text" id="city" placeholder="V√°ros keres√©se...">
                              <!-- <div class="row" style="display: flex;"> -->
                                <!-- <label for="" style="text-align: center; margin-top: 8px;">Koordin√°t√°k</label> -->
                                <label for="" style=" margin-top: 8px;">Koordin√°t√°k</label>
                              <!-- </div> -->
                            <div class="row" style="display: flex;">
                              <div class="col">
                                <!-- <label for="coord_lat" style="text-align: center;">Sz√©less√©gi fok <input placeholder="Sz√©less√©gi fok" type="text" id="coord_lat"></label> -->
                                <input placeholder="Sz√©less√©gi fok" type="text" id="coord_lat">
                              </div>
                              <div class="col">
                                <!-- <label for="coord_lon" style="text-align: center;">Hossz≈±s√°gi fok <input placeholder="Sz√©less√©gi fok" type="text" id="coord_lon"></label> -->
                                <input placeholder="Hossz√∫s√°gi fok" type="text" id="coord_lon">
                              </div>
                            </div>
                        </div>
                        <div class="setting-group">
                            <!-- <label for="datetimepicker" style="text-align: center;">D√°tum & Id≈ë</label> -->
                            <label for="datetimepicker" style="">D√°tum & Id≈ë</label>
                            <input type="text" id="datetimepicker" placeholder="V√°lassz d√°tumot √©s id≈ët">
                        </div>
                    </div>
                    <div class="collapsible-header" data-target="projection-settings">
                        <h2>üåç Projekci√≥</h2>
                        <!-- <span class="collapsible-icon">‚ñº</span> -->
                        <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                    </div>
                    <div class="collapsible-content" id="projection-settings">
                        <div class="setting-group">
                            <!-- <button id="projectionnn">projectionnn</button> -->
                            <label for="projection_">Projekci√≥</label>

                            <select id="projection_">
                                <!-- <option value="orthographic">Orthographic</option>
                                <option value="stereo">Stereographic</option>
                                <option value="gnomonic">Gnomonic</option>
                                <option value="equirectangular">Equirectangular</option> -->
                                <option value="stereographic">Stereographic (hemi)</option>
                                <option value="myHeart2025">myHeart2025 (hemi)</option>
                                <option value="customHeart">SZ√çV ALAK√ö (Egyedi)</option>
                                <option value="customHeartt">tttSZ√çV ALAK√ö (Egyedi)</option>
                                <option value="werner">WERNER (igaz√°b√≥l Bonne)</option>
                                <option value="orthographic">Orthographic (hemi)</option>
                                <option value="airy">Airy‚Äôs Minimum Error (hemi)</option>
                                <option value="azimuthalEqualArea">Azimuthal Equal Area (hemi)</option>
                                <option value="azimuthalEquidistant">Azimuthal Equidistant (hemi)</option>
                                <option value="berghaus">Berghaus Star (hemi)</option>
                                <option value="cassini">Cassini (hemi)</option>
                                <option value="twoPointEquidistant">Two-Point Equidistant (hemi)</option>
                                <option value="wiechel">Wiechel (hemi)</option>
                                <option value="guyou">Guyou</option>
                                <option value="butterfly">Butterfly</option>
                                <option value="mtFlatPolarParabolic">mtFlatPolarParabolic</option>
                                <option value="bonne">bonne</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label for="szivszoge">Sz√≠v sz√∂ge</label>
                            <input id="szivszoge" type="number" min="1.8" max="3.2" step="0.1" value="2.4">
                            <!-- <label for="szivratioja">Sz√≠v ratioja</label>
                            <input id="szivratioja" type="number" min="0.1" max="5" step="0.1" value="0.88"> -->
                        </div>
                    </div>




                    <div class="collapsible-header" data-target="zodiacsign-settings">
                        <h2>üåç Csillagjegyek</h2>
                        <!-- <span class="collapsible-icon">‚ñº</span> -->
                        <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                    </div>

                    <div class="collapsible-content" id="zodiacsign-settings">
                        <div class="setting-group">
                            <!-- <button id="projectionnn">projectionnn</button> -->
                            <label for="zodiacsigns">Csillagjegyek</label>

                            <select id="zodiacsigns">
                                <!-- <option value="orthographic">Orthographic</option>
                                <option value="stereo">Stereographic</option>
                                <option value="gnomonic">Gnomonic</option>
                                <option value="equirectangular">Equirectangular</option> -->
                                <option value="Cap">Bak (december 22. ‚Äì janu√°r 20.)</option>
                                <option value="Aqr">V√≠z√∂nt≈ë (janu√°r 21. ‚Äì febru√°r 19. )</option>
                                <option value="Psc">Halak (febru√°r 20. ‚Äì m√°rcius 20.)</option>
                                <option value="Ari">Kos (m√°rcius 21. ‚Äì √°prilis 19.)</option>
                                <option value="Tau">Bika (√°prilis 20. ‚Äì m√°jus 20.)</option>
                                <option value="Gem">Ikrek (m√°jus 21. ‚Äì j√∫nius 20.)</option>
                                <option value="Cnc">R√°k (j√∫nius 21. ‚Äì j√∫lius 22.)</option>
                                <option value="Leo">Oroszl√°n (j√∫lius 23. ‚Äì augusztus 22.)</option>
                                <option value="Vir">Sz≈±z (augusztus 23. ‚Äì szeptember 22.)</option>
                                <option value="Lib">M√©rleg (szeptember 23. ‚Äì okt√≥ber 22.)</option>
                                <option value="Sco">Skorpi√≥ (okt√≥ber 23. ‚Äì november 22.)</option>
                                <option value="Sgr">Nyilas (november 23. ‚Äì december 21.)</option>
                            </select>
                        </div>
                    </div>


                    <!-- <div class="collapsible-header" data-target="projectionn-settings">
                        <h2>üåç Projekci√≥√≥√≥√≥</h2>
                        < ! - - <span class="collapsible-icon">‚ñº</span> - - >
                        <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                    </div>
                    <div class="collapsible-content" id="projectionn-settings">
                        <div class="setting-group">
                            <label for="projectionn">Projekci√≥</label>

                            <select id="projectionn">
                                < ! - - <option value="orthographic">Orthographic</option>
                                <option value="stereo">Stereographic</option>
                                <option value="gnomonic">Gnomonic</option>
                                <option value="equirectangular">Equirectangular</option> - - >
                                <option value="orthographic">Orthographic (hemi)</option>
                                <option value="airy">Airy‚Äôs Minimum Error (hemi)</option>
                                <option value="azimuthalEqualArea">Azimuthal Equal Area (hemi)</option>
                                <option value="azimuthalEquidistant">Azimuthal Equidistant (hemi)</option>
                                <option value="berghaus">Berghaus Star (hemi)</option>
                                <option value="cassini">Cassini (hemi)</option>
                                <option value="craig">Craig Retroazimuthal (hemi)</option>
                                <option value="stereographic">Stereographic (hemi)</option>
                                <option value="twoPointEquidistant">Two-Point Equidistant (hemi)</option>
                                <option value="wiechel">Wiechel (hemi)</option>
                            </select>
                        </div>
                    </div> -->


                </div>

                <div id="fragment-2">
                    <div class="collapsible-header" data-target="milkyway-settings">
                        <h2>üåå TEJ√öT</h2>
                        <!-- ‚ú®<span class="collapsible-icon">‚ñº</span> -->
                        <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                    </div>
                    <div class="collapsible-content" id="milkyway-settings">
                        <div class="section">
                            <label><input id="mw_show" type="checkbox" checked> Tej√∫t megjelen√≠t√©se</label>
                            <div id="mw_show_settings" class="settings-panel">
                                <label for="mw_style_fill">Sz√≠n</label>
                                <input id="mw_style_fill" type="color" value="#ffffff">
                                <label for="mw_style_opacity">√Åttetsz≈ës√©g</label>
                                <input id="mw_style_opacity" type="number" min="0.01" max="1" step="0.01" value="0.15">
                            </div>
                        </div>
                    </div>

                    <div class="collapsible-header" data-target="sky-settings">
                        <h2>üåå √âGBOLT</h2>
                        <!-- <span class="collapsible-icon">‚ñº</span> -->
                        <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                    </div>
                    <div class="collapsible-content" id="sky-settings">
                        <div class="section settings-panel">
                            <label for="background_fill">√âg sz√≠ne</label>
                            <input id="background_fill" type="color" value="#000000">
                            <label for="background_opacity">√Åttetsz≈ës√©g</label>
                            <input id="background_opacity" type="number" min="0.01" max="1" step="0.01" value="1">
                            <label for="background_stroke">K√∂rvonal sz√≠ne</label>
                            <input id="background_stroke" type="color" value="#FFFFFF">
                            <label for="background_stroke_width">K√∂rvonal vastags√°ga</label>
                            <input id="background_stroke_width" type="number" min="0" max="100" step="0.1" value="1.5">
                        </div>
                    </div>
                </div>

                <div id="fragment-3">
                    <div class="collapsible-header" data-target="constellation-settings">
                        <h2>‚ú® CSILLAGK√âPEK</h2>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="constellation-settings">
                        <div class="section">
                            <label><input id="const_show" type="checkbox" checked>Csillagk√©pek vonalai</label>
                            <div id="const_show_settings" class="settings-panel">

                              <label for="constellation_lineStyle_opacity">√Åttetsz≈ës√©g</label>
                              <input id="constellation_lineStyle_opacity" type="number" min="0.01" max="1" step="0.01" value="0.6">
                              <label for="constellation_lineStyle_stroke">Vonalak sz√≠ne</label>
                              <input id="constellation_lineStyle_stroke" type="color" value="#cccccc">
                              <label for="constellation_lineStyle_stroke_width">Vonalak vastags√°ga</label>
                              <input id="constellation_lineStyle_stroke_width" type="number" min="0" max="100" step="0.1" value="1.5">
                                <!-- <label>F√©nyess√©g limit</label>
                                <input id="stars_limit" type="number" min="0" max="6" step="0.1" value="6">
                                <label>M√©ret</label>
                                <input id="stars_size" type="number" value="7" min="5" max="100" step="0.1">
                                <label>Kitev≈ë</label>
                                <input id="stars_exponent" type="number" value="-0.28" min="-1" max="3" step="0.01">

                                <label><input type="checkbox" id="stars_colors" checked> Sz√≠nes csillagok</label>
                                <div id="stars_colors_settings" style="display: none">
                                    <label for="stars_style_fill">Egysz√≠n≈± m√≥d sz√≠ne</label>
                                    <input id="stars_style_fill" type="color" value="#FFFFFF">
                                </div> -->
                            </div>
                        </div>
                    </div>

                    <div class="collapsible-header" data-target="stars-settings">
                        <h2>‚≠ê CSILLAGOK</h2>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="stars-settings">
                        <div class="section">
                            <label><input type="checkbox" id="stars_show" checked> Csillagok megjelen√≠t√©se</label>
                            <div id="stars_show_settings" class="settings-panel">
                                <label>F√©nyess√©g limit</label>
                                <input id="stars_limit" type="number" min="0" max="6" step="0.1" value="6">
                                <label>M√©ret</label>
                                <input id="stars_size" type="number" value="7" min="5" max="100" step="0.1">
                                <label>Kitev≈ë</label>
                                <input id="stars_exponent" type="number" value="-0.28" min="-1" max="3" step="0.01">

                                <label><input type="checkbox" id="stars_colors" checked> Sz√≠nes csillagok</label>
                                <div id="stars_colors_settings" style="display: none">
                                    <label for="stars_style_fill">Csillagok sz√≠ne</label>
                                    <input id="stars_style_fill" type="color" value="#FFFFFF">
                                    <label for="stars_style_opacity">Csillagok √°ttetsz≈ës√©ge</label>
                                    <input id="stars_style_opacity" type="number" value="1" min="0" max="1" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="collapsible-header" data-target="planets-settings">
                        <h2>ü™ê NAP & HOLD & BOLYG√ìK</h2>
                        <span class="collapsible-icon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="planets-settings">
                        <div class="section">
                            <label><input type="checkbox" id="planets_show"> Nap & Hold & Bolyg√≥k megjelen√≠t√©se</label>
                        </div>
                    </div>
                </div>

                <!-- <div id="fragment-4">
                    <div class="section">
                        <div id="graticule-wrapper">
                            <div class="collapsible-header checkbox-header" data-target="graticule-section">
                                <label style="margin: 0; flex: 1;">
                                    <input id="lines_graticule" type="checkbox" checked> 
                                    <span>‚ö™ Fokh√°l√≥zat</span>
                                </label>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="graticule-section">
                                <div class="settings-panel">
                                    <label for="lines_graticule_color">Sz√≠n</label>
                                    <input id="lines_graticule_color" type="color" value="#cccccc">
                                    <label for="lines_graticule_size">Vastags√°g</label>
                                    <input id="lines_graticule_size" type="number" min="0.1" max="6" step="0.1" value="0.6">
                                    <label for="lines_graticule_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_graticule_opacity" type="number" min="0.01" max="1" step="0.01" value="0.8">
                                </div>
                            </div>
                        </div>
                        <div id="equatorial-wrapper" >
                            <div class="collapsible-header checkbox-header collapsed" data-target="equatorial-section">
                                <label class="collapsible-l" style="margin: 0; flex: 1;">
                                    <input id="lines_equatorial" type="checkbox"> 
                                    <span>‚ö™Ô∏è Egyenl√≠t≈ëi</span>
                                </label>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="equatorial-section">
                                <div class="settings-panel">
                                    <label for="lines_equatorial_color">Sz√≠n</label>
                                    <input id="lines_equatorial_color" type="color" value="#aaaaaa">
                                    <label for="lines_equatorial_size">Vastags√°g</label>
                                    <input id="lines_equatorial_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_equatorial_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_equatorial_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>
                        <div id="ecliptic-wrapper">
                            <div class="collapsible-header checkbox-header collapsed" data-target="ecliptic-section">
                                <label style="margin: 0; flex: 1;">
                                    <input id="lines_ecliptic" type="checkbox"> 
                                    <span>üü¢ Ekliptika</span>
                                </label>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="ecliptic-section">
                                <div class="settings-panel">
                                    <label for="lines_ecliptic_color">Sz√≠n</label>
                                    <input id="lines_ecliptic_color" type="color" value="#66cc66">
                                    <label for="lines_ecliptic_size">Vastags√°g</label>
                                    <input id="lines_ecliptic_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_ecliptic_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_ecliptic_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>
                        <div id="galactic-wrapper">
                            <div class="collapsible-header checkbox-header collapsed" data-target="galactic-section">
                                <label style="margin: 0; flex: 1;">
                                    <input id="lines_galactic" type="checkbox"> 
                                    <span>üî¥ Galaktikus</span>
                                </label>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="galactic-section">
                                <div class="settings-panel">
                                    <label for="lines_galactic_color">Sz√≠n</label>
                                    <input id="lines_galactic_color" type="color" value="#cc6666">
                                    <label for="lines_galactic_size">Vastags√°g</label>
                                    <input id="lines_galactic_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_galactic_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_galactic_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>
                        <div id="supergalactic-wrapper">
                            <div class="collapsible-header checkbox-header collapsed" data-target="supergalactic-section">
                                <label style="margin: 0; flex: 1;">
                                    <input id="lines_supergalactic" type="checkbox"> 
                                    <span>üü£ Szupergalaktikus</span>
                                </label>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="supergalactic-section">
                                <div class="settings-panel">
                                    <label for="lines_supergalactic_color">Sz√≠n</label>
                                    <input id="lines_supergalactic_color" type="color" value="#cc66cc">
                                    <label for="lines_supergalactic_size">Vastags√°g</label>
                                    <input id="lines_supergalactic_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_supergalactic_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_supergalactic_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                <div id="fragment-4">
                    <div class="section">
                        
                        <div id="graticule-wrapper">
                            <div class="collapsible-header" data-target="graticule-section" style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label" style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;">
                                    <input id="lines_graticule" type="checkbox" checked> 
                                    <span style="margin-left: 10px;">‚ö™ Fokh√°l√≥zat</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 10px; cursor: pointer;"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="graticule-section">
                                <div class="settings-panel">
                                    <label for="lines_graticule_color">Sz√≠n</label>
                                    <input id="lines_graticule_color" type="color" value="#cccccc">
                                    <label for="lines_graticule_size">Vastags√°g</label>
                                    <input id="lines_graticule_size" type="number" min="0.1" max="6" step="0.1" value="0.6">
                                    <label for="lines_graticule_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_graticule_opacity" type="number" min="0.01" max="1" step="0.01" value="0.8">
                                </div>
                            </div>
                        </div>

                        <div id="equatorial-wrapper">
                            <div class="collapsible-header collapsed" data-target="equatorial-section" style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label" style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;">
                                    <input id="lines_equatorial" type="checkbox"> 
                                    <span style="margin-left: 10px;">‚ö™Ô∏è Egyenl√≠t≈ëi</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 10px; cursor: pointer;"><i class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="equatorial-section">
                                <div class="settings-panel">
                                    <label for="lines_equatorial_color">Sz√≠n</label>
                                    <input id="lines_equatorial_color" type="color" value="#aaaaaa">
                                    <label for="lines_equatorial_size">Vastags√°g</label>
                                    <input id="lines_equatorial_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_equatorial_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_equatorial_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>

                        <div id="ecliptic-wrapper">
                            <div class="collapsible-header collapsed" data-target="ecliptic-section" style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label" style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;">
                                    <input id="lines_ecliptic" type="checkbox"> 
                                    <span style="margin-left: 10px;">üü¢ Ekliptika</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 10px; cursor: pointer;"><i class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="ecliptic-section">
                                <div class="settings-panel">
                                    <label for="lines_ecliptic_color">Sz√≠n</label>
                                    <input id="lines_ecliptic_color" type="color" value="#66cc66">
                                    <label for="lines_ecliptic_size">Vastags√°g</label>
                                    <input id="lines_ecliptic_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_ecliptic_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_ecliptic_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>

                        <div id="galactic-wrapper">
                            <div class="collapsible-header collapsed" data-target="galactic-section" style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label" style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;">
                                    <input id="lines_galactic" type="checkbox"> 
                                    <span style="margin-left: 10px;">üî¥ Galaktikus</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 10px; cursor: pointer;"><i class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="galactic-section">
                                <div class="settings-panel">
                                    <label for="lines_galactic_color">Sz√≠n</label>
                                    <input id="lines_galactic_color" type="color" value="#cc6666">
                                    <label for="lines_galactic_size">Vastags√°g</label>
                                    <input id="lines_galactic_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_galactic_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_galactic_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>

                        <div id="supergalactic-wrapper">
                            <div class="collapsible-header collapsed" data-target="supergalactic-section" style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label" style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;">
                                    <input id="lines_supergalactic" type="checkbox"> 
                                    <span style="margin-left: 10px;">üü£ Szupergalaktikus</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 10px; cursor: pointer;"><i class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="supergalactic-section">
                                <div class="settings-panel">
                                    <label for="lines_supergalactic_color">Sz√≠n</label>
                                    <input id="lines_supergalactic_color" type="color" value="#cc66cc">
                                    <label for="lines_supergalactic_size">Vastags√°g</label>
                                    <input id="lines_supergalactic_size" type="number" min="0.1" max="6" step="0.1" value="1.3">
                                    <label for="lines_supergalactic_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="lines_supergalactic_opacity" type="number" min="0.01" max="1" step="0.01" value="0.7">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="fragment-5">
                    <!-- <div class="section"> -->
                            <div class="collapsible-header" data-target="theme-settings">
                                <h2>üé® T√©m√°k (Presets)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="theme-settings">
                                <div class="section">
                                    <!-- <div class="grid-2-cols" id="theme-buttons-container" style="grid-template-columns: 1fr 1fr; gap: 10px;"></div> -->
                                    <!-- <div class="theme-grid" id="theme-grid-container"></div> -->
                                    <!-- <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; text-align: center;">
                                        <p style="font-size: 12px; color: #aaa; margin-bottom: 5px;">K√©p k√©sz√≠t√©se a fenti mapp√°hoz:</p>
                                        <button onclick="saveMapThumbnail()" class="add-btn accent" style="width: 100%; background: #4a9eff;">
                                            üì∏ Csak a T√©rk√©p Let√∂lt√©se (PNG)
                                        </button>
                                    </div> -->
                                    <div style="margin-top: 10px;">
                                        <button onclick="downloadAllThemesSequence()" class="add-btn accent" style="width: 100%; background: #b24aff;">
                                            ü§ñ √ñsszes T√©ma K√©p√©nek Gener√°l√°sa & Let√∂lt√©se
                                        </button>
                                    </div>
                                    <div class="theme-grid" id="theme-grid-container"></div>
                                    
                                    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                                        <button onclick="downloadAllThemesSequence()" class="add-btn accent" style="width: 100%; background: #b24aff;">
                                            üì∏ Thumbnail Gener√°tor Ind√≠t√°sa
                                        </button>
                                        <p style="font-size:10px; color:#aaa; text-align:center; margin-top:5px;">
                                            A let√∂lt√∂tt k√©peket m√°sold be az <b>images/themes/</b> mapp√°ba!
                                        </button>
                                    </div>

                                </div>
                            </div>
                    <!-- </div> -->
                </div>
                <div id="fragment-6">
                    <p style="text-align: center; padding: 50px; color: var(--text-secondary);">A Tervez≈ë fel√ºlet megny√≠lt a teljes k√©perny≈ën.</p>
                </div>
                
            </div>
        </div>
    </div>
    <div id="cropper-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:white;">K√©p m√©retre v√°g√°sa</h3>
            <div class="img-container">
                <img id="image-to-crop" src="" alt="K√©p v√°g√°sa">
            </div>
            <div class="grid-2-cols">
                <button onclick="closeCropper()" class="add-btn secondary">M√©gse</button>
                <button onclick="performCrop()" class="add-btn primary">‚úÇÔ∏è Kiv√°g√°s & Hozz√°ad√°s</button>
            </div>
        </div>
    </div>
    <!-- <script type="text/javascript" src="celestial.js"></script> -->
    <script type="text/javascript" src="celestial_jo.js"></script>

    <script type="text/javascript">
        var szivszoge = 2.4;
        var szivratioja = 0.88;
        $( "#tabs" ).tabs();
        $( "#tabs_left" ).tabs();
        $( "#tabs_r" ).tabs();
        $(document).on('change', '#szivszoge', function(e) {
            szivszoge = $(this).val();
            console.log("szivszoge", szivszoge);
            Celestial.projections().customHeart = {
                arg:Math.PI/szivszoge, scale:210, ratio:szivratioja
            };
            myCelestialConf.projection = "customHeart";
            console.log("myCelestialConf", myCelestialConf);
            // Celestial.reproject(myCelestialConf);
            // Celestial.display(myCelestialConf);

            changeProjection(myCelestialConf.projection);
          });
        // $(document).on('change', '#szivratioja', function(e) {
        //     szivratioja = $(this).val();
        //     console.log("szivsratioja", szivratioja);
        //     Celestial.projections().customHeart = {
        //         arg:Math.PI/szivszoge, scale:210, ratio:szivratioja
        //     };
        //     myCelestialConf.projection = "customHeart";
        //     console.log("myCelestialConf", myCelestialConf);
        //     // Celestial.reproject(myCelestialConf);
        //     // Celestial.display(myCelestialConf);

        //     changeProjection(myCelestialConf.projection);
        // });
        // setTimeout(function(){
        //   // var wwwww = $("#celestial-map").width();
        //   // var hhhhh = $("#celestial-map").height();
        //   // var wwwww = $(".mapwrap").width();
        //   // var hhhhh = $(".mapwrap").height();
        //   var wwwww = $(window).width();
        //   var hhhhh = $(window).height();
        //   console.log("wwwww", wwwww);
        //   console.log("hhhhh", hhhhh);
        //   var wwww = Math.min(wwwww, hhhhh);
        //   console.log("wwww", wwww);
        //   Celestial.resize({width:wwww});
        // }, 100);
        // setTimeout(function(){
        //   // EREDETI VOLT:
        //   // var wwwww = $(window).width();
        //   // var hhhhh = $(window).height();
          
        //   // √öJ LOGIKA:
        //   // 1. A kont√©ner (#map-wrap) sz√©less√©ge
        //   var containerWidth = $("#map-wrap").width();
          
        //   // 2. A k√©perny≈ë magass√°ga
        //   var windowHeight = $(window).height();
          
        //   console.log("Container Width:", containerWidth);
        //   console.log("Window Height:", windowHeight);

        //   // 3. Amelyik a kisebb, annak vessz√ºk a 95%-√°t
        //   var finalSize = Math.min(containerWidth, windowHeight) * 0.95;
          
        //   console.log("Final Size (95%):", finalSize);
          
        //   // 4. √Åtm√©retez√©s
        //   Celestial.resize({width: finalSize});
        // }, 100);
        function leftfrag(nr) {
          $( "#tabs_left" ).tabs( "option", "active", nr );
        }
// Master checkboxok a wrapper megjelen√≠t√©s√©re
$(document).on('change', '#lines_graticule_master', function(e) {
    if ($(this).is(':checked')) {
        $("#graticule-wrapper").slideDown(300);
        $("#lines_graticule").prop('checked', true).trigger('change');
    } else {
        $("#graticule-wrapper").slideUp(300);
        $("#lines_graticule").prop('checked', false).trigger('change');
    }
});

$(document).on('change', '#lines_equatorial_master', function(e) {
    if ($(this).is(':checked')) {
        $("#equatorial-wrapper").slideDown(300);
        $("#lines_equatorial").prop('checked', true).trigger('change');
    } else {
        $("#equatorial-wrapper").slideUp(300);
        $("#lines_equatorial").prop('checked', false).trigger('change');
    }
});

$(document).on('change', '#lines_ecliptic_master', function(e) {
    if ($(this).is(':checked')) {
        $("#ecliptic-wrapper").slideDown(300);
        $("#lines_ecliptic").prop('checked', true).trigger('change');
    } else {
        $("#ecliptic-wrapper").slideUp(300);
        $("#lines_ecliptic").prop('checked', false).trigger('change');
    }
});

$(document).on('change', '#lines_galactic_master', function(e) {
    if ($(this).is(':checked')) {
        $("#galactic-wrapper").slideDown(300);
        $("#lines_galactic").prop('checked', true).trigger('change');
    } else {
        $("#galactic-wrapper").slideUp(300);
        $("#lines_galactic").prop('checked', false).trigger('change');
    }
});

$(document).on('change', '#lines_supergalactic_master', function(e) {
    if ($(this).is(':checked')) {
        $("#supergalactic-wrapper").slideDown(300);
        $("#lines_supergalactic").prop('checked', true).trigger('change');
    } else {
        $("#supergalactic-wrapper").slideUp(300);
        $("#lines_supergalactic").prop('checked', false).trigger('change');
    }
});



// A bels≈ë checkboxok v√°ltoz√°sai
$(document).on('change', '#lines_graticule', function(e) {
    e.stopPropagation();
    change({ lines: { graticule: {
        show: $(this).is(':checked'),
        stroke: $("#lines_graticule_color").val(),
        width: parseFloat($("#lines_graticule_size").val()),
        opacity: parseFloat($("#lines_graticule_opacity").val()) } }
    });
});

$(document).on('change', '#lines_equatorial', function(e) {
    e.stopPropagation();
    change({ lines: { equatorial: {
        show: $(this).is(':checked'),
        stroke: $("#lines_equatorial_color").val(),
        width: parseFloat($("#lines_equatorial_size").val()),
        opacity: parseFloat($("#lines_equatorial_opacity").val()) } }
    });
});

$(document).on('change', '#lines_ecliptic', function(e) {
    e.stopPropagation();
    change({ lines: { ecliptic: {
        show: $(this).is(':checked'),
        stroke: $("#lines_ecliptic_color").val(),
        width: parseFloat($("#lines_ecliptic_size").val()),
        opacity: parseFloat($("#lines_ecliptic_opacity").val()) } }
    });
});

$(document).on('change', '#lines_galactic', function(e) {
    e.stopPropagation();
    change({ lines: { galactic: {
        show: $(this).is(':checked'),
        stroke: $("#lines_galactic_color").val(),
        width: parseFloat($("#lines_galactic_size").val()),
        opacity: parseFloat($("#lines_galactic_opacity").val()) } }
    });
});

$(document).on('change', '#lines_supergalactic', function(e) {
    e.stopPropagation();
    change({ lines: { supergalactic: {
        show: $(this).is(':checked'),
        stroke: $("#lines_supergalactic_color").val(),
        width: parseFloat($("#lines_supergalactic_size").val()),
        opacity: parseFloat($("#lines_supergalactic_opacity").val()) } }
    });
});

// Collapsible header kattint√°s - ne triggerelje a checkboxot
$(document).on('click', '.checkbox-header', function(e) {
    // Ha a checkbox-ra kattintottak, ne csukjuk be/ki
    if ($(e.target).is('input[type="checkbox"]')) {
        return;
    }
    
    const header = $(this);
    const targetId = header.data('target');
    const content = $('#' + targetId);
    const icon = header.find('.collapsible-icon-icon');
    
    header.toggleClass('collapsed');
    content.toggleClass('collapsed');
    
    if (header.hasClass('collapsed')) {
        icon.css('transform', 'rotate(-90deg)');
    } else {
        icon.css('transform', 'rotate(0deg)');
    }
});
        // // Collapsible sections functionality
        // $(document).on('click', '.collapsible-header', function() {
        //   console.log("collapsible-header")
        //     const header = $(this);
        //     const targetId = header.data('target');
        //     const content = $('#' + targetId);
        //     const icon = header.find('.collapsible-icon-icon');
            
        //     header.toggleClass('collapsed');
        //     content.toggleClass('collapsed');
            
        //     // Rotate icon animation
        //     if (header.hasClass('collapsed')) {
        //         icon.css('transform', 'rotate(-90deg)');
        //     } else {
        //         icon.css('transform', 'rotate(0deg)');
        //     }
        // });
        // --- 1. SPECI√ÅLIS KEZEL√âS: Ha a Checkbox/Label r√©szre kattintunk ---
        // Ez megakad√°lyozza, hogy a panel √∂sszecsuk√≥djon, amikor csak pip√°lni akarsz.
        // $(document).on('click', '.header-label', function(e) {
        //     // Fontos: Meg√°ll√≠tjuk az esem√©nyt, hogy ne bubor√©koljon fel a .collapsible-header-ig
        //     e.stopPropagation(); 
        //     // A checkbox automatikusan teszi a dolg√°t (pip√°l), itt nem kell m√°st tenni.
        // });

        // // --- 2. √ÅLTAL√ÅNOS KEZEL√âS: Panel nyit√°sa/csuk√°sa ---
        // // Ez akkor fut le, ha a ny√≠lra, vagy a fejl√©c √ºres r√©sz√©re kattintasz,
        // // DE NEM akkor, ha a fenti .header-label-re (mert ott a stopPropagation meg√°ll√≠totta).
        // $(document).on('click', '.collapsible-header', function() {
        //     console.log("Panel nyit√°sa/csuk√°sa");
            
        //     const header = $(this);
        //     const targetId = header.data('target');
        //     const content = $('#' + targetId);
        //     const icon = header.find('.collapsible-icon-icon');
            
        //     // Oszt√°lyok v√°lt√°sa (anim√°ci√≥hoz)
        //     header.toggleClass('collapsed');
        //     content.toggleClass('collapsed');
            
        //     // Ikon forgat√°sa
        //     if (header.hasClass('collapsed')) {
        //         icon.css('transform', 'rotate(-90deg)');
        //     } else {
        //         icon.css('transform', 'rotate(0deg)');
        //     }
        // });
        // --- 1. OKOS KEZEL√âS: Ha a Checkbox/Label r√©szre kattintunk ---
        // Logika: Pipa be -> Nyit√°s | Pipa ki -> Z√°r√°s
        $(document).on('click', '.header-label', function(e) {
            e.stopPropagation(); // Meg√°ll√≠tjuk, hogy ne fusson le a sima toggle

            const header = $(this).closest('.collapsible-header');
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');
            const checkbox = $(this).find('input');

            // Pici k√©sleltet√©s kell, hogy a b√∂ng√©sz≈ë friss√≠tse a checkbox √°llapot√°t a kattint√°s ut√°n
            setTimeout(() => {
                const isChecked = checkbox.is(':checked');

                if (isChecked) {
                    // HA BEPIP√ÅLTUK -> MINDENK√âPP NYIT√ÅS
                    if (header.hasClass('collapsed')) {
                        header.removeClass('collapsed');
                        content.removeClass('collapsed').slideDown(300);
                        icon.css('transform', 'rotate(0deg)');
                    }
                } else {
                    // HA KIVETT√úK A PIP√ÅT -> MINDENK√âPP Z√ÅR√ÅS
                    if (!header.hasClass('collapsed')) {
                        header.addClass('collapsed');
                        content.addClass('collapsed').slideUp(300);
                        icon.css('transform', 'rotate(-90deg)');
                    }
                }
            }, 20);
        });

        // --- 2. √ÅLTAL√ÅNOS KEZEL√âS: Csak a ny√≠lra (vagy √ºres helyre) kattintva ---
        // Logika: Sima v√°lt√°s (Toggle), f√ºggetlen√ºl a pip√°t√≥l
        $(document).on('click', '.collapsible-header', function() {
            const header = $(this);
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');
            
            // Sima v√°lt√°s (Toggle)
            if (header.hasClass('collapsed')) {
                // Nyit√°s
                header.removeClass('collapsed');
                content.removeClass('collapsed').slideDown(300);
                icon.css('transform', 'rotate(0deg)');
            } else {
                // Z√°r√°s
                header.addClass('collapsed');
                content.addClass('collapsed').slideUp(300);
                icon.css('transform', 'rotate(-90deg)');
            }
        });
        // $(document).on('click', '.collapsible-l', function() {
        //   console.log("collapsible-l")
        //     const header = $(this);
        //     const targetId = header.data('target');
        //     const content = $('#' + targetId);
        //     const icon = header.find('.collapsible-icon-icon');
            
        //     header.toggleClass('collapsed');
        //     content.toggleClass('collapsed');
            
        //     // Rotate icon animation
        //     if (header.hasClass('collapsed')) {
        //         icon.css('transform', 'rotate(-90deg)');
        //     } else {
        //         icon.css('transform', 'rotate(0deg)');
        //     }
        // });
        // // Collapsible sections functionality
        // $(document).on('click', '.collapsible-icon', function() {
        //   console.log("gggggggggggg")
        //     const header = $(this);
        //     const targetId = header.data('target');
        //     const content = $('#' + targetId);
        //     const icon = header.find('.collapsible-icon-icon');
            
        //     header.toggleClass('collapsed');
        //     content.toggleClass('collapsed');
            
        //     // Rotate icon animation
        //     if (header.hasClass('collapsed')) {
        //         icon.css('transform', 'rotate(-90deg)');
        //     } else {
        //         icon.css('transform', 'rotate(0deg)');
        //     }
        // });
        // // --- T√âMA DEFIN√çCI√ìK (PRESETS) ---
        // const mapThemes = {
        //     "midnight": {
        //         name: "Midnight Blue",
        //         style: "background: #0B1026; color: #fff; border: 1px solid #4a9eff;",
        //         config: {
        //             background: { fill: "#0B1026", opacity: 1, stroke: "#ffffff", width: 2 },
        //             stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
        //             constellations: { show: false, lines: true, lineStyle: { stroke: "#4a9eff", width: 1.2, opacity: 0.6 } },
        //             lines: { graticule: { show: true, stroke: "#2c3e50", opacity: 0.6 } },
        //             mw: { show: true, style: { fill: "#ffffff", opacity: 0.12 } }
        //         }
        //     },
        //     "minimal": {
        //         name: "Clean White",
        //         style: "background: #ffffff; color: #000; border: 1px solid #000;",
        //         config: {
        //             background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3 },
        //             stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5 },
        //             constellations: { show: false, lines: true, lineStyle: { stroke: "#333333", width: 1.5, opacity: 0.8 } },
        //             lines: { graticule: { show: true, stroke: "#cccccc", opacity: 0.5 } },
        //             mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
        //         }
        //     },
        //     "vintage": {
        //         name: "Vintage Paper",
        //         style: "background: #f0e6d2; color: #4a3b2a; border: 1px solid #8b5a2b;",
        //         config: {
        //             background: { fill: "#f0e6d2", opacity: 1, stroke: "#8b5a2b", width: 4 }, 
        //             stars: { show: true, style: { fill: "#4a3b2a", opacity: 1 }, limit: 6 }, 
        //             constellations: { show: false, lines: true, lineStyle: { stroke: "#8b5a2b", width: 1.5, opacity: 0.7 } },
        //             lines: { graticule: { show: true, stroke: "#a67c52", opacity: 0.4 } },
        //             mw: { show: true, style: { fill: "#4a3b2a", opacity: 0.08 } }
        //         }
        //     },
        //     "cosmic": {
        //         name: "Cosmic Love",
        //         style: "background: #2d0a1e; color: #ffb7c5; border: 1px solid #ff9eb5;",
        //         config: {
        //             background: { fill: "#2d0a1e", opacity: 1, stroke: "#ffb7c5", width: 1.5 },
        //             stars: { show: true, style: { fill: "#ffb7c5", opacity: 1 }, limit: 6 },
        //             constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9eb5", width: 1.3, opacity: 0.8 } },
        //             lines: { graticule: { show: true, stroke: "#804060", opacity: 0.4 } },
        //             mw: { show: true, style: { fill: "#ffb7c5", opacity: 0.15 } }
        //         }
        //     }
        // };
        // --- T√âMA DEFIN√çCI√ìK (B≈êV√çTETT) ---
//         const mapThemes = {
//             "midnight": {
//                 name: "Midnight Blue",
//                 // FONTOS: Ide √≠rd be a TE √°ltalad k√©sz√≠tett k√©p el√©r√©si √∫tj√°t!
//                 image: "images/themes/thumb_midnight.png", 
//                 style: "background: #0B1026; color: #fff;",
//                 config: {
//                     background: { fill: "#0B1026", opacity: 1, stroke: "#ffffff", width: 2 },
//                     stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#4a9eff", width: 1.2, opacity: 0.6 } },
//                     lines: { graticule: { show: true, stroke: "#2c3e50", opacity: 0.6 } },
//                     mw: { show: true, style: { fill: "#ffffff", opacity: 0.12 } }
//                 }
//             },
//             "minimal": {
//                 name: "Clean White",
//                 image: "images/themes/thumb_minimal.png",
//                 style: "background: #ffffff; color: #000; border-bottom: 1px solid #ddd;",
//                 config: {
//                     background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3 },
//                     stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#333333", width: 1.5, opacity: 0.8 } },
//                     lines: { graticule: { show: true, stroke: "#cccccc", opacity: 0.5 } },
//                     mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
//                 }
//             },
//             "vintage": {
//                 name: "Vintage Paper",
//                 image: "images/themes/thumb_vintage.png",
//                 style: "background: #f0e6d2; color: #4a3b2a;",
//                 config: {
//                     background: { fill: "#f0e6d2", opacity: 1, stroke: "#8b5a2b", width: 4 }, 
//                     stars: { show: true, style: { fill: "#4a3b2a", opacity: 1 }, limit: 6 }, 
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#8b5a2b", width: 1.5, opacity: 0.7 } },
//                     lines: { graticule: { show: true, stroke: "#a67c52", opacity: 0.4 } },
//                     mw: { show: true, style: { fill: "#4a3b2a", opacity: 0.08 } }
//                 }
//             },
//             "cosmic": {
//                 name: "Cosmic Love",
//                 image: "images/themes/thumb_cosmic.png",
//                 style: "background: #2d0a1e; color: #ffb7c5;",
//                 config: {

//     // "cosmic":   { mapTheme: "cosmic", name: "Cosmic Love", background: "#2C0C2D",  textColor: "#ffb7c5" },
//                     background: { fill: "#2d0a1e", opacity: 1, stroke: "#ffb7c5", width: 1.5 },
//                     stars: { show: true, style: { fill: "#ffb7c5", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9eb5", width: 1.3, opacity: 0.8 } },
//                     lines: { graticule: { show: true, stroke: "#804060", opacity: 0.4 } },
//                     mw: { show: true, style: { fill: "#ffb7c5", opacity: 0.15 } }
//                 }
//             },
//             // --- √öJ T√âM√ÅK ---
//             "forest": {
//                 name: "Forest Night",
//                 image: "images/themes/thumb_forest.png",
//                 style: "background: #0a220a; color: #e8f5e9;",
//                 config: {
//                     background: { fill: "#0a220a", opacity: 1, stroke: "#8fbc8f", width: 2 },
//                     stars: { show: true, style: { fill: "#e8f5e9", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#8fbc8f", width: 1.2, opacity: 0.7 } },
//                     lines: { graticule: { show: true, stroke: "#1e3b1e", opacity: 0.5 } },
//                     mw: { show: true, style: { fill: "#8fbc8f", opacity: 0.1 } }
//                 }
//             },
//             "monochrome": {
//                 name: "Mono Charcoal",
//                 image: "images/themes/thumb_mono.png",
//                 style: "background: #222222; color: #ffffff;",
//                 config: {
//                     background: { fill: "#222222", opacity: 1, stroke: "#555555", width: 1 },
//                     stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 5.8 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#999999", width: 1, opacity: 0.9 } },
//                     lines: { graticule: { show: true, stroke: "#444444", opacity: 0.5 } },
//                     mw: { show: true, style: { fill: "#ffffff", opacity: 0.08 } }
//                 }
//             },
//              "golden": {
//                 name: "Golden Hour",
//                 image: "images/themes/thumb_golden.png",
//                 style: "background: #4a2511; color: #ffcc00;",
//                 config: {
//                     background: { fill: "#4a2511", opacity: 1, stroke: "#ffcc00", width: 2.5 },
//                     stars: { show: true, style: { fill: "#ffffcc", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.4, opacity: 0.8 } },
//                     lines: { graticule: { show: true, stroke: "#7a4521", opacity: 0.6 } },
//                     mw: { show: true, style: { fill: "#ffcc00", opacity: 0.15 } }
//                 }
//             },
//             // --- üåä √öJ √ÅLTAL√ÅNOS T√âM√ÅK ---
//             "ocean": {
//                 name: "Deep Ocean",
//                 image: "images/themes/thumb_ocean.png",
//                 style: "background: #001f3f; color: #7FDBFF;",
//                 config: {
//                     background: { fill: "#001f3f", opacity: 1, stroke: "#7FDBFF", width: 2 },
//                     stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#7FDBFF", width: 1.2, opacity: 0.6 } },
//                     lines: { graticule: { show: true, stroke: "#39CCCC", opacity: 0.3 } },
//                     mw: { show: true, style: { fill: "#7FDBFF", opacity: 0.1 } }
//                 }
//             },
//             "matrix": {
//                 name: "Cyber Matrix",
//                 image: "images/themes/thumb_matrix.png",
//                 style: "background: #000000; color: #00ff00; border: 1px solid #00ff00;",
//                 config: {
//                     background: { fill: "#000000", opacity: 1, stroke: "#00ff00", width: 1.5 },
//                     stars: { show: true, style: { fill: "#ccffcc", opacity: 1 }, limit: 5.5 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#00ff00", width: 1.2, opacity: 0.8 } },
//                     lines: { graticule: { show: true, stroke: "#003300", opacity: 0.8 } },
//                     mw: { show: true, style: { fill: "#00ff00", opacity: 0.05 } }
//                 }
//             },
//             "aurora": {
//                 name: "Northern Lights",
//                 image: "images/themes/thumb_aurora.png",
//                 style: "background: #022c22; color: #6ee7b7;",
//                 config: {
//                     background: { fill: "#022c22", opacity: 1, stroke: "#34d399", width: 2 },
//                     stars: { show: true, style: { fill: "#d1fae5", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#10b981", width: 1.3, opacity: 0.7 } },
//                     lines: { graticule: { show: true, stroke: "#064e3b", opacity: 0.5 } },
//                     mw: { show: true, style: { fill: "#34d399", opacity: 0.15 } }
//                 }
//             },
//             "royal": {
//                 name: "Royal Amethyst",
//                 image: "images/themes/thumb_royal.png",
//                 style: "background: #240046; color: #ff9e00;",
//                 config: {
//                     background: { fill: "#240046", opacity: 1, stroke: "#ff9e00", width: 2 },
//                     stars: { show: true, style: { fill: "#e0aaff", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9e00", width: 1.2, opacity: 0.6 } },
//                     lines: { graticule: { show: true, stroke: "#5a189a", opacity: 0.4 } },
//                     mw: { show: true, style: { fill: "#e0aaff", opacity: 0.12 } }
//                 }
//             },

//             // --- ‚ù§Ô∏è √öJ VALENTIN-NAP T√âM√ÅK ---
//             "sweetheart": {
//                 name: "Sweetheart",
//                 image: "images/themes/thumb_sweetheart.png",
//                 style: "background: #ffe4e1; color: #ff1493;",
//                 config: {
//                     background: { fill: "#ffe4e1", opacity: 1, stroke: "#ff1493", width: 2.5 },
//                     stars: { show: true, style: { fill: "#ff69b4", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#ff1493", width: 1.5, opacity: 0.8 } },
//                     lines: { graticule: { show: true, stroke: "#ffb6c1", opacity: 0.5 } },
//                     mw: { show: true, style: { fill: "#ff1493", opacity: 0.05 } }
//                 }
//             },
//             "redvelvet": {
//                 name: "Red Velvet",
//                 image: "images/themes/thumb_redvelvet.png",
//                 style: "background: #4a0404; color: #ffd700;",
//                 config: {
//                     background: { fill: "#4a0404", opacity: 1, stroke: "#ffd700", width: 1.5 },
//                     stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1.2, opacity: 0.7 } },
//                     lines: { graticule: { show: true, stroke: "#800000", opacity: 0.6 } },
//                     mw: { show: true, style: { fill: "#ffd700", opacity: 0.1 } }
//                 }
//             },
//             "rosegold": {
//                 name: "Rose Gold",
//                 image: "images/themes/thumb_rosegold.png",
//                 style: "background: #fff0f5; color: #b76e79; border: 1px solid #b76e79;",
//                 config: {
//                     background: { fill: "#fff0f5", opacity: 1, stroke: "#b76e79", width: 3 },
//                     stars: { show: true, style: { fill: "#b76e79", opacity: 1 }, limit: 6 },
//                     constellations: { show: false, lines: true, lineStyle: { stroke: "#b76e79", width: 1.5, opacity: 0.9 } },
//                     lines: { graticule: { show: true, stroke: "#e6e6fa", opacity: 0.8 } },
//                     mw: { show: true, style: { fill: "#b76e79", opacity: 0.05 } }
//                 }
//             }
//         };
// // Ebbe a v√°ltoz√≥ba mentj√ºk, hogy √©ppen melyik t√©ma akt√≠v.
//         // Alap√©rtelmezettk√©nt 'custom', ha m√©g nem v√°lasztott√°l.
//         let activeThemeKey = "custom";
//         // T√©ma bet√∂lt≈ë f√ºggv√©ny
//         function loadTheme(key) {
//           // 1. Megjegyezz√ºk az akt√≠vat
//             activeThemeKey = key;
//             // const theme = mapThemes[key];
//             // if (!theme) return;
            
//             // ... (Itt van a r√©gi config bet√∂lt≈ë k√≥d: change(theme.config)...) ...
//             const theme = mapThemes[key];
//             if (theme) {
//                  change(theme.config);
//                  // ... input mez≈ëk friss√≠t√©se ...
//                 // 2. UI Input mez≈ëk friss√≠t√©se (hogy a color pickerek is k√∂vess√©k a v√°lt√°st)
//                 // H√°tt√©r
//                 $("#background_fill").val(theme.config.background.fill);
//                 $("#background_stroke").val(theme.config.background.stroke);
//                 $("#background_stroke_width").val(theme.config.background.width);
                
//                 // Csillagok
//                 $("#stars_style_fill").val(theme.config.stars.style.fill);
                
//                 // Csillagk√©pek
//                 $("#constellation_lineStyle_stroke").val(theme.config.constellations.lineStyle.stroke);
//                 $("#constellation_lineStyle_opacity").val(theme.config.constellations.lineStyle.opacity);
                
//                 // Tej√∫t
//                 $("#mw_style_fill").val(theme.config.mw.style.fill);
//                 $("#mw_style_opacity").val(theme.config.mw.style.opacity);
                
//                 // R√°cs
//                 $("#lines_graticule_color").val(theme.config.lines.graticule.stroke);
//                 $("#lines_graticule_opacity").val(theme.config.lines.graticule.opacity);
//             }
//             // --- √öJ R√âSZ: H√çVJUK MEG A H√ÅTT√âR FRISS√çT√âST IS! ---
//             // Ha l√©tezik a glob√°lis vez√©rl≈ë (√©s nem onnan h√≠vtak minket, hogy elker√ºlj√ºk a v√©gtelen ciklust)
//             // De a legegyszer≈±bb, ha a h√°tt√©r√°ll√≠t√°st k√ºl√∂n kiszervezz√ºk.
            
//             if (typeof updateDesignerBackground === 'function') {
//                 updateDesignerBackground(key);
//             } else {
//                 // Fallback: Ha a fragment5_jo.js be van t√∂ltve, k√∂zvetlen√ºl el√©rj√ºk a designerThemes-t
//                 if (typeof designerThemes !== 'undefined' && designerThemes[key]) {
//                     const dTheme = designerThemes[key];
//                     const svgBg = document.getElementById('designer-background-rect');
//                     if (svgBg) {
//                         if (dTheme.background.includes('gradient')) {
//                              const colorMatch = dTheme.background.match(/#[0-9a-fA-F]{6}/);
//                              svgBg.setAttribute('fill', colorMatch ? colorMatch[0] : '#222');
//                         } else {
//                              svgBg.setAttribute('fill', dTheme.background);
//                         }
//                     }
//                     // Sz√∂vegek friss√≠t√©se
//                     const texts = document.querySelectorAll('#designer-svg text');
//                     texts.forEach(t => t.setAttribute('fill', dTheme.textColor));
//                 }
//             }
            
//             // 1. T√©rk√©p konfigur√°ci√≥ friss√≠t√©se (Deep merge)
//             // change(theme.config);
            
//         }

        // --- 1. EGYES√çTETT T√âMA ADATB√ÅZIS (Config + H√°tt√©r) ---
        const mapThemes = {
            "midnight": {
                name: "Midnight Blue",
                // Ez a background megy a #map-wrap-re √©s a Designer-re is:
                image: "images/themes/thumb_midnight.png",
                background: "linear-gradient(135deg, #0B1026 0%, #1a2542 100%)", 
                textColor: "#ffffff",
                config: {
                    background: { fill: "#0B1026", opacity: 1, stroke: "#ffffff", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#4a9eff", width: 1.2, opacity: 0.6 } },
                    lines: { graticule: { show: true, stroke: "#2c3e50", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.12 } }
                }
            },
            "minimal": {
                name: "Clean White",
                image: "images/themes/thumb_minimal.png",
                background: "#ffffff",
                textColor: "#000000",
                config: {
                    background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3 },
                    stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#333333", width: 1.5, opacity: 0.8 } },
                    lines: { graticule: { show: true, stroke: "#cccccc", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
                }
            },
            "vintage": {
                name: "Vintage Paper",
                image: "images/themes/thumb_vintage.png",
                background: "#f0e6d2",
                textColor: "#4a3b2a",
                config: {
                    background: { fill: "#f0e6d2", opacity: 1, stroke: "#8b5a2b", width: 4 }, 
                    stars: { show: true, style: { fill: "#4a3b2a", opacity: 1 }, limit: 6 }, 
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#8b5a2b", width: 1.5, opacity: 0.7 } },
                    lines: { graticule: { show: true, stroke: "#a67c52", opacity: 0.4, width: 1.5 } },
                    mw: { show: true, style: { fill: "#4a3b2a", opacity: 0.08 } }
                }
            },
            "cosmic": {
                name: "Cosmic Love",
                image: "images/themes/thumb_cosmic.png",
                background: "linear-gradient(135deg, #2d0a1e 0%, #4a1230 100%)",
                textColor: "#ffb7c5",
                config: {
                    background: { fill: "#2d0a1e", opacity: 1, stroke: "#ffb7c5", width: 1.5 },
                    stars: { show: true, style: { fill: "#ffb7c5", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9eb5", width: 1.3, opacity: 0.8 } },
                    lines: { graticule: { show: true, stroke: "#804060", opacity: 0.4, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffb7c5", opacity: 0.15 } }
                }
            },
            "forest": {
                name: "Forest Night",
                image: "images/themes/thumb_forest.png",
                background: "#0a220a",
                textColor: "#e8f5e9",
                config: {
                    background: { fill: "#0a220a", opacity: 1, stroke: "#8fbc8f", width: 2 },
                    stars: { show: true, style: { fill: "#e8f5e9", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#8fbc8f", width: 1.2, opacity: 0.7 } },
                    lines: { graticule: { show: true, stroke: "#1e3b1e", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#8fbc8f", opacity: 0.1 } }
                }
            },
            "monochrome": {
                name: "Mono Charcoal",
                image: "images/themes/thumb_monochrome.png",
                // style: "background: #222222; color: #ffffff;",
                background: "#222222",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#222222", opacity: 1, stroke: "#555555", width: 1 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 5.8 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#999999", width: 1, opacity: 0.9 } },
                    lines: { graticule: { show: true, stroke: "#444444", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.08 } }
                }
            },
            "golden": {
                name: "Golden Hour",
                image: "images/themes/thumb_golden.png",
                background: "#4a2511",
                textColor: "#ffcc00",
                config: {
                    background: { fill: "#4a2511", opacity: 1, stroke: "#ffcc00", width: 2.5 },
                    stars: { show: true, style: { fill: "#ffffcc", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.4, opacity: 0.8 } },
                    lines: { graticule: { show: true, stroke: "#7a4521", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffcc00", opacity: 0.15 } }
                }
            },
            "ocean": {
                name: "Deep Ocean",
                image: "images/themes/thumb_ocean.png",
                background: "linear-gradient(to bottom, #001f3f 0%, #003366 100%)",
                textColor: "#7FDBFF",
                config: {
                    background: { fill: "#001f3f", opacity: 1, stroke: "#7FDBFF", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#7FDBFF", width: 1.2, opacity: 0.6 } },
                    lines: { graticule: { show: true, stroke: "#39CCCC", opacity: 0.3, width: 1.5 } },
                    mw: { show: true, style: { fill: "#7FDBFF", opacity: 0.1 } }
                }
            },
            "matrix": {
                name: "Cyber Matrix",
                image: "images/themes/thumb_matrix.png",
                // style: "background: #000000; color: #00ff00; border: 1px solid #00ff00;",
                background: "#000000",
                textColor: "#00ff00",
                config: {
                    background: { fill: "#000000", opacity: 1, stroke: "#00ff00", width: 1.5 },
                    stars: { show: true, style: { fill: "#ccffcc", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#00ff00", width: 1.2, opacity: 0.8 } },
                    lines: { graticule: { show: true, stroke: "#003300", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#00ff00", opacity: 0.05 } }
                }
            },
            "aurora": {
                name: "Northern Lights",
                image: "images/themes/thumb_aurora.png",
                // style: "background: #022c22; color: #6ee7b7;",
                background: "linear-gradient(135deg, #022c22 0%, #064e3b 100%)",
                textColor: "#6ee7b7",
                config: {
                    background: { fill: "#022c22", opacity: 1, stroke: "#34d399", width: 2 },
                    stars: { show: true, style: { fill: "#d1fae5", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#10b981", width: 1.3, opacity: 0.7 } },
                    lines: { graticule: { show: true, stroke: "#064e3b", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#34d399", opacity: 0.15 } }
                }
            },
            "royal": {
                name: "Royal Amethyst",
                image: "images/themes/thumb_royal.png",
                // style: "background: #240046; color: #ff9e00;",
                background: "linear-gradient(135deg, #240046 0%, #3c096c 100%)",
                textColor: "#ff9e00",
                config: {
                    background: { fill: "#240046", opacity: 1, stroke: "#ff9e00", width: 2 },
                    stars: { show: true, style: { fill: "#e0aaff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9e00", width: 1.2, opacity: 0.6 } },
                    lines: { graticule: { show: true, stroke: "#5a189a", opacity: 0.4, width: 1.5 } },
                    mw: { show: true, style: { fill: "#e0aaff", opacity: 0.12 } }
                }
            },
            "sweetheart": {
                name: "Sweetheart",
                image: "images/themes/thumb_sweetheart.png",
                background: "linear-gradient(135deg, #ffe4e1 0%, #ffc0cb 100%)",
                textColor: "#ff1493",
                config: {
                    background: { fill: "#ffe4e1", opacity: 1, stroke: "#ff1493", width: 2.5 },
                    stars: { show: true, style: { fill: "#ff69b4", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff1493", width: 1.5, opacity: 0.8 } },
                    lines: { graticule: { show: true, stroke: "#ffb6c1", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ff1493", opacity: 0.05 } }
                }
            },
            "redvelvet": {
                name: "Red Velvet",
                image: "images/themes/thumb_redvelvet.png",
                background: "linear-gradient(135deg, #4a0404 0%, #6d0707 100%)",
                textColor: "#ffd700",
                config: {
                    background: { fill: "#4a0404", opacity: 1, stroke: "#ffd700", width: 1.5 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1.2, opacity: 0.7 } },
                    lines: { graticule: { show: true, stroke: "#800000", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffd700", opacity: 0.1 } }
                }
            },
            "rosegold": {
                name: "Rose Gold",
                image: "images/themes/thumb_rosegold.png",
                background: "#fff0f5",
                textColor: "#b76e79",
                config: {
                    background: { fill: "#fff0f5", opacity: 1, stroke: "#b76e79", width: 3 },
                    stars: { show: true, style: { fill: "#b76e79", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#b76e79", width: 1.5, opacity: 0.9 } },
                    lines: { graticule: { show: true, stroke: "#e6e6fa", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#b76e79", opacity: 0.05 } }
                }
            },
            // --- √öJ MONOKR√ìM T√âM√ÅK ---
            "ink": {
                name: "Tinta (Fekete-Feh√©r)",
                image: "images/themes/thumb_ink.png", // Gener√°ld le hozz√° a k√©pet!
                background: "#ffffff",
                textColor: "#000000",
                config: {
                    background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3 },
                    stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#000000", width: 1.5, opacity: 1 } },
                    lines: { graticule: { show: true, stroke: "#dddddd", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.03 } }
                }
            },
            "slate": {
                name: "Palat√°bla (Kr√©tarajz)",
                image: "images/themes/thumb_slate.png",
                background: "#2b2b2b",
                textColor: "#f0f0f0",
                config: {
                    background: { fill: "#2b2b2b", opacity: 1, stroke: "#ffffff", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffffff", width: 1.2, opacity: 0.7, dash: [8, 8] } },
                    lines: { graticule: { show: true, stroke: "#555555", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.1 } }
                },
            },
            "silhouette": {
                name: "Sziluett (Silhouette)",
                image: "images/themes/thumb_silhouette.png",
                background: "#000000",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#000000", opacity: 1, stroke: "#ffffff", width: 1, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffffff", width: 1, opacity: 0.5, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#333333", opacity: 0.5, width: 1, dash: [2, 2] } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.15 } }
                }
            },
            "foggy": {
                name: "K√∂d√∂s Reggel (Foggy)",
                image: "images/themes/thumb_foggy.png",
                background: "#e0e0e0",
                textColor: "#333333",
                config: {
                    background: { fill: "#e0e0e0", opacity: 1, stroke: "#555555", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#333333", opacity: 1 }, limit: 5.8 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#555555", width: 1.2, opacity: 0.6, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#ffffff", opacity: 0.6, width: 1.5, dash: [] } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
                }
            },

            // --- SZERELMES T√âM√ÅK ---
            "blush": {
                name: "R√≥zsasz√≠n √Ålom (Blush)",
                image: "images/themes/thumb_blush.png",
                background: "linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)",
                textColor: "#d81b60",
                config: {
                    background: { fill: "#fff0f5", opacity: 1, stroke: "#d81b60", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#d81b60", opacity: 0.8 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d81b60", width: 1.5, opacity: 0.5, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#ffc0cb", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#d81b60", opacity: 0.05 } }
                }
            },
            "passion": {
                name: "Szenved√©ly (Passion)",
                image: "images/themes/thumb_passion.png",
                background: "linear-gradient(135deg, #4a0000 0%, #2a0000 100%)",
                textColor: "#ffcc00",
                config: {
                    background: { fill: "#4a0000", opacity: 1, stroke: "#ff0000", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.2, opacity: 0.8, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#800000", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#ff0000", opacity: 0.1 } }
                }
            },

            // --- ELEG√ÅNS T√âM√ÅK ---
            "royal_gold": {
                name: "Kir√°lyi Arany (Royal)",
                image: "images/themes/thumb_royalgold.png",
                background: "#051e3e",
                textColor: "#d4af37",
                config: {
                    background: { fill: "#051e3e", opacity: 1, stroke: "#d4af37", width: 3, dash: [] },
                    stars: { show: true, style: { fill: "#d4af37", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1, opacity: 0.6, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#1a3a6e", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#d4af37", opacity: 0.1 } }
                }
            },
            "silver": {
                name: "Ez√ºst√∂s (Silver)",
                image: "images/themes/thumb_silver.png",
                background: "linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%)",
                textColor: "#2c3e50",
                config: {
                    background: { fill: "#e6e9f0", opacity: 1, stroke: "#bdc3c7", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#2c3e50", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#7f8c8d", width: 1.2, opacity: 0.8, dash: [2, 2] } },
                    lines: { graticule: { show: true, stroke: "#ecf0f1", opacity: 1, width: 1.5, dash: [] } },
                    mw: { show: true, style: { fill: "#2c3e50", opacity: 0.05 } }
                }
            },
            "emerald": {
                name: "Smaragd (Emerald)",
                image: "images/themes/thumb_emerald.png",
                background: "#064e3b",
                textColor: "#d1fae5",
                config: {
                    background: { fill: "#064e3b", opacity: 1, stroke: "#34d399", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#34d399", width: 1.3, opacity: 0.6, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#047857", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#34d399", opacity: 0.1 } }
                }
            },
            "copper": {
                name: "R√©z & Bronz (Copper)",
                image: "images/themes/thumb_copper.png",
                background: "#2a1b15",
                textColor: "#e2a07d",
                config: {
                    background: { fill: "#2a1b15", opacity: 1, stroke: "#cd7f32", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#e2a07d", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#cd7f32", width: 1.2, opacity: 0.7, dash: [] } },
                    lines: { graticule: { show: true, stroke: "#5c3a2e", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#e2a07d", opacity: 0.1 } }
                }
            }
        };

        // // --- 2. UNIVERZ√ÅLIS T√âMA BET√ñLT≈ê F√úGGV√âNY ---
        // let activeThemeKey = "custom";

        // function loadTheme(key) {
        //     console.log("Loading theme:", key);
        //     activeThemeKey = key;
        //     const theme = mapThemes[key];
        //     if (!theme) return;

        //     // A) CSILLAGT√âRK√âP CONFIG FRISS√çT√âSE
        //     change(theme.config);

        //     // Input mez≈ëk szinkroniz√°l√°sa a Szerkeszt≈ëben
        //     $("#background_fill").val(theme.config.background.fill);
        //     $("#background_stroke").val(theme.config.background.stroke);
        //     $("#background_stroke_width").val(theme.config.background.width);
        //     $("#stars_style_fill").val(theme.config.stars.style.fill);
        //     $("#constellation_lineStyle_stroke").val(theme.config.constellations.lineStyle.stroke);
        //     $("#constellation_lineStyle_opacity").val(theme.config.constellations.lineStyle.opacity);
        //     $("#mw_style_fill").val(theme.config.mw.style.fill);
        //     $("#mw_style_opacity").val(theme.config.mw.style.opacity);
        //     $("#lines_graticule_color").val(theme.config.lines.graticule.stroke);
        //     $("#lines_graticule_opacity").val(theme.config.lines.graticule.opacity);

        //     // B) SZERKESZT≈ê N√âZET H√ÅTT√âR (#map-wrap)
        //     // K√∂zvetlen√ºl a CSS gradientet kapja meg!
        //     $("#map-wrap").css("background", theme.background);

        //     // C) TERVEZ≈ê N√âZET H√ÅTT√âR (#designer-svg)
        //     // A Tervez≈ë SVG-nek is be√°ll√≠tjuk a h√°tter√©t CSS-sel (ez l√°tszik a k√©perny≈ën)
        //     $("#designer-svg").css("background", theme.background);
            
        //     // D) EXPORT√ÅL√ÅSHOZ (SVG export h√°tt√©r)
        //     // Be√°ll√≠tjuk a h√°tt√©r t√©glalap fill attrib√∫tum√°t is (ha egysz√≠n≈±)
        //     // Ha gradient, akkor a CSS style domin√°l, de SVG exportn√°l tr√ºkk√∂s.
        //     // Egyszer≈±s√≠t√©s: ha hex sz√≠n, be√°ll√≠tjuk fill-nek.
        //     const svgBgRect = document.getElementById('designer-background-rect');
        //     if(svgBgRect) {
        //         if (theme.background.startsWith('#') || theme.background.startsWith('rgb')) {
        //             svgBgRect.setAttribute('fill', theme.background);
        //         } else {
        //             // Ha gradient, az SVG rect fill nem √©rti a CSS gradientet.
        //             // Exportn√°l majd a canvas/SVG kl√≥noz√°sn√°l kezelj√ºk.
        //             // Ideiglenesen egy √°tlagos sz√≠nt, vagy a config h√°tt√©rsz√≠n√©t adjuk neki.
        //             svgBgRect.setAttribute('fill', theme.config.background.fill);
        //         }
        //     }

        //     // E) TERVEZ≈ê SZ√ñVEGEK SZ√çNE
        //     if(theme.textColor) {
        //         // Minden megl√©v≈ë sz√∂vegelem √°tsz√≠nez√©se
        //         $("#text-layer text").attr("fill", theme.textColor);
        //         // Config friss√≠t√©se a j√∂v≈ëbeli sz√∂vegekhez
        //         if(typeof fixedTextConfig !== 'undefined') {
        //             fixedTextConfig.top.color = theme.textColor;
        //             fixedTextConfig.bottom.color = theme.textColor;
        //             // Inputok friss√≠t√©se
        //             if(document.getElementById('top-text-color')) document.getElementById('top-text-color').value = theme.textColor;
        //             if(document.getElementById('bottom-text-color')) document.getElementById('bottom-text-color').value = theme.textColor;
        //         }
        //         // Blokk alap√∫ rendszer friss√≠t√©se
        //         if(typeof zoneData !== 'undefined') {
        //             // V√©gigmegy√ºnk az √∂sszes blokkon √©s friss√≠tj√ºk a sz√≠n√©t
        //             ['top', 'bottom'].forEach(zone => {
        //                 zoneData[zone].blocks.forEach(block => {
        //                     block.color = theme.textColor;
        //                 });
        //             });
        //             // √öjrarajzol√°s (ha a fragment5 be van t√∂ltve)
        //             if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
        //             if(typeof renderZoneUI === 'function') { renderZoneUI('top'); renderZoneUI('bottom'); }
        //         }
        //     }

        //     // // F) KIJEL√ñL√âS (Vizu√°lis visszajelz√©s a gombokon)
        //     // $('.theme-preview-img').css('border', 'none'); // Reset
        //     // // Megkeress√ºk az ehhez a kulcshoz tartoz√≥ gombokat (mindk√©t n√©zetben)
        //     // $(`.theme-btn[data-key="${key}"]`).prev('.theme-preview-img').css('border', '3px solid #4a9eff');
        //     // F) KIJEL√ñL√âS (Vizu√°lis visszajelz√©s a K√ÅRTY√ÅN)
        //     // Resetel√ºnk minden k√°rtya keretet
        //     $('.theme-item').css('border', '1px solid #444');
            
        //     // Megkeress√ºk az akt√≠v gombot, √©s a SZ√úL≈êJ√âT (a k√°rty√°t) keretezz√ºk be
        //     $(`.theme-btn[data-key="${key}"]`).parent().css('border', '3px solid #4a9eff');
            
        //     // K√©nyszer√≠tett √∫jrarajzol√°s (biztos, ami biztos)
        //     setTimeout(function() {
        //         Celestial.redraw();
        //     }, 50);
        // }

        // // --- 2. UNIVERZ√ÅLIS T√âMA BET√ñLT≈ê F√úGGV√âNY (Jav√≠tott) ---
        // let activeThemeKey = "custom";

        // function loadTheme(key) {
        //     console.log("Loading theme:", key);
        //     activeThemeKey = key;
        //     const theme = mapThemes[key];
        //     if (!theme) return;

        //     // A) Config friss√≠t√©se
        //     change(theme.config);

        //     // Inputok friss√≠t√©se
        //     $("#background_fill").val(theme.config.background.fill);
        //     $("#background_stroke").val(theme.config.background.stroke);
        //     $("#background_stroke_width").val(theme.config.background.width);
        //     $("#stars_style_fill").val(theme.config.stars.style.fill);
        //     $("#constellation_lineStyle_stroke").val(theme.config.constellations.lineStyle.stroke);
        //     $("#constellation_lineStyle_opacity").val(theme.config.constellations.lineStyle.opacity);
        //     $("#mw_style_fill").val(theme.config.mw.style.fill);
        //     $("#mw_style_opacity").val(theme.config.mw.style.opacity);
        //     $("#lines_graticule_color").val(theme.config.lines.graticule.stroke);
        //     $("#lines_graticule_opacity").val(theme.config.lines.graticule.opacity);

        //     // B) H√°tt√©rsz√≠nek friss√≠t√©se (Szerkeszt≈ë √©s Tervez≈ë)
        //     $("#map-wrap").css("background", theme.background);
        //     $("#designer-svg").css("background", theme.background);
            
        //     const svgBgRect = document.getElementById('designer-background-rect');
        //     if(svgBgRect) {
        //         // Egyszer≈±s√≠tett fill be√°ll√≠t√°s export√°l√°shoz
        //         svgBgRect.setAttribute('fill', theme.background.startsWith('#') ? theme.background : theme.config.background.fill);
        //     }

        //     // C) Sz√∂vegsz√≠n friss√≠t√©se
        //     if(theme.textColor) {
        //         $("#text-layer text").attr("fill", theme.textColor);
        //         // Ha van zoneData rendszer, azt is friss√≠tj√ºk
        //         if(typeof zoneData !== 'undefined') {
        //             ['top', 'bottom'].forEach(zone => {
        //                 zoneData[zone].blocks.forEach(block => block.color = theme.textColor);
        //             });
        //             if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
        //             if(typeof renderZoneUI === 'function') { renderZoneUI('top'); renderZoneUI('bottom'); }
        //         }
        //     }

        //     // D) Kijel√∂l√©s (K√©k keret)
        //     $('.theme-item').css('border', '1px solid #ddd'); // Reset (Feh√©r st√≠lushoz ill≈ë)
        //     $(`.theme-btn[data-key="${key}"]`).parent().css('border', '3px solid #4a9eff');

        //     // E) √öJRARAJZOL√ÅS √âS SZINKRONIZ√ÅL√ÅS (A legfontosabb!)
        //     setTimeout(function() {
        //         // 1. Canvas friss√≠t√©se
        //         Celestial.redraw();
                
        //         // 2. SVG (Tervez≈ë) friss√≠t√©se!
        //         // Ez m√°solja √°t az √∫j be√°ll√≠t√°sokat a tervez≈ëbe
        //         if (typeof copySVG === 'function') {
        //             copySVG(); 
        //         }
        //     }, 50);
        // }

        // // --- 3. SABLON V√ÅLASZT√ì GENER√ÅTOR ---
        // function initThemeSelectors() {
        //     // K√©t helyre kell gener√°lnunk:
        //     // 1. Szerkeszt≈ë n√©zet (#theme-grid-container)
        //     // 2. Tervez≈ë n√©zet (#designer-templates-grid)
            
        //     const containers = ['theme-grid-container', 'designer-templates-grid'];
            
        //     containers.forEach(containerId => {
        //         const container = document.getElementById(containerId);
        //         if (!container) return;
                
        //         container.innerHTML = ''; // T√∂rl√©s

        //         for (const [key, theme] of Object.entries(mapThemes)) {
        //             const card = document.createElement('div');
        //             card.className = 'theme-item';
        //             card.style.cursor = "pointer";

        //             // EL≈êN√âZET: Nem k√©pf√°jl, hanem CSS Gradiens!
        //             const preview = document.createElement('div');
        //             preview.className = 'theme-preview-img';
        //             // ITT A TR√úKK: A config-b√≥l vessz√ºk a h√°tteret!
        //             // Ha van K√âP, azt haszn√°ljuk, ha nincs, akkor a SZ√çN√ÅTMENETET
        //             if (theme.image) {
        //                 preview.style.backgroundImage = `url('${theme.image}')`;
        //                 preview.style.backgroundSize = "cover";
        //                 preview.style.backgroundPosition = "center";
                        
        //                 // Fallback: Ha a k√©p nem t√∂lt≈ëdik be, legyen sz√≠n√°tmenet
        //                 // Ehhez egy img taget k√©ne haszn√°lni error handlerrel, de div-n√©l a 
        //                 // background-image sorrend tr√ºkk√∂s. Egyszer≈±bb, ha a background
        //                 // defaultja a gradiens, √©s fel√ºlcsapjuk a k√©ppel.
        //                 preview.style.background = `${theme.background} url('${theme.image}') no-repeat center/cover`;
        //                 // A fenti szintaxis modern b√∂ng√©sz≈ëkben m≈±k√∂dik: ha az URL √©rv√©nyes, az l√°tszik.
                        
        //             } else {
        //                 // Ha nincs k√©p defini√°lva, marad a tiszta sz√≠n√°tmenet
        //                 preview.style.background = theme.background; 
        //             }

        //             preview.style.height = "70px";
        //             // preview.style.background = theme.background; 
        //             // preview.style.height = "70px";
        //             preview.style.width = "100%";
        //             preview.style.borderRadius = "4px 4px 0 0";
        //             preview.style.border = "1px solid #444"; // Kis keret

        //             const label = document.createElement('div');
        //             label.innerText = theme.name;
        //             label.className = "theme-btn"; // Kell a kijel√∂l√©shez
        //             label.dataset.key = key;       // Kell a kijel√∂l√©shez
        //             label.style.padding = "8px";
        //             label.style.textAlign = "center";
        //             label.style.fontSize = "12px";
        //             label.style.fontWeight = "bold";
        //             label.style.background = "#fff";
        //             label.style.color = "#000";
        //             label.style.width = "100%";
        //             label.style.border = "none";

        //             // Kattint√°s esem√©ny
        //             card.onclick = function(e) {
        //                 e.preventDefault();
        //                 loadTheme(key);
        //             };

        //             card.appendChild(preview);
        //             card.appendChild(label);
        //             container.appendChild(card);
        //         }
        //     });
        // }
        // --- 3. SABLON V√ÅLASZT√ì GENER√ÅTOR (JAV√çTOTT: N√©v fel√ºl, K√©p alul) ---
        // function initThemeSelectors() {
        //     const containers = ['theme-grid-container', 'designer-templates-grid'];
            
        //     containers.forEach(containerId => {
        //         const container = document.getElementById(containerId);
        //         if (!container) return;
                
        //         container.innerHTML = ''; // üßπ TISZTA LAP: Mindent t√∂rl√ºnk, miel≈ëtt gener√°lunk

        //         for (const [key, theme] of Object.entries(mapThemes)) {
        //             // 1. K√°rtya Keret
        //             const card = document.createElement('div');
        //             card.className = 'theme-item';
        //             card.style.cursor = "pointer";
        //             card.style.display = "flex";
        //             card.style.flexDirection = "column"; // Egym√°s al√° rendez√©s
        //             card.style.border = "1px solid #444";
        //             card.style.borderRadius = "8px";
        //             card.style.overflow = "hidden";
        //             card.style.marginBottom = "10px";

        //             // 2. N√âV (Fel√ºl)
        //             const label = document.createElement('div');
        //             label.innerText = theme.name;
        //             label.className = "theme-btn"; // A kijel√∂l√©shez (border) ezt keress√ºk majd
        //             label.dataset.key = key;       // Azonos√≠t√≥
                    
        //             // St√≠lus a n√©vnek
        //             label.style.padding = "10px";
        //             label.style.textAlign = "center";
        //             label.style.fontSize = "14px";
        //             label.style.fontWeight = "bold";
        //             label.style.background = "#222"; // S√∂t√©t fejl√©c
        //             label.style.color = "#fff";
        //             label.style.width = "100%";
        //             label.style.borderBottom = "1px solid #555";

        //             // 3. K√âP (Alul, Nagyban)
        //             const preview = document.createElement('div');
        //             preview.className = 'theme-preview-img';
                    
        //             // K√©p vagy Sz√≠n√°tmenet be√°ll√≠t√°sa
        //             if (theme.image) {
        //                 // Ha van gener√°lt k√©p, azt mutatjuk
        //                 // 'contain' = teljes k√©p l√°tszik (lehetnek cs√≠kok a sz√©l√©n)
        //                 // 'cover' = kit√∂lti a dobozt (lev√°ghatja a sz√©l√©t)
        //                 // Javaslom a 'cover'-t a gombokhoz, vagy 'contain'-t ha l√°tni akarod a teljes A4-et.
        //                 preview.style.background = `url('${theme.image}') no-repeat center/cover`;
        //                 // Ha a h√°tt√©rsz√≠nt is al√° akarjuk tenni (hogy ne legyen feh√©r cs√≠k contain-n√©l):
        //                 // preview.style.background = `${theme.background} url('${theme.image}') no-repeat center/contain`;
        //             } else {
        //                 // Ha nincs k√©p, marad a CSS gradiens
        //                 preview.style.background = theme.background; 
        //             }

        //             // M√âRET BE√ÅLL√çT√ÅSA
        //             preview.style.width = "100%";
        //             // Itt √°ll√≠thatod a magass√°got! 
        //             // 200px el√©g nagy, hogy j√≥l l√°tsz√≥djon a r√©szlet.
        //             // Vagy haszn√°lhatsz aspect-ratio-t (A4 ar√°ny kb 1:1.4)
        //             preview.style.height = "220px"; 

        //             // 4. √ñSSZERAK√ÅS (Sorrend: Label -> Preview)
        //             card.appendChild(label);   // N√©v megy el≈ëre
        //             card.appendChild(preview); // K√©p megy ut√°na

        //             // Kattint√°s esem√©ny
        //             card.onclick = function(e) {
        //                 e.preventDefault();
        //                 loadTheme(key);
        //             };

        //             container.appendChild(card);
        //         }
        //     });
        // }

        // // --- 3. SABLON V√ÅLASZT√ì (FEH√âR DESIGN + NAGY K√âP) ---
        // function initThemeSelectors() {
        //     const containers = ['theme-grid-container', 'designer-templates-grid'];
            
        //     containers.forEach(containerId => {
        //         const container = document.getElementById(containerId);
        //         if (!container) return;
                
        //         container.innerHTML = ''; // Tiszta lap

        //         for (const [key, theme] of Object.entries(mapThemes)) {
        //             // 1. K√°rtya Keret
        //             const card = document.createElement('div');
        //             card.className = 'theme-item';
        //             card.style.cursor = "pointer";
        //             card.style.display = "flex";
        //             card.style.flexDirection = "column"; 
        //             card.style.border = "1px solid #ddd"; // Vil√°gos keret
        //             card.style.borderRadius = "8px";
        //             card.style.overflow = "hidden";
        //             card.style.marginBottom = "10px";
        //             card.style.background = "#fff"; // FEH√âR H√ÅTT√âR

        //             // 2. N√âV (Fel√ºl)
        //             const label = document.createElement('div');
        //             label.innerText = theme.name;
        //             label.className = "theme-btn"; 
        //             label.dataset.key = key;       
                    
        //             // FEH√âR DESIGN ST√çLUS:
        //             label.style.padding = "10px";
        //             label.style.textAlign = "center";
        //             label.style.fontSize = "14px";
        //             label.style.fontWeight = "bold";
        //             label.style.background = "#fff"; // Feh√©r fejl√©c
        //             label.style.color = "#000";      // Fekete bet≈±
        //             label.style.width = "100%";
        //             label.style.borderBottom = "1px solid #eee";

        //             // 3. K√âP (Alul, Nagyban)
        //             const preview = document.createElement('div');
        //             preview.className = 'theme-preview-img';
                    
        //             if (theme.image) {
        //                 // 'contain' = a teljes k√©p l√°tszik, nem v√°gja le a sz√©l√©t
        //                 preview.style.background = `url('${theme.image}') center/contain no-repeat, ${theme.background}`;
        //             } else {
        //                 preview.style.background = theme.background; 
        //             }

        //             preview.style.width = "100%";
        //             preview.style.height = "220px"; // NAGY K√âP (kb. A4 ar√°ny)

        //             // 4. √ñsszerak√°s (N√©v el≈ëre!)
        //             card.appendChild(label);
        //             card.appendChild(preview);

        //             card.onclick = function(e) {
        //                 e.preventDefault();
        //                 loadTheme(key);
        //             };

        //             container.appendChild(card);
        //         }
        //     });
        // }
        // --- 3. SABLON V√ÅLASZT√ì GENER√ÅTOR (Feh√©r Design + Nagy K√©p) ---
        // function initThemeSelectors() {
        //     const containers = ['theme-grid-container', 'designer-templates-grid'];
            
        //     containers.forEach(containerId => {
        //         const container = document.getElementById(containerId);
        //         if (!container) return;
                
        //         container.innerHTML = ''; // üßπ TISZTA LAP

        //         for (const [key, theme] of Object.entries(mapThemes)) {
        //             console.log("key", key);
        //             console.log("theme", theme);
        //             console.log("mapThemes", mapThemes);
        //             // 1. K√°rtya Keret
        //             const card = document.createElement('div');
        //             card.className = 'theme-item';
        //             card.style.cursor = "pointer";
        //             card.style.display = "flex";
        //             card.style.flexDirection = "column"; 
        //             card.style.border = "1px solid #ddd"; // Vil√°gos keret
        //             card.style.borderRadius = "8px";
        //             card.style.overflow = "hidden";
        //             card.style.marginBottom = "10px";
        //             card.style.background = "#fff"; // FEH√âR H√ÅTT√âR

        //             // 2. N√âV (Fel√ºl)
        //             const label = document.createElement('div');
        //             label.innerText = theme.name;
        //             label.className = "theme-btn"; // A kijel√∂l√©shez
        //             label.dataset.key = key;       
                    
        //             // Feh√©r st√≠lus a n√©vnek
        //             label.style.padding = "10px";
        //             label.style.textAlign = "center";
        //             label.style.fontSize = "14px";
        //             label.style.fontWeight = "bold";
        //             label.style.background = "#fff"; 
        //             label.style.color = "#000";      
        //             label.style.width = "100%";
        //             label.style.borderBottom = "1px solid #eee";

        //             // 3. K√âP (Alul, Nagyban)
        //             const preview = document.createElement('div');
        //             preview.className = 'theme-preview-img';
                    
        //             if (theme.image) {
        //                 // K√©p + H√°tt√©rsz√≠n kombin√°ci√≥ja (hogy ne legyen feh√©r cs√≠k)
        //                 preview.style.background = `url('${theme.image}') center/contain no-repeat, ${theme.background}`;
        //             } else {
        //                 preview.style.background = theme.background; 
        //             }

        //             preview.style.width = "100%";
        //             preview.style.height = "220px"; // Nagy m√©ret

        //             // 4. √ñsszerak√°s
        //             card.appendChild(label);
        //             card.appendChild(preview);

        //             // Kattint√°s
        //             card.onclick = function(e) {
        //                 e.preventDefault();
        //                 loadTheme(key);
        //             };

        //             container.appendChild(card);
        //             console.log("card", card);
        //             console.log("card", $(card.innerHTML.replace(".png", "_heart.png")));
        //             // container.appendChild($(card.innerHTML.replace(".png", "_heart.png")));

        //             const card_h = document.createElement('div');
        //             card_h.className = 'theme-item';
        //             card_h.style.cursor = "pointer";
        //             card_h.style.display = "flex";
        //             card_h.style.flexDirection = "column"; 
        //             card_h.style.border = "1px solid #ddd"; // Vil√°gos keret
        //             card_h.style.borderRadius = "8px";
        //             card_h.style.overflow = "hidden";
        //             card_h.style.marginBottom = "10px";
        //             card_h.style.background = "#fff"; // FEH√âR H√ÅTT√âR

        //             // 2. N√âV (Fel√ºl)
        //             const label_h = document.createElement('div');
        //             label_h.innerText = theme.name;
        //             label_h.className = "theme-btn"; // A kijel√∂l√©shez
        //             label_h.dataset.key = key;       
                    
        //             // Feh√©r st√≠lus a n√©vnek
        //             label_h.style.padding = "10px";
        //             label_h.style.textAlign = "center";
        //             label_h.style.fontSize = "14px";
        //             label_h.style.fontWeight = "bold";
        //             label_h.style.background = "#fff"; 
        //             label_h.style.color = "#000";      
        //             label_h.style.width = "100%";
        //             label_h.style.borderBottom = "1px solid #eee";

        //             // 3. K√âP (Alul, Nagyban)
        //             const preview_h = document.createElement('div');
        //             preview_h.className = 'theme-preview-img';
                    
        //             if (theme.image) {
        //                 // K√©p + H√°tt√©rsz√≠n kombin√°ci√≥ja (hogy ne legyen feh√©r cs√≠k)
        //                 preview_h.style.background = `url('${theme.image.replace(".png", "_heart.png")}') center/contain no-repeat, ${theme.background}`;
        //             } else {
        //                 preview_h.style.background = theme.background; 
        //             }

        //             preview_h.style.width = "100%";
        //             preview_h.style.height = "220px"; // Nagy m√©ret

        //             // 4. √ñsszerak√°s
        //             card_h.appendChild(label_h);
        //             card_h.appendChild(preview_h);

        //             // Kattint√°s
        //             card_h.onclick = function(e) {
        //                 e.preventDefault();
        //                 loadTheme(key);
        //             };

        //             container.appendChild(card_h);
        //         }
        //     });
        // }

        // // --- SEG√âDF√úGGV√âNY: Tiszta t√©rk√©p ment√©se a t√©m√°khoz ---
        // function saveMapThumbnail() {
        //     // Megkeress√ºk a f≈ë t√©rk√©p v√°szn√°t (nem a tervez≈ë√©t!)
        //     const canvas = document.querySelector('#celestial-map canvas');
            
        //     if (!canvas) {
        //         alert("Hiba: Nem tal√°lhat√≥ a t√©rk√©p! Gy≈ëz≈ëdj meg r√≥la, hogy a 'T√©rk√©p Be√°ll√≠t√°s' f√ºl√∂n vagy, nem a Tervez≈ëben.");
        //         return;
        //     }
            
        //     // L√©trehozunk egy let√∂lt√©si linket
        //     const link = document.createElement('a');
        //     const timestamp = new Date().getTime();
        //     // A f√°jln√©vben benne lesz az id≈ëb√©lyeg, hogy ne √≠rj√°k fel√ºl egym√°st
        //     link.download = `tema_elonezet_${timestamp}.png`;
            
        //     // A canvas tartalm√°t √°talak√≠tjuk k√©pp√©
        //     link.href = canvas.toDataURL('image/png');
            
        //     // Kattint√°s szimul√°l√°sa
        //     document.body.appendChild(link);
        //     link.click();
        //     document.body.removeChild(link);
        // }
        // // --- SEG√âDF√úGGV√âNY: Okos Ment√©s (Egyes√©vel vagy T√∂megesen) ---
        // function saveMapThumbnail(forcedName = null) {
        //     const canvas = document.querySelector('#celestial-map canvas');
        //     if (!canvas) return;
            
        //     const link = document.createElement('a');
            
        //     // Ha kapott k√©nyszer√≠tett nevet (a robott√≥l), haszn√°lja azt,
        //     // k√ºl√∂nben vegye az √©ppen akt√≠v t√©ma nev√©t.
        //     link.download = forcedName ? forcedName : `thumb_${activeThemeKey}.png`;
        //     link.href = canvas.toDataURL('image/png');
            
        //     document.body.appendChild(link);
        //     link.click();
        //     document.body.removeChild(link);
        // }
        // // --- T√ñMEGES LET√ñLT≈ê ROBOT ü§ñ ---
        // function downloadAllThemesSequence() {
        //     const keys = Object.keys(mapThemes);
        //     let index = 0;

        //     if(!confirm(`Figyelem! Ez a folyamat sorban let√∂lti mind a(z) ${keys.length} k√©pet.\n\nFONTOS: A b√∂ng√©sz≈ë k√©rdezheti, hogy enged√©lyezed-e a t√∂bb f√°jl let√∂lt√©s√©t. Nyomj az 'Enged√©lyez√©s'-re!\n\nMehet?`)) {
        //         return;
        //     }

        //     function processNext() {
        //         if (index >= keys.length) {
        //             alert("K√©sz! Minden t√©ma k√©pe let√∂ltve. ü•Ç");
        //             // Vissza√°ll√≠tjuk az eredeti (vagy els≈ë) t√©m√°t, hogy ne maradjon az utols√≥n
        //             loadTheme(keys[0]); 
        //             return;
        //         }

        //         const key = keys[index];
        //         console.log(`Feldolgoz√°s: ${key} (${index + 1}/${keys.length})`);
                
        //         // 1. T√©ma bet√∂lt√©se
        //         loadTheme(key);

        //         // 2. V√°rakoz√°s √©s Ment√©s (1000ms = 1 m√°sodperc)
        //         // Musz√°j v√°rni, k√ºl√∂nben a b√∂ng√©sz≈ë nem tudja el√©g gyorsan √∫jrarajzolni a Canvast!
        //         setTimeout(() => {
        //             saveMapThumbnail(`thumb_${key}.png`); // Itt adjuk √°t a pontos nevet
        //             index++;
        //             processNext(); // H√≠vjuk a k√∂vetkez≈ët
        //         }, 1000); 
        //     }

        //     // Ind√≠t√°s
        //     processNext();
        // }

        // // --- SEG√âDF√úGGV√âNY: Tiszta t√©rk√©p ment√©se ---
        // function saveMapThumbnail(forcedName) {
        //     // A #celestial-map a tiszta t√©rk√©p, ezt fot√≥zzuk le
        //     const canvas = document.querySelector('#celestial-map canvas');
        //     if (!canvas) return;
            
        //     const link = document.createElement('a');
        //     link.download = forcedName;
        //     link.href = canvas.toDataURL('image/png');
            
        //     document.body.appendChild(link);
        //     link.click();
        //     document.body.removeChild(link);
        // }
        // --- JAV√çTOTT SEG√âDF√úGGV√âNY: T√©rk√©p + H√°tt√©r ment√©se ---
        // function saveMapThumbnail(forcedName) {
        //     const sourceCanvas = document.querySelector('#celestial-map canvas');
        //     if (!sourceCanvas) {
        //         console.error("Nem tal√°lhat√≥ a t√©rk√©p canvas!");
        //         return;
        //     }

        //     // 1. Az √©ppen akt√≠v t√©ma adatainak lek√©r√©se
        //     // (Mivel a loadTheme be√°ll√≠tja az activeThemeKey-t, tudjuk mi van kiv√°lasztva)
        //     const theme = mapThemes[activeThemeKey];
        //     const bgStyle = theme ? theme.background : "#000000";

        //     // 2. √öj, ideiglenes v√°szon l√©trehoz√°sa (ugyanakkora m√©retben)
        //     const exportCanvas = document.createElement('canvas');
        //     exportCanvas.width = sourceCanvas.width;
        //     exportCanvas.height = sourceCanvas.height;
        //     const ctx = exportCanvas.getContext('2d');

        //     // 3. H√ÅTT√âR MEGFEST√âSE
        //     // Megpr√≥b√°ljuk kital√°lni, hogy ez egy gradiens vagy sima sz√≠n
        //     if (bgStyle.includes('gradient')) {
        //         // Ha gradiens: Kinyerj√ºk a sz√≠neket a stringb≈ël (pl. #0B1026, #1a2542)
        //         const colors = bgStyle.match(/#[a-fA-F0-9]{6}|rgb\([^)]+\)/g);
                
        //         if (colors && colors.length >= 2) {
        //             // Csin√°lunk egy √°tl√≥s (135deg kb.) gradienst a canvasra
        //             // (0,0)-t√≥l (width, height)-ig
        //             const gradient = ctx.createLinearGradient(0, 0, exportCanvas.width, exportCanvas.height);
        //             gradient.addColorStop(0, colors[0]); // Kezd≈ë sz√≠n
        //             gradient.addColorStop(1, colors[colors.length - 1]); // V√©g sz√≠n
        //             ctx.fillStyle = gradient;
        //         } else {
        //             // Ha nem siker√ºlt sz√≠nt lopni, fallback fekete
        //             ctx.fillStyle = "#000000";
        //         }
        //     } else {
        //         // Ha sima sz√≠n (pl. #ffffff)
        //         ctx.fillStyle = bgStyle;
        //     }

        //     // Kit√∂ltj√ºk a h√°tteret
        //     ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

        //     // 4. R√ÅRAJZOLJUK A CSILLAGT√âRK√âPET
        //     // Ez r√°ker√ºl a h√°tt√©rre (mivel a t√©rk√©p √°tl√°tsz√≥, a h√°tt√©r l√°tszani fog alatta)
        //     ctx.drawImage(sourceCanvas, 0, 0);

        //     // 5. MENT√âS
        //     const link = document.createElement('a');
        //     link.download = forcedName || `thumb_${activeThemeKey}.png`;
        //     link.href = exportCanvas.toDataURL('image/png');
            
        //     document.body.appendChild(link);
        //     link.click();
        //     document.body.removeChild(link);
        // }
// // --- 2. √ÅLLAPOT MENT√âSE (User Settings) ---
// let userSavedState = null; // Ide mentj√ºk a "Saj√°t" be√°ll√≠t√°sokat

// function saveUserState() {
//     // √ñsszegy≈±jtj√ºk a jelenlegi √°llapotot
//     userSavedState = {
//         config: JSON.parse(JSON.stringify(myCelestialConf)), // M√©ly m√°solat
//         background: $("#map-wrap").css("background"), // Jelenlegi h√°tt√©r
//         // Sz√∂vegek ment√©se (ha a fragment5.js zoneData-t haszn√°lja)
//         zoneData: (typeof zoneData !== 'undefined') ? JSON.parse(JSON.stringify(zoneData)) : null,
//         // Input mez≈ëk √©rt√©kei
//         inputs: {
//             bgFill: $("#background_fill").val(),
//             bgStroke: $("#background_stroke").val(),
//             textColor: $("#text-layer text").attr("fill") // Egy p√©lda a sz√∂vegsz√≠nre
//         }
//     };
//     console.log("Saj√°t be√°ll√≠t√°sok elmentve!", userSavedState);
// }

// function restoreUserState() {
//     if (!userSavedState) return;

//     console.log("Saj√°t be√°ll√≠t√°sok vissza√°ll√≠t√°sa...");
    
//     // 1. Config vissza√°ll√≠t√°sa
//     myCelestialConf = JSON.parse(JSON.stringify(userSavedState.config));
//     if (myCelestialConf.projection != lastProjection) {
//         // changeProjection(myCelestialConf.projection);
//     }
//     else {
//       // Celestial.apply(myCelestialConf);
//     }
//         changeProjection(myCelestialConf.projection);
//     // Celestial.display(myCelestialConf);

//     // 2. H√°tt√©r vissza√°ll√≠t√°sa
//     $("#map-wrap").css("background", userSavedState.background);
//     $("#designer-svg").css("background", userSavedState.background);
    
//     const svgBgRect = document.getElementById('designer-background-rect');
//     if(svgBgRect) {
//          // Egyszer≈±s√≠t√©s: ha gradiens volt, lehet, hogy a config fill-j√©t kell haszn√°lni
//          svgBgRect.setAttribute('fill', userSavedState.config.background.fill);
//     }

//     // 3. Sz√∂vegek √©s Z√≥n√°k vissza√°ll√≠t√°sa
//     if (typeof zoneData !== 'undefined' && userSavedState.zoneData) {
//         // Glob√°lis zoneData fel√ºl√≠r√°sa
//         Object.assign(zoneData, JSON.parse(JSON.stringify(userSavedState.zoneData)));
        
//         if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
//         if(typeof renderZoneUI === 'function') { 
//             renderZoneUI('top'); 
//             renderZoneUI('bottom'); 
//         }
//     }
    
//     // 4. Inputok szinkroniz√°l√°sa
//     $("#background_fill").val(userSavedState.inputs.bgFill);
//     $("#background_stroke").val(userSavedState.inputs.bgStroke);
//     $("#projection_").val(myCelestialConf.projection);
    
//     // UI friss√≠t√©s (border lev√©tele mindenr≈ël, kiv√©ve a custom)
//     $('.theme-item').removeClass('active-theme');
//     $('#custom-theme-card').addClass('active-theme');
// }

// // --- 3. OKOS T√âMA BET√ñLT√âS (Normal vs Heart) ---
// let activeThemeKey = "custom";
// let isHeartMode = false;
// var lastProjection = "stereographic";
// function loadTheme(key, variant = 'normal') {
//     // HA ez az els≈ë t√©ma v√°lt√°s (m√©g custom m√≥dban vagyunk), ments√ºk el az √°llapotot!
//     if (activeThemeKey === 'custom') {
//         saveUserState();
//     }
//     console.log(`T√©ma bet√∂lt√©se: ${key} (${variant})`);
//     activeThemeKey = key;
//     isHeartMode = (variant === 'heart');

//     const theme = mapThemes[key];
//     if (!theme) return;

//     // A) Config kl√≥noz√°sa √©s m√≥dos√≠t√°sa
//     // Fontos: m√©ly m√°solatot k√©sz√≠t√ºnk, hogy ne √≠rjuk fel√ºl az alap t√©m√°t
//     let currentConfig = JSON.parse(JSON.stringify(theme.config));
    
//     // PROJEKCI√ì V√ÅLT√ÅS LOGIKA
//     if (isHeartMode) {
//         if (myCelestialConf.projection != "customHeart") {
//           lastProjection = myCelestialConf.projection;
//           currentConfig.projection = "customHeart"; // Sz√≠v alak
//           myCelestialConf.projection = "customHeart"; // Sz√≠v alak
//               // Celestial.reproject({projection: myCelestialConf.projection})
//           // Esetleg finomhangolhatjuk a sk√°l√°z√°st a sz√≠vhez
//           // currentConfig.width = getOptimalMapSize(); 
//           changeProjection(myCelestialConf.projection);
//         }
//     } else {
//         // Ha nincs sz√≠v, akkor alapvet≈ëen stereographic vagy amit a t√©ma akar
//         // currentConfig.projection = "stereographic"; 

//         if (myCelestialConf.projection != lastProjection) {
//           // lastProjection = myCelestialConf.projection;
//           currentConfig.projection = lastProjection; 
//           myCelestialConf.projection = lastProjection; // El≈ëz≈ë alak
//           // lastProjection = myCelestialConf.projection
//               // Celestial.reproject({projection: myCelestialConf.projection})
//           // currentConfig.width = getOptimalMapSize(); 
//           changeProjection(myCelestialConf.projection);
//         }
//         // Vagy ha a t√©ma defini√°lt saj√°t projekci√≥t, azt haszn√°ljuk:
//         // if (theme.config.projection) currentConfig.projection = theme.config.projection;
//     }

//     // B) Alkalmaz√°s
//     change(currentConfig);

//     // C) Inputok szinkroniz√°l√°sa (hogy a szerkeszt≈ëben j√≥ √©rt√©kek legyenek)
//     // $("#mw_style_show").val(currentConfig.mw.show);
//     $("#mw_show").prop('checked', currentConfig.mw.show).trigger('change');
//     $("#mw_style_fill").val(currentConfig.mw.style.fill);
//     $("#mw_style_opacity").val(currentConfig.mw.style.opacity);

//     $("#background_fill").val(currentConfig.background.fill);
//     $("#background_opacity").val(currentConfig.background.opacity);
//     $("#background_stroke").val(currentConfig.background.stroke);
//     $("#background_stroke_width").val(currentConfig.background.stroke.width);

//     $("#const_show").prop('checked', currentConfig.constellations.lines).trigger('change');
//     $("#constellation_lineStyle_opacity").val(currentConfig.constellations.lineStyle.opacity);
//     $("#constellation_lineStyle_stroke").val(currentConfig.constellations.lineStyle.stroke);
//     $("#constellation_lineStyle_stroke_width").val(currentConfig.constellations.lineStyle.width);

//     $("#stars_show").prop('checked', currentConfig.stars.show).trigger('change');
//     $("#stars_limit").val(currentConfig.stars.limit);
//     $("#stars_size").val(currentConfig.stars.size);
//     $("#stars_style_fill").val(currentConfig.stars.style.fill);
//     $("#stars_style_opacity").val(currentConfig.stars.style.opacity);

//     $("#lines_graticule").prop('checked', currentConfig.lines.graticule.show).trigger('change');
//     $("#lines_graticule_color").val(currentConfig.lines.graticule.stroke);
//     $("#lines_graticule_size").val(currentConfig.lines.graticule.width);
//     $("#lines_graticule_opacity").val(currentConfig.lines.graticule.opacity);
//     // $("#lines_graticule").is(':checked');
//     // ... t√∂bbi input ...
//     // mw_style_fill
//     // mw_style_opacity
//     // D) H√°tt√©r be√°ll√≠t√°sa
//     $("#map-wrap").css("background", theme.background);
//     $("#designer-svg").css("background", theme.background);
//   // lines: {
//     // graticule: { show: true, stroke: "#cccccc", width: 0.6, opacity: 0.8,      // Show graticule lines 
//                     // lines: { graticule: { show: true, stroke: "#064e3b", opacity: 0.5 } },
    
//     // Export h√°tt√©r be√°ll√≠t√°sa
//     const svgBgRect = document.getElementById('designer-background-rect');
//     if(svgBgRect) {
//         svgBgRect.setAttribute('fill', theme.background.startsWith('#') ? theme.background : currentConfig.background.fill);
//     }

//     // E) Sz√∂vegsz√≠n friss√≠t√©se (Ez nem √≠rja fel√ºl a sz√∂veget, csak a sz√≠n√©t!)
//     if(theme.textColor && typeof zoneData !== 'undefined') {
//         ['top', 'bottom'].forEach(zone => {
//             zoneData[zone].blocks.forEach(block => block.color = theme.textColor);
//         });
//         if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
//         if(typeof renderZoneUI === 'function') { renderZoneUI('top'); renderZoneUI('bottom'); }
//     }

//     // F) Projekci√≥ select friss√≠t√©se a UI-n
//     $("#projection_").val(currentConfig.projection);

//     // G) Kijel√∂l√©s kezel√©se (Keret)
//     $('.theme-item').removeClass('active-theme');
//     // Megkeress√ºk a megfelel≈ë k√°rty√°t (key + variant alapj√°n)
//     const activeCard = document.querySelector(`.theme-btn[data-key="${key}"][data-variant="${variant}"]`).closest('.theme-item');
//     if (activeCard) activeCard.classList.add('active-theme');

//     // H) √öjrarajzol√°s √©s Igaz√≠t√°s
//     setTimeout(function() {
//         Celestial.redraw();
//         // Ha sz√≠v alak√∫, akkor igaz√≠tani kell a poz√≠ci√≥n
//         if (isHeartMode) {
//              // Itt h√≠vhatjuk meg a kor√°bbi igaz√≠t√≥ logik√°t, ha sz√ºks√©ges
//              // window.refreshMapTransform(); 
//         }
//     }, 50);
// }


// // --- 4. T√âMAV√ÅLASZT√ì GENER√ÅL√ÅSA (Jav√≠tott) ---
// function initThemeSelectors() {
//     const containers = ['theme-grid-container', 'designer-templates-grid'];
    
//     containers.forEach(containerId => {
//         const container = document.getElementById(containerId);
//         if (!container) return;
        
//         container.innerHTML = ''; // T√∂rl√©s

//         // 1. "SAJ√ÅT BE√ÅLL√çT√ÅSOK" (CUSTOM) K√ÅRTYA HOZZ√ÅAD√ÅSA
//         const customCard = document.createElement('div');
//         customCard.className = 'theme-item active-theme'; // Alapb√≥l ez akt√≠v
//         customCard.id = 'custom-theme-card';
//         customCard.style.cursor = "pointer";
//         customCard.style.background = "#fff";
//         customCard.onclick = function(e) { e.preventDefault(); restoreUserState(); };

//         customCard.innerHTML = `
//             <div style="padding:10px; text-align:center; font-weight:bold; background:#eee; color:#333; border-bottom:1px solid #ddd;">
//                 Saj√°t / Vissza
//             </div>
//             <div style="height:120px; display:flex; align-items:center; justify-content:center; background:#f9f9f9; color:#666; font-size:40px;">
//                 ‚Ü∫
//             </div>
//             <div style="padding:5px; font-size:10px; text-align:center; color:#888;">
//                 Vissza a szerkesztett √°llapothoz
//             </div>
//         `;
//         container.appendChild(customCard);


//         // 2. T√âM√ÅK LIST√ÅZ√ÅSA (Dupl√°zva: Norm√°l √©s Sz√≠v)
//         for (const [key, theme] of Object.entries(mapThemes)) {
            
//             // --- A) NORM√ÅL VERZI√ì ---
//             createThemeCard(container, key, theme, 'normal');

//             // --- B) SZ√çV ALAK√ö VERZI√ì ---
//             createThemeCard(container, key, theme, 'heart');
//         }
//     });
// }
// // --- 2. SAJ√ÅT BE√ÅLL√çT√ÅSOK MENT√âSE (OBJECTBE) ---
// let userSavedState = null;
// let activeThemeKey = "custom"; // custom, midnight, ink, stb.
// let activeVariant = "normal"; // normal vagy heart

// function saveUserState() {
//     // Csak akkor ments√ºnk, ha m√©g nem sablont n√©z√ºnk, VAGY ha a felhaszn√°l√≥ m√≥dos√≠tott valamit
//     // Egyszer≈±s√≠tve: ha a "Custom" √°llapotban vagyunk.
//     if (activeThemeKey !== 'custom') return;

//     userSavedState = {
//         // Celestial config m√©ly m√°solata
//         config: JSON.parse(JSON.stringify(myCelestialConf)),
        
//         // H√°tt√©r √©s egy√©b UI √°llapotok
//         background: $("#background_fill").val(), // A szerkeszt≈ëb≈ël olvassuk ki a legbiztosabb
        
//         // Sz√∂vegek √°llapota (zoneData)
//         zoneData: (typeof zoneData !== 'undefined') ? JSON.parse(JSON.stringify(zoneData)) : null,
        
//         // Sz√∂vegsz√≠n (p√©ld√°ul az els≈ë sz√∂vegblokkb√≥l)
//         textColor: (typeof zoneData !== 'undefined' && zoneData.top.blocks.length > 0) 
//                    ? zoneData.top.blocks[0].color 
//                    : "#ffffff"
//     };
//     console.log("Saj√°t be√°ll√≠t√°sok elmentve:", userSavedState);
// }

// function restoreUserState() {
//     if (!userSavedState) {
//         alert("Nincs elmentett saj√°t be√°ll√≠t√°s!");
//         return;
//     }

//     console.log("restoreUserState Saj√°t be√°ll√≠t√°sok vissza√°ll√≠t√°sa...");
//     activeThemeKey = "custom";
//     activeVariant = "normal";

//     console.log("restoreUserState myCelestialConf JSON.parse el≈ëtt", myCelestialConf);
//     console.log("restoreUserState userSavedState.config JSON.parse ut√°n", userSavedState.config);
//     // 1. Config vissza√°ll√≠t√°sa
//     myCelestialConf = JSON.parse(JSON.stringify(userSavedState.config));
    
//     console.log("restoreUserState myCelestialConf JSON.parse ut√°n", myCelestialConf);
//     // Vet√ºlet kezel√©se: vissza a mentett vet√ºletre
//     changeProjection(myCelestialConf.projection);
    
//     // Egy√©b config √©rt√©kek alkalmaz√°sa (change helyett, mert a change merge-√∂l, de itt reset kell)
//     Celestial.apply(myCelestialConf);
//     $("#mw_show").prop('checked', myCelestialConf.mw.show).trigger('change');
//     $("#mw_style_fill").val(myCelestialConf.mw.style.fill);
//     $("#mw_style_opacity").val(myCelestialConf.mw.style.opacity);

//     $("#background_fill").val(myCelestialConf.background.fill);
//     $("#background_opacity").val(myCelestialConf.background.opacity);
//     $("#background_stroke").val(myCelestialConf.background.stroke);
//     $("#background_stroke_width").val(myCelestialConf.background.stroke.width);

//     $("#const_show").prop('checked', myCelestialConf.constellations.lines).trigger('change');
//     $("#constellation_lineStyle_opacity").val(myCelestialConf.constellations.lineStyle.opacity);
//     $("#constellation_lineStyle_stroke").val(myCelestialConf.constellations.lineStyle.stroke);
//     $("#constellation_lineStyle_stroke_width").val(myCelestialConf.constellations.lineStyle.width);

//     $("#stars_show").prop('checked', myCelestialConf.stars.show).trigger('change');
//     $("#stars_limit").val(myCelestialConf.stars.limit);
//     $("#stars_size").val(myCelestialConf.stars.size);
//     $("#stars_style_fill").val(myCelestialConf.stars.style.fill);
//     $("#stars_style_opacity").val(myCelestialConf.stars.style.opacity);

//     $("#lines_graticule").prop('checked', myCelestialConf.lines.graticule.show).trigger('change');
//     $("#lines_graticule_color").val(myCelestialConf.lines.graticule.stroke);
//     $("#lines_graticule_size").val(myCelestialConf.lines.graticule.width);
//     $("#lines_graticule_opacity").val(myCelestialConf.lines.graticule.opacity);
//     // 2. H√°tt√©r vissza√°ll√≠t√°sa
//     // Fontos: a updateCanvasBackground h√≠v√°sa friss√≠ti a rect-et is!
//     if (window.updateCanvasBackground) {
//         window.updateCanvasBackground(userSavedState.background);
//     }
//     // Input friss√≠t√©se
//     $("#background_fill").val(userSavedState.background);

//     // 3. Sz√∂vegek √©s Z√≥n√°k vissza√°ll√≠t√°sa
//     if (typeof zoneData !== 'undefined' && userSavedState.zoneData) {
//         Object.assign(zoneData, JSON.parse(JSON.stringify(userSavedState.zoneData)));
        
//         if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
//         if(typeof renderZoneUI === 'function') { 
//             renderZoneUI('top'); 
//             renderZoneUI('bottom'); 
//         }
//     }
    
//     // UI Keret friss√≠t√©se
//     $('.theme-item').removeClass('active-theme');
//     $('#custom-theme-card').addClass('active-theme');
// }

// // --- 3. OKOS T√âMA BET√ñLT√âS (PROJEKCI√ì V√ÅLT√ÅSSAL) ---
// function loadTheme(key, variant = 'normal') {
//     // Ha eddig Custom m√≥dban voltunk, ments√ºk el az √°llapotot, miel≈ëtt fel√ºl√≠rjuk!
//     if (activeThemeKey === 'custom') {
//         saveUserState();
//     }

//     console.log(`T√©ma bet√∂lt√©se: ${key}, Verzi√≥: ${variant}`);
//     activeThemeKey = key;
//     activeVariant = variant;
    
//     const theme = mapThemes[key];
//     if (!theme) return;

//     // A) Config m√°sol√°sa
//     let currentConfig = JSON.parse(JSON.stringify(theme.config));
    
//     // B) PROJEKCI√ì BE√ÅLL√çT√ÅSA A VERZI√ì ALAPJ√ÅN
//     if (variant === 'heart') {
//         currentConfig.projection = "customHeart"; // A te sz√≠v vet√ºleted
//     } else {
//         // Ha sima verzi√≥, akkor sztereografikus (vagy amit a t√©ma alapb√≥l akarna)
//         currentConfig.projection = "stereographic";
//     }

//     console.log("loadTheme currentConfig", currentConfig);
//     // C) Alkalmaz√°s a Celestialra
//     change(currentConfig);
//     // K√©nyszer√≠tett projekci√≥ friss√≠t√©s (hogy a m√©retez√©s is fusson)
//     changeProjection(currentConfig.projection);

//     // D) Input mez≈ëk friss√≠t√©se (hogy a szerkeszt≈ëben l√°tsz√≥djon)
//     // $("#background_fill").val(currentConfig.background.fill);
//     // $("#background_stroke").val(currentConfig.background.stroke);
//     // $("#stars_style_fill").val(currentConfig.stars.style.fill);
//     // ... tov√°bbi mez≈ëk szinkroniz√°l√°sa sz√ºks√©g szerint ...


//     // C) Inputok szinkroniz√°l√°sa (hogy a szerkeszt≈ëben j√≥ √©rt√©kek legyenek)
//     // $("#mw_style_show").val(currentConfig.mw.show);
//     $("#mw_show").prop('checked', currentConfig.mw.show).trigger('change');
//     $("#mw_style_fill").val(currentConfig.mw.style.fill);
//     $("#mw_style_opacity").val(currentConfig.mw.style.opacity);

//     $("#background_fill").val(currentConfig.background.fill);
//     $("#background_opacity").val(currentConfig.background.opacity);
//     $("#background_stroke").val(currentConfig.background.stroke);
//     $("#background_stroke_width").val(currentConfig.background.stroke.width);

//     $("#const_show").prop('checked', currentConfig.constellations.lines).trigger('change');
//     $("#constellation_lineStyle_opacity").val(currentConfig.constellations.lineStyle.opacity);
//     $("#constellation_lineStyle_stroke").val(currentConfig.constellations.lineStyle.stroke);
//     $("#constellation_lineStyle_stroke_width").val(currentConfig.constellations.lineStyle.width);

//     $("#stars_show").prop('checked', currentConfig.stars.show).trigger('change');
//     $("#stars_limit").val(currentConfig.stars.limit);
//     $("#stars_size").val(currentConfig.stars.size);
//     $("#stars_style_fill").val(currentConfig.stars.style.fill);
//     $("#stars_style_opacity").val(currentConfig.stars.style.opacity);

//     $("#lines_graticule").prop('checked', currentConfig.lines.graticule.show).trigger('change');
//     $("#lines_graticule_color").val(currentConfig.lines.graticule.stroke);
//     $("#lines_graticule_size").val(currentConfig.lines.graticule.width);
//     $("#lines_graticule_opacity").val(currentConfig.lines.graticule.opacity);
//     // $("#lines_graticule").is(':checked');
//     // ... t√∂bbi input ...
//     // mw_style_fill
//     // mw_style_opacity
//     // D) H√°tt√©r be√°ll√≠t√°sa
//     // $("#map-wrap").css("background", theme.background);
//     // $("#designer-svg").css("background", theme.background);



//     // E) H√°tt√©rsz√≠n be√°ll√≠t√°sa (Jav√≠tott f√ºggv√©nnyel)
//     if (window.updateCanvasBackground) {
//         // Ha gradiens a h√°tt√©r, azt a rect fill nem biztos hogy megeszi.
//         // Itt egyszer≈±s√≠t√ºnk: ha hex k√≥d, mehet a rect-be.
//         // Ha gradiens, akkor a rect-et elt√ºntethetj√ºk vagy √°tlagolhatunk.
//         // Most felt√©telezz√ºk, hogy a theme.background egy sz√≠nk√≥d vagy gradiens.
        
//         if (theme.background.includes("gradient")) {
//             // Ha gradiens, akkor a #designer-svg style-j√°ba tessz√ºk
//             $("#designer-svg").css("background", theme.background);
//             // A rect-et √°tl√°tsz√≥ra vagy az els≈ë sz√≠nre √°ll√≠tjuk export√°l√°shoz
//             // (Exportn√°l a gradiens bonyolultabb, most maradjunk a megjelen√≠t√©sn√©l)
//         } else {
//             window.updateCanvasBackground(theme.background);
//         }
//     }

//     // F) Sz√∂vegsz√≠nek friss√≠t√©se
//     if(theme.textColor && typeof zoneData !== 'undefined') {
//         ['top', 'bottom'].forEach(zone => {
//             zoneData[zone].blocks.forEach(block => block.color = theme.textColor);
//         });
//         window.renderFixedTexts();
//         renderZoneUI('top'); renderZoneUI('bottom');
//     }

//     // G) Kijel√∂l√©s vizu√°lis friss√≠t√©se
//     $('.theme-item').removeClass('active-theme');
//     // Megkeress√ºk a gombot, √©s a sz√ºl≈ë k√°rty√°j√°t jel√∂lj√ºk ki
//     const activeBtn = document.querySelector(`.theme-btn[data-key="${key}"][data-variant="${variant}"]`);
//     if (activeBtn) {
//         activeBtn.closest('.theme-item').classList.add('active-theme');
//     }
// }
// --- 2. SAJ√ÅT BE√ÅLL√çT√ÅSOK MENT√âSE (OBJECTBE) ---
        let userSavedState = null;
        let activeThemeKey = "custom"; 
        let activeVariant = "normal"; 

        function saveUserState() {
            if (activeThemeKey !== 'custom') return;

            userSavedState = {
                config: JSON.parse(JSON.stringify(myCelestialConf)),
                background: $("#background_fill").val(), 
                zoneData: (typeof zoneData !== 'undefined') ? JSON.parse(JSON.stringify(zoneData)) : null,
                textColor: (typeof zoneData !== 'undefined' && zoneData.top.blocks.length > 0) 
                        ? zoneData.top.blocks[0].color 
                        : "#ffffff"
            };
            console.log("Saj√°t be√°ll√≠t√°sok elmentve:", userSavedState);
        }

        // // --- JAV√çTOTT VISSZA√ÅLL√çT√ÅS (UI FRISS√çT√âSSEL) ---
        // function restoreUserState() {
        //     if (!userSavedState) {
        //         alert("Nincs elmentett saj√°t be√°ll√≠t√°s!");
        //         return;
        //     }

        //     console.log("Saj√°t be√°ll√≠t√°sok vissza√°ll√≠t√°sa...");
        //     activeThemeKey = "custom";
        //     activeVariant = "normal";

        //     // 1. Config vissza√°ll√≠t√°sa
        //     myCelestialConf = JSON.parse(JSON.stringify(userSavedState.config));
            
        //     // 2. UI INPUTOK SZINKRONIZ√ÅL√ÅSA (Ez hi√°nyzott!)
        //     // Tej√∫t
        //     $("#mw_style_fill").val(myCelestialConf.mw.style.fill);
        //     $("#mw_style_opacity").val(myCelestialConf.mw.style.opacity);
        //     $("#mw_show").prop('checked', myCelestialConf.mw.show);
        //     if(myCelestialConf.mw.show) $("#mw_show_settings").slideDown(); else $("#mw_show_settings").slideUp();

        //     // H√°tt√©r
        //     $("#background_fill").val(myCelestialConf.background.fill);
        //     $("#background_opacity").val(myCelestialConf.background.opacity);
        //     $("#background_stroke").val(myCelestialConf.background.stroke);
        //     $("#background_stroke_width").val(myCelestialConf.background.width);

        //     // Csillagk√©pek
        //     $("#constellation_lineStyle_stroke").val(myCelestialConf.constellations.lineStyle.stroke);
        //     $("#constellation_lineStyle_opacity").val(myCelestialConf.constellations.lineStyle.opacity);
        //     $("#constellation_lineStyle_stroke_width").val(myCelestialConf.constellations.lineStyle.width);
        //     $("#const_show").prop('checked', myCelestialConf.constellations.lines);
        //     if(myCelestialConf.constellations.lines) $("#const_show_settings").slideDown(); else $("#const_show_settings").slideUp();

        //     // Csillagok
        //     $("#stars_limit").val(myCelestialConf.stars.limit);
        //     $("#stars_size").val(myCelestialConf.stars.size);
        //     $("#stars_style_fill").val(myCelestialConf.stars.style.fill);
        //     $("#stars_style_opacity").val(myCelestialConf.stars.style.opacity);
        //     $("#stars_show").prop('checked', myCelestialConf.stars.show);
        //     if(myCelestialConf.stars.show) $("#stars_show_settings").slideDown(); else $("#stars_show_settings").slideUp();

        //     // R√°cs (Graticule) - Ez volt a f≈ë hibaforr√°s
        //     $("#lines_graticule_color").val(myCelestialConf.lines.graticule.stroke);
        //     $("#lines_graticule_size").val(myCelestialConf.lines.graticule.width);
        //     $("#lines_graticule_opacity").val(myCelestialConf.lines.graticule.opacity);
        //     $("#lines_graticule").prop('checked', myCelestialConf.lines.graticule.show);
        //     // Nem h√≠vunk trigger('change')-et, mert az √∫jra megh√≠vn√° a change()-et, 
        //     // de a change()-et most k√©zzel h√≠vjuk a pontos configgal.

        //     // 3. Alkalmaz√°s a t√©rk√©pre
        //     change(myCelestialConf);
        //     changeProjection(myCelestialConf.projection);
            
        //     // 4. H√°tt√©rsz√≠n (Rect) vissza√°ll√≠t√°sa
        //     if (window.updateCanvasBackground) {
        //         window.updateCanvasBackground(userSavedState.background);
        //     }

        //     // 5. Sz√∂vegek vissza√°ll√≠t√°sa
        //     if (typeof zoneData !== 'undefined' && userSavedState.zoneData) {
        //         Object.assign(zoneData, JSON.parse(JSON.stringify(userSavedState.zoneData)));
        //         if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
        //         if(typeof renderZoneUI === 'function') { 
        //             renderZoneUI('top'); 
        //             renderZoneUI('bottom'); 
        //         }
        //     }
            
        //     // UI Keret friss√≠t√©se
        //     $('.theme-item').removeClass('active-theme');
        //     $('#custom-theme-card').addClass('active-theme');
        // }

        // // --- JAV√çTOTT T√âMA BET√ñLT√âS (HELYES SORRENDBEN) ---
        // function loadTheme(key, variant = 'normal') {
        //     if (activeThemeKey === 'custom') {
        //         saveUserState();
        //     }

        //     console.log(`T√©ma bet√∂lt√©se: ${key}, Verzi√≥: ${variant}`);
        //     activeThemeKey = key;
        //     activeVariant = variant;
            
        //     const theme = mapThemes[key];
        //     if (!theme) return;

        //     // A) Config m√°sol√°sa
        //     let currentConfig = JSON.parse(JSON.stringify(theme.config));
            
        //     if (variant === 'heart') {
        //         currentConfig.projection = "customHeart"; 
        //     } else {
        //         currentConfig.projection = "stereographic";
        //     }

        //     // B) INPUTOK FRISS√çT√âSE EL≈êSZ√ñR! (Fontos a sorrend!)
        //     // El≈ëbb be√≠rjuk az √©rt√©keket, hogy ha a checkbox triggerel, m√°r a j√≥t olvassa ki.
            
        //     // Tej√∫t
        //     $("#mw_style_fill").val(currentConfig.mw.style.fill);
        //     $("#mw_style_opacity").val(currentConfig.mw.style.opacity);
            
        //     // H√°tt√©r
        //     $("#background_fill").val(currentConfig.background.fill);
        //     $("#background_opacity").val(currentConfig.background.opacity);
        //     $("#background_stroke").val(currentConfig.background.stroke);
        //     $("#background_stroke_width").val(currentConfig.background.width); // Note: check structure if width is nested

        //     // Csillagk√©pek
        //     $("#constellation_lineStyle_stroke").val(currentConfig.constellations.lineStyle.stroke);
        //     $("#constellation_lineStyle_opacity").val(currentConfig.constellations.lineStyle.opacity);
        //     $("#constellation_lineStyle_stroke_width").val(currentConfig.constellations.lineStyle.width);

        //     // Csillagok
        //     $("#stars_limit").val(currentConfig.stars.limit);
        //     $("#stars_size").val(currentConfig.stars.size);
        //     $("#stars_style_fill").val(currentConfig.stars.style.fill);
        //     $("#stars_style_opacity").val(currentConfig.stars.style.opacity);

        //     // R√°cs (Graticule)
        //     $("#lines_graticule_color").val(currentConfig.lines.graticule.stroke);
        //     $("#lines_graticule_size").val(currentConfig.lines.graticule.width);
        //     $("#lines_graticule_opacity").val(currentConfig.lines.graticule.opacity);

        //     // C) Checkboxok triggerel√©se (hogy a panelek ny√≠ljanak/csuk√≥djanak)
        //     // Most m√°r biztons√°gos, mert az inputokban az √öJ √©rt√©k van.
            
        //     // UI seg√©df√ºggv√©ny a slide-hoz (hogy ne kelljen triggerelni a change-et, ha nem akarjuk)
        //     const toggleSection = (id, show) => {
        //         if(show) $(id).slideDown(); else $(id).slideUp();
        //     };

        //     $("#mw_show").prop('checked', currentConfig.mw.show);
        //     toggleSection("#mw_show_settings", currentConfig.mw.show);

        //     $("#const_show").prop('checked', currentConfig.constellations.lines);
        //     toggleSection("#const_show_settings", currentConfig.constellations.lines);

        //     $("#stars_show").prop('checked', currentConfig.stars.show);
        //     toggleSection("#stars_show_settings", currentConfig.stars.show);

        //     $("#lines_graticule").prop('checked', currentConfig.lines.graticule.show);
        //     // Graticule-nek nincs k√ºl√∂n slide panelje ebben a k√≥dban, de a checkbox √°llapot√°t be√°ll√≠tottuk.

        //     // D) T√âRK√âP FRISS√çT√âSE (MINDEN FEL√úL√çR√ÅSA A T√âM√ÅVAL)
        //     // A change() h√≠v√°st a v√©g√©re hagyjuk, hogy ez legyen a d√∂nt≈ë sz√≥.
        //     change(currentConfig);
        //     changeProjection(currentConfig.projection);

        //     // E) H√°tt√©rsz√≠n vizu√°lis be√°ll√≠t√°sa
        //     if (window.updateCanvasBackground) {
        //         if (theme.background.includes("gradient")) {
        //             $("#designer-svg").css("background", theme.background);
        //         } else {
        //             window.updateCanvasBackground(theme.background);
        //         }
        //     }

        //     // F) Sz√∂vegsz√≠nek
        //     if(theme.textColor && typeof zoneData !== 'undefined') {
        //         ['top', 'bottom'].forEach(zone => {
        //             zoneData[zone].blocks.forEach(block => block.color = theme.textColor);
        //         });
        //         window.renderFixedTexts();
        //         renderZoneUI('top'); renderZoneUI('bottom');
        //     }

        //     // G) Kijel√∂l√©s
        //     $('.theme-item').removeClass('active-theme');
        //     const activeBtn = document.querySelector(`.theme-btn[data-key="${key}"][data-variant="${variant}"]`);
        //     if (activeBtn) {
        //         activeBtn.closest('.theme-item').classList.add('active-theme');
        //     }
        // }
        // --- JAV√çTOTT VISSZA√ÅLL√çT√ÅS (H√ÅTT√âRREL EGY√úTT) ---
        function restoreUserState() {
            if (!userSavedState) {
                alert("Nincs elmentett saj√°t be√°ll√≠t√°s!");
                return;
            }

            console.log("Saj√°t be√°ll√≠t√°sok vissza√°ll√≠t√°sa...");
            activeThemeKey = "custom";
            activeVariant = "normal";

            // 1. Config vissza√°ll√≠t√°sa
            myCelestialConf = JSON.parse(JSON.stringify(userSavedState.config));
            
            // 2. UI INPUTOK SZINKRONIZ√ÅL√ÅSA
            // Tej√∫t
            $("#mw_style_fill").val(myCelestialConf.mw.style.fill);
            $("#mw_style_opacity").val(myCelestialConf.mw.style.opacity);
            $("#mw_show").prop('checked', myCelestialConf.mw.show);
            if(myCelestialConf.mw.show) $("#mw_show_settings").slideDown(); else $("#mw_show_settings").slideUp();

            // H√°tt√©r INPUTOK
            $("#background_fill").val(myCelestialConf.background.fill);
            $("#background_opacity").val(myCelestialConf.background.opacity);
            $("#background_stroke").val(myCelestialConf.background.stroke);
            $("#background_stroke_width").val(myCelestialConf.background.width);

            // Csillagk√©pek
            $("#constellation_lineStyle_stroke").val(myCelestialConf.constellations.lineStyle.stroke);
            $("#constellation_lineStyle_opacity").val(myCelestialConf.constellations.lineStyle.opacity);
            $("#constellation_lineStyle_stroke_width").val(myCelestialConf.constellations.lineStyle.width);
            $("#const_show").prop('checked', myCelestialConf.constellations.lines);
            if(myCelestialConf.constellations.lines) $("#const_show_settings").slideDown(); else $("#const_show_settings").slideUp();

            // Csillagok
            $("#stars_limit").val(myCelestialConf.stars.limit);
            $("#stars_size").val(myCelestialConf.stars.size);
            $("#stars_style_fill").val(myCelestialConf.stars.style.fill);
            $("#stars_style_opacity").val(myCelestialConf.stars.style.opacity);
            $("#stars_show").prop('checked', myCelestialConf.stars.show);
            if(myCelestialConf.stars.show) $("#stars_show_settings").slideDown(); else $("#stars_show_settings").slideUp();

            // R√°cs
            $("#lines_graticule_color").val(myCelestialConf.lines.graticule.stroke);
            $("#lines_graticule_size").val(myCelestialConf.lines.graticule.width);
            $("#lines_graticule_opacity").val(myCelestialConf.lines.graticule.opacity);
            $("#lines_graticule").prop('checked', myCelestialConf.lines.graticule.show);

            // 3. Alkalmaz√°s a t√©rk√©pre
            change(myCelestialConf);
            changeProjection(myCelestialConf.projection);
            
            // 4. H√ÅTT√âR VISSZA√ÅLL√çT√ÅSA (CSS + Rect)
            // Ez a r√©sz kezeli a szerkeszt≈ë (#map-wrap) √©s a tervez≈ë (#designer-svg) h√°tter√©t is
            if (userSavedState.background) {
                $("#map-wrap").css("background", userSavedState.background);
                $("#designer-svg").css("background", userSavedState.background);
                
                // Export rect kezel√©se
                if (window.updateCanvasBackground) {
                    window.updateCanvasBackground(userSavedState.background);
                }
            }

            // 5. Sz√∂vegek vissza√°ll√≠t√°sa
            if (typeof zoneData !== 'undefined' && userSavedState.zoneData) {
                Object.assign(zoneData, JSON.parse(JSON.stringify(userSavedState.zoneData)));
                if(typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                if(typeof renderZoneUI === 'function') { 
                    renderZoneUI('top'); 
                    renderZoneUI('bottom'); 
                }
            }
            
            $('.theme-item').removeClass('active-theme');
            $('#custom-theme-card').addClass('active-theme');
        }

        // // --- JAV√çTOTT T√âMA BET√ñLT√âS (H√ÅTT√âR KEZEL√âSSEL) ---
        // function loadTheme(key, variant = 'normal') {
        //     if (activeThemeKey === 'custom') {
        //         saveUserState();
        //     }

        //     console.log(`T√©ma bet√∂lt√©se: ${key}, Verzi√≥: ${variant}`);
        //     activeThemeKey = key;
        //     activeVariant = variant;
            
        //     const theme = mapThemes[key];
        //     if (!theme) return;

        //     let currentConfig = JSON.parse(JSON.stringify(theme.config));
            
        //     if (variant === 'heart') {
        //         currentConfig.projection = "customHeart"; 
        //     } else {
        //         currentConfig.projection = "stereographic";
        //     }

        //     // B) INPUTOK FRISS√çT√âSE
        //     $("#mw_style_fill").val(currentConfig.mw.style.fill);
        //     $("#mw_style_opacity").val(currentConfig.mw.style.opacity);
            
        //     $("#background_fill").val(currentConfig.background.fill);
        //     $("#background_opacity").val(currentConfig.background.opacity);
        //     $("#background_stroke").val(currentConfig.background.stroke);
        //     $("#background_stroke_width").val(currentConfig.background.width);

        //     $("#constellation_lineStyle_stroke").val(currentConfig.constellations.lineStyle.stroke);
        //     $("#constellation_lineStyle_opacity").val(currentConfig.constellations.lineStyle.opacity);
        //     $("#constellation_lineStyle_stroke_width").val(currentConfig.constellations.lineStyle.width);

        //     $("#stars_limit").val(currentConfig.stars.limit);
        //     $("#stars_size").val(currentConfig.stars.size);
        //     $("#stars_style_fill").val(currentConfig.stars.style.fill);
        //     $("#stars_style_opacity").val(currentConfig.stars.style.opacity);

        //     $("#lines_graticule_color").val(currentConfig.lines.graticule.stroke);
        //     $("#lines_graticule_size").val(currentConfig.lines.graticule.width);
        //     $("#lines_graticule_opacity").val(currentConfig.lines.graticule.opacity);

        //     // C) Checkboxok
        //     const toggleSection = (id, show) => { if(show) $(id).slideDown(); else $(id).slideUp(); };

        //     $("#mw_show").prop('checked', currentConfig.mw.show);
        //     toggleSection("#mw_show_settings", currentConfig.mw.show);

        //     $("#const_show").prop('checked', currentConfig.constellations.lines);
        //     toggleSection("#const_show_settings", currentConfig.constellations.lines);

        //     $("#stars_show").prop('checked', currentConfig.stars.show);
        //     toggleSection("#stars_show_settings", currentConfig.stars.show);

        //     $("#lines_graticule").prop('checked', currentConfig.lines.graticule.show);

        //     // D) H√ÅTT√âR FRISS√çT√âSE (MINDENHOL)
        //     // 1. Szerkeszt≈ë n√©zet (#map-wrap) - CSS-t haszn√°lunk a gradiens miatt!
        //     $("#map-wrap").css("background", theme.background);

        //     // 2. Tervez≈ë n√©zet (#designer-svg) - Szint√©n CSS
        //     $("#designer-svg").css("background", theme.background);

        //     // 3. Export h√°tt√©r (rect)
        //     const svgBgRect = document.getElementById('designer-background-rect');
        //     if(svgBgRect) {
        //         if(theme.background.includes('gradient')) {
        //              // SVG rect fill nem szereti a CSS gradienst. 
        //              // Ideiglenesen a t√©ma alapsz√≠n√©t (fill) adjuk neki, vagy feket√©t.
        //              // (Az exportCanvas f√ºggv√©ny majd megoldja a gradienst a canvas-ra rajzol√°skor)
        //              svgBgRect.setAttribute('fill', currentConfig.background.fill);
        //         } else {
        //              svgBgRect.setAttribute('fill', theme.background);
        //         }
        //     }

        //     // E) T√âRK√âP FRISS√çT√âSE
        //     change(currentConfig);
        //     changeProjection(currentConfig.projection);

        //     // F) Sz√∂vegsz√≠nek
        //     if(theme.textColor && typeof zoneData !== 'undefined') {
        //         ['top', 'bottom'].forEach(zone => {
        //             zoneData[zone].blocks.forEach(block => block.color = theme.textColor);
        //         });
        //         window.renderFixedTexts();
        //         renderZoneUI('top'); renderZoneUI('bottom');
        //     }

        //     // G) Kijel√∂l√©s
        //     $('.theme-item').removeClass('active-theme');
        //     const activeBtn = document.querySelector(`.theme-btn[data-key="${key}"][data-variant="${variant}"]`);
        //     if (activeBtn) {
        //         activeBtn.closest('.theme-item').classList.add('active-theme');
        //     }
            
        //     // H) Tervez≈ë transzform√°ci√≥ friss√≠t√©se (ha nyitva van)
        //     if(typeof window.refreshMapTransform === 'function') {
        //         window.refreshMapTransform();
        //     }
        // }
        // --- JAV√çTOTT T√âMA BET√ñLT√âS (H√ÅTT√âR KEZEL√âSSEL) ---
        function loadTheme(key, variant = 'normal') {
            if (activeThemeKey === 'custom') {
                saveUserState();
            }

            console.log(`T√©ma bet√∂lt√©se: ${key}, Verzi√≥: ${variant}`);
            activeThemeKey = key;
            activeVariant = variant;
            
            const theme = mapThemes[key];
            if (!theme) return;

            let currentConfig = JSON.parse(JSON.stringify(theme.config));
            
            // Projekci√≥ be√°ll√≠t√°sa
            if (variant === 'heart') {
                currentConfig.projection = "customHeart"; 
            } else {
                currentConfig.projection = "stereographic";
            }

            // A) H√ÅTT√âR FRISS√çT√âSE (MINDENHOL) - EZ A JAV√çT√ÅS A #map-wrap-HEZ!
            // 1. Szerkeszt≈ë n√©zet (#map-wrap) - CSS-t haszn√°lunk a gradiens miatt!
            // $("#map-wrap").css("background", theme.background);

            // 2. Tervez≈ë n√©zet (#designer-svg) - Szint√©n CSS
            // $("#designer-svg").css("background", theme.background);
            // A) H√ÅTT√âR FRISS√çT√âSE (MINDENHOL)
            $("#map-wrap").css("background", theme.background);
            $("#designer-svg").css("background", theme.background);

            // √öJ: Input mez≈ë szinkroniz√°l√°sa itt is!
            // Mivel a theme.background lehet gradiens, a getHexFromBackground logik√°t itt is alkalmazzuk 
            // vagy egyszer≈± regex-el.
            const colorInput = document.getElementById('canvas-bg-color');
            if (colorInput) {
                let hex = "#000000";
                if (theme.background.startsWith("#")) hex = theme.background;
                else {
                    const match = theme.background.match(/#[a-fA-F0-9]{6}/);
                    if (match) hex = match[0];
                }
                colorInput.value = hex;
            }

            // 3. Export h√°tt√©r (rect) - Ez csak a sz√≠nt kapja meg, a gradienst az export√°l√≥ kezeli
            const svgBgRect = document.getElementById('designer-background-rect');
            if(svgBgRect) {
                if(theme.background.includes('gradient')) {
                     // SVG rect fill nem szereti a CSS gradienst. 
                     // Ideiglenesen a t√©ma alapsz√≠n√©t (fill) adjuk neki.
                     svgBgRect.setAttribute('fill', currentConfig.background.fill);
                } else {
                     svgBgRect.setAttribute('fill', theme.background);
                }
            }

            // B) INPUTOK FRISS√çT√âSE
            $("#mw_style_fill").val(currentConfig.mw.style.fill);
            $("#mw_style_opacity").val(currentConfig.mw.style.opacity);
            
            $("#background_fill").val(currentConfig.background.fill);
            $("#background_opacity").val(currentConfig.background.opacity);
            $("#background_stroke").val(currentConfig.background.stroke);
            $("#background_stroke_width").val(currentConfig.background.width);

            $("#constellation_lineStyle_stroke").val(currentConfig.constellations.lineStyle.stroke);
            $("#constellation_lineStyle_opacity").val(currentConfig.constellations.lineStyle.opacity);
            $("#constellation_lineStyle_stroke_width").val(currentConfig.constellations.lineStyle.width);

            $("#stars_limit").val(currentConfig.stars.limit);
            $("#stars_size").val(currentConfig.stars.size);
            $("#stars_style_fill").val(currentConfig.stars.style.fill);
            $("#stars_style_opacity").val(currentConfig.stars.style.opacity);

            $("#lines_graticule_color").val(currentConfig.lines.graticule.stroke);
            $("#lines_graticule_size").val(currentConfig.lines.graticule.width);
            $("#lines_graticule_opacity").val(currentConfig.lines.graticule.opacity);

            // C) Checkboxok kezel√©se
            const toggleSection = (id, show) => { if(show) $(id).slideDown(); else $(id).slideUp(); };

            $("#mw_show").prop('checked', currentConfig.mw.show);
            toggleSection("#mw_show_settings", currentConfig.mw.show);

            $("#const_show").prop('checked', currentConfig.constellations.lines);
            toggleSection("#const_show_settings", currentConfig.constellations.lines);

            $("#stars_show").prop('checked', currentConfig.stars.show);
            toggleSection("#stars_show_settings", currentConfig.stars.show);

            $("#lines_graticule").prop('checked', currentConfig.lines.graticule.show);

            // D) T√âRK√âP FRISS√çT√âSE
            change(currentConfig);
            changeProjection(currentConfig.projection);

            // E) Sz√∂vegsz√≠nek friss√≠t√©se
            if(theme.textColor && typeof zoneData !== 'undefined') {
                ['top', 'bottom'].forEach(zone => {
                    zoneData[zone].blocks.forEach(block => block.color = theme.textColor);
                });
                window.renderFixedTexts();
                renderZoneUI('top'); renderZoneUI('bottom');
            }

            // F) Kijel√∂l√©s kezel√©se
            $('.theme-item').removeClass('active-theme');
            const activeBtn = document.querySelector(`.theme-btn[data-key="${key}"][data-variant="${variant}"]`);
            if (activeBtn) {
                activeBtn.closest('.theme-item').classList.add('active-theme');
            }
            
            // G) Tervez≈ë transzform√°ci√≥ friss√≠t√©se (ha nyitva van)
            if(typeof window.refreshMapTransform === 'function') {
                window.refreshMapTransform();
            }
        }

// --- 4. T√âMA V√ÅLASZT√ì GENER√ÅL√ÅSA (CUSTOM + NORMAL + HEART) ---
function initThemeSelectors() {
    // const containers = ['theme-grid-container', 'designer-templates-grid'];
    const containers = ['theme-grid-container'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        container.innerHTML = ''; // T√∂rl√©s

        // 1. "SAJ√ÅT BE√ÅLL√çT√ÅSOK" K√ÅRTYA (Legels≈ë)
        const customCard = document.createElement('div');
        customCard.className = 'theme-item active-theme'; // Alapb√≥l akt√≠v
        customCard.id = 'custom-theme-card';
        customCard.onclick = function(e) { e.preventDefault(); restoreUserState(); };

        customCard.innerHTML = `
            <div style="background:#eee; color:#333; padding:10px; text-align:center; font-weight:bold; border-bottom:1px solid #ddd;">
                Saj√°t / Vissza
            </div>
            <div style="height:120px; display:flex; align-items:center; justify-content:center; background:#f9f9f9; font-size:40px; color:#666;">
                ‚Ü∫
            </div>
        `;
        container.appendChild(customCard);

        // 2. T√âM√ÅK LIST√ÅZ√ÅSA
        for (const [key, theme] of Object.entries(mapThemes)) {
            
            // --- A) NORM√ÅL K√ÅRTYA ---
            const normalCard = createCardHTML(key, theme, 'normal');
            container.appendChild(normalCard);

            // --- B) SZ√çV K√ÅRTYA ---
            const heartCard = createCardHTML(key, theme, 'heart');
            container.appendChild(heartCard);
        }
    });
}
function createCardHTML(key, theme, variant) {
    const isHeart = variant === 'heart';
    
    const card = document.createElement('div');
    card.className = 'theme-item';
    card.style.cursor = "pointer";
    
    // Fejl√©c (N√©v)
    const label = document.createElement('div');
    label.className = "theme-btn"; 
    label.dataset.key = key;
    label.dataset.variant = variant;
    
    // Sz√≠v ikon a n√©vhez, ha sz√≠v m√≥d
    label.innerText = isHeart ? `‚ô• ${theme.name}` : theme.name;
    
    // St√≠lusok
    label.style.background = isHeart ? "#ffebee" : "#fff"; // Halv√°ny r√≥zsasz√≠n a sz√≠vnek
    label.style.color = isHeart ? "#d81b60" : "#000";
    
    // K√©p (Preview)
    const preview = document.createElement('div');
    preview.className = 'theme-preview-img';
    
    // K√©p URL manipul√°ci√≥ a sz√≠v verzi√≥hoz
    let imgUrl = theme.image;
    if (isHeart && imgUrl) {
        // Felt√©telezz√ºk, hogy van _heart v√©g≈± k√©p, pl. thumb_midnight_heart.png
        // Ha nincs, a .replace nem rontja el, csak ha tal√°l .png-t
        imgUrl = imgUrl.replace('.png', '_heart.png'); 
    }
    
    if (imgUrl) {
        preview.style.backgroundImage = `url('${imgUrl}')`;
        // Fallback: h√°tt√©rsz√≠n + k√©p
        preview.style.background = `url('${imgUrl}') center/contain no-repeat, ${theme.background}`;
    } else {
        preview.style.background = theme.background;
    }

    card.appendChild(label);
    card.appendChild(preview);

    card.onclick = function() {
        loadTheme(key, variant);
    };

    return card;
}
// Seg√©df√ºggv√©ny a k√°rtya l√©trehoz√°s√°hoz
function createThemeCard(container, key, theme, variant) {
    const isHeart = (variant === 'heart');
    
    const card = document.createElement('div');
    card.className = 'theme-item';
    card.style.cursor = "pointer";
    card.style.background = "#fff";
    card.style.overflow = "hidden";
    card.style.borderRadius = "8px";
    card.style.border = "1px solid #ddd";

    // FEJL√âC
    const label = document.createElement('div');
    // Ha sz√≠v, tegy√ºnk jelet a n√©vhez
    label.innerText = isHeart ? `‚ô• ${theme.name}` : theme.name;
    label.className = "theme-btn"; 
    // T√°roljuk az adatokat a gombban a kiv√°laszt√°shoz
    label.dataset.key = key;       
    label.dataset.variant = variant;
    
    label.style.padding = "8px";
    label.style.textAlign = "center";
    label.style.fontSize = "13px";
    label.style.fontWeight = "bold";
    label.style.background = isHeart ? "#ffebee" : "#fff"; // Sz√≠vn√©l halv√°ny r√≥zsasz√≠n fejl√©c
    label.style.color = isHeart ? "#d81b60" : "#000";
    label.style.borderBottom = "1px solid #eee";

    // K√âP (Preview)
    const preview = document.createElement('div');
    preview.className = 'theme-preview-img';
    
    // K√©p URL logik√°ja:
    // Norm√°l: theme.image (pl. thumb_midnight.png)
    // Sz√≠v: theme.image cser√©lve (pl. thumb_midnight_heart.png)
    let imgUrl = theme.image;
    if (isHeart && imgUrl) {
        imgUrl = imgUrl.replace('.png', '_heart.png');
    }

    if (imgUrl) {
        // Background + K√©p
        preview.style.background = `url('${imgUrl}') center/contain no-repeat, ${theme.background}`;
    } else {
        preview.style.background = theme.background; 
    }

    preview.style.width = "100%";
    preview.style.height = "160px"; // Kicsit kisebb, hogy t√∂bb kif√©rjen

    // Kattint√°s esem√©ny
    card.onclick = function(e) {
        e.preventDefault();
        loadTheme(key, variant);
    };

    card.appendChild(label);
    card.appendChild(preview);
    container.appendChild(card);
}
        // --- JAV√çTOTT MENT√âS: H√ÅTT√âRREL EGY√úTT ---
        function saveMapThumbnail(forcedName) {
            const sourceCanvas = document.querySelector('#celestial-map canvas');
            if (!sourceCanvas) return;

            // 1. Akt√≠v t√©ma h√°tter√©nek lek√©r√©se
            const theme = mapThemes[activeThemeKey];
            const bgStyle = theme ? theme.background : "#000000";

            // 2. Ideiglenes v√°szon
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');

            // 3. H√°tt√©r fest√©se
            if (bgStyle.includes('gradient')) {
                // Gradiens sz√≠nek kinyer√©se
                const colors = bgStyle.match(/#[a-fA-F0-9]{6}|rgb\([^)]+\)/g);
                if (colors && colors.length >= 2) {
                    const gradient = ctx.createLinearGradient(0, 0, exportCanvas.width, exportCanvas.height);
                    gradient.addColorStop(0, colors[0]);
                    gradient.addColorStop(1, colors[colors.length - 1]);
                    ctx.fillStyle = gradient;
                } else {
                    ctx.fillStyle = "#000000";
                }
            } else {
                ctx.fillStyle = bgStyle;
            }
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

            // 4. T√©rk√©p r√°fest√©se
            ctx.drawImage(sourceCanvas, 0, 0);

            // 5. Let√∂lt√©s
            const link = document.createElement('a');
            link.download = forcedName || `thumb_${activeThemeKey}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- T√ñMEGES GENER√ÅL√ì ROBOT ü§ñ ---
        function downloadAllThemesSequence() {
            const keys = Object.keys(mapThemes);
            let index = 0;

            if(!confirm(`Figyelem! Ez a folyamat sorban let√∂lti mind a(z) ${keys.length} k√©pet.\n\nNe ny√∫lj az eg√©rhez, am√≠g nem v√©gez!`)) {
                return;
            }

            function processNext() {
                if (index >= keys.length) {
                    alert("K√©sz! Minden t√©ma k√©pe let√∂ltve. ü•Ç\nMost m√°sold be ≈ëket az 'images/themes/' mapp√°ba!");
                    return;
                }

                const key = keys[index];
                console.log(`Gener√°l√°s: ${key} (${index + 1}/${keys.length})`);
                let variant = 'normal';
                // 1. T√©ma bet√∂lt√©se (ez friss√≠ti a map-wrap h√°tter√©t √©s a t√©rk√©pet is)
                loadTheme(key, variant);

                // 2. V√°rakoz√°s (800ms el√©g kell legyen a rajzol√°shoz)
                setTimeout(() => {
                    // 3. Ment√©s: thumb_midnight.png, thumb_vintage.png, stb.
                    saveMapThumbnail(`thumb_${key}.png`);
                    
                    index++;
                    processNext(); // K√∂vetkez≈ë
                }, 800); 
            }

            // Ind√≠t√°s
            processNext();
        }


        var myCelestialConf = null;
        var timeZone = 60;
        var lat = 47.4979;
        var lng = 19.0402;
        var date = new Date();

        function change(opts) { 
            console.log("change");
            var ujCelesConf = deepMerge(myCelestialConf, opts);
            myCelestialConf = ujCelesConf;
            console.log("myCelestialConf", myCelestialConf);
            console.log("opts", opts);
            console.log("ujCelesConf", ujCelesConf);
            Celestial.apply(opts); 
        }

        // $(document).on('change', '#const_show', function(e) {
        //     change({ constellations: { lines: $(this).is(':checked') } });
        // });

        $(document).on('change', '#const_show', function(e) {
            if ($(this).is(':checked')) {
                $("#const_show_settings").slideDown(300);
            }
            else {
                $("#const_show_settings").slideUp(300);
            }
            change({ constellations: { lines: $(this).is(':checked') } });
        });

        $(document).on('change', '#mw_show', function(e) {
            if ($(this).is(':checked')) {
                $("#mw_show_settings").slideDown(300);
            }
            else {
                $("#mw_show_settings").slideUp(300);
            }
            change({ mw: { show: $(this).is(':checked') } });
        });
        
        $(document).on('change', '#mw_style_fill', function(e) {
            change({ mw: { style: {
                fill: $("#mw_style_fill").val(),
                opacity: $("#mw_style_opacity").val() } }
            });
        });
        
        $(document).on('change', '#mw_style_opacity', function(e) {
            change({ mw: { style: {
                fill: $("#mw_style_fill").val(),
                opacity: $("#mw_style_opacity").val() } }
            });
        });

        $(document).on('change', '#background_fill', function(e) {
            change({ background: { 
                fill: $("#background_fill").val() }
            });
        });
        
        $(document).on('change', '#background_opacity', function(e) {
            change({ background: {
                opacity: $("#background_opacity").val() }
            });
        });
        
        $(document).on('change', '#background_stroke', function(e) {
            change({ background: { 
                stroke: $("#background_stroke").val() }
            });
        });
        
        $(document).on('change', '#background_stroke_width', function(e) {
            change({ background: {
                width: $("#background_stroke_width").val() }
            });
        });

        $(document).on('change', '#constellation_lineStyle_opacity', function(e) {
            change({ constellations: { lineStyle: {
                opacity: $("#constellation_lineStyle_opacity").val(),
                stroke: $("#constellation_lineStyle_stroke").val(),
                width: $("#constellation_lineStyle_stroke_width").val() } },
            });
        });
        
        $(document).on('change', '#constellation_lineStyle_stroke', function(e) {
            change({ constellations: { lineStyle: {
                opacity: $("#constellation_lineStyle_opacity").val(),
                stroke: $("#constellation_lineStyle_stroke").val(),
                width: $("#constellation_lineStyle_stroke_width").val() } },
            });
        });
        
        $(document).on('change', '#constellation_lineStyle_stroke_width', function(e) {
            change({ constellations: { lineStyle: {
                opacity: $("#constellation_lineStyle_opacity").val(),
                stroke: $("#constellation_lineStyle_stroke").val(),
                width: $("#constellation_lineStyle_stroke_width").val() } },
            });
        });
        

        $(document).on('change', '#stars_show', function(e) {
            if ($(this).is(':checked')) {
                $("#stars_show_settings").slideDown(300);
            }
            else {
                $("#stars_show_settings").slideUp(300);
            }
            change({ stars: { show: $(this).is(':checked') } });
        });
        
        $(document).on('input', '#stars_limit', function(e) {
            change({ stars: { limit: parseFloat($(this).val()) } });
        });
        
        $(document).on('change', '#stars_size', function(e) {
            change({ stars: { size: parseFloat($(this).val()) } });
        });
        
        $(document).on('change', '#stars_exponent', function(e) {
            change({ stars: { exponent: parseFloat($(this).val()) } });
        });
        
        $(document).on('change', '#stars_colors', function(e) {
            if (!$(this).is(':checked')) {
                $("#stars_colors_settings").slideDown(300);
            }
            else {
                $("#stars_colors_settings").slideUp(300);
            }
            change({ stars: { colors: $(this).is(':checked') } });
        });
        
        $(document).on('change', '#stars_style_fill', function(e) {
            change({ stars: { style: {
                fill: $("#stars_style_fill").val(),
                opacity: $("#stars_style_opacity").val() } }
            });
        });
        $(document).on('change', '#stars_style_opacity', function(e) {
            change({ stars: { style: {
                fill: $("#stars_style_fill").val(),
                opacity: $("#stars_style_opacity").val() } }
            });
        });

        $(document).on('change', '#planets_show', function(e) {
            change({ planets: { show: $(this).is(':checked'), symbolType: "disk" } });
        });

        
        $(document).on('change', '#lines_graticule_color', function(e) {
          console.log("lines_graticule_color")
            change({ lines: { graticule: {
                show: $("#lines_graticule").is(':checked'),
                stroke: $("#lines_graticule_color").val(),
                width: parseFloat($("#lines_graticule_size").val()),
                opacity: parseFloat($("#lines_graticule_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_graticule_size', function(e) {
            change({ lines: { graticule: {
                show: $("#lines_graticule").is(':checked'),
                stroke: $("#lines_graticule_color").val(),
                width: parseFloat($("#lines_graticule_size").val()),
                opacity: parseFloat($("#lines_graticule_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_graticule_opacity', function(e) {
            change({ lines: { graticule: {
                show: $("#lines_graticule").is(':checked'),
                stroke: $("#lines_graticule_color").val(),
                width: parseFloat($("#lines_graticule_size").val()),
                opacity: parseFloat($("#lines_graticule_opacity").val()) } }
            });
        });
        
        
        $(document).on('change', '#lines_equatorial_color', function(e) {
            change({ lines: { equatorial: {
                show: $("#lines_equatorial").is(':checked'),
                stroke: $("#lines_equatorial_color").val(),
                width: parseFloat($("#lines_equatorial_size").val()),
                opacity: parseFloat($("#lines_equatorial_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_equatorial_size', function(e) {
            change({ lines: { equatorial: {
                show: $("#lines_equatorial").is(':checked'),
                stroke: $("#lines_equatorial_color").val(),
                width: parseFloat($("#lines_equatorial_size").val()),
                opacity: parseFloat($("#lines_equatorial_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_equatorial_opacity', function(e) {
            change({ lines: { equatorial: {
                show: $("#lines_equatorial").is(':checked'),
                stroke: $("#lines_equatorial_color").val(),
                width: parseFloat($("#lines_equatorial_size").val()),
                opacity: parseFloat($("#lines_equatorial_opacity").val()) } }
            });
        });

        
        $(document).on('change', '#lines_ecliptic_color', function(e) {
            change({ lines: { ecliptic: {
                show: $("#lines_ecliptic").is(':checked'),
                stroke: $("#lines_ecliptic_color").val(),
                width: parseFloat($("#lines_ecliptic_size").val()),
                opacity: parseFloat($("#lines_ecliptic_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_ecliptic_size', function(e) {
            change({ lines: { ecliptic: {
                show: $("#lines_ecliptic").is(':checked'),
                stroke: $("#lines_ecliptic_color").val(),
                width: parseFloat($("#lines_ecliptic_size").val()),
                opacity: parseFloat($("#lines_ecliptic_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_ecliptic_opacity', function(e) {
            change({ lines: { ecliptic: {
                show: $("#lines_ecliptic").is(':checked'),
                stroke: $("#lines_ecliptic_color").val(),
                width: parseFloat($("#lines_ecliptic_size").val()),
                opacity: parseFloat($("#lines_ecliptic_opacity").val()) } }
            });
        });
        
        
        $(document).on('change', '#lines_galactic_color', function(e) {
            change({ lines: { galactic: {
                show: $("#lines_galactic").is(':checked'),
                stroke: $("#lines_galactic_color").val(),
                width: parseFloat($("#lines_galactic_size").val()),
                opacity: parseFloat($("#lines_galactic_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_galactic_size', function(e) {
            change({ lines: { galactic: {
                show: $("#lines_galactic").is(':checked'),
                stroke: $("#lines_galactic_color").val(),
                width: parseFloat($("#lines_galactic_size").val()),
                opacity: parseFloat($("#lines_galactic_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_galactic_opacity', function(e) {
            change({ lines: { galactic: {
                show: $("#lines_galactic").is(':checked'),
                stroke: $("#lines_galactic_color").val(),
                width: parseFloat($("#lines_galactic_size").val()),
                opacity: parseFloat($("#lines_galactic_opacity").val()) } }
            });
        });
        
        
        $(document).on('change', '#lines_supergalactic_color', function(e) {
            change({ lines: { supergalactic: {
                show: $("#lines_supergalactic").is(':checked'),
                stroke: $("#lines_supergalactic_color").val(),
                width: parseFloat($("#lines_supergalactic_size").val()),
                opacity: parseFloat($("#lines_supergalactic_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_supergalactic_size', function(e) {
            change({ lines: { supergalactic: {
                show: $("#lines_supergalactic").is(':checked'),
                stroke: $("#lines_supergalactic_color").val(),
                width: parseFloat($("#lines_supergalactic_size").val()),
                opacity: parseFloat($("#lines_supergalactic_opacity").val()) } }
            });
        });
        
        $(document).on('change', '#lines_supergalactic_opacity', function(e) {
            change({ lines: { supergalactic: {
                show: $("#lines_supergalactic").is(':checked'),
                stroke: $("#lines_supergalactic_color").val(),
                width: parseFloat($("#lines_supergalactic_size").val()),
                opacity: parseFloat($("#lines_supergalactic_opacity").val()) } }
            });
        });

        
    $(document).ready(function() {
      // initThemeSelectors();
      // Kis k√©sleltet√©ssel, hogy a Celestial biztosan bet√∂lts√∂n
      // setTimeout(() => {
      //     saveUserState();
      // }, 1000);
      
      // initThemeSelectors();
      setTimeout(() => {
          saveUserState(); // Ments√ºk el az alap√°llapotot
      }, 1000);
      initThemeSelectors();
      // 1. A Werner vet√ºlet "aliasa" a Bonne-nak a D3-ban.
        // Fontos: √≠gy megmarad a .raw tulajdons√°g, ami kell a celestial.js-nek!
        // if (d3.geo && d3.geo.bonne) {
            // d3.geo.werner = d3.geo.bonne;
        // }
        // --- 1. PROJEKCI√ì DEFINI√ÅL√ÅSA (SZ√çV ALAK KORREKCI√ìVAL) ---
        // if (d3.geo && d3.geo.bonne) {
        //     console.log("d3.geo && d3.geo.bonne");
        //     // L√©trehozunk egy burkol√≥t a Bonne vet√ºlet k√∂r√©, ami eltolja Y tengelyen
        //     d3.geo.werner = function() { return d3.geo.bonne(); };
            
        //     d3.geo.werner.raw = function(phi0) {
        //         var rawBonne = d3.geo.bonne.raw(phi0);
                
        //         function rawWerner(lambda, phi) {
        //             var xy = rawBonne(lambda, phi);
        //             // M√ÅGIKUS ELTOL√ÅS: Feljebb h√∫zzuk a t√©rk√©pet, hogy a k√∂zepe legyen az orig√≥ban
        //             // Az 1.35 √©rt√©k k√≠s√©rleti √∫ton a legszebb poz√≠ci√≥t adja a sz√≠vnek
        //             xy[1] -= 1.7; 
        //             return xy;
        //         }
                
        //         rawWerner.invert = function(x, y) {
        //             return rawBonne.invert(x, y + 1.35);
        //         };
                
        //         return rawWerner;
        //     };
        // }
      // --- 1. PROJEKCI√ì DEFINI√ÅL√ÅSA (SZ√çV ALAK KORREKCI√ìVAL) ---
        // if (d3.geo && d3.geo.bonne) {
        //     console.log("d3.geo && d3.geo.bonne");
        //     d3.geo.werner = function() { return d3.geo.bonne(); };
            
        //     d3.geo.werner.raw = function(phi0) {
        //         var rawBonne = d3.geo.bonne.raw(phi0);
                
        //         function rawWerner(lambda, phi) {
        //             var xy = rawBonne(lambda, phi);
        //             // M√ÅGIKUS ELTOL√ÅS:
        //             // 1.35 t√∫l sok volt (t√∫l magasra tolta).
        //             // 0.5 k√∂r√ºli √©rt√©kkel lejjebb ker√ºl, a v√°szon k√∂zep√©re.
        //             xy[1] -= 0.1; 
        //             return xy;
        //         }
                
        //         rawWerner.invert = function(x, y) {
        //             return rawBonne.invert(x, y + 0.5);
        //         };
                
        //         return rawWerner;
        //     };
        // }
        // // 2. Beregisztr√°ljuk a Celestial k√∂nyvt√°rba a param√©terekkel
        // // arg: Math.PI / 2 (90 fok) adja a sz√≠v alakot
        // if (Celestial.projections) {
        //     console.log("if (Celestial.projections) {");
        //     Celestial.projections().werner = {
        //         // n: "Werner",
        //         // arg: Math.PI / 2, 
        //         // scale: 225,
        //         // ratio: 0.88
        //         // n: "Werner",
        //         // arg: Math.PI / 2,  // Ez a standard Werner (90 fok)
        //         // scale: 225,        // Ha t√∫l kicsi a t√©rk√©p, n√∂veld ezt (pl. 300-ra)
        //         // ratio: 1.1         // FONTOS: 0.88 helyett 1.1 vagy 1.2
        //         // n: "Bonne (Sz√≠v)",
        //         // // 90 fok (PI/2) helyett 45 fok. Ez adja a klasszikus, kerekebb sz√≠vet.
        //         // arg: 45 * (Math.PI / 180), 
        //         // scale: 225, 
        //         // ratio: 1.2  // Itt sz√©lesebb v√°szon kell

        //         // n: "Werner",
        //         // arg: Math.PI / 2.8,  // Ez a standard Werner (90 fok)
        //         // scale: 150,        // Ha t√∫l kicsi a t√©rk√©p, n√∂veld ezt (pl. 300-ra)
        //         // ratio: 1.6        // FONTOS: 0.88 helyett 1.1 vagy 1.2
        //         // n: "Werner",
        //         // arg: Math.PI / 2.8,  // Ez a standard Werner (90 fok)
        //         // scale: 150,        // Ha t√∫l kicsi a t√©rk√©p, n√∂veld ezt (pl. 300-ra)
        //         // ratio: 1.6        // FONTOS: 0.88 helyett 1.1 vagy 1.2

        //         // n: "Werner", ALAP BONNE
        //         // arg: Math.PI / 2.5,  // Ez a standard Werner (90 fok)
        //         // scale: 150,        // Ha t√∫l kicsi a t√©rk√©p, n√∂veld ezt (pl. 300-ra)
        //         // ratio: 0.88       // FONTOS: 0.88 helyett 1.1 vagy 1.2


        //         // n: "Bonne (Sz√≠v)",
        //         // // 90 fok (PI/2) helyett 45 fok. Ez adja a klasszikus, kerekebb sz√≠vet.
        //         // arg: 45 * (Math.PI / 180), 
        //         // scale: 225, 
        //         // ratio: 1.2  // Itt sz√©lesebb v√°szon kell

        //         // n: "Werner",
        //         // arg: Math.PI / 2,  // Ez a standard Werner (90 fok)
        //         // scale: 225,        // Ha t√∫l kicsi a t√©rk√©p, n√∂veld ezt (pl. 300-ra)
        //         // ratio: 1.1        // FONTOS: 0.88 helyett 1.1 vagy 1.2
        //                 // n: "Bonne (Kerekebb sz√≠v)",
        //         // arg: Math.PI / 4,  // 45 fok. Ez egy kerekebb, "ducibb" forma.
        //         // scale: 225,
        //         // ratio: 1.3         // Ez a forma sz√©lesebb, ez√©rt nagyobb ratio kell
        //         //bonne alak√≠t e
        //         n:"Werner (sz√≠v)", arg:Math.PI/2.5, scale:225, ratio:0.88
        //     };

        // }
      // // --- 1. SAJ√ÅT VET√úLET DEFINI√ÅL√ÅSA (Egyedi n√©vvel!) ---
      //   if (d3.geo && d3.geo.bonne) {
      //       // L√©trehozunk egy "customHeart" nev≈± vet√ºletet a Bonne alapj√°n
      //       d3.geo.customHeart = function() { return d3.geo.bonne(); };
            
      //       d3.geo.customHeart.raw = function(phi0) {
      //           var rawBonne = d3.geo.bonne.raw(phi0);
                
      //           function rawCustom(lambda, phi) {
      //               var xy = rawBonne(lambda, phi);
      //               // M√ÅGIKUS ELTOL√ÅS: 
      //               // Mivel saj√°t nevet haszn√°lunk, ez BIZTOSAN lefut.
      //               // 0.6 = Kicsit feljebb h√∫zzuk, hogy a sz√≠v k√∂zepe legyen a v√°szon k√∂zep√©n
      //               xy[1] -= 0.6; 
      //               return xy;
      //           }
                
      //           rawCustom.invert = function(x, y) {
      //               return rawBonne.invert(x, y + 0.6);
      //           };
                
      //           return rawCustom;
      //       };
      //   }

      //   // Beregisztr√°ljuk a Celestial-ba az √∫j n√©ven
      //   if (Celestial.projections) {
      //       Celestial.projections().customHeart = {
      //           n: "Sz√≠v Alak√∫ (Werner)",
      //           arg: Math.PI / 2.5,  // Sz√≠v alak sz√∂ge
      //           scale: 225,          
      //           ratio: 0.88           
      //       };
      //   }
      // --- 1. PROJEKCI√ì DEFINI√ÅL√ÅSA (SZ√çV ALAK JAV√çTVA) ---
        // Fontos: Itt fel√ºl√≠rjuk a be√©p√≠tett werner-t, hogy a te men√ºddel m≈±k√∂dj√∂n
        if (d3.geo && d3.geo.bonne) {
            d3.geo.werner = function() { return d3.geo.bonne(); };
            
            d3.geo.werner.raw = function(phi0) {
                var rawBonne = d3.geo.bonne.raw(phi0);
                
                function rawWerner(lambda, phi) {
                    var xy = rawBonne(lambda, phi);
                    
                    // JAV√çT√ÅS: += jelet haszn√°lunk! Ez tolja LEFEL√â a t√©rk√©pet.
                    // 0.2 = Kb. a sz√≠v magass√°g√°nak 20%-√°val lejjebb toljuk.
                    // xy[1] += 0.2; 
                    xy[1] += 1; 
                    return xy;
                }
                
                rawWerner.invert = function(x, y) {
                    // Az invert√°l√°sn√°l ki kell vonni, amit hozz√°adtunk
                    // return rawBonne.invert(x, y - 0.2);
                    return rawBonne.invert(x, y - 1);
                };
                
                return rawWerner;
            };
        }

        if (Celestial.projections) {
            Celestial.projections().werner = {
                n: "Werner (Sz√≠v)",
                arg: Math.PI / szivszoge, 
                scale: 210,  // Kicsit kisebb m√©ret, hogy biztosan kif√©rjen
                ratio: szivratioja   // Magasabb v√°szon (kisebb sz√°m = magasabb), hogy az alja is r√°f√©rjen
            };
        }
        // 1. Defini√°ljuk az √öJ vet√ºletet a D3 rendszer√©ben (nem √≠rjuk fel√ºl a r√©git)
    if (d3.geo && d3.geo.bonne) {
        d3.geo.customHeart = function() {
              // console.log("d3.geo.customHeart = function(phi0)")
              return d3.geo.bonne();
            };
        
        d3.geo.customHeart.raw = function(phi0) {
              // console.log("d3.geo.customHeart.raw = function(phi0)")
            // Az alap Bonne vet√ºletet haszn√°ljuk
            var rawBonne = d3.geo.bonne.raw(phi0);
            
            function rawCustom(lambda, phi) {
              // console.log("rawCustom")
                var xy = rawBonne(lambda, phi);
                
                // --- IGAZ√çT√ÅS ---
                // Itt tudod tologatni a rajzot a v√°sznon bel√ºl!
                // xy[1] a f√ºgg≈ëleges tengely.
                // += tolja LEFEL√â, -= tolja FELFEL√â.
                // Ha a sz√≠v a v√°szon tetej√©re tapad, n√∂veld ezt az √©rt√©ket!
                
                xy[1] -= 0.6;  // Pr√≥b√°ld ki: 0.2, 0.4 vagy ak√°r 0.6
                
                return xy;
            }
            
            rawCustom.invert = function(x, y) {
              // console.log("rawCustom.invert")
                // Az invert√°l√°sn√°l az ellent√©t√©t kell csin√°lni
                return rawBonne.invert(x, y + 0.6); 
            };
            
            return rawCustom;
        };
    }

    // 2. Beregisztr√°ljuk a Celestial-ba az √∫j n√©ven
    if (Celestial.projections) {
        Celestial.projections().customHeart = {
            n: "Sz√≠v Alak√∫ (K√∂z√©pre Igaz√≠tott)",
            arg: Math.PI / szivszoge, 
            scale: 235, 
            ratio: szivratioja // A te j√≥l bev√°lt ar√°nyod
        };
    }
// // --- 1. SAJ√ÅT EGYEDI VET√úLET (myHeartFinal - Tiszta verzi√≥) ---
//         if (d3.geo && d3.geo.bonne) {
//             d3.geo.myHeartFinal = function() { return d3.geo.bonne(); };
//             d3.geo.myHeartFinal.raw = d3.geo.bonne.raw; // Nem kell custom raw f√ºggv√©ny!
//         }

//         if (Celestial.projections) {
//             Celestial.projections().myHeartFinal = {
//                 n: "Sz√≠v Alak√∫ (V√©gleges)",
//                 arg: Math.PI / 2.5, 
//                 scale: 235, 
//                 ratio: 1.0 
//             };
//         }


    //     // 1. Defini√°ljuk az √öJ vet√ºletet a D3 rendszer√©ben (nem √≠rjuk fel√ºl a r√©git)
    // if (d3.geo && d3.geo.bonne) {
    //     d3.geo.bonne = function() {
    //           // console.log("d3.geo.bonne = function(phi0)")
    //           return d3.geo.bonne();
    //         };
        
    //     d3.geo.bonne.raw = function(phi0) {
    //           // console.log("d3.geo.bonne.raw = function(phi0)")
    //         // Az alap Bonne vet√ºletet haszn√°ljuk
    //         var rawBonne = d3.geo.bonne.raw(phi0);
            
    //         function rawCustom(lambda, phi) {
    //           // console.log("rawCustom")
    //             var xy = rawBonne(lambda, phi);
                
    //             // --- IGAZ√çT√ÅS ---
    //             // Itt tudod tologatni a rajzot a v√°sznon bel√ºl!
    //             // xy[1] a f√ºgg≈ëleges tengely.
    //             // += tolja LEFEL√â, -= tolja FELFEL√â.
    //             // Ha a sz√≠v a v√°szon tetej√©re tapad, n√∂veld ezt az √©rt√©ket!
                
    //             xy[1] += 0.9;  // Pr√≥b√°ld ki: 0.2, 0.4 vagy ak√°r 0.6
                
    //             return xy;
    //         }
            
    //         rawCustom.invert = function(x, y) {
    //           // console.log("rawCustom.invert")
    //             // Az invert√°l√°sn√°l az ellent√©t√©t kell csin√°lni
    //             return rawBonne.invert(x, y - 0.9); 
    //         };
            
    //         return rawCustom;
    //     };
    // }

    // // 2. Beregisztr√°ljuk a Celestial-ba az √∫j n√©ven
    // if (Celestial.projections) {
    //     Celestial.projections().bonne = {
    //         n: "Sz√≠v Alak√∫ (K√∂z√©pre Igaz√≠tott)",
    //         arg: Math.PI / 2.5, 
    //         scale: 210, 
    //         ratio: 0.88 // A te j√≥l bev√°lt ar√°nyod
    //     };
    // }
        const cityInput = document.getElementById('city');
        const autocomplete = new google.maps.places.Autocomplete(cityInput, {
            types: ['(cities)'],
            fields: ['geometry', 'name']
        });

        autocomplete.addListener('place_changed', async () => {
            const place = autocomplete.getPlace();
            console.log("autocomplete change place", place);
            console.log("autocomplete change place.name", place.name);
            if (!place.geometry) {
                console.log('No details available for input: ', place.name);
                return;
            }

            lat = place.geometry.location.lat();
            lng = place.geometry.location.lng();
            console.log("autocomplete change lat", lat);
            console.log("autocomplete change lng", lng);
            $("#coord_lat").val(lat.toString().replace(".", ","));
            $("#coord_lon").val(lng.toString().replace(".", ","));
            
            date = $("#datetimepicker").datetimepicker("getDate");
            console.log("autocomplete change date", date);
            var tttz = await getTimezoneOffset_(lat, lng);
            console.log("autocomplete change tttz", tttz);
            Celestial.skyview({date: date, location: [lat, lng], timezone: tttz});
            myCelestialConf.Varos = place.name;
            myCelestialConf.Ido = date;
            myCelestialConf.Lokacio = [lat, lng];
            myCelestialConf.Idozona = tttz;
            myCelestialConf.geopos = [lat, lng];
        });

            // // --- T√âMA GOMBOK GENER√ÅL√ÅSA ---
            // const themeContainer = document.getElementById('theme-buttons-container');
            // if (themeContainer) {
            //     for (const [key, theme] of Object.entries(mapThemes)) {
            //         const btn = document.createElement('button');
            //         btn.className = 'add-btn'; // A megl√©v≈ë CSS oszt√°lyodat haszn√°ljuk
            //         btn.innerText = theme.name;
                    
            //         // Egyedi st√≠lus a gombnak, hogy hasonl√≠tson a t√©m√°ra
            //         btn.style.cssText = theme.style + "padding: 15px; font-weight: bold; cursor: pointer; transition: transform 0.2s;";
                    
            //         btn.onmouseover = function() { this.style.transform = "scale(1.05)"; };
            //         btn.onmouseout = function() { this.style.transform = "scale(1.0)"; };
                    
            //         btn.onclick = function(e) {
            //             e.preventDefault(); // Ne t√∂ltse √∫jra az oldalt
            //             loadTheme(key);
            //         };
                    
            //         themeContainer.appendChild(btn);
            //     }
            // }
        // --- T√âMA K√ÅRTY√ÅK GENER√ÅL√ÅSA (K√©ppel egy√ºtt) ---
            // Figyeld meg: az √∫j ID-t haszn√°ljuk!
            // const themeContainer = document.getElementById('theme-grid-container');
            
            // if (themeContainer) {
            //     for (const [key, theme] of Object.entries(mapThemes)) {
            //         // 1. L√©trehozzuk a k√°rtya t√°rol√≥t (wrapper)
            //         const themeItem = document.createElement('div');
            //         themeItem.className = 'theme-item';

            //         // 2. L√©trehozzuk a gombot (a k√°rtya tetej√©re)
            //         const btn = document.createElement('button');
            //         btn.className = 'theme-btn'; // √öj CSS class
            //         btn.innerText = theme.name;
            //         // A gomb kapja a t√©ma sz√≠neit
            //         btn.style.cssText = theme.style;
                    
            //         // 3. L√©trehozzuk a k√©pet (a gomb al√°)
            //         const img = document.createElement('img');
            //         img.className = 'theme-preview-img';
            //         img.src = theme.image; // Itt olvassa ki a f√°jl el√©r√©si √∫tj√°t
            //         img.alt = theme.name + " preview";
                    
            //         // Ha esetleg nem tal√°lja a k√©pet, tegyen be egy placeholdert (opcion√°lis)
            //         img.onerror = function() {
            //             this.src = 'https://placehold.co/150x120?text=No+Image'; 
            //         };

            //         // Esem√©nykezel≈ë: Kattint√°s a teljes k√°rty√°ra (gombra vagy k√©pre)
            //         themeItem.onclick = function(e) {
            //             e.preventDefault();
            //             loadTheme(key);
            //             // Opcion√°lis: vizu√°lis visszajelz√©s az akt√≠v t√©m√°r√≥l
            //             document.querySelectorAll('.theme-item').forEach(i => i.style.borderColor = '#eee');
            //             this.style.borderColor = '#4a9eff'; // K√©k keret az akt√≠von
            //         };
                    
            //         // √ñsszerakjuk a k√°rty√°t
            //         themeItem.appendChild(btn);
            //         themeItem.appendChild(img);
                    
            //         // Betessz√ºk a f≈ë t√°rol√≥ba
            //         themeContainer.appendChild(themeItem);
            //     }
            // }

            console.log("celestialConfig_ elott qwe");
        var celestialConfig_ = {
            container: 'celestial-map',
            disableAnimations: false,
            form: false,
            // width: 0,
            // width: document.getElementById('map-wrap') ? document.getElementById('map-wrap').clientWidth : 600,

            width: getOptimalMapSize(),
            datapath: "https://ofrohn.github.io/data/",
            geopos: [47.4979, 19.0402],
            interactive: false,
            alignCelestialMap: "center",
            formFields: {
                location: true,
                general: true,
                stars: true,
                dsos: false,
                constellations: false,
                lines: true,
                other: true,
                download: true
            },
            stars: {
                show: true,
                limit: 6,
                size: 7,
                exponent: -0.28,
                colors: true,
                style: {
                    fill: "#ffffff",
                    opacity: 1
                },
                designation: false,
                designationType: "desig",
                designationStyle: {
                    fill: "#ddbbbb",
                    font: "11px 'Palatino Linotype', Georgia, Times, 'Times Roman', serif",
                    align: "left",
                    baseline: "top"
                },
                propername: false,
                propernameType: "name",
                propernameStyle: {
                    fill: "#ddbbbb",
                    font: "13px 'Palatino Linotype', Georgia, Times, 'Times Roman', serif",
                    align: "right",
                    baseline: "bottom"
                }
            },
            // projection: "orthographic",
            projection: "stereographic",
            lines: { 
                    graticule: { show: true, stroke: "#cccccc", width: 0.6, opacity: 0.8,
                      lon: {pos: [], fill: "#eee", font: "10px 'Lucida Sans Unicode', Helvetica, Arial, sans-serif"}, 
                          lat: {pos: [], fill: "#eee", font: "10px 'Lucida Sans Unicode', Helvetica, Arial, sans-serif"}},
                    equatorial: { show: false, stroke: "#aaaaaa", width: 1.3, opacity: 0.7 },
                    ecliptic: { show: false, stroke: "#66cc66", width: 1.3, opacity: 0.7 },
                    galactic: { show: false, stroke: "#cc6666", width: 1.3, opacity: 0.7 },
                    supergalactic: { show: false, stroke: "#cc66cc", width: 1.3, opacity: 0.7 }
            },
            mw: {
                show: true,
                style: { fill: "#ffffff", opacity: "0.15" }
            },
            background: { 
                fill: "#000000", 
                opacity: 1, 
                stroke: "#FFFFFF",
                width: 1.5 
            }, 

            dsos: {
                show: false,
                names: false,
            },
            constellations: {
                names: false,
                namesType: "iau",
                nameStyle: {
                    fill: "#cccc99",
                    align: "center",
                    baseline: "middle",
                    font: ["14px Helvetica, Arial, sans-serif", "12px Helvetica, Arial, sans-serif", "11px Helvetica, Arial, sans-serif"]
                },
                lines: true,
                lineStyle: {
                    stroke: "#cccccc",
                    width: 1.5,
                    opacity: 0.6
                },
                bounds: false,
                boundStyle: {
                    stroke: "#cccc00",
                    width: 0.5,
                    opacity: 0.8,
                    dash: [2, 4]
                }
            },
        }
        myCelestialConf = celestialConfig_;

        Celestial.display(celestialConfig_);

        $("#datetimepicker").datetimepicker({
            showAnim: "slideDown",
            showOtherMonths: true,
            selectOtherMonths: true,
            showButtonPanel: true,
            changeMonth: true,
            changeYear: true,
            format: "yy-mm-dd hh:mm:ss",
            dateFormat: "yy-mm-dd",
            timeFormat: "HH:mm",
            showOn: "both",
            buttonImageOnly: false,
            buttonText: "üìÖ",
            firstDay: 1,
            currentText: "Most",
            closeText: "Bez√°r",
            regional: $.datepicker.regional[ "hu" ],  
            showSecond: false,    
            showTimezone: false,
              onSelect: function() {
                    date = $(this).datetimepicker("getDate");
                    console.log("datetimepicker change date", date);
                    Celestial.skyview({date: date, location: [lat, lng], timezone: timeZone});
              },
              // minDate: -20,
              // minDate: new Date(1900, 0, 1),
              // maxDate: new Date(2100, 0, 1),
              minDate: "-300y",
              maxDate: "+300y",
              yearRange: '1725:2325'
        });
        $( "#datetimepicker" ).datetimepicker('setDate', new Date());


        // Update settings when form controls change
        // document.getElementById('projection').addEventListener('change', (e) => {
        // $(document).on('change', '#projection', function(e) {
        // document.getElementById('projection').addEventListener('change', function(e) {
        //             console.log("projection change e", e);
        //             console.log("projection change e.target.value", e.target.value);
        //     // Celestial.setOption('projection', e.target.value);
        //     // Celestial.refresh();
        //     // Celestial.reproject({projection:<see above>})
        //     // Celestial.reproject({projection:e.target.value})
        // });
    });

        async function getTimezoneOffset_(lt, ln) {
            console.log("getTimezoneOffset lt", lt);
            console.log("getTimezoneOffset ln", ln);

            if (!lt || !ln) {
                return;
            }

            const timestamp = Math.floor(Date.now() / 1000);

            const API_KEY = "AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s"; 
            const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + lt + ',' + ln + '&timestamp=' + timestamp + '&key=' + API_KEY;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === "OK") {
                    const rawOffsetSeconds = data.rawOffset;
                    const dstOffsetSeconds = data.dstOffset;

                    const totalOffsetSeconds = rawOffsetSeconds + dstOffsetSeconds;

                    const totalOffsetMinutes = totalOffsetSeconds / 60;

                    timeZone = totalOffsetMinutes;
                    console.log("timeZone", timeZone);
                    return totalOffsetMinutes;

                } else {
                    let errorMessage = data.errorMessage || 'Ismeretlen hiba t√∂rt√©nt.';
                }
            } catch (error) {
                console.error("Hiba t√∂rt√©nt:", error);
            }
        }

        $(document).on('click', '.ui-datepicker-current', function(e) {
            console.log("datetimepicker click .ui-datepicker-current");
            var date = new Date();
            var datestr = date.toString();
            console.log("datetimepicker change datestr", datestr);
            var reg = /([\+?\-?]\d\d\d\d)/g;
            var matches = datestr.match(reg);
            console.log("datetimepicker change matches", matches);
            console.log("datetimepicker change matches[0]", matches[0]);

            timeZoneMin = convertTimezoneOffset(matches[0]);
            $( "#datetimepicker" ).datetimepicker('setDate', new Date());
        });

        function convertTimezoneOffset(offsetString) {
          const regex = /^([+-])(\d{2})(\d{2})$/;
          const match = offsetString.match(regex);

          if (!match) {
            console.error("√ârv√©nytelen id≈ëz√≥na form√°tum. P√©lda: '+0200' vagy '-0400'");
            return null;
          }

          const sign = match[1];
          const hours = parseInt(match[2], 10);

          let totalMinutes = hours * 60;

          if (sign === '-') {
            totalMinutes = -totalMinutes;
          }

          return totalMinutes;
        }
        
        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] instanceof Object && key in target && target[key] instanceof Object) {
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        // M√°sol√°s gomb
        // document.getElementById('copy-button').addEventListener('click', function() {
        //     // copyCelestialToSVG();
        //     // Celestial.copySVG("asd")
        //     $("#copy-svg").trigger("click");
        // });
        // copy2 gomb
        // document.getElementById('copy2-button').addEventListener('click', function(e) {
        //             console.log("copy2-button click e", e);
        //     // // copyCelestialToSVG();
        //     // // Celestial.exportSVG("asd")
        //     // // exportSVG("asd");
        //     // $("#copy-svg").trigger("click");
        // });
        // dl-button gomb
        // document.getElementById('dl-button').addEventListener('click', function() {
        //     // copyCelestialToSVG();
        //     // Celestial.exportSVG("asd")
        //     // exportSVG("asd");
        //     $("#download-svg").trigger("click");
        // });
        // width-button
        // document.getElementById('width-button').addEventListener('click', function(e) {
        //             console.log("width-button click e", e);
        //             console.log("width-button click Celestial", Celestial);
        //             console.log("width-button click Celestial.metrics()", Celestial.metrics());
        //     // // copyCelestialToSVG();
        //     // // Celestial.exportSVG("asd")
        //     // // exportSVG("asd");
        //     // $("#copy-svg").trigger("click");
        // });
        function copyCelestialToSVG() {
            const celestialContainer = document.getElementById('celestial-map');
            const canvas = celestialContainer.querySelector('canvas');
            
            if (!canvas) {
                console.error('Nem tal√°lhat√≥ Canvas a Celestial t√©rk√©pben');
                return;
            }
            
            // Canvas tartalom konvert√°l√°sa data URL-l√©
            const dataURL = canvas.toDataURL('image/png');
            
            // √öj SVG l√©trehoz√°sa
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
            
            // Image elem l√©trehoz√°sa a canvas tartalommal
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('href', dataURL);
            image.setAttribute('width', canvas.width);
            image.setAttribute('height', canvas.height);
            image.setAttribute('x', '0');
            image.setAttribute('y', '0');
            
            svg.appendChild(image);
            
            // SVG hozz√°ad√°sa a c√©l kont√©nerhez
            // const targetContainer = document.getElementById('svg-container');
            // const targetContainer = document.getElementById('text-overlay-svg');
            const targetContainer = document.getElementById('designer-svg');
            targetContainer.innerHTML = '';
            targetContainer.appendChild(svg);
            
            console.log('Celestial t√©rk√©p sikeresen m√°solva SVG-be!');
        }
        // // Update settings when form controls change
        // // document.getElementById('projection').addEventListener('change', (e) => {
        // // $(document).on('change', '#projection', function(e) {
        // document.getElementById('projection').addEventListener('change', function(e) {
        //             console.log("projection change e", e);
        //             console.log("projection change e.target.value", e.target.value);
        //     // Celestial.setOption('projection', e.target.value);
        //     // Celestial.refresh();
        //     // Celestial.reproject({projection:<see above>})
        //     // Celestial.reproject({projection:e.target.value})
        // });

        // Update settings when form controls change
        // document.getElementById('projection_').addEventListener('change', (e) => {
        // // $(document).on('change', '#projection', function(e) {
        //             console.log("projection_ change e", e);
        //             console.log("projection_ change e.target.value", e.target.value);
        //             myCelestialConf.projection = e.target.value;
        //     // Celestial.setOption('projection', e.target.value);
        //     // Celestial.refresh();
        //     // Celestial.reproject({projection:<see above>})
        //     // Celestial.reproject({projection: e.target.value})
        //     // Celestial.reproject({projection: e.target.value})

        // // setTimeout(function(){
        //     Celestial.clear();
        //     Celestial.display(myCelestialConf);
        // // }, 2000)
        //     // Celestial.clear();
        //     // Celestial.display(myCelestialConf);
        // });
        // Update settings when form controls change
        document.getElementById('zodiacsigns').addEventListener('change', (e) => {
        // $(document).on('change', '#projection', function(e) {
                    console.log("zodiacsigns change e", e);
                    console.log("zodiacsigns change e.target.value", e.target.value);
                    myCelestialConf.Csillagjegy = e.target.value;
            // Celestial.setOption('projection', e.target.value);
            // Celestial.refresh();
            // Celestial.reproject({projection:<see above>})
            // Celestial.reproject({projection: e.target.value})
            // Celestial.reproject({projection: e.target.value})

        // setTimeout(function(){
            // Celestial.clear();
            // Celestial.display(myCelestialConf);
            Celestial.showConstellation(e.target.value)
        // }, 2000)
            // Celestial.clear();
            // Celestial.display(myCelestialConf);
        });

        // // // Update settings when form controls change
        // document.getElementById('projectionnn').addEventListener('click', (e) => {
        // // $(document).on('click', '#projectionnn', function(e) {
        //             console.log("projection change e", e);
        //             console.log("projection change e.target.value", e.target.value);
        //     // Celestial.setOption('projection', e.target.value);
        //     // Celestial.refresh();
        //     // Celestial.reproject({projection:<see above>})
        //     // Celestial.reproject({projection:e.target.value})
        // });
        /**
         * A Celestial t√©rk√©p igaz√≠t√°sa a v√°sznon
         */
        // function alignCelestialMap(position = 'center') {
        //     if (!getDOMElements()) return;
            
        //     const celestialMap = document.getElementById('celestial-map-container');
        //     const svgElement = celestialMap.querySelector('svg');
            
        //     if (!svgElement) {
        //         console.warn("Nincs SVG elem az igaz√≠t√°shoz");
        //         return;
        //     }
            
        //     // Az SVG m√©reteinek lek√©r√©se
        //     const svgViewBox = svgElement.getAttribute('viewBox');
        //     if (!svgViewBox) return;
            
        //     const viewBoxParts = svgViewBox.split(' ').map(Number);
        //     const svgWidth = viewBoxParts[2];
        //     const svgHeight = viewBoxParts[3];
            
        //     // A kont√©ner m√©reteinek lek√©r√©se
        //     const containerViewBox = textOverlaySVG.getAttribute('viewBox').split(' ').map(Number);
        //     const containerWidth = containerViewBox[2];
        //     const containerHeight = containerViewBox[3];
            
        //     // Sz√°m√≠tsuk ki az ar√°nyt √©s az √∫j poz√≠ci√≥t
        //     const scale = Math.min(containerWidth / svgWidth, containerHeight / svgHeight);
        //     const scaledWidth = svgWidth * scale;
        //     const scaledHeight = svgHeight * scale;
            
        //     // Poz√≠ci√≥k sz√°m√≠t√°sa
        //     let x, y;
            
        //     switch(position) {
        //         case 'top':
        //             x = (containerWidth - scaledWidth) / 2;
        //             y = 0;
        //             break;
        //         case 'bottom':
        //             x = (containerWidth - scaledWidth) / 2;
        //             y = containerHeight - scaledHeight;
        //             break;
        //         case 'center':
        //         default:
        //             x = (containerWidth - scaledWidth) / 2;
        //             y = (containerHeight - scaledHeight) / 2;
        //             break;
        //     }
            
        //     // Alkalmazzuk az √∫j poz√≠ci√≥t
        //     svgElement.setAttribute('x', x);
        //     svgElement.setAttribute('y', y);
        //     svgElement.setAttribute('width', scaledWidth);
        //     svgElement.setAttribute('height', scaledHeight);
            
        //     console.log(`Celestial t√©rk√©p igaz√≠tva: ${position}`);
        // }

        // const GOOGLE_API_KEY = "AIzaSyAksFO9HeXBhjzvKKzCPndnr-jxy1JPGwE"; csak fontshoz
        const GOOGLE_API_KEY = "AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s"; 
        // K√©rt bet≈±t√≠pusok
        // const fontNames = ['Merriweather', 'Montserrat', 'Roboto', 'Open Sans'];
        const fontNames = [
          'Montserrat',
          'Roboto', 
          'Open Sans',
          'Merriweather',
          'Playfair Display',
          'Raleway',
          'Inter',
          'Source Sans Pro',
          'Source Sans 3',
          'Source Code Pro',
          'Noto Sans',
          'Abril Fatface',
          'Cormorant',
          'JetBrains Mono',
          'EB Garamond',
          'Cinzel',
          'MedievalSharp',
          'Uncial Antiqua',
          'Great Vibes',
          'Tangerine',
          'Special Elite',
          'Dancing Script',
          'Allura',
          'Sacramento',
          'Quicksand',
          'Parisienne'
        ];
        
        // Font vari√°nsok lek√©rdez√©se
        async function loadAndDisplayFonts() {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/webfonts/v1/webfonts?key=${GOOGLE_API_KEY}`
                );
                
                if (!response.ok) throw new Error('API hiba');
                
                const data = await response.json();
                const container = document.getElementById('font-tests');
                
                fontNames.forEach(fontName => {
                    const font = data.items.find(f => f.family === fontName);
                    if (font) {
                        const fontSection = document.createElement('div');
                        fontSection.className = 'font-test';
                        
                        // fontSection.innerHTML = `
                        //     <div class="font-name">${fontName}</div>
                        //     <div class="variant-grid">
                        //         ${font.variants.map(variant => `
                        //             <div class="variant-item">
                        //                 <div class="variant-header">
                        //                     <span>${variant}</span>
                        //                     <span>${getVariantInfo(variant).name}</span>
                        //                 </div>
                        //                 <div class="variant-preview" style="
                        //                     font-family: '${fontName}';
                        //                     font-weight: ${getVariantInfo(variant).weight};
                        //                     font-style: ${getVariantInfo(variant).style};
                        //                 ">
                        //                     √Årv√≠zt≈±r≈ë t√ºk√∂rf√∫r√≥g√©p
                        //                 </div>
                        //             </div>
                        //         `).join('')}
                        //     </div>
                        // `;
                        var fonts_opt = document.createElement('option');
                        // fonts_opt.innerHTML = `
                        //     <option value="${fontName}"
                        //             style="
                        //             font-family: '${fontName}';
                        //     ">${fontName}</option>
                        // `;
                        // fonts_opt.innerHTML = `${fontName}`;
                        // fonts_opt.innerHTML = "Szeretettel T≈ëlem Neked!";
                        // $(fonts_opt).css("font-family", fontName);
                        // var fff = `${font.variants.map(variant => `
                        //             <option style="font-family: '${fontName}';font-weight: ${getVariantInfo(variant).weight};font-style: ${getVariantInfo(variant).style};" value="${fontName}_${getVariantInfo(variant).name}">
                        //             ${fontName}_${getVariantInfo(variant).name}
                        //             </option>
                        //         `).join('')}
                        // `;
                        var fff = `${font.variants.map(variant => `
                                    <option style="font-family: '${fontName}';font-weight: ${getVariantInfo(variant).weight};font-style: ${getVariantInfo(variant).style};" value="${fontName}_${getVariantInfo(variant).name}">Szeretettel T≈ëlem Neked!
                                    </option>
                                `).join('')}
                        `;

                        // var fonts_opt = 
                        // $(fonts_opt).css("font-family", fontName);
                        $("#font_").append(fff)
                        
                        // container.appendChild(fontSection);
                    }
                });
                
            } catch (error) {
                console.error('Hiba:', error);
                document.getElementById('font-tests').innerHTML = 
                    '<p>Hiba a bet≈±t√≠pusok bet√∂lt√©s√©ben. Ellen≈ërizd az API kulcsot.</p>';
            }
        }
        
        function getVariantInfo(variant) {
            const weightNames = {
                100: 'Thin 100',
                200: 'ExtraLight 200',
                300: 'Light 300',
                400: 'Regular 400',
                500: 'Medium 500',
                600: 'SemiBold 600',
                700: 'Bold 700',
                800: 'ExtraBold 800',
                900: 'Black 900'
            };
            
            let weight = 400;
            let style = 'normal';
            let name = '';
            
            if (variant === 'regular') {
                weight = 400;
                style = 'normal';
                name = 'Regular 400';
            } else if (variant === 'italic') {
                weight = 400;
                style = 'italic';
                name = 'Regular 400 Italic';
            } else if (variant.includes('italic')) {
                weight = parseInt(variant.replace('italic', ''));
                style = 'italic';
                name = `${weightNames[weight]} Italic`;
            } else {
                weight = parseInt(variant);
                style = 'normal';
                name = weightNames[weight];
            }
            
            return { weight, style, name };
        }
        // // --- √öJ SEG√âDF√úGGV√âNY A M√âRETEZ√âSHEZ ---
        // function getOptimalMapSize() {
        //     var containerWidth = $("#map-wrap").width();
        //     var windowHeight = $(window).height();
        //     // A kisebbik 95%-a, hogy biztosan kif√©rjen
        //     return Math.min(containerWidth, windowHeight) * 0.95;
        // }
        // --- JAV√çTOTT M√âRETEZ√âS (Kezeli a rejtett √°llapotot is) ---
        // function getOptimalMapSize() {
        //     var containerWidth = $("#map-wrap").width();
        //     var windowHeight = $(window).height();
            
        //     // Ha a #map-wrap rejtett (width=0), akkor az ablak sz√©less√©g√©b≈ël becsl√ºnk
        //     if (!containerWidth || containerWidth === 0) {
        //         // Mobilon teljes sz√©less√©g, asztalin√°l kb. 70% (a sidebar miatt)
        //         containerWidth = $(window).width() * ($(window).width() > 768 ? 0.7 : 1.0);
        //     }

        //     // Biztons√°gi ellen≈ërz√©s
        //     if (containerWidth === 0) containerWidth = 500;

        //     return Math.min(containerWidth, windowHeight) * 0.95;
        // }
        // --- JAV√çTOTT M√âRETEZ√âS (Kezeli a rejtett √°llapotot is) ---
        // function getOptimalMapSize() {
        //     var containerWidth = $("#map-wrap").width();
        //     var windowHeight = $(window).height();
            
        //     // Ha a #map-wrap rejtett (width=0), akkor az ablak sz√©less√©g√©b≈ël becsl√ºnk
        //     if (!containerWidth || containerWidth === 0) {
        //         // Desktopon kb a k√©perny≈ë 70%-a a t√©rk√©p helye, mobilon 100%
        //         var ratio = ($(window).width() > 768) ? 0.7 : 1.0;
        //         containerWidth = $(window).width() * ratio;
        //     }

        //     // V√©gs≈ë biztons√°gi ellen≈ërz√©s: ne legyen 0
        //     if (containerWidth < 100) containerWidth = 500;

        //     // A kisebbik 95%-a, hogy biztosan kif√©rjen
        //     return Math.min(containerWidth, windowHeight) * 0.95;
        // }
        // --- JAV√çTOTT M√âRETEZ√âS (Rejtett √°llapotban is m≈±k√∂dik) ---
        function getOptimalMapSize() {
            console.log("getOptimalMapSize qwe");
            var containerWidth = $("#map-wrap").width();
            var windowHeight = $(window).height();
            
            // Ha rejtett (width=0), az ablakb√≥l sz√°molunk
            if (!containerWidth || containerWidth === 0) {
                var ratio = ($(window).width() > 768) ? 0.7 : 1.0;
                containerWidth = $(window).width() * ratio;
            }
            if (containerWidth < 100) containerWidth = 500; // Fallback

            return Math.min(containerWidth, windowHeight) * 0.95;
        }


        // --- 1. IND√çT√ÅSKOR M√âRETEZ√âS ---
        setTimeout(function(){
          console.log("setTimeout(function(){ qwe");
            Celestial.resize({width: getOptimalMapSize()});
        }, 100);

        // // --- 2. PROJEKCI√ì V√ÅLT√ÅSKOR √öJRAM√âRETEZ√âS √âS FRISS√çT√âS ---
        // document.getElementById('projection_').addEventListener('change', (e) => {
        //     console.log("Projekci√≥ v√°lt√°s:", e.target.value);
            
        //     // Be√°ll√≠tjuk az √∫j projekci√≥t
        //     myCelestialConf.projection = e.target.value;
            
        //     // FONTOS: Friss√≠tj√ºk a sz√©less√©get az aktu√°lis ablakm√©rethez
        //     myCelestialConf.width = getOptimalMapSize();
        //     // myCelestialConf.projection = e.target.value;
            
        //     // T√∂rl√©s √©s √∫jrarajzol√°s az √∫j m√©rettel √©s projekci√≥val
        //     // Celestial.reproject(myCelestialConf);
        //     // Celestial.clear();
        //     Celestial.display(myCelestialConf);
        //     setTimeout(function(){
        //       Celestial.resize({width: getOptimalMapSize()});
        //     }, 1000);
        //     // 4. K√âSLELTETETT IGAZ√çT√ÅS (Ez a l√©nyeg a Wernerhez!)
        //     // Megv√°rjuk, am√≠g a D3 kirajzolja a sz√≠v alakot, √©s ut√°na igaz√≠tjuk k√∂z√©pre
        //     // if(window.alignCelestialMap) {
        //     // console.log("window.alignCelestialMap");
        //     //     setTimeout(function() {
        //     // console.log("window.alignCelestialMap setTimeout");
        //     //         window.alignCelestialMap('center');
        //     //     }, 1000); // 200ms el√©g a kirajzol√°shoz
        //     // }
        // });

        // // --- PROJEKCI√ì V√ÅLT√ÅSKOR √öJRAM√âRETEZ√âS √âS FRISS√çT√âS ---
        // document.getElementById('projection_').addEventListener('change', (e) => {
        //     console.log("Projekci√≥ v√°lt√°s:", e.target.value);
            
        //     // 1. Be√°ll√≠tjuk az √∫j projekci√≥t
        //     myCelestialConf.projection = e.target.value;
            
        //     // 2. Kisz√°moljuk az optim√°lis m√©retet a #map-wrap alapj√°n
        //     var newSize = getOptimalMapSize();
        //     myCelestialConf.width = newSize;
            
        //     // 3. Kirajzol√°s (Ez reseteli a t√©rk√©pet)
        //     Celestial.display(myCelestialConf);
            
        //     // 4. K√âNYSZER√çTETT √ÅTM√âRETEZ√âS (Ez teszi k√∂z√©pre!)
        //     // Kis k√©sleltet√©ssel h√≠vjuk meg a resize-t, ami √∫jrasz√°molja 
        //     // a k√∂zepet (translate) az √∫j vet√ºlet befoglal√≥ m√©reteihez.
        //     setTimeout(function(){
        //         Celestial.resize({width: newSize});
        //     }, 50);
        // });
        // --- 2. PROJEKCI√ì V√ÅLT√ÅSKOR √öJRAM√âRETEZ√âS √âS IGAZ√çT√ÅS ---
        document.getElementById('projection_').addEventListener('change', (e) => {
            // console.log("Projekci√≥ v√°lt√°s:", e.target.value);
            
            // // 1. Projekci√≥ be√°ll√≠t√°sa
            // myCelestialConf.projection = e.target.value;
            // myCelestialConf.width = getOptimalMapSize();
            
            // // 2. Kirajzol√°s
            // Celestial.display(myCelestialConf);
            
            // // 3. UT√ìLAGOS KORREKCI√ì (Ez fogja helyretenni!)
            // setTimeout(function(){
            //     // El≈ësz√∂r m√©retezz√ºk √°t a kont√©nerhez
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         console.log(">>> Sz√≠v alak igaz√≠t√°sa...");
                    
            //         var mapProj = Celestial.mapProjection; // Hozz√°f√©r√©s a D3 vet√ºlethez
            //         var t = mapProj.translate(); // Lek√©rj√ºk a jelenlegi [x, y] poz√≠ci√≥t
                    
            //         // --- ITT √ÅLL√çTSD AZ ELTOL√ÅST! ---
            //         // t[1] az Y tengely (f√ºgg≈ëleges).
            //         // Ha a t√©rk√©p FENT van, n√∂veld ezt a sz√°mot (pl. +150), hogy LEFEL√â menjen.
            //         // Ha t√∫l lent van, cs√∂kkentsd vagy haszn√°lj m√≠nuszt.
                    
            //         t[1] += 100; // 150 pixel lefel√© tol√°s. Pr√≥b√°ld ki: 100, 150, 200...
                    
            //         mapProj.translate(t); // Vissza√≠rjuk az √∫j poz√≠ci√≥t
            //         Celestial.redraw();   // √öjrarajzoljuk a t√©rk√©pet az √∫j helyen
            //     }
                
            // }, 150); // Pici k√©sleltet√©s kell, hogy a Celestial v√©gezzen az alapbe√°ll√≠t√°ssal
          changeProjection(e.target.value);
        });
        function changeProjection(mire) {
            console.log("Projekci√≥ v√°lt√°s: qwe", mire);
            
            // 1. Projekci√≥ be√°ll√≠t√°sa
            myCelestialConf.projection = mire;
            myCelestialConf.width = getOptimalMapSize();
            
            // 2. Kirajzol√°s
            Celestial.display(myCelestialConf);
            
            // 3. UT√ìLAGOS KORREKCI√ì (Ez fogja helyretenni!)
            setTimeout(function(){
                // El≈ësz√∂r m√©retezz√ºk √°t a kont√©nerhez
                Celestial.resize({width: getOptimalMapSize()});
                
                // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
                if (myCelestialConf.projection === 'customHeart') {
                    console.log(">>> Sz√≠v alak igaz√≠t√°sa...");
                    
                    var mapProj = Celestial.mapProjection; // Hozz√°f√©r√©s a D3 vet√ºlethez
                    var t = mapProj.translate(); // Lek√©rj√ºk a jelenlegi [x, y] poz√≠ci√≥t
                    
                    // --- ITT √ÅLL√çTSD AZ ELTOL√ÅST! ---
                    // t[1] az Y tengely (f√ºgg≈ëleges).
                    // Ha a t√©rk√©p FENT van, n√∂veld ezt a sz√°mot (pl. +150), hogy LEFEL√â menjen.
                    // Ha t√∫l lent van, cs√∂kkentsd vagy haszn√°lj m√≠nuszt.
                    
                    t[1] += 100; // 150 pixel lefel√© tol√°s. Pr√≥b√°ld ki: 100, 150, 200...
                    
                    mapProj.translate(t); // Vissza√≠rjuk az √∫j poz√≠ci√≥t
                    Celestial.redraw();   // √öjrarajzoljuk a t√©rk√©pet az √∫j helyen
                }
                
            }, 150); // Pici k√©sleltet√©s kell, hogy a Celestial v√©gezzen az alapbe√°ll√≠t√°ssal
        }

        // function changeProjection(mire) {
            // console.log("Projekci√≥ v√°lt√°s: qwe", mire);
            
            // 1. Projekci√≥ be√°ll√≠t√°sa
            // myCelestialConf.projection = mire;
            // myCelestialConf.width = getOptimalMapSize();
            
            // 2. Kirajzol√°s
            // Celestial.display(myCelestialConf);

            // // 3. UT√ìLAGOS KORREKCI√ì (Prec√≠zi√≥s igaz√≠t√°s)
            // setTimeout(function(){
            //     // 1. L√©p√©s: M√©retez√©s a kont√©nerhez (Ez reseteli a poz√≠ci√≥t alap√°llapotra)
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         console.log(">>> Sz√≠v alak PRECIZ√çOS igaz√≠t√°sa...");
                    
            //         var mapProj = Celestial.mapProjection;
            //         if (!mapProj) return; // Biztons√°gi ellen≈ërz√©s

            //         // --- A MATEMATIKA ---
                    
            //         // 2. Megm√©rj√ºk a VET√úLET (a sz√≠v alak) pontos hely√©t √©s m√©ret√©t
            //         // L√©trehozunk egy D3 √∫tvonal gener√°tort az aktu√°lis vet√ºlettel
            //         var path = d3.geo.path().projection(mapProj);
                    
            //         // L√©trehozunk egy "graticule" (fokh√°l√≥zat) objektumot.
            //         // Ennek az "outline" (k√∂rvonal) tulajdons√°ga adja ki a teljes sz√≠v form√°t.
            //         var graticule = d3.geo.graticule();
            //         var outline = graticule.outline();
                    
            //         // A .bounds() visszaadja a befoglal√≥ dobozt: [[x_bal, y_fent], [x_jobb, y_lent]]
            //         var bounds = path.bounds(outline);
                    
            //         // Kisz√°moljuk, hol van MOST a sz√≠v k√∂zepe f√ºgg≈ëlegesen
            //         var mapTop = bounds[0][1];
            //         var mapBottom = bounds[1][1];
            //         var mapHeight = mapBottom - mapTop;
            //         var mapCenterY = mapTop + (mapHeight / 2);
                    
            //         console.log("mapTop", mapTop);
            //         console.log("mapBottom", mapBottom);
            //         console.log("mapHeight", mapHeight);
            //         console.log("mapCenterY", mapCenterY);
            //         // 3. Megn√©zz√ºk, hol van a V√ÅSZON k√∂zepe
            //         var canvas = document.querySelector('#celestial-map canvas');
            //         var canvasHeight = canvas.height;
            //         var canvasCenterY = canvasHeight / 2;
                    
            //         // 4. Kisz√°moljuk a sz√ºks√©ges ELTOL√ÅST (Delta)
            //         // Ha a t√©rk√©p k√∂zepe (mapCenterY) pl. 300, de a v√°szon√© (canvasCenterY) 500,
            //         // akkor +200 pixellel kell lejjebb tolni.
            //         var deltaY = canvasCenterY - mapCenterY;
                    
            //         console.log(`M√©r√©s: T√©rk√©pK√∂z√©p=${mapCenterY.toFixed(1)}, V√°szonK√∂z√©p=${canvasCenterY.toFixed(1)} -> Eltol√°s=${deltaY.toFixed(1)}px`);


            //         // 5. Alkalmazzuk az eltol√°st
            //         var currentTranslate = mapProj.translate();
            //         console.log("currentTranslate[0]", currentTranslate[0]);
            //         console.log("currentTranslate[1]", currentTranslate[1]);
            //         console.log("currentTranslate[1] + deltaY", currentTranslate[1] + deltaY);
            //         // [X marad (az m√°r j√≥), Y-hoz hozz√°adjuk a sz√°m√≠tott delt√°t]
            //         // mapProj.translate([currentTranslate[0], currentTranslate[1] + deltaY]);
                    
            //         // 6. √öjrarajzol√°s a t√∂k√©letes poz√≠ci√≥ban
            //         Celestial.redraw();
            //     }
                
            // }, 150); // Pici v√°rakoz√°s a resize ut√°n
            // 3. UT√ìLAGOS KORREKCI√ì (M√©r√©s, √Åtm√©retez√©s √©s K√∂z√©pre z√°r√°s)
            // setTimeout(function(){
            //     // 1. Alap m√©retez√©s
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         console.log(">>> Sz√≠v alak INTELIGENS igaz√≠t√°sa...");
                    
            //         var mapProj = Celestial.mapProjection;
            //         if (!mapProj) return;

            //         var canvas = document.querySelector('#celestial-map canvas');
            //         if (!canvas) return;

            //         // A) M√©rj√ºk meg a vet√ºlet pontos befoglal√≥ m√©reteit (a teljes g√∂mb√∂t alapul v√©ve)
            //         var path = d3.geo.path().projection(mapProj);
            //         var bounds = path.bounds({type: "Sphere"});
                    
            //         var mapTop = bounds[0][1];
            //         var mapBottom = bounds[1][1];
            //         var mapHeight = mapBottom - mapTop;
                    
            //         // B) ELLEN≈êRZ√âS: Ha a t√©rk√©p magasabb, mint a v√°szon, kicsiny√≠teni kell!
            //         // Hagyunk 5% marg√≥t (canvas.height * 0.95)
            //         var maxHeight = canvas.height * 0.95;
                    
            //         if (mapHeight > maxHeight) {
            //             console.log("A t√©rk√©p t√∫l magas, √°tm√©retez√©s...");
            //             // Kisz√°moljuk az ar√°nyt, amennyivel cs√∂kkenteni kell a sz√©less√©get (hogy a magass√°g is cs√∂kkenjen)
            //             var ratio = maxHeight / mapHeight;
            //             var currentWidthSettings = Celestial.metrics().width; // Jelenlegi sz√©less√©g be√°ll√≠t√°s
                        
            //             // Alkalmazzuk az √∫j, kisebb sz√©less√©get
            //             Celestial.resize({width: currentWidthSettings * ratio});
                        
            //             // √öjram√©r√©s az √°tm√©retez√©s ut√°n (mert v√°ltoztak a koordin√°t√°k)
            //             mapProj = Celestial.mapProjection;
            //             path = d3.geo.path().projection(mapProj);
            //             bounds = path.bounds({type: "Sphere"});
            //             mapTop = bounds[0][1];
            //             mapBottom = bounds[1][1];
            //             mapHeight = mapBottom - mapTop;
            //         }

            //         // C) K√ñZ√âPRE IGAZ√çT√ÅS (F√ºgg≈ëlegesen)
            //         var mapCenterY = mapTop + (mapHeight / 2);
            //         var canvasCenterY = canvas.height / 2;
            //         var eee = (canvas.height - mapHeight) / 2;
                    
            //         // Ennyivel kell eltolni, hogy fed√©sbe ker√ºljenek a k√∂zepek
            //         var deltaY = canvasCenterY - mapCenterY;
                    
            //         console.log(`Igaz√≠t√°s: T√©rk√©p k√∂z√©p=${mapCenterY.toFixed(0)}, V√°szon k√∂z√©p=${canvasCenterY.toFixed(0)} -> Eltol√°s=${deltaY.toFixed(0)}px`);

            //         // Alkalmazzuk a transzform√°ci√≥t
            //         var t = mapProj.translate();
            //             console.log("canvas.height", canvas.height);
            //             console.log("mapHeight", mapHeight);
            //             console.log("eee", eee);
            //             console.log("t[0]", t[0]);
            //             console.log("t[1]", t[1]);
            //         // mapProj.translate([t[0], t[1] + deltaY]);
            //         mapProj.translate([t[0],  t[1] + eee]);
                    
            //         Celestial.redraw();
            //     }
                
            // }, 150);
            // 3. UT√ìLAGOS KORREKCI√ì (P√≥lus-alap√∫ prec√≠zi√≥s igaz√≠t√°s)
            // setTimeout(function(){
            //     // √öjram√©retez√©s
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         console.log(">>> Sz√≠v alak P√ìLUS-ALAP√ö igaz√≠t√°sa...");
                    
            //         var mapProj = Celestial.mapProjection;
            //         if (!mapProj) return;

            //         var canvas = document.querySelector('#celestial-map canvas');
            //         if (!canvas) return;

            //         // A) Kisz√°moljuk a sz√≠v fix pontjait (P√≥lusok)
            //         // [0, 90] = √âszaki p√≥lus (a sz√≠v fels≈ë cs√ºcske/beharap√°sa)
            //         // [0, -90] = D√©li p√≥lus (a sz√≠v als√≥ hegye)
            //         var topPoint = mapProj([0, 90]);  
            //         var bottomPoint = mapProj([0, -90]);

            //         if (topPoint && bottomPoint) {
            //             var axisTopY = topPoint[1];
            //             var axisBottomY = bottomPoint[1];
            //             var axisHeight = axisBottomY - axisTopY;

            //             // B) BECS√úLT MAGASS√ÅG (A lebenyek miatt)
            //             // A sz√≠v "v√°lla" (lebenyei) feljebb vannak, mint a cs√ºcs√∂k.
            //             // Tapasztalat alapj√°n a lebenyek kb. a magass√°g 20-25%-√°val ny√∫lnak a cs√ºcs√∂k f√∂l√©.
            //             var lobeCorrection = axisHeight * 0.25; 
                        
            //             var visualTop = axisTopY - lobeCorrection; // A vizu√°lis teteje
            //             var visualBottom = axisBottomY;            // A vizu√°lis alja
            //             var visualHeight = visualBottom - visualTop;
            //             var visualCenterY = visualTop + (visualHeight / 2);

            //             // C) V√ÅSZON K√ñZEPE
            //             var canvasCenterY = canvas.height / 2;

            //             // D) ELTOL√ÅS SZ√ÅM√çT√ÅSA
            //             // Ennyivel kell eltolni, hogy a vizu√°lis k√∂z√©p a v√°szon k√∂zep√©re essen
            //             var deltaY = canvasCenterY - visualCenterY;

            //             console.log(`Igaz√≠t√°s: Sz√≠vK√∂z√©p=${visualCenterY.toFixed(0)}, V√°szonK√∂z√©p=${canvasCenterY.toFixed(0)} -> Eltol√°s=${deltaY.toFixed(0)}px`);

            //             // E) ALKALMAZ√ÅS
            //             var t = mapProj.translate();
            //             mapProj.translate([t[0], t[1] + deltaY]);
                        
            //             Celestial.redraw();
            //         }
            //     }
                
            // }, 150);

            // // 3. UT√ìLAGOS KORREKCI√ì (Stabil Geometriai Igaz√≠t√°s)
            // setTimeout(function(){
            //     // A) √öjram√©retez√©s a kont√©nerhez (Reset)
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         console.log(">>> Sz√≠v alak STABIL igaz√≠t√°sa...");
                    
            //         var mapProj = Celestial.mapProjection;
            //         var canvas = document.querySelector('#celestial-map canvas');
                    
            //         if (mapProj && canvas) {
            //             var w = canvas.width;
            //             var h = canvas.height;

            //             // 1. V√≠zszintes k√∂z√©p: A v√°szon fele
            //             var centerX = w / 2;

            //             // 2. F√ºgg≈ëleges k√∂z√©p + OPTIKAI KORREKCI√ì
            //             // A sz√≠v alak geometriai k√∂z√©ppontja magasabban van, mint a vizu√°lis k√∂zepe.
            //             // Ez√©rt a v√°szon fel√©hez hozz√°adunk a magass√°g 12%-√°t.
            //             // Ez matematikai t√©ny a Werner vet√ºletn√©l, nem kell m√©rni.
            //             var centerY = (h / 2) + (h * 0.12); 

            //             // 3. Alkalmazzuk a fix eltol√°st
            //             mapProj.translate([centerX, centerY]);
                        
            //             // 4. √öjrarajzol√°s a helyes poz√≠ci√≥ban
            //             Celestial.redraw();
            //         }
            //     }
            // }, 100); // 100ms v√°rakoz√°s el√©g a resize ut√°n
            // 3. PRECIZ√çOS IGAZ√çT√ÅS (Bounding Box Center)
            // setTimeout(function(){
            //     // Kont√©nerhez igaz√≠t√°s
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         var mapProj = Celestial.mapProjection;
            //         var canvas = document.querySelector('#celestial-map canvas');
                    
            //         if (mapProj && canvas) {
            //             // A) L√©trehozunk egy √∫tvonal gener√°tort a m√©r√©shez
            //             var path = d3.geo.path().projection(mapProj);
                        
            //             // B) Lek√©rj√ºk a teljes sz√≠v alakot (a fokh√°l√≥zat keret√©t)
            //             var outline = d3.geo.graticule().outline();
                        
            //             // C) Megm√©rj√ºk a jelenlegi pixeleket: [[bal, fent], [jobb, lent]]
            //             var b = path.bounds(outline);
                        
            //             // D) Kisz√°moljuk a sz√≠v jelenlegi vizu√°lis k√∂zep√©t
            //             var heartCenterX = (b[0][0] + b[1][0]) / 2;
            //             var heartCenterY = (b[0][1] + b[1][1]) / 2;
                        
            //             // E) Kisz√°moljuk a v√°szon k√∂zep√©t
            //             var canvasCenterX = canvas.width / 2;
            //             var canvasCenterY = canvas.height / 2;
                        
            //             // F) Kisz√°moljuk az eltol√°st (Delta)
            //             // Ennyivel kell arr√©bb tolni, hogy fed√©sbe ker√ºljenek
            //             var dx = canvasCenterX - heartCenterX;
            //             var dy = canvasCenterY - heartCenterY;
                        
            //             console.log(`Igaz√≠t√°s: DeltaX=${dx.toFixed(0)}, DeltaY=${dy.toFixed(0)}`);

            //             // G) Alkalmazzuk a jelenlegi transzform√°ci√≥hoz hozz√°adva
            //             var t = mapProj.translate();
            //             mapProj.translate([t[0] + dx, t[1] + dy]);
                        
            //             // H) √öjrarajzol√°s
            //             Celestial.redraw();
            //         }
            //     }
            // }, 150);
            // 3. UT√ìLAGOS KORREKCI√ì (Fix Matematikai Igaz√≠t√°s)
            // setTimeout(function(){
            //     // 1. M√©retez√©s a kont√©nerhez (Reset)
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         var mapProj = Celestial.mapProjection;
            //         var canvas = document.querySelector('#celestial-map canvas');
                    
            //         if (mapProj && canvas) {
            //             var w = canvas.width;
            //             var h = canvas.height;

            //             // --- A MEGOLD√ÅS KULCSA ---
                        
            //             // 1. X TENGELY: Szigor√∫an a v√°szon fele! 
            //             // Nem m√©r√ºnk bounding boxot, mert az elcs√∫szhat.
            //             var centerX = w / 2;

            //             // 2. Y TENGELY: A v√°szon fele + 15% lefel√© tol√°s
            //             // Ez a +15% (h * 0.15) biztos√≠tja, hogy a sz√≠v "teteje" ne l√≥gjon ki,
            //             // √©s a forma optikailag k√∂z√©pen legyen.
            //             var centerY = (h / 2) + (h * 0.15); 

            //             console.log(`Igaz√≠t√°s: [${centerX}, ${centerY}]`);

            //             // 3. Alkalmazzuk a k√©nyszer√≠tett poz√≠ci√≥t
            //             mapProj.translate([centerX, centerY]);
                        
            //             // 4. √öjrarajzol√°s
            //             Celestial.redraw();
            //         }
            //     }
            // }, 100);
            // 3. UT√ìLAGOS KORREKCI√ì (Fix Matematikai Igaz√≠t√°s)
            // setTimeout(function(){
            //     // M√©retez√©s a kont√©nerhez
            //     Celestial.resize({width: getOptimalMapSize()});
                
            //     // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            //     if (myCelestialConf.projection === 'customHeart') {
            //         var mapProj = Celestial.mapProjection;
            //         var canvas = document.querySelector('#celestial-map canvas');
                    
            //         if (mapProj && canvas) {
            //             var w = canvas.width;
            //             var h = canvas.height;

            //             // --- A MEGOLD√ÅS KULCSA ---
                        
            //             // 1. X TENGELY: Szigor√∫an a v√°szon fele! 
            //             // Nem m√©r√ºnk bounding boxot, mert az elcs√∫szhat.
            //             var centerX = w / 2;

            //             // 2. Y TENGELY: A v√°szon fele + 15% lefel√© tol√°s
            //             // Ez a +15% (h * 0.15) biztos√≠tja, hogy a sz√≠v "teteje" ne l√≥gjon ki,
            //             // √©s a forma optikailag k√∂z√©pen legyen.
            //             var centerY = (h / 2) + (h * 0.15); 

            //             console.log(`Igaz√≠t√°s: [${centerX}, ${centerY}]`);

            //             // 3. Alkalmazzuk a k√©nyszer√≠tett poz√≠ci√≥t
            //             mapProj.translate([centerX, centerY]);
                        
            //             // 4. √öjrarajzol√°s
            //             Celestial.redraw();
            //         }
            //     }
            // }, 100);
        // }

        // Ablak √°tm√©retez√©sekor is igazodjon (Opcion√°lis, de hasznos)
        $(window).resize(function() {
            Celestial.resize({width: getOptimalMapSize()});
            // 3. UT√ìLAGOS KORREKCI√ì (Ez fogja helyretenni!)
            setTimeout(function(){
                // El≈ësz√∂r m√©retezz√ºk √°t a kont√©nerhez
                Celestial.resize({width: getOptimalMapSize()});
                
                // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
                if (myCelestialConf.projection === 'customHeart') {
                    console.log(">>> Sz√≠v alak igaz√≠t√°sa...");
                    
                    var mapProj = Celestial.mapProjection; // Hozz√°f√©r√©s a D3 vet√ºlethez
                    var t = mapProj.translate(); // Lek√©rj√ºk a jelenlegi [x, y] poz√≠ci√≥t
                    
                    // --- ITT √ÅLL√çTSD AZ ELTOL√ÅST! ---
                    // t[1] az Y tengely (f√ºgg≈ëleges).
                    // Ha a t√©rk√©p FENT van, n√∂veld ezt a sz√°mot (pl. +150), hogy LEFEL√â menjen.
                    // Ha t√∫l lent van, cs√∂kkentsd vagy haszn√°lj m√≠nuszt.
                    
                    t[1] += 100; // 150 pixel lefel√© tol√°s. Pr√≥b√°ld ki: 100, 150, 200...
                    
                    mapProj.translate(t); // Vissza√≠rjuk az √∫j poz√≠ci√≥t
                    Celestial.redraw();   // √öjrarajzoljuk a t√©rk√©pet az √∫j helyen
                }
                
            }, 150); // Pici k√©sleltet√©s kell, hogy a Celestial v√©gezzen az alapbe√°ll√≠t√°ssal
        });
    </script>
</body>
</html>