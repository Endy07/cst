<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Chart Editor - Theme Selector</title>

    <!-- GLOBAL DEBUG LOGGER -->
    <script>
        window.DebugLogger = {
            logs: [],
            originalConsole: {
                log: console.log,
                warn: console.warn,
                error: console.error,
                info: console.info
            },
            init: function () {
                this.interceptConsole();
                this.interceptErrors();
                this.interceptInteractions();
                this.log("System", "Debug Logger Initialized at " + new Date().toISOString());

                if (document.readyState === 'loading') {
                    // document.addEventListener('DOMContentLoaded', () => this.createUIButton());
                } else {
                    // this.createUIButton();
                }
            },
            log: function (type, ...args) {
                const time = new Date().toISOString().split('T')[1].slice(0, -1);
                let msg = '';
                try {
                    msg = args.map(a => {
                        if (typeof a === 'object') {
                            try { return JSON.stringify(a); } catch (e) { return '[Circular]'; }
                        }
                        return String(a);
                    }).join(' ');
                } catch (e) {
                    msg = '[Log Error]';
                }

                const logLine = `[${time}] [${type}] ${msg}`;
                this.logs.push(logLine);

                if (this.originalConsole[type]) {
                    this.originalConsole[type].apply(console, args);
                }
            },
            interceptConsole: function () {
                const self = this;
                ['log', 'warn', 'error', 'info'].forEach(method => {
                    console[method] = function (...args) {
                        self.log(method, ...args);
                    };
                });
            },
            interceptErrors: function () {
                window.onerror = (msg, url, line, col, error) => {
                    this.log('FATAL ERROR', `${msg} at ${url}:${line}:${col}`, error);
                };
                window.addEventListener('unhandledrejection', event => {
                    this.log('PROMISE REJECT', event.reason);
                });
            },
            interceptInteractions: function () {
                document.addEventListener('click', e => {
                    let target = e.target;
                    let info = target.id ? `#${target.id}` : (target.className ? `.${target.className}` : target.tagName);
                    let text = target.innerText ? target.innerText.substring(0, 30).replace(/\n/g, ' ') : '';
                    this.log('CLICK', `${info} ("${text}")`);
                }, true);

                document.addEventListener('change', e => {
                    let target = e.target;
                    if (target.id) this.log('CHANGE', `#${target.id} = "${target.value}"`);
                }, true);
            },
            createUIButton: function () {
                const btn = document.createElement('button');
                btn.innerText = 'üêû';
                btn.title = 'Download Debug Logs';
                btn.style.position = 'fixed';
                btn.style.top = '10px';
                btn.style.left = '10px';
                btn.style.zIndex = '99999';
                btn.style.fontSize = '24px';
                btn.style.background = '#222';
                btn.style.border = '2px solid #ff0000';
                btn.style.color = 'white';
                btn.style.borderRadius = '50%';
                btn.style.width = '50px';
                btn.style.height = '50px';
                btn.style.cursor = 'pointer';
                btn.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
                btn.style.display = 'flex';
                btn.style.alignItems = 'center';
                btn.style.justifyContent = 'center';

                btn.onclick = () => this.download();
                document.body.appendChild(btn);
            },
            download: function () {
                const text = this.logs.join('\n');
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug_log_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };
        window.DebugLogger.init();
    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s&libraries=places"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script type="text/javascript" src="d3.js"></script>
    <script type="text/javascript" src="d3.geo.projection.min.js"></script>
    <link rel="stylesheet" href="celestial.css">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css">

    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-datepicker/1.13.2/i18n/jquery.ui.datepicker-hu.min.js"></script>
    <script
        src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
    <script
        src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-hu.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-addon-i18n.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/save-svg-as-png/1.4.17/saveSvgAsPng.min.js"></script>
    <!-- <script src="fragment5_jo_uj_.js"></script>  -->
    <!-- <script src="fragment5_jo_alap.js"></script> -->
    <!-- <script src="fragment5_jo_copy_apply_refresh_imaget_ad_kisebb_cst_meret_jobb_felbontas.js"></script>  -->
    <!-- <script src="fragment5_themes.js"></script> -->
    <script src="fragment5_themes_e_nezet.js"></script>
    <script src="auto_tester.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Allura&family=Cinzel:wght@400..900&family=Cormorant:ital,wght@0,300..700;1,300..700&family=Dancing+Script:wght@400..700&family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Great+Vibes&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Maven+Pro:wght@400..900&family=MedievalSharp&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Parisienne&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Quicksand:wght@300..700&family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Rye&family=Sacramento&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&family=Special+Elite&family=Tangerine:wght@400;700&family=Uncial+Antiqua&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="celestial_theme_glass.css">
</head>

<body>
    <!-- Liquid Glass Background -->
    <div class="liquid-bg">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
        <div class="blob b4"></div>
        <div class="blob b5"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px);">
        <div class="spinner-border text-light" role="status"
            style="width: 3rem; height: 3rem; border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite;">
        </div>
        <h3 id="loading-text" style="color: white; margin-top: 20px; font-family: 'Montserrat', sans-serif;">
            Feldolgoz√°s...</h3>
        <style>
            @keyframes spinner-border {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>

    <!-- Session Recovery Modal -->
    <div class="modal fade" id="recoveryModal" tabindex="-1" aria-labelledby="recoveryModalLabel" aria-hidden="true"
        data-bs-backdrop="static"
        style="display: none; position: fixed; top: 0; left: 0; z-index: 10055; width: 100%; height: 100%; pointer-events: none;">
        <div class="modal-backdrop-custom"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); pointer-events: auto;">
        </div>
        <div class="modal-dialog modal-dialog-centered"
            style="position: relative; pointer-events: auto; max-width: 500px; margin: 1.75rem auto; display: flex; align-items: center; min-height: calc(100% - 3.5rem);">
            <div class="modal-content glass-modal"
                style="background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); width: 100%; display: flex; flex-direction: column;">
                <div class="modal-header border-0"
                    style="padding: 1.5rem 1.5rem 0.5rem; border-bottom: none; display: flex; align-items: center; justify-content: space-between;">
                    <h5 class="modal-title fw-bold" id="recoveryModalLabel"
                        style="color: #fff; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 1.25rem; margin: 0;">
                        <i class="fas fa-history text-accent me-2"
                            style="color: #4a9eff; margin-right: 0.5rem;"></i>Folytatod a munk√°t?
                    </h5>
                    <!-- No close button to force choice -->
                </div>
                <div class="modal-body"
                    style="color: #ddd; padding: 1rem 1.5rem; font-size: 0.95rem; line-height: 1.5;">
                    √ögy t≈±nik, van egy kor√°bbi mentett tervez√©sed. Szeretn√©d bet√∂lteni √©s onnan folytatni, ahol
                    abbahagytad?
                </div>
                <div class="modal-footer border-0"
                    style="padding: 1rem 1.5rem 1.5rem; border-top: none; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" id="discardSession" class="btn btn-outline-secondary"
                        style="color: #ccc; border-color: #555; background: transparent; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.2s;">√öj
                        tervez√©s</button>
                    <button type="button" id="restoreSession" class="btn btn-accent px-4"
                        style="background: linear-gradient(135deg, #4a9eff, #3a7eff); color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);">Folytat√°s</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Theme Selector -->
    <div class="theme-fab" onclick="toggleThemePanel()" title="Theme Selector">
        <i class="fas fa-palette"></i>
    </div>

    <div class="theme-panel" id="themePanel">
        <div class="theme-panel-header">
            <h3><i class="fas fa-swatchbook"></i> T√©ma V√°laszt√≥</h3>
            <button class="theme-panel-close" onclick="toggleThemePanel()"><i class="fas fa-times"></i></button>
        </div>

        <!-- Custom Color Pickers -->
        <div class="custom-colors-section">
            <h4><i class="fas fa-sliders-h"></i> Egyedi Sz√≠nek</h4>
            <div class="color-picker-row">
                <div class="color-picker-item">
                    <input type="color" id="customBgColor" value="#000000" onchange="updateCustomColor()">
                    <label>H√°tt√©r</label>
                </div>
                <div class="color-picker-item">
                    <input type="color" id="customBlobColor" value="#111111" onchange="updateCustomColor()">
                    <label>Folt</label>
                </div>
                <div class="color-picker-item">
                    <input type="color" id="customAccentColor" value="#FFFFFF" onchange="updateCustomColor()">
                    <label>Kiemel√©s</label>
                </div>
            </div>
            <button class="apply-custom-btn" onclick="applyCustomColors()">
                <i class="fas fa-magic"></i> Alkalmaz√°s
            </button>
        </div>

        <!-- Theme Grid -->
        <div class="theme-grid-scroll" id="themeGridScroll">
            <!-- Themes will be injected here by JavaScript -->
        </div>
    </div>

    <div id="full-screen-designer" style="display: none;">
        <div id="designer-content-wrapper">
            <div id="designer-canvas-area">
                <!-- Bleed preview background - positioned behind canvas-wrapper -->
                <div id="bleed-preview-bg"></div>
                <div id="canvas-wrapper">
                    <div id="canvas-container celestial-map-container">
                        <svg id="designer-svg" viewBox="0 0 1026 1272" preserveAspectRatio="xMidYMid meet"
                            xmlns="http://www.w3.org/2000/svg" style="background-color: #0a0e27;">
                            <defs>
                                <clipPath id="photo-circle-clip">
                                    <circle id="photo-clip-circle" cx="500" cy="500" r="500" />
                                </clipPath>
                            </defs>

                            <g id="photo-transform-group" style="display:none;">
                                <image id="user-photo-img" width="1000" height="1000"
                                    preserveAspectRatio="xMidYMid slice" clip-path="url(#photo-circle-clip)" />
                            </g>

                            <g id="map-transform-group">
                                <g id="celestial-map-layer"></g>
                            </g>

                            <g id="text-layer"></g>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="settingswrap" id="settings-wrap_r">
                <div id="tabs_r">
                    <ul id="mobile_tabs_r">
                        <li><a href="#fragment_r-1">V√°szon</a></li>
                        <li><a href="#fragment_r-2">K√©p</a></li>
                        <li><a href="#fragment_r-3">Sz√∂vegek</a></li>
                        <li><a href="#fragment_r-4">K√©p +</a></li>
                        <li><a href="#fragment_r-5">Sablonok</a></li>
                        <li><a href="#fragment_r-6">Csillagt√©rk√©p szerkeszt≈ë</a></li>
                        <li><a href="#fragment_r-7">OkosPont +</a></li>
                        <li><a href="#fragment_r-8">N√©zet</a></li>
                    </ul>
                    <div id="fragment_r-1">
                        <div class="designer-controls">

                            <!-- 1. V√ÅSZON BE√ÅLL√çT√ÅSOK (√ñsszecsukhat√≥) -->
                            <div class="collapsible-header" data-target="canvas-settings-panel">
                                <!-- <h2 style="margin:0; font-size:14px;">V√ÅSZON BE√ÅLL√çT√ÅSOK</h2> -->
                                <h2 style="margin:0; font-size:14px;">M√âRET BE√ÅLL√çT√ÅSOK</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>

                            <div class="collapsible-content" id="canvas-settings-panel">
                                <div class="section" style="margin-top: 0; margin-bottom: 10px;">
                                    <div class="setting-group">
                                        <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="aspect-ratio-lock"
                                                onchange="toggleResizeLock(this)" checked>
                                            <span>üîí K√©par√°ny √©s T√©rk√©p r√∂gz√≠t√©se</span>
                                        </label>
                                    </div>

                                    <div class="grid-2-cols">
                                        <div class="setting-group" style="margin-bottom: 6px">
                                            <label>Sz√©less√©g (cm):</label>
                                            <input type="number" id="canvas-width" value="21" step="0.1"
                                                class="input-glass"
                                                oninput="handleCanvasParamChange('width', this.value)">
                                        </div>
                                        <div class="setting-group" style="margin-bottom: 6px">
                                            <label>Magass√°g (cm):</label>
                                            <input type="number" id="canvas-height" value="30" step="0.1"
                                                class="input-glass"
                                                oninput="handleCanvasParamChange('height', this.value)">
                                        </div>
                                    </div>

                                    <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                                        <label style="font-size:11px;">Elrendez√©s ir√°nya:</label>
                                        <div style="display: flex; gap: 5px; margin-top:5px;">
                                            <button id="btn-layout-row" class="add-btn primary"
                                                style="flex:1; font-size:11px; padding:8px;"
                                                aria-label="Soros elrendez√©s">‚Üî
                                                Sor</button>
                                            <button id="btn-layout-column" class="add-btn secondary"
                                                style="flex:1; font-size:11px; padding:8px;"
                                                aria-label="Oszlopos elrendez√©s">‚Üï
                                                Oszlop</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 1. V√ÅSZON BE√ÅLL√çT√ÅSOK (√ñsszecsukhat√≥) -->
                            <div class="collapsible-header" data-target="canvas-settings-panel">
                                <!-- <h2 style="margin:0; font-size:14px;">V√ÅSZON BE√ÅLL√çT√ÅSOK</h2> -->
                                <h2 style="margin:0; font-size:14px;">H√ÅTT√âR BE√ÅLL√çT√ÅSOK</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>

                            <div class="collapsible-content" id="canvas-settings-panel">
                                <div class="section" style="margin-top: 10px; margin-bottom: 5px;">
                                    <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">H√ÅTT√âR √âS FAL</h3>
                                    <div class="setting-group"
                                        style="display: flex; gap: 10px; align-items: center; margin-bottom: 5px;">
                                        <label style="font-size:11px; margin-right:5px;">Hat√≥k√∂r:</label>
                                        <div style="display:flex; gap:10px;">
                                            <label
                                                style="font-size:11px; cursor:pointer; display:flex; align-items:center;">
                                                <input type="radio" name="bg-scope" value="individual" checked
                                                    style="margin-right:4px;"> Jelenlegi
                                            </label>
                                            <label
                                                style="font-size:11px; cursor:pointer; display:flex; align-items:center;">
                                                <input type="radio" name="bg-scope" value="common"
                                                    style="margin-right:4px;"> Mind
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-group"
                                        style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                        <div id="simple-bg-container" style="flex: 1;">
                                            <label
                                                style="font-size:11px; display:block; margin-bottom:3px;">H√°tt√©rsz√≠n:</label>
                                            <div style="display:flex; align-items:center; gap:5px;">
                                                <input type="color" id="canvas-bg-color" value="#0a0e27"
                                                    oninput="window.applySolidColor(this.value)" class="input-glass"
                                                    style="height: 38px; cursor: pointer;">
                                            </div>
                                        </div>
                                        <div style="flex: 1;">
                                            <label style="font-size:11px; display:block; margin-bottom:3px;">Fal
                                                sz√≠ne (Szimul√°ci√≥):</label>
                                            <div style="display:flex; align-items:center; gap:5px;">
                                                <input type="color" id="wall-bg-color" value="#BABABA"
                                                    oninput="updateWallColor(this.value)" class="input-glass"
                                                    style="height: 38px; cursor: pointer;">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="collapsible-header"
                                        style="margin-bottom: 0; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-between; padding-right: 10px;">
                                        <div onclick="window.toggleGradientPanel()"
                                            style="display:flex; align-items:center; gap:10px; flex:1; cursor:pointer;">
                                            <span id="gradient-arrow"
                                                style="font-size: 12px; transform: rotate(-90deg); transition: transform 0.3s;">‚ñº</span>
                                            <span
                                                style="font-size: 13px; font-weight: bold; color: var(--text-primary);">T√∂bbsz√≠n≈±
                                                h√°tt√©r (Gradiens)</span>
                                        </div>
                                        <label class="switch" style="margin-left: 10px;">
                                            <input type="checkbox" id="gradient-toggle"
                                                onchange="window.toggleGradientActive(this.checked)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div id="gradient-editor-panel"
                                        style="display: none; padding: 12px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2); margin-bottom: 15px;">
                                        <div style="margin-bottom: 12px;">
                                            <div
                                                style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:5px;">
                                                <label>D≈ël√©ssz√∂g:</label>
                                                <span id="grad-angle-val"
                                                    style="color:white; font-weight:bold;">135¬∞</span>
                                            </div>
                                            <input type="range" id="grad-angle-range" min="0" max="360" value="135"
                                                class="slider-glass" oninput="window.updateGradientFromEditor()">
                                        </div>
                                        <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Sz√≠nek √©s
                                            Poz√≠ci√≥k (%):</div>
                                        <div id="grad-stops-list"
                                            style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
                                        </div>
                                        <button class="btn-glass btn-glass-secondary"
                                            style="width:100%; border-style:dashed;" onclick="window.addGradientStop()">
                                            + √öj sz√≠n hozz√°ad√°sa
                                        </button>
                                    </div>
                                    <div class="collapsible-header" onclick="window.togglePresetList()"
                                        style="margin-bottom: 0; border-radius: 8px;">
                                        <h2
                                            style="margin:0; font-size:14px; color: var(--text-primary); padding-left:0;">
                                            üé® H√°tt√©r Sablonok</h2>
                                        <span class="collapsible-icon" id="preset-arrow"
                                            style="font-size: 12px;">‚ñº</span>
                                    </div>
                                    <div id="bg-presets-container"
                                        style="display: none; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 12px; border: 1px solid var(--border-color); border-top:none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2);">
                                    </div>
                                </div>
                                <div class="section" style="margin-top: 10px; margin-bottom: 5px; display: none;">
                                    <!-- KIFUT√ì (BLEED) BE√ÅLL√çT√ÅSOK SZEKCI√ì -->
                                    <div style="margin-top:15px; border-top:1px solid #444; padding-top:15px;">
                                        <h3 class="small" style="margin-top: 0; margin-bottom: 10px;">üìê KIFUT√ì (BLEED)
                                            BE√ÅLL√çT√ÅSOK</h3>

                                        <!-- M√≥d v√°laszt√≥ -->
                                        <div class="setting-group" style="margin-bottom: 10px;">
                                            <label style="font-size:11px; display:block; margin-bottom: 3px;">Hat√≥k√∂r
                                                (Melyik elemre vonatkozzon?)</label>
                                            <select id="bleed-element-selector" class="select-glass"
                                                onchange="window.handleUnifiedSelection(this.value)">
                                                <!-- JS t√∂lti fel -->
                                            </select>
                                        </div>

                                        <div style="margin-bottom: 12px;">
                                            <label
                                                style="display:flex; align-items:center; margin-bottom: 8px; cursor: pointer; font-size: 12px;">
                                                <input type="radio" name="bleed-mode" value="theme" checked
                                                    style="margin-right: 8px;" onchange="window.setBleedMode('theme')">
                                                <span>üé® Alap√©rtelmezett (T√©ma szerinti)</span>
                                            </label>
                                            <label
                                                style="display:flex; align-items:center; margin-bottom: 8px; cursor: pointer; font-size: 12px;">
                                                <input type="radio" name="bleed-mode" value="theme_local"
                                                    style="margin-right: 8px;"
                                                    onchange="window.setBleedMode('theme_local')">
                                                <span>üé® Alap√©rtelmezett (T√©ma szerint, elemenk√©nt)</span>
                                            </label>
                                            <label
                                                style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                                <input type="radio" name="bleed-mode" value="custom"
                                                    style="margin-right: 8px;" onchange="window.setBleedMode('custom')">
                                                <span>üñåÔ∏è Egy√©ni kifut√≥ sz√≠n (Aktu√°lis elem)</span>
                                            </label>
                                            <label
                                                style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                                <input type="radio" name="bleed-mode" value="custom_all"
                                                    style="margin-right: 8px;"
                                                    onchange="window.setBleedMode('custom_all')">
                                                <span>üñåÔ∏è Egy√©ni kifut√≥ teljes k√©pre</span>
                                            </label>
                                        </div>

                                        <!-- Egy√©ni kifut√≥ sz√≠n panel (alapb√≥l rejtett) -->
                                        <div id="custom-bleed-panel"
                                            style="display: none; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: rgba(0,0,0,0.2); margin-bottom: 12px;">

                                            <div class="setting-group" style="margin-bottom: 10px;">
                                                <div id="simple-bleed-container">
                                                    <label
                                                        style="font-size:11px; display:block; margin-bottom:3px;">Kifut√≥
                                                        sz√≠n:</label>
                                                    <input type="color" id="bleed-color-picker" value="#000000"
                                                        oninput="window.updateCustomBleedColor(this.value)"
                                                        class="input-glass" style="height: 38px; cursor: pointer;">
                                                </div>
                                            </div>

                                            <!-- Gradiens kapcsol√≥ a kifut√≥hoz -->
                                            <div class="collapsible-header"
                                                style="margin-bottom: 0; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: rgba(255,255,255,0.05);">
                                                <div onclick="window.toggleBleedGradientPanel()"
                                                    style="display:flex; align-items:center; gap:10px; flex:1; cursor:pointer;">
                                                    <span id="bleed-gradient-arrow"
                                                        style="font-size: 12px; transform: rotate(-90deg); transition: transform 0.3s;">‚ñº</span>
                                                    <span style="font-size: 12px; color: var(--text-primary);">T√∂bbsz√≠n≈±
                                                        kifut√≥ (Gradiens)</span>
                                                </div>
                                                <label class="switch" style="margin-left: 10px;">
                                                    <input type="checkbox" id="bleed-gradient-toggle"
                                                        onchange="window.toggleBleedGradientActive(this.checked)">
                                                    <span class="slider round"></span>
                                                </label>
                                            </div>

                                            <div id="bleed-gradient-editor-panel"
                                                style="display: none; padding: 12px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2);">
                                                <div style="margin-bottom: 12px;">
                                                    <div
                                                        style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:5px;">
                                                        <label>D≈ël√©ssz√∂g:</label>
                                                        <span id="bleed-grad-angle-val"
                                                            style="color:white; font-weight:bold;">135¬∞</span>
                                                    </div>
                                                    <input type="range" id="bleed-grad-angle-range" min="0" max="360"
                                                        value="135" oninput="window.updateBleedGradientFromEditor()"
                                                        class="slider-glass">
                                                </div>

                                                <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Sz√≠nek √©s
                                                    Poz√≠ci√≥k (%):</div>
                                                <div id="bleed-grad-stops-list"
                                                    style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
                                                </div>

                                                <button class="btn-glass btn-glass-secondary"
                                                    style="width:100%; border-style:dashed;"
                                                    onclick="window.addBleedGradientStop()">
                                                    + √öj sz√≠n hozz√°ad√°sa
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Kifut√≥ √©l≈ën√©zet kapcsol√≥ -->
                                        <div
                                            style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                                            <span
                                                style="font-size: 12px; font-weight: bold; color: var(--text-primary);">üëÅÔ∏è
                                                √âl/Kifut√≥ √©l≈ën√©zet</span>
                                            <label class="switch">
                                                <input type="checkbox" id="bleed-preview-toggle"
                                                    onchange="window.toggleBleedPreview(this.checked)">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                        <p
                                            style="font-size: 10px; color: var(--text-secondary); margin: 0; line-height: 1.4;">
                                            Bekapcsolva a v√°szon k√∂r√ºl megjelenik a +2 cm-es kifut√≥ ter√ºlet el≈ën√©zete.
                                            Ez a nyomtat√°shoz sz√ºks√©ges extra ter√ºlet, ami lev√°g√°sra ker√ºl.
                                        </p>
                                    </div>
                                </div>
                            </div>


                            <label style="margin-bottom: 4px; margin-top: 15px;">Export:</label>
                            <div class="export-btns" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="exportCanvas('svg')" class="btn-glass">SVG (Vektoros)</button>
                                <button onclick="exportCanvas('png')" class="btn-glass">PNG (Raster)</button>
                                <button onclick="exportCanvas('jpeg')" class="btn-glass">JPEG (Raster)</button>
                                <button id="copy-button" class="btn-glass">M√°sol√°s</button>
                                <button id="dl-button" class="btn-glass">Eredeti SVG let√∂lt√©se</button>
                            </div>
                            <a id="download-link" style="display: none;"></a>

                            <div style="flex-grow: 1;"></div>
                        </div>
                    </div>
                    <div id="fragment_r-2">
                        <!-- 2. ELEM KIV√ÅLASZT√ÅSA (Select Option) - √öJ ID HOZZ√ÅADVA -->
                        <div id="element-selector-container" class="section"
                            style="margin-top: 6px; margin-bottom: 10px; border-left: 4px solid var(--accent-blue);">
                            <label style="color:var(--accent-blue); font-weight:bold; margin-bottom:5px;">Szerkesztett
                                elem:</label>
                            <select id="active-element-selector" onchange="window.handleElementSelection(this.value)"
                                class="select-glass" style="font-weight:bold;">
                                <!-- JS t√∂lti fel: T√©rk√©p 1, Fot√≥ 1, Hold 1... -->
                            </select>
                        </div>
                        <!-- 3. DINAMIKUS BE√ÅLL√çT√ÅSOK (T√©rk√©p vs Fot√≥/Hold) -->
                        <div id="dynamic-element-settings">
                            <!-- A) T√âRK√âP SPECIFIKUS (Alapb√≥l l√°that√≥, display:none lev√©ve) -->
                            <div id="settings-group-map">
                                <div class="section" style="margin-top: 0; margin-bottom: 0;">
                                    <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">T√âRK√âP M√âRETE</h3>
                                    <div class="setting-group" style="margin-bottom: 0px;">
                                        <label for="map-width-cm-input">Sz√©less√©g (cm):</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="number" id="map-width-cm-input" value="" min="1" step="0.1"
                                                class="input-glass" oninput="window.setMapWidth()">
                                            <button onclick="window.fitMapToCanvas()" class="btn-glass btn-glass-sm"
                                                style="color: var(--accent-blue); border-color: var(--accent-blue);">Max</button>
                                        </div>
                                        <small style="color: var(--text-secondary); font-size: 11px;">Nem lehet
                                            nagyobb a v√°szonn√°l.</small>
                                        <label
                                            style="font-size: 11px; display: flex; align-items: center; gap: 5px; cursor: pointer; margin-bottom: 0px">
                                            <input type="checkbox" id="allow-map-overflow"
                                                onchange="window.setMapWidth()">
                                            <span>Kifut√≥ enged√©lyez√©se</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- B) FOT√ì / HOLD SPECIFIKUS (M√©ret) -->
                            <div id="settings-group-photo" style="display:none;">
                                <div class="section" style="margin-top: 0; margin-bottom: 0;">
                                    <!-- HOLD SZERKESZT≈ê (D√°tum, Hely) -->
                                    <div id="moon-edit-panel"
                                        style="display:none; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid var(--accent-purple);">
                                        <h3 class="small" style="margin-top:0; color:var(--accent-purple);">Hold
                                            Be√°ll√≠t√°sok</h3>
                                        <div class="setting-group">
                                            <label>D√°tum:</label>
                                            <input type="date" id="moon-edit-date" onchange="updateActiveMoonSettings()"
                                                class="input-glass">
                                        </div>
                                        <div class="setting-group">
                                            <label>Id≈ë (UTC):</label>
                                            <input type="time" id="moon-edit-time" onchange="updateActiveMoonSettings()"
                                                class="input-glass">
                                        </div>
                                        <div class="setting-group"
                                            style="margin-top:10px; padding-top:10px; border-top:1px solid #444;">
                                            <label>Helysz√≠n (Forgat√°shoz):</label>
                                            <input type="text" id="moon-city-search" placeholder="V√°ros keres√©se..."
                                                class="input-glass" style="margin-bottom:5px;">
                                            <div class="grid-2-cols">
                                                <div>
                                                    <label style="font-size:10px; color:#aaa;">Lat:</label>
                                                    <input type="number" id="moon-edit-lat" step="0.0001"
                                                        class="input-glass" onchange="updateActiveMoonSettings()">
                                                </div>
                                                <div>
                                                    <label style="font-size:10px; color:#aaa;">Lon:</label>
                                                    <input type="number" id="moon-edit-lon" step="0.0001"
                                                        class="input-glass" onchange="updateActiveMoonSettings()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- √öJ M√âRETEZ≈ê PANEL (Fot√≥/Hold) -->
                                    <h3 class="small" style="margin-top: 10px; margin-bottom: 12px;"
                                        id="photo-size-title">
                                        K√âP M√âRETE</h3>
                                    <div class="setting-group" style="margin-bottom: 0px;">
                                        <label for="photo-width-cm-input">Sz√©less√©g (cm):</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="number" id="photo-width-cm-input" value="20" min="1" step="0.1"
                                                class="input-glass" oninput="window.setPhotoWidth()">
                                            <button onclick="window.fitPhotoToCanvas()" class="btn-glass btn-glass-sm"
                                                style="color: var(--accent-blue); border-color: var(--accent-blue);">Max</button>
                                        </div>
                                        <small style="color: var(--text-secondary); font-size: 11px;">Nem lehet
                                            nagyobb a v√°szonn√°l.</small>
                                        <label
                                            style="font-size: 11px; display: flex; align-items: center; gap: 5px; cursor: pointer; margin-bottom: 0px">
                                            <input type="checkbox" id="allow-photo-overflow"
                                                onchange="window.setPhotoWidth()">
                                            <span>Kifut√≥ enged√©lyez√©se</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- C) K√ñZ√ñS: POZ√çCI√ì (Igaz√≠t√°s) -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">POZ√çCI√ì IGAZ√çT√ÅSA</h3>
                                <div class="setting-group">
                                    <div style="display: flex; gap: 10px;">
                                        <!-- A gombok ID-ja megmaradt, a JS kezeli a logik√°t att√≥l f√ºgg≈ëen mi akt√≠v -->
                                        <button id="btn-align-top" class="add-btn secondary"
                                            aria-label="Igaz√≠t√°s fel√ºlre">‚¨Ü
                                            Fent</button>
                                        <button id="btn-align-center" class="add-btn secondary active"
                                            aria-label="Igaz√≠t√°s k√∂z√©pre">‚Ä¢ K√∂z√©p</button>
                                        <button id="btn-align-bottom" class="add-btn secondary"
                                            aria-label="Igaz√≠t√°s alulra">‚¨á Lent</button>
                                    </div>
                                    <!-- Marg√≥k (Dinamikus ID-k) -->
                                    <div id="element-margin-top-container" style="display: none; margin-top: 10px;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <label id="lbl-element-margin-top"
                                                style="font-size: 11px; color: #aaa;">Fels≈ë
                                                Marg√≥ (cm):</label>
                                        </div>
                                        <input type="number" id="element-margin-top" value="0" step="0.5"
                                            class="input-glass" oninput="window.updateElementMargin('top', this.value)">
                                    </div>
                                    <div id="element-margin-bottom-container" style="display: none; margin-top: 5px;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <label id="lbl-element-margin-bottom"
                                                style="font-size: 11px; color: #aaa;">Als√≥
                                                Marg√≥ (cm):</label>
                                        </div>
                                        <input type="number" id="element-margin-bottom" value="0" step="0.5"
                                            class="input-glass"
                                            oninput="window.updateElementMargin('bottom', this.value)">
                                    </div>
                                </div>
                            </div>
                            <!-- D) K√ñZ√ñS: MASZK √âS ALAK -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">‚ô• Sz√≠v Alak √©s M√©ret
                                </h3>
                                <div
                                    style="display: flex; gap: 8px; justify-content: center; margin-top: 5px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <!-- Maszk gombok - JS kezeli a 'setCommonMask'-ot -->
                                    <div onclick="window.setCommonMask('none')" class="mask-option selected"
                                        id="c-mask-btn-none" role="button" tabindex="0" aria-label="Eredeti k√∂r alak"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;"
                                        title="Eredeti (K√∂r)">
                                        <span style="font-size: 18px;">‚ö™</span>
                                    </div>
                                    <div onclick="window.setCommonMask('modern')" class="mask-option"
                                        id="c-mask-btn-modern"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white" stroke="black"
                                            stroke-width="1">
                                            <path
                                                d="M12 21L3 10a5 5 0 0 1 8-4 5 5 0 0 1 1 1 5 5 0 0 1 1-1 5 5 0 0 1 8 4L12 21z" />
                                        </svg>
                                    </div>
                                    <div onclick="window.setCommonMask('elegant')" class="mask-option"
                                        id="c-mask-btn-elegant" role="button" tabindex="0"
                                        aria-label="Eleg√°ns sz√≠v alak"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white" stroke="black"
                                            stroke-width="1">
                                            <path
                                                d="M12 21s-8-5.5-8-11.5C4 5.5 8 3.5 12 8c4-4.5 8-2.5 8 1.5C20 15.5 12 21 12 21z" />
                                        </svg>
                                    </div>
                                    <div onclick="window.setCommonMask('classic')" class="mask-option"
                                        id="c-mask-btn-classic" role="button" tabindex="0"
                                        aria-label="Klasszikus sz√≠v alak"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white" stroke="black"
                                            stroke-width="1">
                                            <path
                                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                        </svg>
                                    </div>
                                    <div onclick="window.setCommonMask('round')" class="mask-option"
                                        id="c-mask-btn-round"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white" stroke="black"
                                            stroke-width="1">
                                            <path
                                                d="M12 20.5C6 16 3 13 3 9.5 3 7 5 5 7.5 5c1.5 0 3 .5 4.5 2 1.5-1.5 3-2 4.5-2 2.5 0 4.5 2 4.5 4.5 0 3.5-3 6.5-9 11z" />
                                        </svg>
                                    </div>
                                </div>
                                <div id="common-mask-scale-container" style="display:none; margin-top: 10px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                        <label style="font-size: 11px; color: #aaa;">Sz√≠v M√©rete:</label>
                                        <span style="font-size: 11px; color: #fff;">+/-</span>
                                    </div>
                                    <input type="range" id="common-mask-scale-slider" min="50" max="130" value="100"
                                        class="slider-glass" oninput="window.updateCommonMaskScale(this.value)">
                                </div>
                            </div>
                            <!-- E) K√ñZ√ñS: KERET & SZ√âLEK -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">KERET & SZ√âLEK</h3>
                                <div class="setting-group">
                                    <label>K√©p Sz√©l√©nek Elmos√°sa: <span id="common-edge-blur-disp"
                                            style="float:right; color:#aaa;">0px</span></label>
                                    <label>K√©p Sz√©l√©nek Elmos√°sa: <span id="common-edge-blur-disp"
                                            style="float:right; color:#aaa;">0px</span></label>
                                    <input type="range" id="common-edge-blur-input" min="0" max="100" value="0"
                                        class="slider-glass"
                                        oninput="window.updateCommonBorderProp('edgeBlur', this.value)">
                                </div>
                                <div class="setting-group"
                                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">
                                    <input type="checkbox" id="common-border-check" class="checkbox-glass"
                                        onchange="window.updateCommonBorderProp('enabled', this.checked)">
                                    <label for="common-border-check"
                                        style="margin:0; cursor:pointer; font-size: 12px; flex: 1;">Keret
                                        bekapcsol√°sa</label>
                                    <input type="color" id="common-border-color" value="#ffffff"
                                        oninput="window.updateCommonBorderProp('color', this.value)"
                                        style="width:30px; height:25px; padding:0; margin:0; border:none;">
                                </div>
                                <div id="common-border-settings-wrapper" style="display:none;">
                                    <div class="setting-group">
                                        <label>Keret Vastags√°g: <span id="common-border-disp"
                                                style="float:right; color:#aaa;">0px</span></label>
                                        <input type="range" id="common-border-input" min="0" max="50" value="0"
                                            class="slider-glass"
                                            oninput="window.updateCommonBorderProp('width', this.value)">
                                    </div>
                                    <div class="setting-group">
                                        <label>Keret T√°vols√°g (Offset): <span id="common-border-offset-disp"
                                                style="float:right; color:#aaa;">0px</span></label>
                                        <input type="range" id="common-border-offset-input" min="-60" max="60" value="0"
                                            class="slider-glass" step="1"
                                            oninput="window.updateCommonBorderProp('offset', this.value)">
                                    </div>
                                    <div class="setting-group">
                                        <label>Keret Elmos√≥d√°s (Blur): <span id="common-border-blur-disp"
                                                style="float:right; color:#aaa;">0px</span></label>
                                        <input type="range" id="common-border-blur-input" min="0" max="50" value="0"
                                            class="slider-glass"
                                            oninput="window.updateCommonBorderProp('blur', this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="grid-2-cols" style="margin-top:15px;" id="btn-delete-element-container">
                                <button onclick="window.deleteActiveElement()" class="btn-glass btn-glass-primary"
                                    style="background:#ff4444; width:100%;">üóëÔ∏è Elem T√∂rl√©se</button>
                            </div>
                        </div>
                    </div>
                    <div id="fragment_r-3">
                        <div class="designer-controls">

                            <div class="text-mode-tabs" style="display: none">
                                <button class="text-mode-tab active" onclick="switchTextContext('map')"
                                    id="tab-context-map">Csillagt√©rk√©p</button>
                                <button class="text-mode-tab" onclick="switchTextContext('photo')"
                                    id="tab-context-photo" style="display:none;">Fot√≥ Oldal</button>
                                <button class="text-mode-tab common-tab" onclick="switchTextContext('common')"
                                    id="tab-context-common" style="display:none;">K√∂z√∂s (Sz√©les)</button>
                            </div>

                            <div class="collapsible-header" data-target="top-text-settings">
                                <h2 id="top-zone-title">üìù FELS≈ê Z√ìNA (T√©rk√©p)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                            </div>

                            <div class="collapsible-content" id="top-text-settings">
                                <div class="section" style="margin-bottom: 0;">

                                    <div id="top-common-toggle-container"
                                        style="display:none; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #444;">
                                        <label><input type="checkbox" id="chk-common-top"
                                                onchange="toggleCommonZone('top', this.checked)"> üîó K√∂z√∂s Fels≈ë
                                            Sz√∂vegdoboz haszn√°lata</label>
                                    </div>

                                    <div class="setting-group">

                                        <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                        <div style="margin-top: 5px; margin-bottom: 5px;">
                                            <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                            <div style="margin-top: 5px; margin-bottom: 5px;">
                                                <select id="zone-top-align" onchange="setZoneAlign('top', this.value)"
                                                    class="select-glass">
                                                    <option value="top">‚¨Ü Lap tetej√©hez</option>
                                                    <option value="center" selected>‚Ä¢ K√∂z√©pre</option>
                                                    <option value="bottom">‚¨á T√©rk√©phez</option>
                                                </select>
                                            </div>

                                            <div id="zone-top-margin-container"
                                                style="display:none; margin-bottom: 10px;">
                                                <label style="font-size: 10px; color: #aaa;">Marg√≥ (cm):</label>
                                                <input id="zone-top-margin-input" type="number" class="input-glass"
                                                    oninput="updateZoneMargin('top', this.value)" value="0" step="0.1">
                                            </div>
                                        </div>
                                        <div id="top-blocks-container"></div>

                                    </div>
                                </div>

                                <div class="collapsible-header" data-target="bottom-text-settings">
                                    <h2 id="bottom-zone-title">üìù ALS√ì Z√ìNA (T√©rk√©p)</h2>
                                    <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                                </div>
                                <div class="collapsible-content" id="bottom-text-settings">
                                    <div class="section" style="margin-bottom: 0;">

                                        <div id="bottom-common-toggle-container"
                                            style="display:none; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #444;">
                                            <label><input type="checkbox" id="chk-common-bottom"
                                                    onchange="toggleCommonZone('bottom', this.checked)"> üîó K√∂z√∂s Als√≥
                                                Sz√∂vegdoboz haszn√°lata</label>
                                        </div>

                                        <div class="setting-group">
                                            <label>Z√≥na F√ºgg≈ëleges Igaz√≠t√°sa:</label>
                                            <div style="margin-top: 5px; margin-bottom: 5px;">
                                                <select id="zone-bottom-align" class="select-glass"
                                                    onchange="setZoneAlign('bottom', this.value)">
                                                    <option value="top">‚¨Ü T√©rk√©phez</option>
                                                    <option value="center" selected>‚Ä¢ K√∂z√©pre</option>
                                                    <option value="bottom">‚¨á Lap alj√°hoz</option>
                                                </select>
                                            </div>

                                            <div id="zone-bottom-margin-container"
                                                style="display:none; margin-bottom: 10px;">
                                                <label style="font-size: 10px; color: #aaa;">Marg√≥ (cm):</label>
                                                <input id="zone-bottom-margin-input" type="number" class="input-glass"
                                                    oninput="updateZoneMargin('bottom', this.value)" value="0"
                                                    step="0.1">
                                            </div>
                                        </div>

                                        <div id="bottom-blocks-container"></div>

                                    </div>
                                </div>

                                <div id="symbol-picker"
                                    style="display:none; position:fixed; z-index:1000; background:var(--secondary-bg); padding:10px; border:1px solid var(--accent-blue); border-radius:10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
                                    <div
                                        style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; font-size:20px;">
                                        <button class="btn-glass" onclick="window.insertSymbol('‚ô•')">‚ô•</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('‚ô°')">‚ô°</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('‚òÖ')">‚òÖ</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('‚òÜ')">‚òÜ</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('‚Äî')">‚Äî</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('‚Ä¢')">‚Ä¢</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('‚àû')">‚àû</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('&')">&</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('+')">+</button>
                                        <button class="btn-glass" onclick="window.insertSymbol('|')">|</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div id="fragment_r-4">
                            <div class="designer-controls">

                                <!-- 1. F≈ê V√ÅLASZT√ì: MIT SZERETN√âL? -->
                                <div class="section" style="margin-top: 0; margin-bottom: 16px; text-align:center;">
                                    <h3 class="small"
                                        style="margin-top: 0; margin-bottom: 12px; color:var(--accent-blue);">
                                        √öJ ELEM HOZZ√ÅAD√ÅSA</h3>
                                    <div class="grid-3-cols" style="gap:10px;">
                                        <button onclick="toggleAddPanel('photo')" id="btn-mode-photo"
                                            class="btn-glass btn-glass-primary" style="height:60px; font-size:14px;">
                                            üì∏ SAJ√ÅT FOT√ì
                                        </button>
                                        <button onclick="toggleAddPanel('moon')" id="btn-mode-moon"
                                            class="btn-glass btn-glass-secondary" style="height:60px; font-size:14px;">
                                            üåî HOLDF√ÅZIS
                                        </button>
                                        <button onclick="toggleAddPanel('map')" id="btn-mode-map"
                                            class="btn-glass btn-glass-secondary"
                                            style="height:60px; font-size:12px; border-color: #546e7a;">
                                            ‚ú® CSILLAGT√âRK√âP
                                        </button>
                                    </div>
                                </div>

                                <!-- 2. TARTALOM PANELEK (V√°ltakoznak) -->

                                <!-- A) FOT√ì FELT√ñLT√âS -->
                                <div id="panel-photo-upload" style="display: none !important">
                                    <div class="section" style="margin-bottom: 16px;">
                                        <input type="file" id="photo-upload" accept="image/*" style="display: none;"
                                            onchange="initCropperFromFile(this)">
                                        <button onclick="document.getElementById('photo-upload').click()"
                                            class="btn-glass btn-glass-primary" style="width:100%; padding:15px;">
                                            F√°jl Kiv√°laszt√°sa...
                                        </button>
                                    </div>
                                </div>
                                <!-- B) HOLD GENER√ÅTOR (NASA API) -->
                                <div id="panel-moon-gen" style="display:none;">
                                    <div class="section" style="margin-bottom: 16px;">

                                        <!-- 1. ADATOK (FENT) -->
                                        <div
                                            style="font-size:11px; line-height:1.4; color:#ccc; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #444;">
                                            <div id="moon-data-phase"
                                                style="font-weight:bold; color:var(--accent-blue); margin-bottom:5px; font-size:14px; text-transform:uppercase;">
                                                -</div>
                                            <div
                                                style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                                <span>Megvil√°g√≠totts√°g:</span>
                                                <span id="moon-data-illum"
                                                    style="color:white; font-weight:bold;">-</span>
                                            </div>
                                            <div
                                                style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                                <span>Hold kora:</span>
                                                <span id="moon-data-age" style="color:white;">-</span>
                                            </div>
                                            <div
                                                style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                                <span>Csillagjegy:</span>
                                                <span id="moon-data-zodiac" style="color:white;">-</span>
                                            </div>
                                            <div style="margin-top:5px; font-size:10px; color:#888;">
                                                <div>K√∂vetkez≈ë √öjhold: <span id="moon-data-nextnew">-</span></div>
                                                <div>K√∂vetkez≈ë Telihold: <span id="moon-data-nextfull">-</span></div>
                                            </div>
                                        </div>

                                        <!-- 2. K√âP (ALATT) -->
                                        <div style="text-align:center; margin-bottom:15px;">
                                            <img id="moon-preview-img" src=""
                                                style="width:120px; height:120px; border-radius:50%; /*background:#000;*/ display:inline-block; box-shadow: 0 0 15px rgba(255,255,255,0.1);">
                                        </div>

                                        <div class="setting-group">
                                            <label>D√°tum:</label>
                                            <input type="date" id="moon-date" onchange="updateMoonPreview()"
                                                class="input-glass">
                                        </div>
                                        <div class="setting-group">
                                            <label>Id≈ë (UTC):</label>
                                            <input type="time" id="moon-time" value="12:00"
                                                onchange="updateMoonPreview()" class="input-glass">
                                        </div>
                                        <div class="setting-group">
                                            <label>Sz√∂veg megjelen√≠t√©se a k√©p alatt:</label>
                                            <input type="checkbox" id="moon-text-check" checked>
                                        </div>
                                    </div>
                                </div>
                                <!-- 3. HOZZ√ÅAD√ÅS HELYE (K√ñZ√ñS) -->
                                <div class="section" style="margin-bottom: 16px;">
                                    <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">HOZZ√ÅAD√ÅS HELYE</h3>
                                    <div
                                        style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:11px; color:#aaa;">
                                        <span>Jelenlegi elrendez√©s:</span>
                                        <span id="layout-dir-display" style="color:white; font-weight:bold;">SOR
                                            (‚Üî)</span>
                                    </div>
                                    <div class="grid-2-cols" id="add-buttons-container">
                                        <button onclick="addCurrentItem('start')" class="btn-glass btn-glass-secondary"
                                            id="btn-add-start">
                                            ‚¨Ö BALRA (Elej√©re)
                                        </button>
                                        <button onclick="addCurrentItem('end')" class="btn-glass btn-glass-secondary"
                                            id="btn-add-end">
                                            ‚û° JOBBRA (V√©g√©re)
                                        </button>
                                    </div>

                                    <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                                        <label style="font-size:11px;">Elrendez√©s ir√°nya:</label>
                                        <div style="display: flex; gap: 5px; margin-top:5px;">
                                            <button onclick="setLayoutDirection('row')" id="btn-layout-row_"
                                                class="btn-glass btn-glass-primary"
                                                style="flex:1; font-size:11px; padding:8px;">‚Üî
                                                Sor</button>
                                            <button onclick="setLayoutDirection('column')" id="btn-layout-column_"
                                                class="btn-glass btn-glass-secondary"
                                                style="flex:1; font-size:11px; padding:8px;">‚Üï
                                                Oszlop</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="fragment_r-5">
                            <div id="designer-tab-templates">
                                <h3 style="margin-top:0;">St√≠lus & H√°tt√©r</h3>

                                <!-- ELEM V√ÅLASZT√ì A SABLONOK MEN√úBEN -->
                                <div id="template-element-selector-container" class="section"
                                    style="margin-bottom: 10px; padding: 10px; border: 1px solid var(--accent-purple); background: rgba(0,0,0,0.2); border-radius: 8px; display:none;">
                                    <label
                                        style="color:var(--accent-purple); font-weight:bold; margin-bottom:5px; font-size: 11px; display:block;">KIV√ÅLASZTOTT
                                        ELEM:</label>
                                    <select id="template-element-selector"
                                        onchange="window.handleTemplateElementSelection(this.value)"
                                        class="select-glass" style="cursor:pointer;">
                                        <!-- JS t√∂lti fel -->
                                    </select>
                                </div>
                                <div class="section"
                                    style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.2); border-radius: 8px;">
                                    <label
                                        style="display:block; font-weight:bold; color: var(--accent-cyan); margin-bottom: 8px; font-size: 11px;">
                                        ALKALMAZ√ÅS M√ìDJA:
                                    </label>

                                    <label
                                        style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-right" value="global" checked
                                            style="margin-right: 8px;">
                                        <span>üåç Teljes v√°szonk√©p (Minden elem)</span>
                                    </label>

                                    <label
                                        style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-right" value="local"
                                            style="margin-right: 8px;">
                                        <span>üñºÔ∏è Csak a kiv√°lasztott k√©p (H√°tt√©rrel)</span>
                                    </label>

                                    <label style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-right" value="none"
                                            style="margin-right: 8px;">
                                        <span>üö´ Csak a kiv√°lasztott csillagt√©rk√©p (St√≠lus)</span>
                                    </label>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <button onclick="if(typeof restoreUserState === 'function') restoreUserState();"
                                        class="btn-glass btn-glass-primary" style="width: 100%; background: #546e7a;">
                                        ‚Ü∫ Vissza√°ll√≠t√°s
                                    </button>
                                </div>

                                <div id="designer-templates-grid"
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                            </div>
                        </div>
                        <div id="fragment_r-6">
                        </div>
                        <div id="fragment_r-7">

                            <div class="designer-controls">
                                <div class="section">
                                    <div class="sp-header">
                                        <h3 class="small" style="margin:0;">Adj hozz√° Okospontot</h3>
                                        <button class="btn-glass btn-glass-sm"
                                            onclick="$('#smartpoint-section-content').slideToggle()">‚ñº</button>
                                    </div>

                                    <!-- Egyedi Alert Doboz -->
                                    <div id="custom-sp-alert" class="shadow">
                                        <p id="sp-alert-text">√úzenet sz√∂vege</p>
                                        <button onclick="$('#custom-sp-alert').fadeOut(200)"
                                            class="btn-glass btn-glass-sm" style="font-size: 12px;">Bez√°r√°s</button>
                                    </div>

                                    <div id="smartpoint-section-content">

                                        <!-- F≈ë vez√©rl≈ëk -->
                                        <div
                                            style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px;">
                                            <button id="btnAddSmartpoint" class="btn-glass btn-glass-primary"
                                                style="width:100%;" onclick="startAddSmartpoint()">
                                                <span style="margin-right:5px;">+</span> √öj Okospont hozz√°ad√°sa
                                            </button>

                                            <div style="display: flex; gap: 8px;">
                                                <button id="btnToggleSmartpoints" class="btn-glass btn-glass-secondary"
                                                    style="flex: 1; font-size: 11px;"
                                                    onclick="toggleSmartpointsVisibility()">
                                                    üëÅÔ∏è Elrejt√©s
                                                </button>
                                                <!-- <button id="btnMoveSmartpoints" class="add-btn secondary" style="flex: 1; font-size: 11px;" onclick="toggleSmartpointsMoveMode()">‚ú• √Åthelyez√©s</button> -->
                                            </div>
                                        </div>

                                        <!-- T√≠pus v√°laszt√≥ -->
                                        <div id="sp-type-selector"
                                            style="display: none; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                                            <label
                                                style="margin-bottom: 10px; display: block; font-weight: bold; color: var(--accent-blue);">1.
                                                V√°lassz t√≠pust:</label>
                                            <button class="btn-glass btn-glass-secondary sp-type-btn"
                                                onclick="selectSPType('audio', this)">üéµ Hangf√°jl</button>
                                            <button class="btn-glass btn-glass-secondary sp-type-btn"
                                                onclick="selectSPType('video', this)">üé• Vide√≥</button>
                                            <button class="btn-glass btn-glass-secondary sp-type-btn"
                                                onclick="selectSPType('image', this)">üñºÔ∏è K√©p</button>
                                            <!-- <button class="btn-glass btn-glass-secondary sp-type-btn" onclick="selectSPType('youtube', this)">‚ñ∂Ô∏è YouTube</button> -->
                                            <!-- <button class="btn-glass btn-glass-secondary sp-type-btn" onclick="selectSPType('youtube', this)"><i class="fab fa-youtube me-2" style=" color: red;"></i> YouTube URL</button> -->
                                            <button class="btn-glass btn-glass-secondary sp-type-btn"
                                                onclick="selectSPType('youtube', this)"><i class="fab fa-youtube me-2"
                                                    style=" color: red;"></i><i class="fa-brands fa-youtube"
                                                    style="color: #ff0000;"></i><i class="bi bi-youtube"></i> <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.-->
                                                    <path fill="#ff0000"
                                                        d="M581.7 188.1C575.5 164.4 556.9 145.8 533.4 139.5C490.9 128 320.1 128 320.1 128C320.1 128 149.3 128 106.7 139.5C83.2 145.8 64.7 164.4 58.4 188.1C47 231 47 320.4 47 320.4C47 320.4 47 409.8 58.4 452.7C64.7 476.3 83.2 494.2 106.7 500.5C149.3 512 320.1 512 320.1 512C320.1 512 490.9 512 533.5 500.5C557 494.2 575.5 476.3 581.8 452.7C593.2 409.8 593.2 320.4 593.2 320.4C593.2 320.4 593.2 231 581.8 188.1zM264.2 401.6L264.2 239.2L406.9 320.4L264.2 401.6z" />
                                                </svg> YouTube URL &#xF62B;</button>
                                            <button class="btn-glass btn-glass-secondary sp-type-btn"
                                                onclick="selectSPType('spotify', this)"><i class="fab fa-spotify"
                                                    style="color: #1DB954"></i> Spotify</button>
                                            <button class="btn-glass btn-glass-secondary sp-type-btn"
                                                onclick="selectSPType('url', this)">üîó URL / Link</button>
                                        </div>

                                        <!-- Tartalom megad√°sa -->
                                        <div id="sp-content-input"
                                            style="display: none; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                                            <label
                                                style="margin-bottom: 10px; display: block; font-weight: bold; color: var(--accent-blue);">2.
                                                Tartalom:</label>

                                            <div id="sp-input-url-group" style="display:none;">
                                                <input type="text" id="sp-input-url" placeholder="https://..."
                                                    class="input-glass" style="width: 100%; margin-bottom: 10px;">
                                            </div>
                                            <div id="sp-input-file-group" style="display:none;">
                                                <input type="file" id="sp-input-file"
                                                    style="width: 100%; margin-bottom: 10px; color: #aaa;">
                                            </div>

                                            <div class="grid-2-cols">
                                                <button id="btn-sp-save" class="btn-glass btn-glass-primary"
                                                    aria-label="Okospont ment√©se">Ment√©s</button>
                                                <button id="btn-sp-cancel" class="btn-glass btn-glass-secondary"
                                                    aria-label="Okospont ment√©s√©nek megszak√≠t√°sa">M√©gse</button>
                                            </div>
                                        </div>

                                        <!-- Lista -->
                                        <div id="smartpoints-list">
                                            <div
                                                style="text-align: center; color: #888; font-style: italic; padding: 10px;">
                                                M√©g nincs okospont.</div>
                                        </div>

                                        <!-- Koordin√°ta Export Info (Rejtett, de a k√≥dban el√©rhet≈ë) -->
                                        <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                                            <p style="font-size: 10px; color: #666;">
                                                * Az okospontok helyzete (CM-ben a k√∂z√©ppontt√≥l) ment√©sre ker√ºl a
                                                konfigur√°ci√≥ba.
                                                Nyomtat√°skor nem l√°tszanak.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="fragment_r-8">
                            <div class="designer-controls">
                                <div class="section">
                                    <!-- NEW: Active Element Selector for Preview -->
                                    <div id="preview-element-selector-container" class="section"
                                        style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-purple); background: rgba(0,0,0,0.2); border-radius: 8px;">
                                        <label
                                            style="color:var(--accent-purple); font-weight:bold; margin-bottom:5px; font-size: 11px; display:block;">KIV√ÅLASZTOTT
                                            ELEM:</label>
                                        <select id="active-element-selector-preview"
                                            onchange="window.handleUnifiedSelection(this.value)" class="select-glass"
                                            style="cursor:pointer;">
                                        </select>
                                    </div>

                                    <h2>üîé R√©szletes N√©zet</h2>
                                    <p style="font-size:12px; color:#aaa;">Ellen≈ërizd a terved minden apr√≥ r√©szlet√©t
                                        nagy
                                        felbont√°sban.</p>

                                    <div class="setting-group">
                                        <label>Mit szeretn√©l l√°tni?</label>
                                        <div class="radio-group" style="display:flex; gap:10px; margin-top:5px;">
                                            <label class="radio-btn active" style="font-size:12px; cursor:pointer;">
                                                <input type="radio" name="view-mode" value="all" checked
                                                    onchange="window.fsViewMode='all'"> Teljes V√°szon
                                            </label>
                                            <label class="radio-btn" style="font-size:12px; cursor:pointer;">
                                                <input type="radio" name="view-mode" value="selected"
                                                    onchange="window.fsViewMode='selected'"> Kijel√∂lt Elem
                                            </label>
                                        </div>
                                    </div>

                                    <button id="btn-open-fullscreen" class="btn-glass btn-glass-primary"
                                        style="margin-top:15px; width:100%; padding:15px; font-size:14px;"
                                        onclick="window.openFullScreenView()">
                                        ‚õ∂ Megnyit√°s Teljes K√©perny≈ën
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="layout" id="main-layout">
        <div class="mapwrap" id="map-wrap">
            <!-- Theme switcher button -->
            <!-- <div id="theme-switcher" class="theme-switcher" title="Toggle Theme"
                onclick="toggleMapTheme()">
                üåô
            </div>-->
            <!--<div id="quickThemeToggle" class="btn btn-circle shadow-sm"
                    style="
                        position: absolute; top: 15px; right: 15px; z-index: 100;
                        background: var(--glass-surface); backdrop-filter: blur(10px);
                        border: 1px solid var(--glass-border); color: var(--text-main);
                        width: 40px; height: 40px; border-radius: 50%;
                        display: flex; align-items: center; justify-content: center;
                        transition: all 0.3s ease;"
                    title="V√°lt√°s m√≥d" aria-label="T√©ma v√°lt√°sa" onclick="toggleMapTheme()">
                <i class="fas fa-moon"></i>
            </div>-->

            <button id="quickThemeToggle" class="btn btn-circle shadow-sm"
                style="position: absolute; top: 15px; right: 15px; z-index: 100; background: var(--glass-surface); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); color: var(--text-main); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                title="V√°lt√°s m√≥d" aria-label="T√©ma v√°lt√°sa" onclick="toggleMapTheme()">
                <i class="fas fa-moon"></i>
            </button>
            <div class="map" id="celestial-map">
            </div>
        </div>

        <div class="settingswrap" id="settings-wrap">
            <div id="tabs">
                <ul id="mobile_tabs">
                    <li><a href="#fragment-1">T√©rk√©p Be√°ll√≠t√°sok</a></li>
                    <li><a href="#fragment-2">Tej√∫t & √âgbolt</a></li>
                    <li><a href="#fragment-3">Csillagok & Csillagk√©pek</a></li>
                    <li><a href="#fragment-4">H√°l√≥ & Vonalak</a></li>
                    <li><a href="#fragment-5">Sablonok</a></li>
                    <li><a href="#fragment-6">Tervez≈ë</a></li>
                </ul>

                <div id="fragment-1">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="location-settings">
                            <h2>üìç HELY & ID≈ê</h2>
                            <div id="font-tests"></div>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                        </div>
                        <div class="collapsible-content" id="location-settings">
                            <div class="newsection" style="padding-bottom: 0px; padding-top: 0px;">
                                <div class="setting-group"
                                    style="padding-bottom: 0px; padding-top: 8px; margin-bottom: 0px;">
                                    <label for="city" style=" margin-top: 8px; margin-bottom: 0px">Helysz√≠n</label>
                                    <input type="text" id="city" placeholder="V√°ros keres√©se...">
                                    <label for="" style=" margin-top: 8px; margin-bottom: 0px">Koordin√°t√°k</label>
                                    <div class="row" style="display: flex;">
                                        <div class="col">
                                            <input placeholder="Sz√©less√©gi fok" type="text" id="coord_lat">
                                        </div>
                                        <div class="col">
                                            <input placeholder="Hossz√∫s√°gi fok" type="text" id="coord_lon">
                                        </div>
                                    </div>
                                    <label for="datetimepicker" style=" margin-top: 8px; margin-bottom: 0px">D√°tum &
                                        Id≈ë</label>
                                    <div class="setting-group" style="display: flex;">
                                        <input type="text" id="datetimepicker" placeholder="V√°lassz d√°tumot √©s id≈ët">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="notcollapsible-content" id="projection-settings">
                            <div class="setting-group">
                                <!-- <label for="projection_">Projekci√≥</label> -->
                                <h2>üåç Projekci√≥</h2>

                                <select id="projection_">
                                    <option value="stereographic">Stereographic (F√©lg√∂mb)</option>
                                    <option value="myHeart2025">myHeart2025 (F√©lg√∂mb)</option>
                                    <option value="customHeart">SZ√çV ALAK√ö (Egyedi)</option>
                                    <option value="customHeartt">tttSZ√çV ALAK√ö (Egyedi)</option>
                                    <option value="werner">WERNER (igaz√°b√≥l Bonne)</option>
                                    <option value="orthographic">Orthographic (F√©lg√∂mb)</option>
                                    <option value="airy">Airy‚Äôs Minimum Error (F√©lg√∂mb)</option>
                                    <option value="azimuthalEqualArea">Azimuthal Equal Area (F√©lg√∂mb)</option>
                                    <option value="azimuthalEquidistant">Azimuthal Equidistant (F√©lg√∂mb)
                                    </option>
                                    <option value="berghaus">Berghaus Star (F√©lg√∂mb)</option>
                                    <option value="cassini">Cassini (F√©lg√∂mb)</option>
                                    <option value="twoPointEquidistant">Two-Point Equidistant (F√©lg√∂mb)</option>
                                    <option value="wiechel">Wiechel (F√©lg√∂mb)</option>
                                    <option value="guyou">Guyou</option>
                                    <option value="butterfly">Butterfly</option>
                                    <option value="mtFlatPolarParabolic">mtFlatPolarParabolic</option>
                                    <option value="bonne">bonne</option>
                                </select>
                            </div>
                            <div class="setting-group" style="display:none;" id="szivszogediv">
                                <label for="szivszoge">Sz√≠v sz√∂ge</label>
                                <input id="szivszoge" type="number" min="1.8" max="3.2" step="0.1" value="2.4">
                            </div>
                        </div>

                        <div class="notcollapsible-content" id="projection-settings">

                            <h2>Csillagjegyek / Holdh√°zak</h2>
                            <div class="setting-group" style="display:flex; gap: 10px">

                                <button onclick="toggleCulture('iau', this)"
                                    class="add-btn secondary toggleCulture active" id="btn-iau"
                                    aria-label="Nyugati √âgbolt">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="3" cy="10" r="1.5" fill="currentColor" stroke="none" />
                                        <circle cx="7" cy="11" r="1.5" fill="currentColor" stroke="none" />
                                        <circle cx="11" cy="13" r="1.5" fill="currentColor" stroke="none" />
                                        <circle cx="13.5" cy="12" r="1.5" fill="currentColor" stroke="none" />
                                        <circle cx="16" cy="7" r="1.5" fill="currentColor" stroke="none" />
                                        <circle cx="21" cy="7" r="1.5" fill="currentColor" stroke="none" />
                                        <circle cx="19" cy="11" r="1.5" fill="currentColor" stroke="none" />
                                        <path d="M3 10 L7 11 L11 13 L13.5 12" />
                                        <path d="M13.5 12 L16 7 L21 7 L19 11 Z" />
                                    </svg>
                                    <span>Nyugati √âgbolt</span>
                                </button>
                                <button onclick="toggleCulture('cn', this)" class="add-btn secondary toggleCulture"
                                    id="btn-cn" aria-label="K√≠nai Trad√≠ci√≥">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M4 18c0-3 2-5 4-5s4 2 6 2c2.5 0 4-2 4-5 0-2-1-3-3-3-1.5 0-2.5 1-2.5 1" />
                                        <path d="M19 6l2-2" />
                                        <path d="M17 4l-1-2" />
                                        <path d="M21 12c-1 1-3 1-3 1" />
                                        <path d="M2 20l2-2" />
                                        <circle cx="15" cy="8" r="1" fill="currentColor" stroke="none" />
                                    </svg>
                                    <span>K√≠nai Trad√≠ci√≥</span>
                                </button>
                            </div>
                        </div>
                        <div class="notcollapsible-content" id="zodiacsign-settings">
                            <div class="setting-group">
                                <!-- <label for="zodiacsigns">Csillagjegyek</label> -->
                                <h2>‚ôéÔ∏é Csillagjegyek</h2>

                                <select id="zodiacsigns">
                                    <option value="nincs">-- V√°lassz csillagjegyet --</option>
                                    <option value="Cap">Bak (december 22. ‚Äì janu√°r 20.)</option>
                                    <option value="Aqr">V√≠z√∂nt≈ë (janu√°r 21. ‚Äì febru√°r 19. )</option>
                                    <option value="Psc">Halak (febru√°r 20. ‚Äì m√°rcius 20.)</option>
                                    <option value="Ari">Kos (m√°rcius 21. ‚Äì √°prilis 19.)</option>
                                    <option value="Tau">Bika (√°prilis 20. ‚Äì m√°jus 20.)</option>
                                    <option value="Gem">Ikrek (m√°jus 21. ‚Äì j√∫nius 20.)</option>
                                    <option value="Cnc">R√°k (j√∫nius 21. ‚Äì j√∫lius 22.)</option>
                                    <option value="Leo">Oroszl√°n (j√∫lius 23. ‚Äì augusztus 22.)</option>
                                    <option value="Vir">Sz≈±z (augusztus 23. ‚Äì szeptember 22.)</option>
                                    <option value="Lib">M√©rleg (szeptember 23. ‚Äì okt√≥ber 22.)</option>
                                    <option value="Sco">Skorpi√≥ (okt√≥ber 23. ‚Äì november 22.)</option>
                                    <option value="Sgr">Nyilas (november 23. ‚Äì december 21.)</option>
                                </select>
                            </div>
                        </div>

                        <!-- √öJ SZEKCI√ì: Egyedi Kiemel√©sek -->
                        <div class="collapsible-header" data-target="highlight-settings">
                            <h2>‚ôãÔ∏é Csillagk√©pek Kiemel√©se</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                        </div>

                        <div class="collapsible-content" id="highlight-settings">
                            <div class="newsection" style="padding-top: 8px;">
                                <!-- 1. SELECT (Mindig l√°tszik, ez a bel√©p√©si pont) -->
                                <div class="setting-group" style="margin-bottom: 10px;">
                                    <label>
                                        √öj csillagk√©p kiemel√©se:
                                    </label>
                                    <select id="hl-constellation-select" class="select-glass">
                                        <option value="">-- V√°lassz csillagk√©pet --</option>
                                    </select>
                                </div>

                                <!-- 2. AKT√çV KIEMEL√âSEK LIST√ÅJA (Csak akkor l√°tszik, ha van) -->
                                <div id="active-highlights-container" style="display:none; margin-bottom: 10px;">
                                    <label style="font-size:11px; color:#aaa; margin-bottom:5px; display:block;">Akt√≠v
                                        kiemel√©sek (Kattints a szerkeszt√©shez):</label>
                                    <div id="active-highlights-list"
                                        style="display:flex; flex-direction:column; gap:5px;">
                                    </div>
                                </div>

                                <!-- 3. SZERKESZT≈ê PANEL (Csak kiv√°laszt√°skor l√°tszik) -->
                                <div id="hl-settings-panel" class="settings-panel"
                                    style="display:none; /*border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.3);*/ padding: 10px; border-radius: 8px; margin-top: 10px; position:relative;">
                                    <div
                                        style="margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                                        <label id="hl-editing-title"
                                            style="margin-bottom: 0px; font-weight:bold; font-size:13px;">Szerkeszt√©s...</label>
                                        <button onclick="closeHighlightSettings()"
                                            style="background:none; border:none; color:#aaa; cursor:pointer; font-size:16px; padding:0;">√ó</button>
                                    </div>

                                    <div class="setting-group">
                                        <label>Sz√≠n:</label>
                                        <input type="color" id="hl-color" value="#ffcc00" class="input-glass"
                                            style="height:38px; cursor:pointer;">
                                    </div>

                                    <div class="grid-2-cols" style="margin-top: 5px;">
                                        <div>
                                            <label>Vastags√°g:</label>
                                            <input type="number" id="hl-width" value="3" min="0.5" step="0.5"
                                                class="input-glass">
                                        </div>
                                        <div>
                                            <label>√Åttetsz≈ës√©g:</label>
                                            <input type="number" id="hl-opacity" value="1" min="0" max="1" step="0.1"
                                                class="input-glass">
                                        </div>
                                    </div>

                                    <label
                                        style="margin-top: 8px; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="hl-dash-check">
                                        Szaggatott vonal
                                    </label>

                                    <div id="hl-dash-settings"
                                        style="display:none;  padding: 8px; border-radius: 6px; margin-top: 5px;">
                                        <div class="grid-2-cols" style="gap: 5px;">
                                            <label style="font-size: 11px;">Vonal (px): <input type="number"
                                                    id="hl-dash-1" value="4" min="0" class="input-glass"></label>
                                            <label style="font-size: 11px;">Sz√ºnet (px): <input type="number"
                                                    id="hl-dash-2" value="4" min="0" class="input-glass"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-2">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="milkyway-settings">
                            <h2>üåå TEJ√öT</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                        </div>
                        <div class="collapsible-content" id="milkyway-settings">
                            <div class="section">
                                <label><input id="mw_show" type="checkbox" checked> Tej√∫t megjelen√≠t√©se</label>
                                <div id="mw_show_settings" class="settings-panel">
                                    <label for="mw_style_fill">Sz√≠n</label>
                                    <input id="mw_style_fill" type="color" value="#ffffff">
                                    <label for="mw_style_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="mw_style_opacity" type="number" min="0.01" max="1" step="0.01"
                                        value="0.15">
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-header" data-target="sky-settings">
                            <h2>üåå √âGBOLT</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                        </div>
                        <div class="collapsible-content" id="sky-settings">
                            <!-- <div class="section settings-panel"> -->
                            <div class="section">
                                <label for="background_fill">√âg sz√≠ne</label>
                                <div>
                                    <input id="background_fill" type="color" value="#000000">
                                </div>
                                <label for="background_opacity">√Åttetsz≈ës√©g</label>
                                <input id="background_opacity" type="number" min="0.01" max="1" step="0.01" value="1">
                                <label for="background_stroke">K√∂rvonal sz√≠ne</label>
                                <input id="background_stroke" type="color" value="#FFFFFF">
                                <label for="background_stroke_width">K√∂rvonal vastags√°ga</label>
                                <input id="background_stroke_width" type="number" min="0" max="100" step="0.1"
                                    value="1.5">
                                <label style="margin-top: 8px; display: flex; align-items: center; cursor: pointer;">
                                    <input id="background_stroke_dash_check" type="checkbox"> Szaggatott
                                    k√∂rvonal
                                </label>
                                <div id="background_stroke_dash_settings"
                                    style="display:none; padding: 8px; border-radius: 6px;">
                                    <div class="grid-2-cols" style="gap: 5px;">
                                        <label style="font-size: 11px;">Vonal (px): <input type="number"
                                                id="background_stroke_dash_1" value="4" min="0"
                                                style="width: 100%;"></label>
                                        <label style="font-size: 11px;">Sz√ºnet (px): <input type="number"
                                                id="background_stroke_dash_2" value="4" min="0"
                                                style="width: 100%;"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-3">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="constellation-settings">
                            <h2>‚ú® CSILLAGK√âPEK</h2>
                            <span class="collapsible-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="constellation-settings">
                            <div class="section">
                                <label><input id="const_show" type="checkbox" checked>Csillagk√©pek
                                    vonalai</label>
                                <div id="const_show_settings" class="settings-panel">

                                    <label for="constellation_lineStyle_opacity">√Åttetsz≈ës√©g</label>
                                    <input id="constellation_lineStyle_opacity" type="number" min="0.01" max="1"
                                        step="0.01" value="0.6">
                                    <label for="constellation_lineStyle_stroke">Vonalak sz√≠ne</label>
                                    <input id="constellation_lineStyle_stroke" type="color" value="#cccccc">
                                    <label for="constellation_lineStyle_stroke_width">Vonalak vastags√°ga</label>
                                    <input id="constellation_lineStyle_stroke_width" type="number" min="0" max="100"
                                        step="0.1" value="1.5">
                                    <label
                                        style="margin-top: 8px; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="constellation_lineStyle_dash_check">
                                        Szaggatott vonalak
                                    </label>
                                    <div id="constellation_lineStyle_dash_settings"
                                        style="display:none; padding: 8px; border-radius: 6px;">
                                        <div class="grid-2-cols" style="gap: 5px;">
                                            <label style="font-size: 11px;">Vonal (px): <input type="number"
                                                    id="constellation_lineStyle_dash_1" value="4" min="0"
                                                    style="width: 100%;"></label>
                                            <label style="font-size: 11px;">Sz√ºnet (px): <input type="number"
                                                    id="constellation_lineStyle_dash_2" value="4" min="0"
                                                    style="width: 100%;"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-header" data-target="stars-settings">
                            <h2>‚≠ê CSILLAGOK</h2>
                            <span class="collapsible-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="stars-settings">
                            <div class="section">
                                <label><input type="checkbox" id="stars_show" checked> Csillagok
                                    megjelen√≠t√©se</label>
                                <div id="stars_show_settings" class="settings-panel">
                                    <label>F√©nyess√©g limit</label>
                                    <input id="stars_limit" type="number" min="0" max="6" step="0.1" value="6">
                                    <label>M√©ret</label>
                                    <input id="stars_size" type="number" value="7" min="5" max="100" step="0.1">
                                    <!-- <label>Kitev≈ë</label>
                                    <input id="stars_exponent" type="number" value="-0.28" min="-1" max="3" step="0.01"> -->

                                    <label><input type="checkbox" id="stars_colors" checked> Sz√≠nes
                                        csillagok</label>
                                    <div id="stars_colors_settings" style="display: none">
                                        <label for="stars_style_fill">Csillagok sz√≠ne</label>
                                        <input id="stars_style_fill" type="color" value="#FFFFFF">
                                        <label for="stars_style_opacity">Csillagok √°ttetsz≈ës√©ge</label>
                                        <input id="stars_style_opacity" type="number" value="1" min="0" max="1"
                                            step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-4">

                    <div class="designer-controls">
                        <div id="graticule-wrapper">
                            <div class="collapsible-header" data-target="graticule-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding:0px">
                                    <input id="lines_graticule" type="checkbox" checked>
                                    <span style="margin-left: 10px;">‚ö™ Fokh√°l√≥zat</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content" id="graticule-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_graticule_color">Sz√≠n</label>
                                        <input id="lines_graticule_color" type="color" value="#cccccc">
                                        <label for="lines_graticule_size">Vastags√°g</label>
                                        <input id="lines_graticule_size" type="number" min="0.1" max="6" step="0.1"
                                            value="0.6">
                                        <label for="lines_graticule_opacity">√Åttetsz≈ës√©g</label>
                                        <input id="lines_graticule_opacity" type="number" min="0.01" max="1" step="0.01"
                                            value="0.8">
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div id="equatorial-wrapper">
                            <div class="collapsible-header collapsed" data-target="equatorial-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_equatorial" type="checkbox">
                                    <span style="margin-left: 10px;">‚ö™Ô∏è Egyenl√≠t≈ëi</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="equatorial-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_equatorial_color">Sz√≠n</label>
                                        <input id="lines_equatorial_color" type="color" value="#aaaaaa">
                                        <label for="lines_equatorial_size">Vastags√°g</label>
                                        <input id="lines_equatorial_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_equatorial_opacity">√Åttetsz≈ës√©g</label>
                                        <input id="lines_equatorial_opacity" type="number" min="0.01" max="1"
                                            step="0.01" value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="ecliptic-wrapper">
                            <div class="collapsible-header collapsed" data-target="ecliptic-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_ecliptic" type="checkbox">
                                    <span style="margin-left: 10px;">üü¢ Ekliptika</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="ecliptic-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_ecliptic_color">Sz√≠n</label>
                                        <input id="lines_ecliptic_color" type="color" value="#66cc66">
                                        <label for="lines_ecliptic_size">Vastags√°g</label>
                                        <input id="lines_ecliptic_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_ecliptic_opacity">√Åttetsz≈ës√©g</label>
                                        <input id="lines_ecliptic_opacity" type="number" min="0.01" max="1" step="0.01"
                                            value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="galactic-wrapper">
                            <div class="collapsible-header collapsed" data-target="galactic-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_galactic" type="checkbox">
                                    <span style="margin-left: 10px;">üî¥ Galaktikus</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="galactic-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_galactic_color">Sz√≠n</label>
                                        <input id="lines_galactic_color" type="color" value="#cc6666">
                                        <label for="lines_galactic_size">Vastags√°g</label>
                                        <input id="lines_galactic_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_galactic_opacity">√Åttetsz≈ës√©g</label>
                                        <input id="lines_galactic_opacity" type="number" min="0.01" max="1" step="0.01"
                                            value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="supergalactic-wrapper">
                            <div class="collapsible-header collapsed" data-target="supergalactic-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_supergalactic" type="checkbox">
                                    <span style="margin-left: 10px;">üü£ Szupergalaktikus</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">‚ñº</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="supergalactic-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_supergalactic_color">Sz√≠n</label>
                                        <input id="lines_supergalactic_color" type="color" value="#cc66cc">
                                        <label for="lines_supergalactic_size">Vastags√°g</label>
                                        <input id="lines_supergalactic_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_supergalactic_opacity">√Åttetsz≈ës√©g</label>
                                        <input id="lines_supergalactic_opacity" type="number" min="0.01" max="1"
                                            step="0.01" value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-5">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="theme-settings-left">
                            <h2>üé® T√©m√°k (Presets)</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">‚ñº</i></span>
                        </div>
                        <div class="collapsible-content" id="theme-settings-left">
                            <div class="section">
                                <div
                                    style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.2); border-radius: 8px;">
                                    <label
                                        style="display:block; font-weight:bold; color: var(--accent-cyan); margin-bottom: 8px; font-size: 11px;">
                                        ALKALMAZ√ÅS M√ìDJA:
                                    </label>

                                    <label
                                        style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-left" value="global" checked
                                            style="margin-right: 8px;">
                                        <span>üåç Teljes v√°szonk√©p (Minden elem)</span>
                                    </label>

                                    <label
                                        style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-left" value="local"
                                            style="margin-right: 8px;">
                                        <span>üñºÔ∏è Csak a kiv√°lasztott k√©p (H√°tt√©rrel)</span>
                                    </label>

                                    <label style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-left" value="none" style="margin-right: 8px;">
                                        <span>üö´ Csak a kiv√°lasztott csillagt√©rk√©p (St√≠lus)</span>
                                    </label>
                                </div>

                                <div style="margin-top: 10px; margin-bottom: 10px;">
                                    <button onclick="restoreUserState()" class="add-btn accent"
                                        style="width: 100%; background: #546e7a;">
                                        ‚Ü∫ Saj√°t Be√°ll√≠t√°sok Vissza√°ll√≠t√°sa
                                    </button>
                                </div>

                                <div class="theme-grid" id="theme-grid-container-left"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="fragment-6">
                    <p style="text-align: center; padding: 50px; color: var(--text-secondary);">A Tervez≈ë
                        fel√ºlet
                        megny√≠lt a teljes k√©perny≈ën.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="cropper-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:white;">K√©p m√©retre v√°g√°sa</h3>
            <div class="img-container">
                <img id="image-to-crop" src="" alt="K√©p v√°g√°sa">
            </div>
            <div class="grid-2-cols">
                <button onclick="closeCropper()" class="add-btn secondary">M√©gse</button>
                <button onclick="performCrop()" class="add-btn primary">‚úÇÔ∏è Kiv√°g√°s & Hozz√°ad√°s</button>
            </div>
        </div>
    </div>
    <!-- <script type="text/javascript" src="celestial_jo_uj_lassankesz_rov_2_cc.js"></script> -->
    <script type="text/javascript" src="celestial_themes_e_nezet.js"></script>

    <script type="text/javascript">
        var szivszoge = 2.4;
        var szivratioja = 0.88;
        $("#tabs").tabs();
        $("#tabs_left").tabs();
        $("#tabs_r").tabs();
        $(document).on('change', '#szivszoge', function (e) {
            szivszoge = $(this).val();
            // console.log("szivszoge", szivszoge);
            Celestial.projections().customHeart = {
                arg: Math.PI / szivszoge, scale: 235, ratio: szivratioja
            };
            myCelestialConf.projection = "customHeart";
            // console.log("myCelestialConf", myCelestialConf);
            changeProjection(myCelestialConf.projection);
        });
        function leftfrag(nr) {
            $("#tabs_left").tabs("option", "active", nr);
        }
        // --- 1. OKOS KEZEL√âS: Ha a Checkbox/Label r√©szre kattintunk ---
        // Logika: Pipa be -> Nyit√°s | Pipa ki -> Z√°r√°s
        $(document).on('click', '.header-label', function (e) {
            e.stopPropagation(); // Meg√°ll√≠tjuk, hogy ne fusson le a sima toggle

            const header = $(this).closest('.collapsible-header');
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');
            const checkbox = $(this).find('input');

            // Pici k√©sleltet√©s kell, hogy a b√∂ng√©sz≈ë friss√≠tse a checkbox √°llapot√°t a kattint√°s ut√°n
            setTimeout(() => {
                const isChecked = checkbox.is(':checked');

                if (isChecked) {
                    // HA BEPIP√ÅLTUK -> MINDENK√âPP NYIT√ÅS
                    if (header.hasClass('collapsed')) {
                        header.removeClass('collapsed');
                        content.removeClass('collapsed').slideDown(300);
                        icon.css('transform', 'rotate(0deg)');
                    }
                } else {
                    // HA KIVETT√úK A PIP√ÅT -> MINDENK√âPP Z√ÅR√ÅS
                    if (!header.hasClass('collapsed')) {
                        header.addClass('collapsed');
                        content.addClass('collapsed').slideUp(300);
                        icon.css('transform', 'rotate(-90deg)');
                    }
                }
            }, 20);
        });

        // --- 2. √ÅLTAL√ÅNOS KEZEL√âS: Csak a ny√≠lra (vagy √ºres helyre) kattintva ---
        // Logika: Sima v√°lt√°s (Toggle), f√ºggetlen√ºl a pip√°t√≥l
        $(document).on('click', '.collapsible-header', function () {
            const header = $(this);
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');

            // Sima v√°lt√°s (Toggle)
            if (header.hasClass('collapsed')) {
                // Nyit√°s
                header.removeClass('collapsed');
                content.removeClass('collapsed').slideDown(300);
                icon.css('transform', 'rotate(0deg)');
            } else {
                // Z√°r√°s
                header.addClass('collapsed');
                content.addClass('collapsed').slideUp(300);
                icon.css('transform', 'rotate(-90deg)');
            }
        });

        // --- 1. EGYES√çTETT T√âMA ADATB√ÅZIS (Config + H√°tt√©r) ---
        const mapThemes = {
            "midnight": {
                name: "Midnight Blue",
                // Ez a background megy a #map-wrap-re √©s a Designer-re is:
                image: "images/themes/thumb_midnight.png",
                background: "linear-gradient(135deg, #0B1026 0%, #1a2542 100%)",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#0B1026", opacity: 1, stroke: "#ffffff", width: 2, dash: [null, null] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6, size: 7, exponent: -0.28, colors: true },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#4a9eff", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#2c3e50", opacity: 0.6, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.12 } }
                }
            },
            "minimal": {
                name: "Clean White",
                image: "images/themes/thumb_minimal.png",
                background: "#ffffff",
                textColor: "#000000",
                config: {
                    background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3, dash: [null, null] },
                    stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5, size: 7, exponent: -0.28, colors: true },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#333333", width: 1.5, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#cccccc", opacity: 0.5, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
                }
            },
            "vintage": {
                name: "Vintage Paper",
                image: "images/themes/thumb_vintage.png",
                background: "#f0e6d2",
                textColor: "#4a3b2a",
                config: {
                    background: { fill: "#f0e6d2", opacity: 1, stroke: "#8b5a2b", width: 4, dash: [null, null] },
                    stars: { show: true, style: { fill: "#4a3b2a", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#8b5a2b", width: 1.5, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#a67c52", opacity: 0.4, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#4a3b2a", opacity: 0.08 } }
                }
            },
            "cosmic": {
                name: "Cosmic Love",
                image: "images/themes/thumb_cosmic.png",
                background: "linear-gradient(135deg, #2d0a1e 0%, #4a1230 100%)",
                textColor: "#ffb7c5",
                config: {
                    background: { fill: "#2d0a1e", opacity: 1, stroke: "#ffb7c5", width: 1.5, dash: [null, null] },
                    stars: { show: true, style: { fill: "#ffb7c5", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9eb5", width: 1.3, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#804060", opacity: 0.4, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#ffb7c5", opacity: 0.15 } }
                }
            },
            "forest": {
                name: "Forest Night",
                image: "images/themes/thumb_forest.png",
                background: "#0a220a",
                textColor: "#e8f5e9",
                config: {
                    background: { fill: "#0a220a", opacity: 1, stroke: "#8fbc8f", width: 2 },
                    stars: { show: true, style: { fill: "#e8f5e9", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#8fbc8f", width: 1.2, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#1e3b1e", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#8fbc8f", opacity: 0.1 } }
                }
            },
            "monochrome": {
                name: "Mono Charcoal",
                image: "images/themes/thumb_monochrome.png",
                // style: "background: #222222; color: #ffffff;",
                background: "#222222",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#222222", opacity: 1, stroke: "#555555", width: 1 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 5.8 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#999999", width: 1, opacity: 0.9, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#444444", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.08 } }
                }
            },
            "golden": {
                name: "Golden Hour",
                image: "images/themes/thumb_golden.png",
                background: "#4a2511",
                textColor: "#ffcc00",
                config: {
                    background: { fill: "#4a2511", opacity: 1, stroke: "#ffcc00", width: 2.5 },
                    stars: { show: true, style: { fill: "#ffffcc", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.4, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#7a4521", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffcc00", opacity: 0.15 } }
                }
            },
            "ocean": {
                name: "Deep Ocean",
                image: "images/themes/thumb_ocean.png",
                background: "linear-gradient(to bottom, #001f3f 0%, #003366 100%)",
                textColor: "#7FDBFF",
                config: {
                    background: { fill: "#001f3f", opacity: 1, stroke: "#7FDBFF", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#7FDBFF", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#39CCCC", opacity: 0.3, width: 1.5 } },
                    mw: { show: true, style: { fill: "#7FDBFF", opacity: 0.1 } }
                }
            },
            "matrix": {
                name: "Cyber Matrix",
                image: "images/themes/thumb_matrix.png",
                // style: "background: #000000; color: #00ff00; border: 1px solid #00ff00;",
                background: "#000000",
                textColor: "#00ff00",
                config: {
                    background: { fill: "#000000", opacity: 1, stroke: "#00ff00", width: 1.5 },
                    stars: { show: true, style: { fill: "#ccffcc", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#00ff00", width: 1.2, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#003300", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#00ff00", opacity: 0.05 } }
                }
            },
            "aurora": {
                name: "Northern Lights",
                image: "images/themes/thumb_aurora.png",
                // style: "background: #022c22; color: #6ee7b7;",
                background: "linear-gradient(135deg, #022c22 0%, #064e3b 100%)",
                textColor: "#6ee7b7",
                config: {
                    background: { fill: "#022c22", opacity: 1, stroke: "#34d399", width: 2 },
                    stars: { show: true, style: { fill: "#d1fae5", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#10b981", width: 1.3, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#064e3b", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#34d399", opacity: 0.15 } }
                }
            },
            "royal": {
                name: "Royal Amethyst",
                image: "images/themes/thumb_royal.png",
                // style: "background: #240046; color: #ff9e00;",
                background: "linear-gradient(135deg, #240046 0%, #3c096c 100%)",
                textColor: "#ff9e00",
                config: {
                    background: { fill: "#240046", opacity: 1, stroke: "#ff9e00", width: 2 },
                    stars: { show: true, style: { fill: "#e0aaff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9e00", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#5a189a", opacity: 0.4, width: 1.5 } },
                    mw: { show: true, style: { fill: "#e0aaff", opacity: 0.12 } }
                }
            },
            "sweetheart": {
                name: "Sweetheart",
                image: "images/themes/thumb_sweetheart.png",
                background: "linear-gradient(135deg, #ffe4e1 0%, #ffc0cb 100%)",
                textColor: "#ff1493",
                config: {
                    background: { fill: "#ffe4e1", opacity: 1, stroke: "#ff1493", width: 2.5 },
                    stars: { show: true, style: { fill: "#ff69b4", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff1493", width: 1.5, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#ffb6c1", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ff1493", opacity: 0.05 } }
                }
            },
            "redvelvet": {
                name: "Red Velvet",
                image: "images/themes/thumb_redvelvet.png",
                background: "linear-gradient(135deg, #4a0404 0%, #6d0707 100%)",
                textColor: "#ffd700",
                config: {
                    background: { fill: "#4a0404", opacity: 1, stroke: "#ffd700", width: 1.5 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1.2, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#800000", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffd700", opacity: 0.1 } }
                }
            },
            "rosegold": {
                name: "Rose Gold",
                image: "images/themes/thumb_rosegold.png",
                background: "#fff0f5",
                textColor: "#b76e79",
                config: {
                    background: { fill: "#fff0f5", opacity: 1, stroke: "#b76e79", width: 3 },
                    stars: { show: true, style: { fill: "#b76e79", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#b76e79", width: 1.5, opacity: 0.9, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#e6e6fa", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#b76e79", opacity: 0.05 } }
                }
            },
            // --- √öJ MONOKR√ìM T√âM√ÅK ---
            "ink": {
                name: "Tinta (Fekete-Feh√©r)",
                image: "images/themes/thumb_ink.png", // Gener√°ld le hozz√° a k√©pet!
                background: "#ffffff",
                textColor: "#000000",
                config: {
                    background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3 },
                    stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#000000", width: 1.5, opacity: 1, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#dddddd", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.03 } }
                }
            },
            "slate": {
                name: "Palat√°bla (Kr√©tarajz)",
                image: "images/themes/thumb_slate.png",
                background: "#2b2b2b",
                textColor: "#f0f0f0",
                config: {
                    background: { fill: "#2b2b2b", opacity: 1, stroke: "#ffffff", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffffff", width: 1.2, opacity: 0.7, dash: [8, 8] } },
                    lines: { graticule: { show: true, stroke: "#555555", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.1 } }
                },
            },
            "silhouette": {
                name: "Sziluett (Silhouette)",
                image: "images/themes/thumb_silhouette.png",
                background: "#000000",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#000000", opacity: 1, stroke: "#ffffff", width: 1, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffffff", width: 1, opacity: 0.5, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#333333", opacity: 0.5, width: 1, dash: [2, 2] } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.15 } }
                }
            },
            "foggy": {
                name: "K√∂d√∂s Reggel (Foggy)",
                image: "images/themes/thumb_foggy.png",
                background: "#e0e0e0",
                textColor: "#333333",
                config: {
                    background: { fill: "#e0e0e0", opacity: 1, stroke: "#555555", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#333333", opacity: 1 }, limit: 5.8 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#555555", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#ffffff", opacity: 0.6, width: 1.5, dash: [] } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
                }
            },

            // --- SZERELMES T√âM√ÅK ---
            "blush": {
                name: "R√≥zsasz√≠n √Ålom (Blush)",
                image: "images/themes/thumb_blush.png",
                background: "linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)",
                textColor: "#d81b60",
                config: {
                    background: { fill: "#fff0f5", opacity: 1, stroke: "#d81b60", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#d81b60", opacity: 0.8 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d81b60", width: 1.5, opacity: 0.5, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#ffc0cb", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#d81b60", opacity: 0.05 } }
                }
            },
            "passion": {
                name: "Szenved√©ly (Passion)",
                image: "images/themes/thumb_passion.png",
                background: "linear-gradient(135deg, #4a0000 0%, #2a0000 100%)",
                textColor: "#ffcc00",
                config: {
                    background: { fill: "#4a0000", opacity: 1, stroke: "#ff0000", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.2, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#800000", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#ff0000", opacity: 0.1 } }
                }
            },

            // --- ELEG√ÅNS T√âM√ÅK ---
            "royal_gold": {
                name: "Kir√°lyi Arany (Royal)",
                image: "images/themes/thumb_royalgold.png",
                background: "#051e3e",
                textColor: "#d4af37",
                config: {
                    background: { fill: "#051e3e", opacity: 1, stroke: "#d4af37", width: 3, dash: [] },
                    stars: { show: true, style: { fill: "#d4af37", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#1a3a6e", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#d4af37", opacity: 0.1 } }
                }
            },
            "silver": {
                name: "Ez√ºst√∂s (Silver)",
                image: "images/themes/thumb_silver.png",
                background: "linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%)",
                textColor: "#2c3e50",
                config: {
                    background: { fill: "#e6e9f0", opacity: 1, stroke: "#bdc3c7", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#2c3e50", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#7f8c8d", width: 1.2, opacity: 0.8, dash: [2, 2] } },
                    lines: { graticule: { show: true, stroke: "#ecf0f1", opacity: 1, width: 1.5, dash: [] } },
                    mw: { show: true, style: { fill: "#2c3e50", opacity: 0.05 } }
                }
            },
            "emerald": {
                name: "Smaragd (Emerald)",
                image: "images/themes/thumb_emerald.png",
                background: "#064e3b",
                textColor: "#d1fae5",
                config: {
                    background: { fill: "#064e3b", opacity: 1, stroke: "#34d399", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#34d399", width: 1.3, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#047857", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#34d399", opacity: 0.1 } }
                }
            },
            "copper": {
                name: "R√©z & Bronz (Copper)",
                image: "images/themes/thumb_copper.png",
                background: "#2a1b15",
                textColor: "#e2a07d",
                config: {
                    background: { fill: "#2a1b15", opacity: 1, stroke: "#cd7f32", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#e2a07d", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#cd7f32", width: 1.2, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#5c3a2e", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#e2a07d", opacity: 0.1 } }
                }
            }
        };

        // --- 2. SAJ√ÅT BE√ÅLL√çT√ÅSOK MENT√âSE (OBJECTBE) ---
        let userSavedState = null;
        let activeThemeKey = "custom";
        let activeVariant = "normal";

        // --- MENT√âS FRISS√çT√âSE ---
        function saveUserState() {
            if (activeThemeKey !== 'custom') return;
            //console.log("function saveUserState() {");

            // Safety check: Initialization
            if (typeof initUserData === 'function' && (!window.myCelestialConf || !window.myCelestialConf.userData)) {
                initUserData();
            }

            if (!window.myCelestialConf) {
                console.warn("saveUserState: myCelestialConf is missing!");
                return;
            }

            // --- JAV√çTOTT K√ìD KEZDETE ---
            // Ments√ºnk mindent, ami a vizualit√°shoz kell (gradiens h√°tt√©r, fal sz√≠ne)
            const designerSvg = document.getElementById('designer-svg');
            const currentVisualBackground = designerSvg ?
                (designerSvg.style.background || designerSvg.style.backgroundColor) :
                ($("#background_fill").val() || "#000000");

            try {
                // Biztons√°gos m√©ly m√°sol√°s
                const safeConfig = window.myCelestialConf ? JSON.parse(JSON.stringify(window.myCelestialConf)) : {};
                const safeUserData = (window.myCelestialConf && window.myCelestialConf.userData) ? JSON.parse(JSON.stringify(window.myCelestialConf.userData)) : {};
                const safeHighlights = (window.Celestial && window.Celestial.highlightList) ? JSON.parse(JSON.stringify(window.Celestial.highlightList)) : {};

                userSavedState = {
                    config: safeConfig,
                    userData: safeUserData,
                    highlights: safeHighlights,

                    // EXTRA META ADATOK A TELJES VISSZA√ÅLL√çT√ÅSHOZ
                    meta: {
                        activeTheme: activeThemeKey,
                        visualBackground: currentVisualBackground, // Ez t√°rolja a gradienst is!
                        wallColor: $("#wall-bg-color").val() || "#222",      // Fal sz√≠ne
                        timestamp: Date.now()
                    }
                };
                // console.log("Saj√°t be√°ll√≠t√°sok (MINDEN) elmentve.");
            } catch (e) {
                console.error("Hiba a saveUserState sor√°n:", e);
            }
            // --- JAV√çTOTT K√ìD V√âGE ---
        }
        // --- JAV√çTOTT VISSZA√ÅLL√çT√ÅS (H√ÅTT√âRREL EGY√úTT) ---
        function restoreUserState() {
            if (!userSavedState) {
                alert("Nincs elmentett saj√°t be√°ll√≠t√°s!");
                return;
            }
            // console.log("function restoreUserState() {");
            // console.log("Saj√°t be√°ll√≠t√°sok vissza√°ll√≠t√°sa...");
            // --- JAV√çTOTT K√ìD KEZDETE ---
            // 1. Config vissza√°ll√≠t√°sa
            myCelestialConf = JSON.parse(JSON.stringify(userSavedState.config));
            activeThemeKey = userSavedState.meta ? userSavedState.meta.activeTheme : "custom";
            activeVariant = "normal";
            // --- JAV√çTOTT K√ìD V√âGE ---
            // console.log("function restoreUserState() { myCelestialConf", myCelestialConf);

            // 2. UI INPUTOK SZINKRONIZ√ÅL√ÅSA
            // Tej√∫t
            $("#mw_style_fill").val(myCelestialConf.mw.style.fill);
            $("#mw_style_opacity").val(myCelestialConf.mw.style.opacity);
            $("#mw_show").prop('checked', myCelestialConf.mw.show);


            // --- DASH checkboxok friss√≠t√©se a t√©ma alapj√°n ---
            // 1. H√°tt√©r (K√∂rvonal)
            var bgDash = myCelestialConf.background.dash; // Ez egy t√∂mb, pl. [4, 4] vagy []
            var hasBgDash = bgDash && bgDash.length > 0;

            // Checkbox be√°ll√≠t√°sa
            $("#background_stroke_dash_check").prop('checked', hasBgDash);

            // Panel nyit√°sa/csuk√°sa √©s √©rt√©kek be√≠r√°sa
            if (hasBgDash) {
                $("#background_stroke_dash_settings").slideDown();
                $("#background_stroke_dash_1").val(bgDash[0]); // Vonal hossza
                $("#background_stroke_dash_2").val(bgDash[1]); // Sz√ºnet hossza
            } else {
                $("#background_stroke_dash_settings").slideUp();
            }
            // 2. Csillagk√©pek
            var constDash = myCelestialConf.constellations.lineStyle.dash;
            var hasConstDash = constDash && constDash.length > 0;

            $("#constellation_lineStyle_dash_check").prop('checked', hasConstDash);
            if (hasConstDash) {
                $("#constellation_lineStyle_dash_settings").slideDown();
                $("#constellation_lineStyle_dash_1").val(constDash[0]);
                $("#constellation_lineStyle_dash_2").val(constDash[1]);
            } else {
                $("#constellation_lineStyle_dash_settings").slideUp();
            }
            // 3. Fokh√°l√≥zat (Graticule)
            var gratDash = myCelestialConf.lines.graticule.dash;
            var hasGratDash = gratDash && gratDash.length > 0;

            $("#lines_graticule_dash_check").prop('checked', hasGratDash);
            if (hasGratDash) {
                $("#lines_graticule_dash_settings").slideDown();
                $("#lines_graticule_dash_1").val(gratDash[0]);
                $("#lines_graticule_dash_2").val(gratDash[1]);
            } else {
                $("#lines_graticule_dash_settings").slideUp();
            }


            // Tej√∫t
            if (myCelestialConf.mw.show) $("#mw_show_settings").slideDown(); else $("#mw_show_settings").slideUp();


            // H√°tt√©r INPUTOK
            $("#background_fill").val(myCelestialConf.background.fill);
            $("#background_opacity").val(myCelestialConf.background.opacity);
            $("#background_stroke").val(myCelestialConf.background.stroke);
            $("#background_stroke_width").val(myCelestialConf.background.width);

            // console.log("myCelestialConf.constellations.lineStyle.stroke", myCelestialConf.constellations.lineStyle.stroke);
            // console.log("myCelestialConf.constellations.lineStyle.opacity", myCelestialConf.constellations.lineStyle.opacity);
            // console.log("myCelestialConf.constellations.lineStyle.width", myCelestialConf.constellations.lineStyle.width);

            // --- JAV√çTOTT: Csillagk√©pek UI vissza√°ll√≠t√°sa (T√∂mbkezel√©ssel) ---
            var cStyle = myCelestialConf.constellations.lineStyle;

            // Sz√≠n, √Åttetsz≈ës√©g, Vastags√°g: Ha t√∂mb, akkor az els≈ë elemet vessz√ºk
            var cStroke = Array.isArray(cStyle.stroke) ? cStyle.stroke[0] : cStyle.stroke;
            var cOpacity = Array.isArray(cStyle.opacity) ? cStyle.opacity[0] : cStyle.opacity;
            var cWidth = Array.isArray(cStyle.width) ? cStyle.width[0] : cStyle.width;

            $("#constellation_lineStyle_stroke").val(cStroke);
            $("#constellation_lineStyle_opacity").val(cOpacity);
            $("#constellation_lineStyle_stroke_width").val(cWidth);

            // Szaggatott vonalak (Dash)
            var cDash = cStyle.dash;
            // Ha a dash is t√∂mb√∂s√≠tve lett (pl. [[4,4], [4,4], [4,4]]), akkor kivessz√ºk az els≈ët
            if (Array.isArray(cDash) && cDash.length > 0 && Array.isArray(cDash[0])) {
                cDash = cDash[0];
            }

            var hasConstDash = cDash && cDash.length > 0; // Most m√°r sima t√∂mb (pl. [4,4]) vagy null

            $("#constellation_lineStyle_dash_check").prop('checked', hasConstDash);
            if (hasConstDash) {
                $("#constellation_lineStyle_dash_settings").slideDown();
                $("#constellation_lineStyle_dash_1").val(cDash[0]);
                $("#constellation_lineStyle_dash_2").val(cDash[1]);
            } else {
                $("#constellation_lineStyle_dash_settings").slideUp();
            }

            $("#const_show").prop('checked', myCelestialConf.constellations.lines);
            // ------------------------------------------------------------------
            if (myCelestialConf.constellations.lines) $("#const_show_settings").slideDown(); else $("#const_show_settings").slideUp();

            // Csillagok
            $("#stars_limit").val(myCelestialConf.stars.limit);
            $("#stars_size").val(myCelestialConf.stars.size);
            $("#stars_style_fill").val(myCelestialConf.stars.style.fill);
            $("#stars_style_opacity").val(myCelestialConf.stars.style.opacity);
            $("#stars_show").prop('checked', myCelestialConf.stars.show);
            if (myCelestialConf.stars.show) $("#stars_show_settings").slideDown(); else $("#stars_show_settings").slideUp();

            // R√°cs
            $("#lines_graticule_color").val(myCelestialConf.lines.graticule.stroke);
            $("#lines_graticule_size").val(myCelestialConf.lines.graticule.width);
            $("#lines_graticule_opacity").val(myCelestialConf.lines.graticule.opacity);
            $("#lines_graticule").prop('checked', myCelestialConf.lines.graticule.show);

            // 3. Alkalmaz√°s a t√©rk√©pre
            change(myCelestialConf);
            changeProjection(myCelestialConf.projection);

            // 4. H√ÅTT√âR VISSZA√ÅLL√çT√ÅSA (CSS + Rect) EZ LEHET NEM KELL
            // Ez a r√©sz kezeli a szerkeszt≈ë (#map-wrap) √©s a tervez≈ë (#designer-svg) h√°tter√©t is
            if (userSavedState.background) {
                $("#map-wrap").css("background", userSavedState.background);
                $("#designer-svg").css("background", userSavedState.background);

                // Export rect kezel√©se
                if (window.updateCanvasBackground) {
                    window.updateCanvasBackground(userSavedState.background);
                }
            }

            // 3. Alkalmaz√°s a t√©rk√©pre
            // change(myCelestialConf);
            // changeProjection(myCelestialConf.projection);

            // --- JAV√çTOTT K√ìD KEZDETE ---
            // 4. H√ÅTT√âR √âS FAL VISSZA√ÅLL√çT√ÅSA
            // Ha van meta adatunk, haszn√°ljuk azt, mert az pontosabb (gradiens)
            let bgToRestore = userSavedState.meta && userSavedState.meta.visualBackground ?
                userSavedState.meta.visualBackground :
                (userSavedState.background || "#000000");

            $("#map-wrap").css("background", bgToRestore);
            $("#designer-svg").css("background", bgToRestore);

            if (window.updateCanvasBackground) {
                if (bgToRestore.includes("gradient")) {
                    document.getElementById('designer-svg').style.background = bgToRestore;
                } else {
                    window.updateCanvasBackground(bgToRestore);
                }
            }

            // Fal sz√≠ne
            if (userSavedState.meta && userSavedState.meta.wallColor) {
                $("#wall-bg-color").val(userSavedState.meta.wallColor);
                if (typeof window.updateWallColor === 'function') {
                    window.updateWallColor(userSavedState.meta.wallColor);
                }
            }
            // --- JAV√çTOTT K√ìD V√âGE ---

            // 5. Sz√∂vegek √©s Be√°ll√≠t√°sok vissza√°ll√≠t√°sa (JAV√çTOTT)
            if (userSavedState.userData) {
                // A teljes userData-t vissza√°ll√≠tjuk
                myCelestialConf.userData = JSON.parse(JSON.stringify(userSavedState.userData));

                // Friss√≠tj√ºk a n√©zeteket
                if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                if (typeof renderZoneUI === 'function') {
                    renderZoneUI('top');
                    renderZoneUI('bottom');
                }

                // Friss√≠tj√ºk a v√°szon m√©ret√©t √©s a t√©rk√©p poz√≠ci√≥j√°t is az adatokb√≥l
                if (typeof window.updateCanvasSize === 'function') window.updateCanvasSize();
                if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
            }


            // 5. --- √öJ: KIEMEL√âSEK VISSZA√ÅLL√çT√ÅSA ---
            if (userSavedState.highlights) {
                Celestial.highlightList = JSON.parse(JSON.stringify(userSavedState.highlights));
                Celestial.redraw();
                renderActiveHighlights();

                // --- JAV√çTOTT K√ìD KEZDETE ---
                if (typeof closeHighlightSettings === 'function') closeHighlightSettings(); // Panel bez√°r√°sa
            } else {
                if (typeof Celestial.clearHighlights === 'function') Celestial.clearHighlights();
                if (typeof renderActiveHighlights === 'function') renderActiveHighlights();
            }
            // --- JAV√çTOTT K√ìD V√âGE ---


            $('.theme-item').removeClass('active-theme');
            $('#custom-theme-card').addClass('active-theme');
            // --- √öJ R√âSZ: Tervez≈ë n√©zet azonnali friss√≠t√©se ---
            // Ez m√°solja √°t a helyre√°ll√≠tott t√©rk√©pet a Tervez≈ëbe
            setTimeout(function () {
                if (typeof window.copyMapToDesigner === 'function') {
                    window.copyMapToDesigner();
                }
                // Ez igaz√≠tja helyre a poz√≠ci√≥t √©s m√©retet
                if (typeof window.refreshMapTransform === 'function') {
                    window.refreshMapTransform();
                }
            }, 200); // Pici k√©sleltet√©s, hogy a Celestial.redraw() biztosan v√©gezzen
        }


        // --- √öJ SEG√âDF√úGGV√âNY: Melyik h√°tt√©r m√≥d van kiv√°lasztva? ---
        function getActiveBackgroundMode() {
            // 1. Megn√©zz√ºk, melyik f√ºl/panel l√°that√≥ √©ppen
            const isDesignerTabVisible = $("#tabs_r").is(":visible") && $("#fragment_r-5").is(":visible");
            const isEditorTabVisible = $("#fragment-5").is(":visible"); // Bal oldali panel

            let mode = 'global'; // Alap√©rtelmezett

            if (isDesignerTabVisible) {
                // Ha a jobb oldali Tervez≈ë f√ºl√∂n vagyunk, olvassuk a 'bg-mode-right' r√°di√≥kat
                const radios = document.getElementsByName('bg-mode-right');
                for (let r of radios) if (r.checked) mode = r.value;
                console.log("H√°tt√©r m√≥d (Designer panel):", mode);
            } else if (isEditorTabVisible) {
                // Ha a bal oldali Szerkeszt≈ë f√ºl√∂n vagyunk, olvassuk a 'bg-mode-left' r√°di√≥kat
                const radios = document.getElementsByName('bg-mode-left');
                for (let r of radios) if (r.checked) mode = r.value;
                console.log("H√°tt√©r m√≥d (Editor panel):", mode);
            } else {
                // Ha egyik sem egy√©rtelm≈± (pl. script h√≠vja), megn√©zz√ºk mindkett≈ët, 
                // √©s amelyik nem 'global', azt vessz√ºk figyelembe (priorit√°s).
                const rRight = document.querySelector('input[name="bg-mode-right"]:checked');
                const rLeft = document.querySelector('input[name="bg-mode-left"]:checked');

                if (rRight && rRight.value !== 'global') mode = rRight.value;
                else if (rLeft && rLeft.value !== 'global') mode = rLeft.value;
            }

            return mode;
        }

        // --- √öJ: R√°di√≥gombok √°llapot√°nak friss√≠t√©se az elem t√≠pusa alapj√°n ---
        // Fot√≥ √©s Hold elemekn√©l a "Csak st√≠lus" opci√≥ nem el√©rhet≈ë
        window.updateThemeModeRadioState = function () {
            if (!myCelestialConf.userData) return;

            const uiState = myCelestialConf.userData.uiState;
            const selectedId = uiState.selectedElementId;
            const selectedEl = myCelestialConf.userData.elements.find(e => e.id == selectedId);

            // console.log(`üîò updateThemeModeRadioState: selectedId=${selectedId}, type=${selectedEl ? selectedEl.type : 'N/A'}`);

            // Meghat√°rozzuk, hogy t√©rk√©p-e az elem
            const isMapElement = selectedEl && selectedEl.type === 'map';

            // Mindk√©t panel r√°di√≥inak kezel√©se
            const radioNames = ['bg-mode-left', 'bg-mode-right'];

            radioNames.forEach(radioName => {
                const radios = document.getElementsByName(radioName);
                radios.forEach(radio => {
                    if (radio.value === 'none') {
                        const label = radio.closest('label');
                        if (isMapElement) {
                            // T√©rk√©p - enged√©lyezve
                            radio.disabled = false;
                            if (label) {
                                label.style.opacity = '1';
                                label.style.cursor = 'pointer';
                                label.title = '';
                            }
                            // console.log(`üîò Enabled 'none' radio for ${radioName}`);
                        } else {
                            // Fot√≥/Hold - letiltva
                            radio.disabled = true;
                            if (label) {
                                label.style.opacity = '0.4';
                                label.style.cursor = 'not-allowed';
                                label.title = 'Ez az opci√≥ csak csillagt√©rk√©pekn√©l el√©rhet≈ë';
                            }
                            // console.log(`üîò Disabled 'none' radio for ${radioName}`);

                            // Ha a 'none' volt kiv√°lasztva, v√°ltsunk 'global'-ra
                            if (radio.checked) {
                                const globalRadio = document.querySelector(`input[name="${radioName}"][value="global"]`);
                                if (globalRadio) {
                                    globalRadio.checked = true;
                                    // console.log(`üîò Switched from 'none' to 'global' for ${radioName}`);
                                }
                            }
                        }
                    }
                });
            });
        };

        function createCardHTML(key, theme, variant, sourceSide = 'right') {
            const isHeart = variant === 'heart';

            const card = document.createElement('div');
            card.className = 'theme-item';
            card.style.cursor = "pointer";

            // Fejl√©c (N√©v)
            const label = document.createElement('div');
            label.className = "theme-btn";
            label.dataset.key = key;
            label.dataset.variant = variant;

            // Sz√≠v ikon a n√©vhez, ha sz√≠v m√≥d
            label.innerText = isHeart ? `‚ô• ${theme.name}` : theme.name;

            // St√≠lusok
            label.style.background = isHeart ? "#ffebee" : "#fff"; // Halv√°ny r√≥zsasz√≠n a sz√≠vnek
            label.style.color = isHeart ? "#d81b60" : "#000";

            // K√©p (Preview)
            const preview = document.createElement('div');
            preview.className = 'theme-preview-img';

            // K√©p URL manipul√°ci√≥ a sz√≠v verzi√≥hoz
            let imgUrl = theme.image;
            if (isHeart && imgUrl) {
                // Felt√©telezz√ºk, hogy van _heart v√©g≈± k√©p, pl. thumb_midnight_heart.png
                // Ha nincs, a .replace nem rontja el, csak ha tal√°l .png-t
                imgUrl = imgUrl.replace('.png', '_heart.png');
            }

            if (imgUrl) {
                preview.style.backgroundImage = `url('${imgUrl}')`;
                // Fallback: h√°tt√©rsz√≠n + k√©p
                preview.style.background = `url('${imgUrl}') center/contain no-repeat, ${theme.background}`;
            } else {
                preview.style.background = theme.background;
            }

            card.appendChild(label);
            card.appendChild(preview);

            card.onclick = function () {
                loadTheme(key, variant, sourceSide);
            };

            return card;
        }
        // Seg√©df√ºggv√©ny a k√°rtya l√©trehoz√°s√°hoz
        function createThemeCard(container, key, theme, variant) {
            const isHeart = (variant === 'heart');

            const card = document.createElement('div');
            card.className = 'theme-item';
            card.style.cursor = "pointer";
            card.style.background = "#fff";
            card.style.overflow = "hidden";
            card.style.borderRadius = "8px";
            card.style.border = "1px solid #ddd";

            // FEJL√âC
            const label = document.createElement('div');
            // Ha sz√≠v, tegy√ºnk jelet a n√©vhez
            label.innerText = isHeart ? `‚ô• ${theme.name}` : theme.name;
            label.className = "theme-btn";
            // T√°roljuk az adatokat a gombban a kiv√°laszt√°shoz
            label.dataset.key = key;
            label.dataset.variant = variant;

            label.style.padding = "8px";
            label.style.textAlign = "center";
            label.style.fontSize = "13px";
            label.style.fontWeight = "bold";
            label.style.background = isHeart ? "#ffebee" : "#fff"; // Sz√≠vn√©l halv√°ny r√≥zsasz√≠n fejl√©c
            label.style.color = isHeart ? "#d81b60" : "#000";
            label.style.borderBottom = "1px solid #eee";

            // K√âP (Preview)
            const preview = document.createElement('div');
            preview.className = 'theme-preview-img';

            // K√©p URL logik√°ja:
            // Norm√°l: theme.image (pl. thumb_midnight.png)
            // Sz√≠v: theme.image cser√©lve (pl. thumb_midnight_heart.png)
            let imgUrl = theme.image;
            if (isHeart && imgUrl) {
                imgUrl = imgUrl.replace('.png', '_heart.png');
            }

            if (imgUrl) {
                // Background + K√©p
                preview.style.background = `url('${imgUrl}') center/contain no-repeat, ${theme.background}`;
            } else {
                preview.style.background = theme.background;
            }

            preview.style.width = "100%";
            preview.style.height = "160px"; // Kicsit kisebb, hogy t√∂bb kif√©rjen

            // Kattint√°s esem√©ny
            card.onclick = function (e) {
                e.preventDefault();
                loadTheme(key, variant);
            };

            card.appendChild(label);
            card.appendChild(preview);
            container.appendChild(card);
        }

        // --- T√âMA BET√ñLT√âS (A CORE FUNKCI√ì) ---
        // ============================================================
        // --- STABIL T√âMA BET√ñLT√âS (ADAT M√ìDOS√çT√ÅS -> RENDER SOR) ---
        // ============================================================
        window.loadTheme = function (key, variant = 'normal', sourceSide = 'right') {
            if (typeof window.logDebug !== 'function') {
                window.logDebug = function (msg) {
                    // console.log("DEBUG_THEME: " + msg);
                    let dbg = document.getElementById('debug-theme-log');
                    if (!dbg) {
                        dbg = document.createElement('div');
                        dbg.id = 'debug-theme-log';
                        dbg.style.cssText = "position:fixed; top:0; left:0; width:400px; max-height:50vh; overflow:auto; background:rgba(0,0,0,0.85); color:#0f0; z-index:99999; font-family:monospace; font-size:11px; padding:5px; pointer-events:none;";
                        document.body.appendChild(dbg);
                    }
                    dbg.innerHTML += "<div>" + msg + "</div>";
                    dbg.scrollTop = dbg.scrollHeight;
                }
            }
            /*window.logDebug(`LOADTHEME CALLED: key=${key}, variant=${variant}, sourceSide=${sourceSide}`);*/

            // console.log(`üé® T√©ma kiv√°lasztva: ${key} (${variant})`);

            if (!myCelestialConf.userData) initUserData();

            // 1. Melyik az akt√≠v elem?
            const uiState = myCelestialConf.userData.uiState;
            let targetId = uiState.selectedElementId;
            let selectedEl = myCelestialConf.userData.elements.find(e => e.id == targetId);

            /*window.logDebug(`TargetID from UIState: ${targetId}`);*/
            // console.log(`üéØ loadTheme: Selected element ID: ${targetId}, type: ${selectedEl ? selectedEl.type : 'N/A'}, subType: ${selectedEl ? selectedEl.subType : 'N/A'}`);

            // Ellen≈ërizz√ºk az elem t√≠pus√°t (map, photo, moon)
            const isMapElement = selectedEl && selectedEl.type === 'map';
            const isPhotoElement = selectedEl && selectedEl.type === 'photo' && selectedEl.subType !== 'moon';
            const isMoonElement = selectedEl && selectedEl.type === 'photo' && selectedEl.subType === 'moon';

            // console.log(`üîç loadTheme: isMap=${isMapElement}, isPhoto=${isPhotoElement}, isMoon=${isMoonElement}`);

            // Ha nincs kiv√°lasztva elem, keress√ºk az els≈ë t√©rk√©pet
            if (!selectedEl) {
                /*window.logDebug(`Selected element not found. Falling back to first map.`);*/
                selectedEl = myCelestialConf.userData.elements.find(e => e.type === 'map');
                if (selectedEl) targetId = selectedEl.id;
            }

            if (!selectedEl) {
                /*window.logDebug("ERROR: No element found!");*/
                alert("Nincs kiv√°lasztva elem!");
                return;
            }

            /*window.logDebug(`Final Selected Element ID: ${selectedEl.id}, Type: ${selectedEl.type}, SubType: ${selectedEl.subType || 'N/A'}`);*/

            // 2. T√©ma bet√∂lt√©se
            const theme = mapThemes[key];
            if (!theme) return;

            activeThemeKey = key;
            activeVariant = variant;

            // Alap config el≈ëk√©sz√≠t√©se (K√©nyszer√≠tett 1000px)
            let themeConfig = JSON.parse(JSON.stringify(theme.config));
            themeConfig.width = 1000;

            // Projekci√≥ kezel√©se
            if (variant === 'heart') {
                themeConfig.projection = "customHeart";
                selectedEl.mask = 'none';
            } else {
                themeConfig.projection = "stereographic";
            }

            // 3. M√ìD KIV√ÅLASZT√ÅSA
            // Haszn√°ljuk a k√∂zonti, robusztus f√ºggv√©nyt a m√≥d meghat√°roz√°s√°ra
            let bgMode = 'global';
            // Ellen≈ërizz√ºk, hogy el√©rhet≈ë-e a helper f√ºggv√©ny (mivel k√ºls≈ë JS-ben lehet)
            if (typeof window.getActiveBackgroundMode === 'function') {
                bgMode = window.getActiveBackgroundMode();
            } else if (typeof getActiveBackgroundMode === 'function') {
                bgMode = getActiveBackgroundMode();
            } else {
                // Fallback (ha valami√©rt nem el√©rhet≈ë a fv)
                let radioName = (sourceSide === 'left') ? 'bg-mode-left' : 'bg-mode-right';
                let selectedRadio = document.querySelector(`input[name="${radioName}"]:checked`);
                // Ha nincs tal√°lat, megn√©zz√ºk a m√°sik oldalt is (Fallback)
                if (!selectedRadio) {
                    const otherRadioName = (sourceSide === 'left') ? 'bg-mode-right' : 'bg-mode-left';
                    selectedRadio = document.querySelector(`input[name="${otherRadioName}"]:checked`);
                }
                if (selectedRadio) bgMode = selectedRadio.value;
            }

            // console.log("LoadTheme detected mode:", bgMode, "SourceSide:", sourceSide);

            // --- ADATB√ÅZIS FRISS√çT√âSE (M√âG NEM RAJZOLUNK!) ---
            const mapsToRender = []; // Ebbe gy≈±jtj√ºk azokat az ID-kat, akiket √∫jra kell gener√°lni

            if (bgMode === 'global') {
                // üåç GLOB√ÅLIS:
                // console.log("üåç loadTheme: GLOBAL mode - applying to ALL elements");
                // 1. V√°szon h√°tt√©r be√°ll√≠t√°sa
                window.updateCanvasBackground(theme.background);

                // 2. Minden elem m√≥dos√≠t√°sa
                myCelestialConf.userData.elements.forEach(el => {
                    // Csekkoljuk a bleedMode-ot
                    if (el.bleedMode === 'custom') {
                        // Ha egy√©ni kifut√≥ van be√°ll√≠tva, NE √≠rjuk fel√ºl null-lal vagy a t√©m√°val!
                        // el.localBackground = el.bleedColor; // M√°r be van √°ll√≠tva
                        // console.log(`üîí Element ${el.id} has CUSTOM bleed mode. Keeping localBackground: ${el.localBackground}`);
                    } else {
                        el.localBackground = null; // Glob√°lisn√°l t√∂r√∂lj√ºk a lok√°lis h√°tteret (hogy √°tl√°tsz√≥ legyen a canvas sz√≠n√©re)
                    }
                    // console.log(`üåç Processing element: ${el.id}, type: ${el.type}, subType: ${el.subType || 'N/A'}`);

                    if (el.type === 'map') {
                        // Config friss√≠t√©se (megtartva a helyadatokat)
                        updateElementConfig(el, themeConfig);
                        // Sz√∂vegek sz√≠nez√©se
                        updateZoneColors(el.id, theme.textColor);
                        // Hozz√°ad√°s a renderel√©si list√°hoz
                        mapsToRender.push(el);
                        /*window.logDebug(`Added MAP element to mapsToRender (Global Mode): ${el.id}`);*/
                    } else if (el.type === 'photo') {
                        // Fot√≥ vagy Hold elem - sz√∂vegek sz√≠nez√©se
                        // console.log(`üì∑ Processing photo/moon element: ${el.id}, subType: ${el.subType || 'photo'}`);
                        updateZoneColors(el.id, theme.textColor);
                        /*window.logDebug(`Updated text colors for PHOTO/MOON element (Global Mode): ${el.id}`);*/
                    }
                });

                // Fot√≥/Hold elemek megjelen√≠t√©s√©nek friss√≠t√©se (Global mode)
                const hasPhotoElements = myCelestialConf.userData.elements.some(e => e.type === 'photo');
                if (hasPhotoElements) {
                    setTimeout(() => {
                        if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
                        if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                        // console.log(`üì∑ Refreshed display for photo/moon elements (Global Mode)`);
                    }, 100);
                }

            } else if (bgMode === 'local') {
                // üñºÔ∏è LOK√ÅLIS:
                console.log(`üñºÔ∏è loadTheme: LOCAL mode - applying to selected element: ${selectedEl.id}, type: ${selectedEl.type}`);
                /*window.logDebug("EXECUTING LOCAL MODE LOGIC");*/

                // 1. Csak a kijel√∂lt elem h√°ttere
                if (selectedEl.bleedMode === 'custom') {
                    console.log(`üîí Selected element has CUSTOM bleed mode. Ignoring theme background.`);
                } else {
                    selectedEl.localBackground = theme.background;
                    console.log(`üñºÔ∏è Set localBackground for ${selectedEl.id}: ${theme.background}`);
                }

                if (selectedEl.type === 'map') {
                    // 2. Config friss√≠t√©se (csak t√©rk√©pn√©l)
                    updateElementConfig(selectedEl, themeConfig);
                    // Hozz√°ad√°s a renderel√©si list√°hoz
                    mapsToRender.push(selectedEl);
                    /*window.logDebug(`Added selectedEl to mapsToRender (Local Mode): ${selectedEl.id}`);*/
                } else {
                    console.log(`üì∑ Photo/Moon element - skipping celestial config update, triggering refresh`);
                    // Fot√≥/Hold elemn√©l nincs t√©rk√©p renderel√©s, de friss√≠teni kell a megjelen√≠t√©st
                    setTimeout(() => {
                        if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
                        if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                        console.log(`üì∑ Refreshed display for photo/moon element: ${selectedEl.id}`);
                    }, 100);
                }

                // 3. Sz√∂vegek sz√≠nez√©se (mindegyik elemt√≠pusn√°l)
                updateZoneColors(selectedEl.id, theme.textColor);
                console.log(`üñºÔ∏è Updated text colors for element: ${selectedEl.id}`);

            } else if (bgMode === 'none') {
                // üö´ CSAK ST√çLUS (CSAK T√âRK√âPEKHEZ!):
                console.log(`üö´ loadTheme: STYLE ONLY mode - element type: ${selectedEl.type}`);

                // Ellen≈ërizz√ºk, hogy t√©rk√©p-e az elem
                if (selectedEl.type !== 'map') {
                    console.warn(`‚ö†Ô∏è loadTheme: STYLE ONLY mode is not available for ${selectedEl.type} elements!`);
                    alert("A 'Csak st√≠lus' m√≥d csak csillagt√©rk√©pekn√©l el√©rhet≈ë!\nV√°lassz m√°sik alkalmaz√°si m√≥dot.");
                    return;
                }

                /*window.logDebug("EXECUTING STYLE ONLY MODE LOGIC");*/

                // 1. Csak a localBackground-ot mentj√ºk (slot h√°tt√©r)
                // A celestialConfig.background (t√©rk√©p k√∂r kit√∂lt√©se) V√ÅLTOZHAT!
                const existingLocalBackground = selectedEl.localBackground;

                // 2. Config friss√≠t√©se (t√©rk√©p st√≠lus v√°ltozik az √∫j t√©m√°ra)
                updateElementConfig(selectedEl, themeConfig);

                // 3. Csak a localBackground-ot √°ll√≠tjuk vissza (slot h√°tt√©r megmarad)
                // A celestialConfig.background az √∫j t√©ma szerinti lesz!
                selectedEl.localBackground = existingLocalBackground;

                // 4. Sz√∂vegekhez nem ny√∫lunk (nincs updateZoneColors h√≠v√°s)

                // 5. Hozz√°ad√°s a renderel√©si list√°hoz
                mapsToRender.push(selectedEl);
                /*window.logDebug(`Added selectedEl to mapsToRender (Style Only Mode): ${selectedEl.id}`);*/
            }

            // --- RENDEREL√âS IND√çT√ÅSA (QUEUE) ---
            /*window.logDebug(`Calling processRenderQueue with ${mapsToRender.length} elements.`);*/
            // Ez a f√ºggv√©ny fogja egyes√©vel, biztons√°gosan v√©grehajtani a rajzol√°st
            processRenderQueue(mapsToRender, 0);
        };

        // --- SEG√âDF√úGGV√âNY: Elem konfigur√°ci√≥j√°nak friss√≠t√©se ---
        function updateElementConfig(el, newBaseConfig) {
            // M√°solat k√©sz√≠t√©se az √∫j alapr√≥l
            let finalConfig = JSON.parse(JSON.stringify(newBaseConfig));

            // Megl√©v≈ë adatok (Hely, Id≈ë) √°tment√©se, ha vannak
            if (el.celestialConfig) {
                if (el.celestialConfig.Ido) finalConfig.Ido = el.celestialConfig.Ido;
                if (el.celestialConfig.Varos) finalConfig.Varos = el.celestialConfig.Varos;
                if (el.celestialConfig.Lokacio) finalConfig.Lokacio = el.celestialConfig.Lokacio;
                if (el.celestialConfig.geopos) finalConfig.geopos = el.celestialConfig.geopos;
                // Kiemel√©sek meg≈ërz√©se
                if (el.celestialConfig.highlights) finalConfig.highlights = el.celestialConfig.highlights;
            }

            el.celestialConfig = finalConfig;
        }

        // --- SEG√âDF√úGGV√âNY: Sz√∂vegz√≥n√°k sz√≠nez√©se ---
        function updateZoneColors(elementId, newColor) {
            if (!newColor) return;
            const zones = myCelestialConf.userData.zones;

            // Pr√≥b√°ljuk meg mindk√©t form√°tumot: map_ √©s photo_
            // main-map speci√°lis eset: 'map' kulcs
            const possibleKeys = [];
            if (elementId === 'main-map') {
                possibleKeys.push('map');
            } else {
                possibleKeys.push(`map_${elementId}`);
                possibleKeys.push(`photo_${elementId}`);
            }

            console.log(`üé® updateZoneColors: elementId=${elementId}, possibleKeys=${possibleKeys.join(', ')}`);

            possibleKeys.forEach(zoneKey => {
                if (zones[zoneKey]) {
                    console.log(`üé® Found zone: ${zoneKey}`);
                    ['top', 'bottom'].forEach(z => {
                        if (zones[zoneKey][z] && zones[zoneKey][z].blocks) {
                            zones[zoneKey][z].blocks.forEach(block => {
                                block.color = newColor;
                            });
                            console.log(`üé® Updated ${zones[zoneKey][z].blocks.length} blocks in ${zoneKey}.${z}`);
                        }
                    });
                }
            });
        }

        // ============================================================
        // --- RENDER QUEUE (JAV√çTOTT: REFERENCIA MENT√âSSEL) ---
        // ============================================================
        function processRenderQueue(elementsList, index) {
            // 1. KIL√âP√âSI FELT√âTEL
            if (index >= elementsList.length) {
                console.log("‚úÖ Minden t√©rk√©p gener√°l√°sa k√©sz.");

                // Vissza√°ll√≠tjuk a teljes UserDat√°t (Most m√°r tartalmazza a friss√≠t√©seket!)
                if (window.savedFullUserData) {
                    myCelestialConf.userData = window.savedFullUserData;
                    window.savedFullUserData = null;
                }

                // V√©gs≈ë UI friss√≠t√©s
                if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
                if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                if (typeof window.renderZoneUI === 'function') {
                    window.renderZoneUI('top');
                    window.renderZoneUI('bottom');
                }

                // Kijel√∂l√©s friss√≠t√©se (mindk√©t panelen)
                $('.theme-item').removeClass('active-theme');
                const activeBtns = document.querySelectorAll(`.theme-btn[data-key="${activeThemeKey}"][data-variant="${activeVariant}"]`);
                activeBtns.forEach(btn => btn.closest('.theme-item').classList.add('active-theme'));

                return;
            }

            // 2. EL≈êK√âSZ√úLETEK
            const el = elementsList[index];
            console.log(`‚è≥ Gener√°l√°s: ${el.id} (${index + 1}/${elementsList.length})`);

            // --- JAV√çT√ÅS: CSAK REFERENCI√ÅT MENT√úNK, NEM M√ÅSOLATOT! ---
            if (index === 0 && !window.savedFullUserData) {
                window.savedFullUserData = myCelestialConf.userData;
            }
            // ---------------------------------------------------------

            // 3. ISOL√ÅCI√ì (Becsapjuk a rendszert)
            // Az elem configj√°t m√°soljuk, hogy ne legyen gond
            myCelestialConf = JSON.parse(JSON.stringify(el.celestialConfig));

            // De a UserDat√°ba az EREDETI elem referenci√°j√°t tessz√ºk!
            // √çgy ha a handleVectorExport √≠r bele, az megmarad.
            myCelestialConf.userData = {
                uiState: {
                    selectedElementId: el.id,
                    zoneFlags: window.savedFullUserData.uiState.zoneFlags || {}
                },
                elements: [el], // <--- Eredeti referencia!
                zones: window.savedFullUserData.zones,
                canvas: window.savedFullUserData.canvas
            };

            // 4. GENER√ÅL√ÅS
            if (typeof Celestial !== 'undefined') {
                Celestial.resize({ width: 1000 });
                Celestial.apply(myCelestialConf);

                if (myCelestialConf.Ido) Celestial.date(new Date(myCelestialConf.Ido));
                if (myCelestialConf.geopos) Celestial.location(myCelestialConf.geopos);

                if (el.highlights) Celestial.highlightList = el.highlights;
                else Celestial.highlightList = {};

                Celestial.redraw();

                // Callback
                window.onVectorExportFinished = function () {
                    processRenderQueue(elementsList, index + 1);
                };

                setTimeout(() => {
                    if (typeof window.updateActiveMapSnapshot === 'function') {
                        window.updateActiveMapSnapshot();
                    }
                }, 150);
            } else {
                processRenderQueue(elementsList, index + 1);
            }
        }

        // --- T√âMA V√ÅLASZT√ì GENER√ÅL√ÅSA ---
        window.initThemeSelectors = function () {
            console.log("initThemeSelectors futtat√°sa...");

            const containers = [
                'theme-grid-container-left', // Editor (Bal)
                'designer-templates-grid'    // Designer (Jobb)
            ];

            const themesSource = (typeof mapThemes !== 'undefined') ? mapThemes : {};

            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;

                const sourceSide = (containerId === 'theme-grid-container-left') ? 'left' : 'right';

                container.innerHTML = ''; // T√∂rl√©s

                for (const [key, theme] of Object.entries(themesSource)) {
                    // A) Norm√°l k√°rtya
                    const normalCard = createCardHTML(key, theme, 'normal', sourceSide);
                    container.appendChild(normalCard);
                    // B) Sz√≠v k√°rtya
                    const heartCard = createCardHTML(key, theme, 'heart', sourceSide);
                    container.appendChild(heartCard);
                }
            });
        };

        // --- JAV√çTOTT MENT√âS: H√ÅTT√âRREL EGY√úTT ---
        function saveMapThumbnail(forcedName) {
            const sourceCanvas = document.querySelector('#celestial-map canvas');
            if (!sourceCanvas) return;

            // 1. Akt√≠v t√©ma h√°tter√©nek lek√©r√©se
            const theme = mapThemes[activeThemeKey];
            const bgStyle = theme ? theme.background : "#000000";

            // 2. Ideiglenes v√°szon
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');

            // 3. H√°tt√©r fest√©se
            if (bgStyle.includes('gradient')) {
                // Gradiens sz√≠nek kinyer√©se
                const colors = bgStyle.match(/#[a-fA-F0-9]{6}|rgb\([^)]+\)/g);
                if (colors && colors.length >= 2) {
                    const gradient = ctx.createLinearGradient(0, 0, exportCanvas.width, exportCanvas.height);
                    gradient.addColorStop(0, colors[0]);
                    gradient.addColorStop(1, colors[colors.length - 1]);
                    ctx.fillStyle = gradient;
                } else {
                    ctx.fillStyle = "#000000";
                }
            } else {
                ctx.fillStyle = bgStyle;
            }
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

            // 4. T√©rk√©p r√°fest√©se
            ctx.drawImage(sourceCanvas, 0, 0);

            // 5. Let√∂lt√©s
            const link = document.createElement('a');
            link.download = forcedName || `thumb_${activeThemeKey}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- T√ñMEGES GENER√ÅL√ì ROBOT ü§ñ ---
        function downloadAllThemesSequence() {
            const keys = Object.keys(mapThemes);
            let index = 0;

            if (!confirm(`Figyelem! Ez a folyamat sorban let√∂lti mind a(z) ${keys.length} k√©pet.\n\nNe ny√∫lj az eg√©rhez, am√≠g nem v√©gez!`)) {
                return;
            }

            function processNext() {
                if (index >= keys.length) {
                    alert("K√©sz! Minden t√©ma k√©pe let√∂ltve. ü•Ç\nMost m√°sold be ≈ëket az 'images/themes/' mapp√°ba!");
                    return;
                }

                const key = keys[index];
                console.log(`Gener√°l√°s: ${key} (${index + 1}/${keys.length})`);
                let variant = 'normal';
                // 1. T√©ma bet√∂lt√©se (ez friss√≠ti a map-wrap h√°tter√©t √©s a t√©rk√©pet is)
                loadTheme(key, variant);

                // 2. V√°rakoz√°s (800ms el√©g kell legyen a rajzol√°shoz)
                setTimeout(() => {
                    // 3. Ment√©s: thumb_midnight.png, thumb_vintage.png, stb.
                    saveMapThumbnail(`thumb_${key}.png`);

                    index++;
                    processNext(); // K√∂vetkez≈ë
                }, 800);
            }

            // Ind√≠t√°s
            processNext();
        }


        var myCelestialConf = null;
        var timeZone = 60;
        var lat = 47.4979;
        var lng = 19.0402;
        var date = new Date();

        window.preConstellationConfig = null;

        // --- √öJ: DEBOUNCE SEG√âDF√úGGV√âNY ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // K√©sleltetett alkalmaz√°s (Redraw)
        // 50ms k√©sleltet√©s: el√©g gyors, de megv√°rja m√≠g a cs√∫szka "megpihen"
        // const debouncedCelestialApply = debounce(function(conf) {
        //     Celestial.apply(conf);
        // }, 50);
        /*const debouncedCelestialApply = debounce(function (conf) {
            Celestial.apply(conf);
            // √öJ: Snapshot friss√≠t√©se a v√°ltoz√°s ut√°n
            if (typeof window.updateActiveMapSnapshot === 'function') {
                window.updateActiveMapSnapshot();
            }
        }, 50);*/

        // --- √öJ: GUI FRISS√çT≈ê F√úGGV√âNY (JS h√≠vja meg t√©rk√©p v√°lt√°skor) ---
        window.updateGUIFromConfig = function (conf) {
            console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l...", conf);
            console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.background.dash", conf.background.dash);
            console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.constellations.lineStyle.dash", conf.constellations.lineStyle.dash);
            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... (conf.constellations.lineStyle.dash[0] !== 0 && conf.constellations.lineStyle.dash[1] !== 0) || (conf.constellations.lineStyle.dash[0] !== null && conf.constellations.lineStyle.dash[1] !== null) ? true : false", (conf.constellations.lineStyle.dash[0] !== 0 && conf.constellations.lineStyle.dash[1] !== 0) && (conf.constellations.lineStyle.dash[0] !== null && conf.constellations.lineStyle.dash[1] !== null) ? true : false);

            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.const", (conf.constellations.lineStyle.dash[0] !== 0 & conf.constellations.lineStyle.dash[1] !== 0)
            //|| (conf.constellations.lineStyle.dash[0] !== null && conf.constellations.lineStyle.dash[1] !== null) ? true : false);
            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.constellations.lineStyle.dash[0] !== 0", conf.constellations.lineStyle.dash[0] !== 0);
            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.constellations.lineStyle.dash[0] !== null", conf.constellations.lineStyle.dash[0] !== null);
            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.constellations.lineStyle.dash[1] !== 0", conf.constellations.lineStyle.dash[1] !== 0);
            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.constellations.lineStyle.dash[1] !== null", conf.constellations.lineStyle.dash[1] !== null);
            //console.log("GUI Friss√≠t√©se konfigur√°ci√≥b√≥l... conf.const", (conf.background.dash[0] !== 0 && conf.background.dash[1] !== 0)
            //|| (conf.background.dash[0] !== null && conf.background.dash[1] !== null) ? true : false);
            // 1. Checkboxok √©s Panelek
            const setCheck = (id, val, settingsId) => {
                // Ha a val undefined, akkor false-nak vessz√ºk
                const isChecked = !!val;
                $(id).prop('checked', isChecked);
                if (settingsId) { if (isChecked) $(settingsId).slideDown(); else $(settingsId).slideUp(); }
            };

            // Biztons√°gos hozz√°f√©r√©s a config elemekhez
            const safeConf = (path) => {
                return path ? path : {};
            };

            // --- JAV√çTOTT R√âSZ: Biztons√°gos ellen≈ërz√©sek ---
            setCheck("#const_show", conf.constellations ? conf.constellations.lines : false, "#const_show_settings");
            setCheck("#mw_show", conf.mw ? conf.mw.show : false, "#mw_show_settings");
            setCheck("#stars_show", conf.stars ? conf.stars.show : false, "#stars_show_settings");
            setCheck("#stars_colors", !conf.stars.colors, "#stars_colors_settings");
            setCheck("#constellation_lineStyle_dash_check", conf.constellations.lineStyle.dash !== undefined ? ((conf.constellations.lineStyle.dash[0] !== undefined && conf.constellations.lineStyle.dash[1] !== undefined)
                && (conf.constellations.lineStyle.dash[0] !== 0 && conf.constellations.lineStyle.dash[1] !== 0)
                && (conf.constellations.lineStyle.dash[0] !== null && conf.constellations.lineStyle.dash[1] !== null) ? true : false) : false, "#constellation_lineStyle_dash_settings");
            setCheck("#background_stroke_dash_check", conf.background.dash !== undefined ? ((conf.background.dash[0] !== undefined && conf.background.dash[1] !== undefined)
                && (conf.background.dash[0] !== 0 && conf.background.dash[1] !== 0)
                && (conf.background.dash[0] !== null && conf.background.dash[1] !== null) ? true : false) : false, "#background_stroke_dash_settings");
            // Vonalak biztons√°gos kezel√©se (Itt volt a hiba)
            const lines = conf.lines || {};
            setCheck("#lines_graticule", lines.graticule ? lines.graticule.show : false);
            setCheck("#lines_equatorial", lines.equatorial ? lines.equatorial.show : false);
            setCheck("#lines_ecliptic", lines.ecliptic ? lines.ecliptic.show : false);
            setCheck("#lines_galactic", lines.galactic ? lines.galactic.show : false);
            setCheck("#lines_supergalactic", lines.supergalactic ? lines.supergalactic.show : false);

            // ------------------------------------------------

            // 2. √ârt√©kek
            if (conf.mw && conf.mw.style) {
                $("#mw_style_fill").val(conf.mw.style.fill);
                $("#mw_style_opacity").val(conf.mw.style.opacity);
            }

            if (conf.background) {
                $("#background_fill").val(conf.background.fill);
                $("#background_opacity").val(conf.background.opacity);
                $("#background_stroke").val(conf.background.stroke);
                $("#background_stroke_width").val(conf.background.width);
                $("#background_stroke_dash_1").val(Array.isArray(conf.background.dash) ? conf.background.dash[0] : conf.background.dash);
                $("#background_stroke_dash_2").val(Array.isArray(conf.background.dash) ? conf.background.dash[1] : conf.background.dash);
            }

            // St√≠lusok (t√∂mbkezel√©ssel)
            if (conf.constellations && conf.constellations.lineStyle) {
                const cStyle = conf.constellations.lineStyle;
                $("#constellation_lineStyle_stroke").val(Array.isArray(cStyle.stroke) ? cStyle.stroke[0] : cStyle.stroke);
                $("#constellation_lineStyle_opacity").val(Array.isArray(cStyle.opacity) ? cStyle.opacity[0] : cStyle.opacity);
                $("#constellation_lineStyle_stroke_width").val(Array.isArray(cStyle.width) ? cStyle.width[0] : cStyle.width);
                $("#constellation_lineStyle_dash_1").val(Array.isArray(cStyle.dash) ? cStyle.dash[0] : cStyle.dash);
                $("#constellation_lineStyle_dash_2").val(Array.isArray(cStyle.dash) ? cStyle.dash[1] : cStyle.dash);
            }

            if (conf.stars) {
                $("#stars_limit").val(conf.stars.limit);
                $("#stars_size").val(conf.stars.size);
                if (!conf.stars.colors) {
                    $("#stars_style_fill").val(conf.stars.style.fill);
                    $("#stars_style_opacity").val(conf.stars.style.opacity);
                }
            }

            // 3. D√°tum √©s Hely
            if (conf.Ido) {
                let d = new Date(conf.Ido);
                if (!isNaN(d.getTime())) {
                    $("#datetimepicker").datetimepicker('setDate', d);
                    if (typeof date !== 'undefined') date = d;
                }
            }

            if (conf.Varos) $("#city").val(conf.Varos);

            if (conf.geopos) {
                $("#coord_lat").val(conf.geopos[0]);
                $("#coord_lon").val(conf.geopos[1]);
                if (typeof lat !== 'undefined') lat = conf.geopos[0];
                if (typeof lng !== 'undefined') lng = conf.geopos[1];
            }
        };
        /*function change(opts) {
            console.log("change");
            var ujCelesConf = deepMerge(myCelestialConf, opts);
            myCelestialConf = ujCelesConf;
            console.log("myCelestialConf", myCelestialConf);
            console.log("opts", opts);
 
            // JAV√çT√ÅS: A k√∂zvetlen h√≠v√°s helyett a debounced verzi√≥t haszn√°ljuk
            // Celestial.apply(myCelestialConf); 
            debouncedCelestialApply(myCelestialConf);
 
            // AUTO-SAVE: myCelestialConf v√°ltozott, mentj√ºk IndexedDB-be
            console.log("change")
            if (window.triggerAutoSave) window.triggerAutoSave();
        }*/

        /**
         * Ez az EGYETLEN f√ºggv√©ny, amit h√≠vni kell, ha b√°rmi v√°ltozik a t√©rk√©pen.
         * Kezeli: Glob√°lis konfig, Elem ment√©s, Motor friss√≠t√©s, Tervez≈ë snapshot.
         */
        window.updateMapState = function (partialConfig) {
            if (!myCelestialConf) return;

            // 1. Glob√°lis konfig friss√≠t√©se (Deep Merge)
            deepMerge(myCelestialConf, partialConfig);

            // 2. Akt√≠v Elem Szinkroniz√°ci√≥ (Azonnali ment√©s a mem√≥ri√°ba)
            if (myCelestialConf.userData && myCelestialConf.userData.uiState) {
                const activeId = myCelestialConf.userData.uiState.selectedElementId;
                const element = myCelestialConf.userData.elements.find(e => e.id == activeId);

                if (element && element.type === 'map') {
                    if (!element.celestialConfig) {
                        // Ha m√©g nincs, l√©trehozzuk a glob√°lis alapb√≥l (userData n√©lk√ºl)
                        const base = JSON.parse(JSON.stringify(myCelestialConf));
                        delete base.userData;
                        element.celestialConfig = base;
                    }
                    // Beleolvasztjuk a v√°ltoz√°sokat
                    deepMerge(element.celestialConfig, partialConfig);
                    // console.log(`üíæ Map Sync [${activeId}]:`, partialConfig);
                }
            }

            // 3. Celestial Motor Friss√≠t√©se
            // Debounce nem sz√ºks√©ges itt, mert a Celestial.apply k√∂nny≈± m≈±velet,
            // a redraw-t pedig a motor kezeli, vagy k√ºl√∂n h√≠vjuk.
            if (typeof Celestial !== 'undefined') {
                Celestial.apply(partialConfig);
                Celestial.redraw();
            }

            // 4. Tervez≈ë N√©zet Friss√≠t√©se (K√©sleltetve, hogy ne akadjon)
            // Ez gener√°lja le a kis k√©pet a jobb oldali n√©zethez
            debouncedSnapshot();
        };
        // A r√©gi 'change' f√ºggv√©nyt √°tir√°ny√≠tjuk az √∫j k√∂zpontira
        window.change = function (opts) {
            updateMapState(opts);
        };

        // Debounce a snapshot gener√°l√°shoz (hogy ne gener√°ljon minden pixelh√∫z√°sra)
        const debouncedSnapshot = debounce(function () {
            if (typeof window.updateActiveMapSnapshot === 'function') {
                window.updateActiveMapSnapshot();
            }
        }, 100);
        $(document).on('change', '#const_show', function (e) {
            if ($(this).is(':checked')) {
                $("#const_show_settings").slideDown(300);
            }
            else {
                $("#const_show_settings").slideUp(300);
            }
            change({ constellations: { lines: $(this).is(':checked') } });
        });

        $(document).on('change', '#mw_show', function (e) {
            if ($(this).is(':checked')) {
                $("#mw_show_settings").slideDown(300);
            }
            else {
                $("#mw_show_settings").slideUp(300);
            }
            change({ mw: { show: $(this).is(':checked') } });
        });

        $(document).on('change', '#mw_style_fill', function (e) {
            change({
                mw: {
                    style: {
                        fill: $("#mw_style_fill").val(),
                        opacity: $("#mw_style_opacity").val()
                    }
                }
            });
        });

        $(document).on('change', '#mw_style_opacity', function (e) {
            change({
                mw: {
                    style: {
                        fill: $("#mw_style_fill").val(),
                        opacity: $("#mw_style_opacity").val()
                    }
                }
            });
        });

        $(document).on('change', '#background_fill', function (e) {
            change({
                background: {
                    fill: $("#background_fill").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#background_opacity', function (e) {
            change({
                background: {
                    opacity: $("#background_opacity").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#background_stroke', function (e) {
            change({
                background: {
                    stroke: $("#background_stroke").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#background_stroke_width', function (e) {
            change({
                background: {
                    width: $("#background_stroke_width").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#constellation_lineStyle_opacity', function (e) {
            // alert("constellation_lineStyle_opacity")
            // if ($("#constellation_lineStyle_dash_check").prop("checked") == true) {
            // alert("dash")
            change({
                constellations: {
                    lineStyle: {
                        opacity: $("#constellation_lineStyle_opacity").val(),
                        stroke: $("#constellation_lineStyle_stroke").val(),
                        width: $("#constellation_lineStyle_stroke_width").val(),
                        dash: $("#constellation_lineStyle_dash_check").prop("checked") == true ?
                            [$("#constellation_lineStyle_dash_1").val(), $("#constellation_lineStyle_dash_2").val()] :
                            [null, null]
                    }
                }
            });
            // } else {
            //   alert("nemdash")
            //   change({ constellations: { lineStyle: {
            //       opacity: $("#constellation_lineStyle_opacity").val(),
            //       stroke: $("#constellation_lineStyle_stroke").val(),
            //       width: $("#constellation_lineStyle_stroke_width").val() ,
            //       dash: [null,  null]
            //       }}
            //   });
            // }

        });

        $(document).on('change', '#constellation_lineStyle_stroke', function (e) {
            change({
                constellations: {
                    lineStyle: {
                        opacity: $("#constellation_lineStyle_opacity").val(),
                        stroke: $("#constellation_lineStyle_stroke").val(),
                        width: $("#constellation_lineStyle_stroke_width").val(),
                        dash: $("#constellation_lineStyle_dash_check").prop("checked") == true ?
                            [$("#constellation_lineStyle_dash_1").val(), $("#constellation_lineStyle_dash_2").val()] :
                            [null, null]
                    }
                }
            });
        });

        $(document).on('change', '#constellation_lineStyle_stroke_width', function (e) {
            change({
                constellations: {
                    lineStyle: {
                        opacity: $("#constellation_lineStyle_opacity").val(),
                        stroke: $("#constellation_lineStyle_stroke").val(),
                        width: $("#constellation_lineStyle_stroke_width").val(),
                        dash: $("#constellation_lineStyle_dash_check").prop("checked") == true ?
                            [$("#constellation_lineStyle_dash_1").val(), $("#constellation_lineStyle_dash_2").val()] :
                            [null, null]
                    }
                }
            });
        });


        $(document).on('change', '#stars_show', function (e) {
            if ($(this).is(':checked')) {
                $("#stars_show_settings").slideDown(300);
            }
            else {
                $("#stars_show_settings").slideUp(300);
            }
            change({ stars: { show: $(this).is(':checked') } });
        });

        $(document).on('input', '#stars_limit', function (e) {
            change({ stars: { limit: parseFloat($(this).val()) } });
        });

        $(document).on('change', '#stars_size', function (e) {
            change({ stars: { size: parseFloat($(this).val()) } });
        });

        $(document).on('change', '#stars_exponent', function (e) {
            change({ stars: { exponent: parseFloat($(this).val()) } });
        });

        $(document).on('change', '#stars_colors', function (e) {
            if (!$(this).is(':checked')) {
                $("#stars_colors_settings").slideDown(300);
            }
            else {
                $("#stars_colors_settings").slideUp(300);
            }
            change({ stars: { colors: $(this).is(':checked') } });
        });

        $(document).on('change', '#stars_style_fill', function (e) {
            change({
                stars: {
                    style: {
                        fill: $("#stars_style_fill").val(),
                        opacity: $("#stars_style_opacity").val()
                    }
                }
            });
        });
        $(document).on('change', '#stars_style_opacity', function (e) {
            change({
                stars: {
                    style: {
                        fill: $("#stars_style_fill").val(),
                        opacity: $("#stars_style_opacity").val()
                    }
                }
            });
        });

        $(document).on('change', '#planets_show', function (e) {
            change({ planets: { show: $(this).is(':checked'), symbolType: "disk" } });
        });


        $(document).on('change', '#lines_graticule_color', function (e) {
            console.log("lines_graticule_color")
            if ($("#lines_graticule_dash_check").prop("checked") == true) {

                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [$("#lines_graticule_dash_1").val(), $("#lines_graticule_dash_2").val()]
                        }
                    }
                });
            } else {
                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [null, null]
                        }
                    }
                });

            }
        });

        $(document).on('change', '#lines_graticule_size', function (e) {
            if ($("#lines_graticule_dash_check").prop("checked") == true) {

                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [$("#lines_graticule_dash_1").val(), $("#lines_graticule_dash_2").val()]
                        }
                    }
                });
            } else {
                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: []
                        }
                    }
                });
            }
        });

        $(document).on('change', '#lines_graticule_opacity', function (e) {
            if ($("#lines_graticule_dash_check").prop("checked") == true) {

                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [$("#lines_graticule_dash_1").val(), $("#lines_graticule_dash_2").val()]
                        }
                    }
                });
            } else {
                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: []
                        }
                    }
                });

            }
        });


        $(document).on('change', '#lines_equatorial_color', function (e) {
            change({
                lines: {
                    equatorial: {
                        show: $("#lines_equatorial").is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_equatorial_size', function (e) {
            change({
                lines: {
                    equatorial: {
                        show: $("#lines_equatorial").is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_equatorial_opacity', function (e) {
            change({
                lines: {
                    equatorial: {
                        show: $("#lines_equatorial").is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });


        $(document).on('change', '#lines_ecliptic_color', function (e) {
            change({
                lines: {
                    ecliptic: {
                        show: $("#lines_ecliptic").is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_ecliptic_size', function (e) {
            change({
                lines: {
                    ecliptic: {
                        show: $("#lines_ecliptic").is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_ecliptic_opacity', function (e) {
            change({
                lines: {
                    ecliptic: {
                        show: $("#lines_ecliptic").is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });


        $(document).on('change', '#lines_galactic_color', function (e) {
            change({
                lines: {
                    galactic: {
                        show: $("#lines_galactic").is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_galactic_size', function (e) {
            change({
                lines: {
                    galactic: {
                        show: $("#lines_galactic").is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_galactic_opacity', function (e) {
            change({
                lines: {
                    galactic: {
                        show: $("#lines_galactic").is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });


        $(document).on('change', '#lines_supergalactic_color', function (e) {
            change({
                lines: {
                    supergalactic: {
                        show: $("#lines_supergalactic").is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_supergalactic_size', function (e) {
            change({
                lines: {
                    supergalactic: {
                        show: $("#lines_supergalactic").is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_supergalactic_opacity', function (e) {
            change({
                lines: {
                    supergalactic: {
                        show: $("#lines_supergalactic").is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });

        // Master checkboxok a wrapper megjelen√≠t√©s√©re
        $(document).on('change', '#lines_graticule_master', function (e) {
            if ($(this).is(':checked')) {
                $("#graticule-wrapper").slideDown(300);
                $("#lines_graticule").prop('checked', true).trigger('change');
            } else {
                $("#graticule-wrapper").slideUp(300);
                $("#lines_graticule").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_equatorial_master', function (e) {
            if ($(this).is(':checked')) {
                $("#equatorial-wrapper").slideDown(300);
                $("#lines_equatorial").prop('checked', true).trigger('change');
            } else {
                $("#equatorial-wrapper").slideUp(300);
                $("#lines_equatorial").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_ecliptic_master', function (e) {
            if ($(this).is(':checked')) {
                $("#ecliptic-wrapper").slideDown(300);
                $("#lines_ecliptic").prop('checked', true).trigger('change');
            } else {
                $("#ecliptic-wrapper").slideUp(300);
                $("#lines_ecliptic").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_galactic_master', function (e) {
            if ($(this).is(':checked')) {
                $("#galactic-wrapper").slideDown(300);
                $("#lines_galactic").prop('checked', true).trigger('change');
            } else {
                $("#galactic-wrapper").slideUp(300);
                $("#lines_galactic").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_supergalactic_master', function (e) {
            if ($(this).is(':checked')) {
                $("#supergalactic-wrapper").slideDown(300);
                $("#lines_supergalactic").prop('checked', true).trigger('change');
            } else {
                $("#supergalactic-wrapper").slideUp(300);
                $("#lines_supergalactic").prop('checked', false).trigger('change');
            }
        });



        // A bels≈ë checkboxok v√°ltoz√°sai
        $(document).on('change', '#lines_graticule', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    graticule: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_graticule_color").val(),
                        width: parseFloat($("#lines_graticule_size").val()),
                        opacity: parseFloat($("#lines_graticule_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_equatorial', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    equatorial: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_ecliptic', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    ecliptic: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_galactic', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    galactic: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_supergalactic', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    supergalactic: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });
        // // 1. H√°tt√©r (K√∂rvonal) Dash
        // $(document).on('change', '#background_stroke_dash', function(e) {
        //     var isDashed = $(this).is(':checked');
        //     // [4, 4] = 4px vonal, 4px sz√ºnet. 
        //     // Ha nem szaggatott, √ºres t√∂mb√∂t [] kell k√ºldeni.
        //     change({ background: { dash: isDashed ? [4, 4] : [] } });
        // });
        // 1. H√ÅTT√âR (K√ñRVONAL)
        $(document).on('change', '#background_stroke_dash_check', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#background_stroke_dash_settings').slideDown();
                var v1 = parseFloat($('#background_stroke_dash_1').val()) || 4;
                var v2 = parseFloat($('#background_stroke_dash_2').val()) || 4;
                change({ background: { dash: [v1, v2] } });
            } else {
                $('#background_stroke_dash_settings').slideUp();
                change({ background: { dash: [null, null] } });
            }
        });
        // Input v√°ltoz√°s figyel√©se
        $(document).on('input', '#background_stroke_dash_1, #background_stroke_dash_2', function () {
            if ($('#background_stroke_dash_check').is(':checked')) {
                var v1 = parseFloat($('#background_stroke_dash_1').val()) || 4;
                var v2 = parseFloat($('#background_stroke_dash_2').val()) || 4;
                change({ background: { dash: [v1, v2] } });
            }
        });

        // // 2. Csillagk√©pek Dash
        // $(document).on('change', '#constellation_lineStyle_dash', function(e) {
        //     var isDashed = $(this).is(':checked');
        //     change({ constellations: { lineStyle: { dash: isDashed ? [4, 4] : [] } } });
        // });

        // // 3. Fokh√°l√≥zat (Graticule) Dash
        // $(document).on('change', '#lines_graticule_dash', function(e) {
        //     var isDashed = $(this).is(':checked');
        //     // A r√°csn√°l finomabb szaggat√°st haszn√°lunk [2, 2]
        //     change({ lines: { graticule: { dash: isDashed ? [2, 2] : [] } } });
        // });
        // 2. CSILLAGK√âPEK
        $(document).on('change', '#constellation_lineStyle_dash_check', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#constellation_lineStyle_dash_settings').slideDown();
                var v1 = parseFloat($('#constellation_lineStyle_dash_1').val()) || 4;
                var v2 = parseFloat($('#constellation_lineStyle_dash_2').val()) || 4;
                change({
                    constellations: {
                        lineStyle:
                        {
                            opacity: $("#constellation_lineStyle_opacity").val(),
                            stroke: $("#constellation_lineStyle_stroke").val(),
                            width: $("#constellation_lineStyle_stroke_width").val(),
                            dash: [v1, v2]
                        }
                    }
                });
            } else {
                $('#constellation_lineStyle_dash_settings').slideUp();

                change({
                    constellations: {
                        lineStyle:
                        {
                            opacity: $("#constellation_lineStyle_opacity").val(),
                            stroke: $("#constellation_lineStyle_stroke").val(),
                            width: $("#constellation_lineStyle_stroke_width").val(),
                            dash: [null, null]
                        }
                    }
                });
            }
        });
        $(document).on('input', '#constellation_lineStyle_dash_1, #constellation_lineStyle_dash_2', function () {
            if ($('#constellation_lineStyle_dash_check').is(':checked')) {
                var v1 = parseFloat($('#constellation_lineStyle_dash_1').val()) || 4;
                var v2 = parseFloat($('#constellation_lineStyle_dash_2').val()) || 4;
                change({
                    constellations: {
                        lineStyle:
                        {
                            opacity: $("#constellation_lineStyle_opacity").val(),
                            stroke: $("#constellation_lineStyle_stroke").val(),
                            width: $("#constellation_lineStyle_stroke_width").val(),
                            dash: [v1, v2]
                        }
                    }
                });
            }
        });

        // 3. FOKH√ÅL√ìZAT (GRATICULE)
        $(document).on('change', '#lines_graticule_dash_check', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#lines_graticule_dash_settings').slideDown();
                var v1 = parseFloat($('#lines_graticule_dash_1').val()) || 2;
                var v2 = parseFloat($('#lines_graticule_dash_2').val()) || 2;
                change({
                    lines: {
                        graticule: {

                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [v1, v2]
                        }
                    }
                });
            } else {
                $('#lines_graticule_dash_settings').slideUp();
                change({
                    lines: {
                        graticule: {

                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [null, null]
                        }
                    }
                });
            }
        });
        $(document).on('input', '#lines_graticule_dash_1, #lines_graticule_dash_2', function () {
            if ($('#lines_graticule_dash_check').is(':checked')) {
                var v1 = parseFloat($('#lines_graticule_dash_1').val()) || 2;
                var v2 = parseFloat($('#lines_graticule_dash_2').val()) || 2;
                change({
                    lines: {
                        graticule: {

                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [v1, v2]
                        }
                    }
                });
            }
        });
        // Collapsible header kattint√°s - ne triggerelje a checkboxot
        $(document).on('click', '.checkbox-header', function (e) {
            // Ha a checkbox-ra kattintottak, ne csukjuk be/ki
            if ($(e.target).is('input[type="checkbox"]')) {
                return;
            }

            const header = $(this);
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');

            header.toggleClass('collapsed');
            content.toggleClass('collapsed');

            if (header.hasClass('collapsed')) {
                icon.css('transform', 'rotate(-90deg)');
            } else {
                icon.css('transform', 'rotate(0deg)');
            }
        });

        // Jelenlegi kult√∫ra √°llapota
        var currentCulture = "iau";
        var constellationsHU = {
            // --- ZODI√ÅKUSOK (12 db) ---
            "ari": "Kos",
            "tau": "Bika",
            "gem": "Ikrek",
            "cnc": "R√°k",
            "leo": "Oroszl√°n",
            "vir": "Sz≈±z",
            "lib": "M√©rleg",
            "sco": "Skorpi√≥",
            "sgr": "Nyilas",
            "cap": "Bak",
            "aqr": "V√≠z√∂nt≈ë",
            "psc": "Halak",

            // --- EGY√âB CSILLAGK√âPEK (76 db) ---
            "and": "Androm√©da",
            "ant": "L√©gszivatty√∫",
            "aps": "Paradicsommad√°r",
            "aql": "Sas",
            "ara": "Olt√°r",
            "aur": "Szekeres",
            "boo": "√ñk√∂rhajcs√°r",
            "cae": "V√©s≈ë",
            "cam": "Zsir√°f",
            "cvn": "Vad√°szebek",
            "cma": "Nagy Kutya",
            "cmi": "Kis Kutya",
            "car": "Haj√≥gerinc",
            "cas": "Kassziopeia",
            "cen": "Kentaur",
            "cep": "Cefeusz",
            "cet": "Cethal",
            "cha": "Kam√©leon",
            "cir": "K√∂rz≈ë",
            "col": "Galamb",
            "com": "Berenik√© Haja",
            "cra": "D√©li Korona",
            "crb": "√âszaki Korona",
            "crv": "Holl√≥",
            "crt": "Serleg",
            "cru": "D√©l Keresztje",
            "cyg": "Hatty√∫",
            "del": "Delfin",
            "dor": "Aranyhal",
            "dra": "S√°rk√°ny",
            "equ": "Csik√≥",
            "eri": "Erid√°nusz",
            "for": "Kemence",
            "gru": "Daru",
            "her": "Herkules",
            "hor": "Inga√≥ra",
            "hya": "√âszaki V√≠zik√≠gy√≥",
            "hyi": "D√©li V√≠zik√≠gy√≥",
            "ind": "Indi√°n",
            "lac": "Gy√≠k",
            "lmi": "Kis Oroszl√°n",
            "lep": "Ny√∫l",
            "lup": "Farkas",
            "lyn": "Hi√∫z",
            "lyr": "Lant",
            "men": "T√°blahegy",
            "mic": "Mikroszk√≥p",
            "mon": "Egyszarv√∫",
            "mus": "L√©gy",
            "nor": "Sz√∂gm√©r≈ë",
            "oct": "Okt√°ns",
            "oph": "K√≠gy√≥tart√≥",
            "ori": "Orion",
            "pav": "P√°va",
            "peg": "Pegazus",
            "per": "Perszeusz",
            "phe": "F≈ënix",
            "pic": "Fest≈ë",
            "psa": "D√©li Hal",
            "pup": "Haj√≥far",
            "pyx": "T√°jol√≥",
            "ret": "H√°l√≥",
            "sge": "Ny√≠l",
            "scl": "Szobr√°sz",
            "sct": "Pajzs",
            "ser": "K√≠gy√≥",
            "sex": "Szext√°ns",
            "tel": "T√°vcs≈ë",
            "tri": "H√°romsz√∂g",
            "tra": "D√©li H√°romsz√∂g",
            "tuc": "Tuk√°n",
            "uma": "Nagy Medve",
            "umi": "Kis Medve",
            "vel": "Vitorla",
            "vol": "Rep√ºl≈ëhal",
            "vul": "Kis R√≥ka"
        };
        $(document).ready(function () {

            // initThemeSelectors();
            setTimeout(() => {
                saveUserState(); // Ments√ºk el az alap√°llapotot
                // Friss√≠ts√ºk a t√©ma m√≥d r√°di√≥gombokat az aktu√°lis elem t√≠pusa alapj√°n
                if (typeof window.updateThemeModeRadioState === 'function') {
                    window.updateThemeModeRadioState();
                    console.log("üîò Initial updateThemeModeRadioState called");
                }
            }, 1000);
            // initThemeSelectors();
            // --- 1. PROJEKCI√ì DEFINI√ÅL√ÅSA (SZ√çV ALAK JAV√çTVA) ---
            // Fontos: Itt fel√ºl√≠rjuk a be√©p√≠tett werner-t, hogy a te men√ºddel m≈±k√∂dj√∂n
            if (d3.geo && d3.geo.bonne) {
                d3.geo.werner = function () { return d3.geo.bonne(); };

                d3.geo.werner.raw = function (phi0) {
                    var rawBonne = d3.geo.bonne.raw(phi0);

                    function rawWerner(lambda, phi) {
                        var xy = rawBonne(lambda, phi);

                        // JAV√çT√ÅS: += jelet haszn√°lunk! Ez tolja LEFEL√â a t√©rk√©pet.
                        // 0.2 = Kb. a sz√≠v magass√°g√°nak 20%-√°val lejjebb toljuk.
                        // xy[1] += 0.2; 
                        xy[1] += 1;
                        return xy;
                    }

                    rawWerner.invert = function (x, y) {
                        // Az invert√°l√°sn√°l ki kell vonni, amit hozz√°adtunk
                        // return rawBonne.invert(x, y - 0.2);
                        return rawBonne.invert(x, y - 1);
                    };

                    return rawWerner;
                };
            }

            if (Celestial.projections) {
                Celestial.projections().werner = {
                    n: "Werner (Sz√≠v)",
                    arg: Math.PI / 1,
                    scale: 210,  // Kicsit kisebb m√©ret, hogy biztosan kif√©rjen
                    ratio: 1   // Magasabb v√°szon (kisebb sz√°m = magasabb), hogy az alja is r√°f√©rjen
                };
            }
            // 1. Defini√°ljuk az √öJ vet√ºletet a D3 rendszer√©ben (nem √≠rjuk fel√ºl a r√©git)
            if (d3.geo && d3.geo.bonne) {
                d3.geo.customHeart = function () {
                    // console.log("d3.geo.customHeart = function(phi0)")
                    return d3.geo.bonne();
                };

                d3.geo.customHeart.raw = function (phi0) {
                    // console.log("d3.geo.customHeart.raw = function(phi0)")
                    // Az alap Bonne vet√ºletet haszn√°ljuk
                    var rawBonne = d3.geo.bonne.raw(phi0);

                    function rawCustom(lambda, phi) {
                        // console.log("rawCustom")
                        var xy = rawBonne(lambda, phi);

                        // --- IGAZ√çT√ÅS ---
                        // Itt tudod tologatni a rajzot a v√°sznon bel√ºl!
                        // xy[1] a f√ºgg≈ëleges tengely.
                        // += tolja LEFEL√â, -= tolja FELFEL√â.
                        // Ha a sz√≠v a v√°szon tetej√©re tapad, n√∂veld ezt az √©rt√©ket!

                        xy[1] -= 0.6;  // Pr√≥b√°ld ki: 0.2, 0.4 vagy ak√°r 0.6

                        return xy;
                    }

                    rawCustom.invert = function (x, y) {
                        // console.log("rawCustom.invert")
                        // Az invert√°l√°sn√°l az ellent√©t√©t kell csin√°lni
                        return rawBonne.invert(x, y + 0.6);
                    };

                    return rawCustom;
                };
            }

            // 2. Beregisztr√°ljuk a Celestial-ba az √∫j n√©ven
            if (Celestial.projections) {
                Celestial.projections().customHeart = {
                    n: "Sz√≠v Alak√∫ (K√∂z√©pre Igaz√≠tott)",
                    arg: Math.PI / szivszoge,
                    scale: 235,
                    ratio: szivratioja // A te j√≥l bev√°lt ar√°nyod
                };
            }
            const cityInput = document.getElementById('city');
            const autocomplete = new google.maps.places.Autocomplete(cityInput, {
                types: ['(cities)'],
                fields: ['geometry', 'name']
            });

            autocomplete.addListener('place_changed', async () => {
                const place = autocomplete.getPlace();
                // console.log("autocomplete change place", place);
                // console.log("autocomplete change place.name", place.name);
                if (!place.geometry) {
                    // console.log('No details available for input: ', place.name);
                    return;
                }

                lat = place.geometry.location.lat();
                lng = place.geometry.location.lng();
                // console.log("autocomplete change lat", lat);
                // console.log("autocomplete change lng", lng);
                $("#coord_lat").val(lat.toString().replace(".", ","));
                $("#coord_lon").val(lng.toString().replace(".", ","));

                date = $("#datetimepicker").datetimepicker("getDate");
                // console.log("autocomplete change date", date);
                var tttz = await getTimezoneOffset_(lat, lng);
                // console.log("autocomplete change tttz", tttz);
                Celestial.skyview({ date: date, location: [lat, lng], timezone: tttz });
                myCelestialConf.Varos = place.name;
                myCelestialConf.Ido = date;
                myCelestialConf.Lokacio = [lat, lng];
                myCelestialConf.Idozona = tttz;
                myCelestialConf.geopos = [lat, lng];

                // console.log("autocomplete.addListener('place_changed', async () => {");

                // AUTO-SAVE: helysz√≠n/d√°tum v√°ltozott
                if (window.triggerAutoSave) window.triggerAutoSave();

                // 3. ADATB√ÅZIS MENT√âS (A JAV√çT√ÅS L√âNYEGE)
                // Megkeress√ºk, melyik t√©rk√©p van kijel√∂lve, √©s abba mentj√ºk az adatokat!
                if (myCelestialConf.userData && myCelestialConf.userData.uiState) {
                    const activeId = myCelestialConf.userData.uiState.selectedElementId;
                    const activeEl = myCelestialConf.userData.elements.find(e => e.id == activeId);

                    // Csak akkor ment√ºnk, ha az akt√≠v elem t√©nyleg egy T√âRK√âP
                    if (activeEl && activeEl.type === 'map') {
                        if (!activeEl.celestialConfig) activeEl.celestialConfig = {};

                        // Adatok √°tvezet√©se a t√°rol√≥ba
                        activeEl.celestialConfig.Varos = place.name;
                        activeEl.celestialConfig.Ido = date;
                        activeEl.celestialConfig.Lokacio = [lat, lng];
                        activeEl.celestialConfig.Idozona = tttz;
                        activeEl.celestialConfig.geopos = [lat, lng];

                        // console.log(`‚úÖ Helysz√≠n mentve a(z) ${activeId} azonos√≠t√≥j√∫ t√©rk√©pbe.`);
                    }
                }

                // 4. TERVEZ≈ê N√âZET FRISS√çT√âSE (Sz√∂vegek)
                if (typeof window.updateDesignerFromCelestial === 'function') {
                    window.updateDesignerFromCelestial();
                }
            });

            // console.log("celestialConfig_ elott qwe");
            var celestialConfig_ = {
                container: 'celestial-map',
                culture: "iau", // Kezdj√ºnk a nyugatival
                // culture: "cn",
                disableAnimations: false,
                form: false,
                // width: 0,
                // width: document.getElementById('map-wrap') ? document.getElementById('map-wrap').clientWidth : 600,

                width: getOptimalMapSize(),
                // datapath: "https://ofrohn.github.io/data/",
                datapath: "data/",
                geopos: [47.4979, 19.0402],
                interactive: false,
                alignCelestialMap: "center",
                formFields: {
                    location: true,
                    general: true,
                    stars: true,
                    dsos: false,
                    constellations: false,
                    lines: true,
                    other: true,
                    download: true
                },
                stars: {
                    show: true,
                    limit: 6,
                    size: 7,
                    exponent: -0.28,
                    colors: true,
                    style: {
                        fill: "#ffffff",
                        opacity: 1
                    },
                    designation: false,
                    designationType: "desig",
                    designationStyle: {
                        fill: "#ddbbbb",
                        font: "11px 'Palatino Linotype', Georgia, Times, 'Times Roman', serif",
                        align: "left",
                        baseline: "top"
                    },
                    propername: false,
                    propernameType: "name",
                    propernameStyle: {
                        fill: "#ddbbbb",
                        font: "13px 'Palatino Linotype', Georgia, Times, 'Times Roman', serif",
                        align: "right",
                        baseline: "bottom"
                    }
                },
                // projection: "orthographic",
                projection: "stereographic",
                lines: {
                    graticule: {
                        show: true, stroke: "#cccccc", width: 0.6, opacity: 0.8,
                        lon: { pos: [], fill: "#eee", font: "10px 'Lucida Sans Unicode', Helvetica, Arial, sans-serif" },
                        lat: { pos: [], fill: "#eee", font: "10px 'Lucida Sans Unicode', Helvetica, Arial, sans-serif" }
                    },
                    equatorial: { show: false, stroke: "#aaaaaa", width: 1.3, opacity: 0.7 },
                    ecliptic: { show: false, stroke: "#66cc66", width: 1.3, opacity: 0.7 },
                    galactic: { show: false, stroke: "#cc6666", width: 1.3, opacity: 0.7 },
                    supergalactic: { show: false, stroke: "#cc66cc", width: 1.3, opacity: 0.7 }
                },
                mw: {
                    show: true,
                    style: { fill: "#ffffff", opacity: "0.15" }
                },
                background: {
                    fill: "#000000",
                    opacity: 1,
                    stroke: "#FFFFFF",
                    width: 1.5,
                    dash: []
                },

                dsos: {
                    show: false,
                    names: false,
                },
                constellations: {
                    names: false,
                    namesType: "iau",
                    nameStyle: {
                        fill: "#cccc99",
                        align: "center",
                        baseline: "middle",
                        font: ["14px Helvetica, Arial, sans-serif", "12px Helvetica, Arial, sans-serif", "11px Helvetica, Arial, sans-serif"]
                    },
                    lines: true,
                    lineStyle: {
                        stroke: "#cccccc",
                        width: 1.5,
                        opacity: 0.6
                    },
                    bounds: false,
                    boundStyle: {
                        stroke: "#cccc00",
                        width: 0.5,
                        opacity: 0.8,
                        dash: [2, 4]
                    }
                },
            }
            myCelestialConf = celestialConfig_;

            Celestial.display(celestialConfig_);
            // Indul√°skor t√∂lts√ºk be az alap (nyugati) list√°t
            loadConstellationList("iau");
            $("#datetimepicker").datetimepicker({
                showAnim: "slideDown",
                showOtherMonths: true,
                selectOtherMonths: true,
                showButtonPanel: true,
                changeMonth: true,
                changeYear: true,
                format: "yy-mm-dd hh:mm:ss",
                dateFormat: "yy-mm-dd",
                timeFormat: "HH:mm",
                showOn: "both",
                buttonImageOnly: false,
                buttonText: "üìÖ",
                firstDay: 1,
                currentText: "Most",
                closeText: "Bez√°r",
                regional: $.datepicker.regional["hu"],
                showSecond: false,
                showTimezone: false,
                onSelect: function () {
                    date = $(this).datetimepicker("getDate");
                    // console.log("datetimepicker change date", date);
                    Celestial.skyview({ date: date, location: [lat, lng], timezone: timeZone });
                    // Glob√°lis config
                    myCelestialConf.Ido = date;

                    // console.log("datetimepicker.addListener('change', function () {");
                    // AUTO-SAVE: d√°tum v√°ltozott
                    if (window.triggerAutoSave) window.triggerAutoSave();

                    // ADATB√ÅZIS MENT√âS (SZINKRONIZ√ÅCI√ì)
                    if (myCelestialConf.userData && myCelestialConf.userData.uiState) {
                        const activeId = myCelestialConf.userData.uiState.selectedElementId;
                        const activeEl = myCelestialConf.userData.elements.find(e => e.id == activeId);

                        if (activeEl && activeEl.type === 'map') {
                            if (!activeEl.celestialConfig) activeEl.celestialConfig = {};
                            activeEl.celestialConfig.Ido = date;
                            // console.log(`‚úÖ D√°tum mentve a(z) ${activeId} azonos√≠t√≥j√∫ t√©rk√©pbe.`);
                        }
                    }

                    // Tervez≈ë friss√≠t√©se
                    if (typeof window.updateDesignerFromCelestial === 'function') {
                        window.updateDesignerFromCelestial();
                    }
                },
                // minDate: -20,
                // minDate: new Date(1900, 0, 1),
                // maxDate: new Date(2100, 0, 1),
                minDate: "-300y",
                maxDate: "+300y",
                yearRange: '1725:2325'
            });
            $("#datetimepicker").datetimepicker('setDate', new Date());


        });
        // 2. F√úGGV√âNY: A list√°k friss√≠t√©se
        function loadConstellationList(culture) {
            var zodiacSelect = document.getElementById("zodiacsign-settings");
            var constellationSelect = document.getElementById("hl-constellation-select");

            // T√∂r√∂lj√ºk a jelenlegi tartalmat
            constellationSelect.innerHTML = '<option value="">-- V√°lassz csillagk√©pet --</option>';

            // --- HA NYUGATI (LATIN) N√âZET VAN ---
            if (culture === "iau") {
                // 1. Zodi√°kus lista megjelen√≠t√©se

                setTimeout(function () {
                    $("#zodiacsign-settings").removeClass("collapsed");
                    $("#zodiacsign-settings").stop(true, true).slideDown(300);
                }, 300);

                // 2. √ñsszes csillagk√©p lista felt√∂lt√©se
                // d3.json("https://ofrohn.github.io/data/constellations.json", function(json) {
                d3.json("data/constellations.json", function (json) {
                    // json.features.sort((a, b) => a.properties.name.localeCompare(b.properties.name));
                    json.features.sort((a, b) => a.properties.hu.localeCompare(b.properties.hu));
                    json.features.forEach(function (feature) {
                        var id = feature.id;
                        var option = document.createElement("option");
                        option.value = id;
                        // ITT VAN A K√âRT FORM√ÅTUM: Magyar / Latin
                        option.text = feature.properties.hu + " / " + feature.properties.name;
                        constellationSelect.appendChild(option);
                    });
                });

                // --- HA K√çNAI N√âZET VAN ---
            } else if (culture === "cn") {
                setTimeout(function () {
                    $("#zodiacsign-settings").addClass("collapsed");
                    $("#zodiacsign-settings").stop(true, true).slideUp(300);
                }, 300);



                // 2. K√≠nai csillagk√©pek bet√∂lt√©se
                d3.json("data/constellations.cn.json", function (json) {
                    // K√≠nai nevek rendez√©se
                    // json.features.sort((a, b) => a.properties.name.localeCompare(b.properties.name));
                    json.features.sort((a, b) => a.properties.hu.localeCompare(b.properties.hu));

                    json.features.forEach(function (feature) {
                        var option = document.createElement("option");
                        option.value = feature.id;
                        // K√≠nai form√°tum: Eredeti n√©v / Angol ford√≠t√°s (Mivel magyar ford√≠t√°s nincs hozz√°juk gy√°rilag)
                        // Pl: "Jiao / Horn"
                        option.text = feature.properties.hu + " / " + feature.properties.en + " / " + feature.properties.name;
                        constellationSelect.appendChild(option);
                    });
                });
            }
        }
        // Ez a f√ºggv√©ny v√©gzi a v√°lt√°st
        function toggleCulture(mire, ez) {
            if (mire === currentCulture) { return };
            console.log("this", ez);
            console.log("$(this)", $(ez));
            $(ez).toggleClass("active");
            $(ez).siblings('.toggleCulture').toggleClass("active");
            currentCulture = mire;

            // 1. T√©rk√©p friss√≠t√©se (ehhez √∫jra kell t√∂lteni a configot)
            myCelestialConf.culture = currentCulture;
            console.log("myCelestialConf", myCelestialConf);
            console.log("myCelestialConf.culture", myCelestialConf.culture);
            console.log("currentCulture", currentCulture);
            // Celestial.apply(myCelestialConf); 
            // Celestial.apply(myCelestialConf); 
            // 2. Kirajzol√°s
            Celestial.display(myCelestialConf);

            // 2. Lista friss√≠t√©se
            loadConstellationList(currentCulture);
            Celestial.resize({ width: getOptimalMapSize() });
            console.log("Kult√∫ra √°tv√°ltva erre: " + currentCulture);
        }
        async function getTimezoneOffset_(lt, ln) {
            // console.log("getTimezoneOffset lt", lt);
            // console.log("getTimezoneOffset ln", ln);

            if (!lt || !ln) {
                return;
            }

            const timestamp = Math.floor(Date.now() / 1000);

            const API_KEY = "AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s";
            const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + lt + ',' + ln + '&timestamp=' + timestamp + '&key=' + API_KEY;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === "OK") {
                    const rawOffsetSeconds = data.rawOffset;
                    const dstOffsetSeconds = data.dstOffset;

                    const totalOffsetSeconds = rawOffsetSeconds + dstOffsetSeconds;

                    const totalOffsetMinutes = totalOffsetSeconds / 60;

                    timeZone = totalOffsetMinutes;
                    // console.log("timeZone", timeZone);
                    return totalOffsetMinutes;

                } else {
                    let errorMessage = data.errorMessage || 'Ismeretlen hiba t√∂rt√©nt.';
                }
            } catch (error) {
                console.error("Hiba t√∂rt√©nt:", error);
            }
        }

        $(document).on('click', '.ui-datepicker-current', function (e) {
            // console.log("datetimepicker click .ui-datepicker-current");
            var date = new Date();
            var datestr = date.toString();
            // console.log("datetimepicker change datestr", datestr);
            var reg = /([\+?\-?]\d\d\d\d)/g;
            var matches = datestr.match(reg);
            // console.log("datetimepicker change matches", matches);
            // console.log("datetimepicker change matches[0]", matches[0]);

            timeZoneMin = convertTimezoneOffset(matches[0]);
            $("#datetimepicker").datetimepicker('setDate', new Date());
        });

        function convertTimezoneOffset(offsetString) {
            const regex = /^([+-])(\d{2})(\d{2})$/;
            const match = offsetString.match(regex);

            if (!match) {
                console.error("√ârv√©nytelen id≈ëz√≥na form√°tum. P√©lda: '+0200' vagy '-0400'");
                return null;
            }

            const sign = match[1];
            const hours = parseInt(match[2], 10);

            let totalMinutes = hours * 60;

            if (sign === '-') {
                totalMinutes = -totalMinutes;
            }

            return totalMinutes;
        }

        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] instanceof Object && key in target && target[key] instanceof Object) {
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        function copyCelestialToSVG() {
            const celestialContainer = document.getElementById('celestial-map');
            const canvas = celestialContainer.querySelector('canvas');

            if (!canvas) {
                console.error('Nem tal√°lhat√≥ Canvas a Celestial t√©rk√©pben');
                return;
            }

            // Canvas tartalom konvert√°l√°sa data URL-l√©
            const dataURL = canvas.toDataURL('image/png');

            // √öj SVG l√©trehoz√°sa
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);

            // Image elem l√©trehoz√°sa a canvas tartalommal
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('href', dataURL);
            image.setAttribute('width', canvas.width);
            image.setAttribute('height', canvas.height);
            image.setAttribute('x', '0');
            image.setAttribute('y', '0');

            svg.appendChild(image);

            // SVG hozz√°ad√°sa a c√©l kont√©nerhez
            // const targetContainer = document.getElementById('svg-container');
            // const targetContainer = document.getElementById('text-overlay-svg');
            const targetContainer = document.getElementById('designer-svg');
            targetContainer.innerHTML = '';
            targetContainer.appendChild(svg);

            // console.log('Celestial t√©rk√©p sikeresen m√°solva SVG-be!');
        }
        // Update settings when form controls change
        document.getElementById('zodiacsigns').addEventListener('change', (e) => {
            // console.log("zodiacsigns change e", e);
            // console.log("zodiacsigns change e.target.value", e.target.value);
            //         myCelestialConf.Csillagjegy = e.target.value;
            // Celestial.showConstellation(e.target.value)


            // --- JAV√çT√ÅS: √Ållapot ment√©se √©s Vissza√°ll√≠t√°sa (myCelestialConf-ban) ---
            if (e.target.value === "nincs") {
                // 1. VISSZA√ÅLL√çT√ÅS

                // Ellen≈ërizz√ºk, hogy van-e mentett √°llapot a konfigban
                if (myCelestialConf.preConstellationConfig) {
                    // console.log("Vissza√°ll√≠t√°s mentett √°llapotb√≥l (myCelestialConf)...");

                    // Visszat√∂ltj√ºk a mentett konfigot egy ideiglenes v√°ltoz√≥ba
                    var savedConfig = myCelestialConf.preConstellationConfig;

                    // Vissza√°ll√≠tjuk a teljes konfigot a mentett √°llapotra
                    myCelestialConf = JSON.parse(JSON.stringify(savedConfig));

                    // Alkalmazzuk a Celestial-ra
                    Celestial.apply(myCelestialConf);

                    // T√∂r√∂lj√ºk a mentett property-t, mivel m√°r nem kell (vissza√°lltunk)
                    // (B√°r a savedConfig-ban eleve nem volt benne, ha j√≥l csin√°ltuk a ment√©st, 
                    // de a biztons√°g kedv√©√©rt explicit t√∂r√∂lhetj√ºk a mostani objektumb√≥l)
                    delete myCelestialConf.preConstellationConfig;
                }

                myCelestialConf.Csillagjegy = null;

                // 2. K√âNYSZER√çTETT √ÅTM√âRETEZ√âS (Ez a kulcs a Zoom Reset-hez!)
                Celestial.resize({ width: getOptimalMapSize() });

                // 3. POZ√çCI√ì VISSZA√ÅLL√çT√ÅSA
                Celestial.skyview({ date: date, location: [lat, lng], timezone: timeZone });
                // $("#zodiacsigns").find("option").value() == "nincs";
                $('option[value="nincs"]').text('-- V√°lassz csillagjegyet --');

            } else {
                // 1. MENT√âS (Csak ha m√©g nincs mentve)
                if (!myCelestialConf.preConstellationConfig) {
                    // console.log("Jelenlegi √°llapot ment√©se zoom el≈ëtt a myCelestialConf-ba...");

                    // M√©ly m√°solat k√©sz√≠t√©se a jelenlegi √°llapotr√≥l
                    var configToSave = JSON.parse(JSON.stringify(myCelestialConf));

                    // Elt√°vol√≠tjuk a ment√©sb≈ël a ment√©st (hogy ne legyen rekurzi√≥ vagy felesleges adat)
                    // B√°r m√©g nincs benne, de a biztons√°g kedv√©√©rt.
                    delete configToSave.preConstellationConfig;

                    // Elmentj√ºk a f≈ë objektumba
                    myCelestialConf.preConstellationConfig = configToSave;
                }
                $('option[value="nincs"]').text('-- Vissza√°ll√≠t√°s --');

                // 2. CSILLAGJEGY MEGJELEN√çT√âSE
                myCelestialConf.Csillagjegy = e.target.value;

                // console.log("constellationSelect.on('change', function () {");
                // AUTO-SAVE: csillagjegy v√°ltozott
                if (window.triggerAutoSave) window.triggerAutoSave();
                Celestial.showConstellation(e.target.value);
            }
        });

        // --- √öJ LOGIKA: AZONNALI SZERKESZT√âS (JAV√çTOTT VERZI√ì) ---

        let currentlyEditingId = null; // T√°roljuk, hogy √©pp melyiket szerkesztj√ºk

        // 1. SELECT ESEM√âNY (√öj hozz√°ad√°sa)
        $('#hl-constellation-select').on('change', function () {
            const id = $(this).val();
            if (!id) return;

            // Ha m√©g nincs a list√°ban, hozz√°adjuk alap√©rtelmezett st√≠lussal
            if (!Celestial.highlightList || !Celestial.highlightList[id]) {
                const defaultStyle = {
                    stroke: "#ffcc00",
                    width: 3,
                    opacity: 1,
                    dash: []
                };
                Celestial.highlight(id, defaultStyle);
            }

            // Azonnal megnyitjuk szerkeszt√©sre
            startEditingHighlight(id);

            // UI friss√≠t√©s (lista)
            renderActiveHighlights();
            // Celestial.select(this.value);
            // Select vissza√°ll√≠t√°sa alaphelyzetbe
            $(this).val('');

            // Auto-save
            if (typeof activeThemeKey !== 'undefined' && activeThemeKey === 'custom') saveUserState();
        });

        // 2. SZERKESZT√âS IND√çT√ÅSA (Panel bet√∂lt√©se)
        function startEditingHighlight(id) {
            // Ha m√°r ez van megnyitva, akkor bez√°rjuk (Toggle)
            if (currentlyEditingId === id) {
                closeHighlightSettings();
                return;
            }

            currentlyEditingId = id;
            const style = Celestial.highlightList[id];
            if (!style) return;

            // Panel c√≠me
            const nameText = $(`#hl-constellation-select option[value="${id}"]`).text() || id;
            $('#hl-editing-title').text(nameText + " szerkeszt√©se");

            // √ârt√©kek bet√∂lt√©se az inputokba
            $('#hl-color').val(style.stroke);
            $('#hl-width').val(style.width);
            $('#hl-opacity').val(style.opacity);

            if (style.dash && style.dash.length > 0) {
                $('#hl-dash-check').prop('checked', true);
                $('#hl-dash-settings').show();
                $('#hl-dash-1').val(style.dash[0]);
                $('#hl-dash-2').val(style.dash[1]);
            } else {
                $('#hl-dash-check').prop('checked', false);
                $('#hl-dash-settings').hide();
            }

            // Panel megjelen√≠t√©se
            $('#hl-settings-panel').slideDown();

            // Lista vizu√°lis friss√≠t√©se (hogy l√°tsz√≥djon, melyik akt√≠v)
            renderActiveHighlights();
        }

        // 3. SZERKESZT√âS BEZ√ÅR√ÅSA
        window.closeHighlightSettings = function () {
            currentlyEditingId = null;
            $('#hl-settings-panel').slideUp();
            renderActiveHighlights(); // Kijel√∂l√©s elt≈±ntet√©se a list√°r√≥l
        };

        // 4. INPUTOK ESEM√âNYEI (Azonnali friss√≠t√©s ment√©s n√©lk√ºl)
        const updateCurrentHighlight = () => {
            if (!currentlyEditingId) return;

            const newStyle = {
                stroke: $('#hl-color').val(),
                width: parseFloat($('#hl-width').val()),
                opacity: parseFloat($('#hl-opacity').val()),
                dash: $('#hl-dash-check').is(':checked') ?
                    [parseFloat($('#hl-dash-1').val()), parseFloat($('#hl-dash-2').val())] :
                    []
            };

            // Friss√≠t√©s a Celestialban (Redraw)
            Celestial.highlight(currentlyEditingId, newStyle);

            // Friss√≠tj√ºk a lista elem sz√©l√©t is (sz√≠njel√∂l≈ë)
            renderActiveHighlights();

            // Auto-save
            if (typeof activeThemeKey !== 'undefined' && activeThemeKey === 'custom') saveUserState();
        };

        // Esem√©nyfigyel≈ëk az inputokra (input = azonnali, change = v√©gleges√≠t√©s)
        $('#hl-color, #hl-width, #hl-opacity, #hl-dash-1, #hl-dash-2').on('input', updateCurrentHighlight);
        $('#hl-dash-check').on('change', function () {
            if ($(this).is(':checked')) $('#hl-dash-settings').slideDown();
            else $('#hl-dash-settings').slideUp();
            updateCurrentHighlight();
        });

        // 5. LISTA RENDEREL√âSE (JAV√çTOTT CSS SORRENDDEL)
        function renderActiveHighlights() {
            const listContainer = $('#active-highlights-list');
            const mainContainer = $('#active-highlights-container');
            listContainer.empty();

            // Ha nincs highlight, elrejtj√ºk az eg√©sz list√°t √©s a szerkeszt≈ët
            if (!Celestial.highlightList || Object.keys(Celestial.highlightList).length === 0) {
                mainContainer.hide();
                if (currentlyEditingId) closeHighlightSettings();
                return;
            }

            mainContainer.show();

            for (const [id, style] of Object.entries(Celestial.highlightList)) {
                // N√©v kinyer√©se a selectb≈ël
                let nameText = id;
                const option = $(`#hl-constellation-select option[value="${id}"]`);
                if (option.length > 0) nameText = option.text();

                // Akt√≠v elem jel√∂l√©se
                const activeClass = isActive ? 'active' : '';

                // --- A JAV√çT√ÅS ITT VAN: ---
                // Az √°ltal√°nos border legyen √°tl√°tsz√≥ vagy k√©k, DE a border-left-color-t 
                // k√ºl√∂n fel√ºl√≠rjuk a v√©g√©n a st√≠lus sz√≠n√©vel!
                // const baseBorder = isActive ? '1px solid var(--accent-blue)' : '1px solid transparent';

                const item = $(`
                    <div class="highlight-item-glass ${activeClass}" data-id="${id}" 
                         style="border-left: 4px solid ${style.stroke};">
                        <div class="highlight-item-text">${nameText}</div>
                        <button class="remove-hl-btn" data-id="${id}" style="background:none; border:none; color:#ff4444; cursor:pointer; font-weight:bold; padding:5px; font-size: 16px;">√ó</button>
                    </div>
                `);

                // Kattint√°s az elemre -> Szerkeszt√©s (vagy bez√°r√°s)
                item.on('click', function (e) {
                    if ($(e.target).hasClass('remove-hl-btn')) return; // Ha a t√∂rl√©sre kattintott, ne nyissa meg
                    startEditingHighlight(id);
                });

                listContainer.append(item);
            }

            // T√∂rl√©s gombok esem√©nykezel≈ëje
            $('.remove-hl-btn').on('click', function (e) {
                e.stopPropagation(); // Ne nyissa meg a szerkeszt≈ët
                const idToRemove = $(this).data('id');

                // Ha √©pp ezt szerkesztett√ºk, z√°rjuk be a panelt
                if (currentlyEditingId === idToRemove) {
                    closeHighlightSettings();
                }

                Celestial.highlight(idToRemove, null); // Null st√≠lussal h√≠vva t√∂r√∂l
                renderActiveHighlights(); // √öjrarajzoljuk a list√°t

                if (typeof activeThemeKey !== 'undefined' && activeThemeKey === 'custom') {
                    saveUserState();
                }
            });
        }

        // const GOOGLE_API_KEY = "AIzaSyAksFO9HeXBhjzvKKzCPndnr-jxy1JPGwE"; csak fontshoz
        const GOOGLE_API_KEY = "AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s";
        // K√©rt bet≈±t√≠pusok
        // const fontNames = ['Merriweather', 'Montserrat', 'Roboto', 'Open Sans'];
        const fontNames = [
            'Montserrat',
            'Roboto',
            'Open Sans',
            'Merriweather',
            'Playfair Display',
            'Raleway',
            'Inter',
            'Source Sans Pro',
            'Source Sans 3',
            'Source Code Pro',
            'Noto Sans',
            'Abril Fatface',
            'Cormorant',
            'JetBrains Mono',
            'EB Garamond',
            'Cinzel',
            'MedievalSharp',
            'Uncial Antiqua',
            'Great Vibes',
            'Tangerine',
            'Special Elite',
            'Dancing Script',
            'Allura',
            'Sacramento',
            'Quicksand',
            'Parisienne'
        ];

        // Font vari√°nsok lek√©rdez√©se
        async function loadAndDisplayFonts() {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/webfonts/v1/webfonts?key=${GOOGLE_API_KEY}`
                );

                if (!response.ok) throw new Error('API hiba');

                const data = await response.json();
                const container = document.getElementById('font-tests');

                fontNames.forEach(fontName => {
                    const font = data.items.find(f => f.family === fontName);
                    if (font) {
                        const fontSection = document.createElement('div');
                        fontSection.className = 'font-test';

                        var fonts_opt = document.createElement('option');
                        var fff = `${font.variants.map(variant => `
                                    <option style="font-family: '${fontName}';font-weight: ${getVariantInfo(variant).weight};font-style: ${getVariantInfo(variant).style};" value="${fontName}_${getVariantInfo(variant).name}">Szeretettel T≈ëlem Neked!
                                    </option>
                                `).join('')}
                        `;

                        $("#font_").append(fff)
                    }
                });

            } catch (error) {
                console.error('Hiba:', error);
                document.getElementById('font-tests').innerHTML =
                    '<p>Hiba a bet≈±t√≠pusok bet√∂lt√©s√©ben. Ellen≈ërizd az API kulcsot.</p>';
            }
        }

        function getVariantInfo(variant) {
            const weightNames = {
                100: 'Thin 100',
                200: 'ExtraLight 200',
                300: 'Light 300',
                400: 'Regular 400',
                500: 'Medium 500',
                600: 'SemiBold 600',
                700: 'Bold 700',
                800: 'ExtraBold 800',
                900: 'Black 900'
            };

            let weight = 400;
            let style = 'normal';
            let name = '';

            if (variant === 'regular') {
                weight = 400;
                style = 'normal';
                name = 'Regular 400';
            } else if (variant === 'italic') {
                weight = 400;
                style = 'italic';
                name = 'Regular 400 Italic';
            } else if (variant.includes('italic')) {
                weight = parseInt(variant.replace('italic', ''));
                style = 'italic';
                name = `${weightNames[weight]} Italic`;
            } else {
                weight = parseInt(variant);
                style = 'normal';
                name = weightNames[weight];
            }

            return { weight, style, name };
        }
        // Glob√°lis v√°ltoz√≥ a helyes m√©ret t√°rol√°s√°ra
        window.lastValidMapWidth = null;
        // --- JAV√çTOTT M√âRETEZ√âS (K√©par√°ny figyelembev√©tel√©vel) ---
        function getOptimalMapSize() {
            // console.log("function getOptimalMapSize() {");
            // console.log("function getOptimalMapSize() { myCelestialConf", myCelestialConf);
            // console.log("function getOptimalMapSize() { Celestial", Celestial);
            var container = $("#map-wrap");
            var windowHeight = $(window).height();
            var containerHeight = container.height();
            var proj = "stereographic";
            // console.log("function getOptimalMapSize() { container", container);
            // console.log("function getOptimalMapSize() { windowHeight", windowHeight);
            // console.log("function getOptimalMapSize() { containerHeight", containerHeight);
            // 1. Megn√©zz√ºk az aktu√°lis projekci√≥ ar√°ny√°t (Ratio)
            var currentRatio = 1.0;
            // BIZTONS√ÅGI ELLEN≈êRZ√âS: 
            // Csak akkor k√©rdezz√ºk le a projekci√≥t, ha a konfig m√°r l√©tezik √©s nem null!
            if (typeof myCelestialConf !== 'undefined' &&
                myCelestialConf !== null &&  // <--- EZ HI√ÅNYZOTT! (Null check)
                myCelestialConf.projection &&
                Celestial.projections()[myCelestialConf.projection]) {

                // console.log("myCelestialConf !== null");
                proj = myCelestialConf.projection;
                var p = Celestial.projections()[myCelestialConf.projection];
                if (p.ratio) currentRatio = p.ratio;
            }
            // 2. Sz√°m√≠t√°s, ha l√°that√≥ a kont√©ner
            if (container.is(':visible') && container.width() > 0) {
                // console.log("container.is(':visible') && container.width() > 0");
                var containerWidth = container.width();

                // Kisz√°moljuk, mekkora a maxim√°lis sz√©less√©g, ami bef√©r:

                // A) A kont√©ner sz√©less√©ge korl√°tozza:
                var maxW_by_Width = containerWidth;

                // B) Az ablak magass√°ga korl√°tozza:
                // Mivel Height = Width / Ratio  =>  Width = Height * Ratio
                // Teh√°t a sz√©less√©g nem lehet t√∂bb, mint (AblakMagass√°g * Ratio)
                // var maxW_by_Height = windowHeight * currentRatio; 
                // var maxW_by_Height = windowHeight * 1; 
                var maxW_by_Height = containerHeight * 1;

                // A kett≈ë k√∂z√ºl a SZIGOR√öBBAT (kisebbet) v√°lasztjuk
                var calculatedSize = proj == "customHeart" ? Math.min(maxW_by_Width, maxW_by_Height) * 0.93 : Math.min(maxW_by_Width, maxW_by_Height) * 0.95;
                // var calculatedSize = Math.min(maxW_by_Width, maxW_by_Height); // * 0.95;

                // Elmentj√ºk a k√©s≈ëbbi (Tervez≈ë n√©zet) haszn√°latra
                window.lastValidMapWidth = calculatedSize;

                // console.log("container.is(':visible') && container.width() > 0 calculatedSize", calculatedSize);
                return calculatedSize;
            }

            // 3. Ha a t√©rk√©p rejtett (Tervez≈ë n√©zet), a mentett √©rt√©ket adjuk vissza
            if (window.lastValidMapWidth) {
                // console.log("if (window.lastValidMapWidth) {");
                // console.log("if (window.lastValidMapWidth) { window.lastValidMapWidth", window.lastValidMapWidth);
                return window.lastValidMapWidth;
            }

            // 4. Fallback (V√©szhelyzeti becsl√©s ar√°nnyal)
            var ratio = ($(window).width() > 768) ? 0.7 : 1.0;
            var estWidth = $(window).width() * ratio;
            // Itt is alkalmazzuk az ar√°nyt:
            // return Math.min(estWidth, windowHeight * currentRatio) * 0.95;
            // console.log("4. Fallback (V√©szhelyzeti becsl√©s ar√°nnyal)");
            // console.log("4. Fallback (V√©szhelyzeti becsl√©s ar√°nnyal) Math.min(estWidth, windowHeight * currentRatio) * 0.95", Math.min(estWidth, windowHeight * currentRatio) * 0.95);
            return Math.min(estWidth, windowHeight * currentRatio) * 0.95;
        }

        // --- 1. IND√çT√ÅSKOR M√âRETEZ√âS ---
        setTimeout(function () {
            // console.log("setTimeout(function(){ qwe");
            // Celestial.resize({width: getOptimalMapSize()});

            // Ha esetleg a fenti nem futott le, itt is ellen≈ërizz√ºk
            if (typeof Celestial !== 'undefined' && typeof Celestial.resize === 'function') {
                Celestial.resize({ width: getOptimalMapSize() });
            }
        }, 100);

        // --- 2. PROJEKCI√ì V√ÅLT√ÅSKOR √öJRAM√âRETEZ√âS √âS IGAZ√çT√ÅS ---
        document.getElementById('projection_').addEventListener('change', (e) => {
            // console.log("Projekci√≥ v√°lt√°s:", e.target.value);

            changeProjection(e.target.value);
        });

        function changeProjection(mire) {
            console.log("Projekci√≥ v√°lt√°s: qwe", mire);
            // console.log("function changeProjection(mire) {");
            // 1. Projekci√≥ be√°ll√≠t√°sa
            myCelestialConf.projection = mire;
            myCelestialConf.width = getOptimalMapSize();

            // 2. Kirajzol√°s
            //Celestial.display(myCelestialConf);

            // console.log("function changeProjection(mire) {");
            // AUTO-SAVE: projekci√≥ v√°ltozott
            if (window.triggerAutoSave) window.triggerAutoSave();

            // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
            if (myCelestialConf.projection !== 'customHeart') {
                console.log("Projekci√≥ v√°lt√°s: qwe  !== 'customHeart'", mire);
                Celestial.reproject({ projection: mire });
                // AUTO-SAVE: projekci√≥ v√°ltozott
                if (window.triggerAutoSave) window.triggerAutoSave();
                // 1. L√©p√©s: M√©retez√©s a kont√©nerhez (Ez reseteli a poz√≠ci√≥t alap√°llapotra)
                // setTimeout(function () {
                //     Celestial.resize({ width: getOptimalMapSize() });
                // }, 150);
                // $("#szivszogediv").hide();

                setTimeout(function () {
                    $("#szivszogediv").addClass("collapsed");
                    $("#szivszogediv").stop(true, true).slideUp(300);
                }, 300);
            }
            else {
                console.log("Projekci√≥ v√°lt√°s: qwe  === 'customHeart'", mire);
                // 3. UT√ìLAGOS KORREKCI√ì (Prec√≠zi√≥s igaz√≠t√°s)
                setTimeout(function () {
                    console.log("Projekci√≥ v√°lt√°s: qwe  === 'customHeart sett'", mire);
                    Celestial.display(myCelestialConf);
                    // 1. L√©p√©s: M√©retez√©s a kont√©nerhez (Ez reseteli a poz√≠ci√≥t alap√°llapotra)
                    Celestial.resize({ width: getOptimalMapSize() });

                    // AUTO-SAVE: projekci√≥ v√°ltozott
                    if (window.triggerAutoSave) window.triggerAutoSave();

                    // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
                    if (myCelestialConf.projection === 'customHeart') {
                        // console.log("function changeProjection(mire) { customHeart");
                        // console.log(">>> Sz√≠v alak PRECIZ√çOS igaz√≠t√°sa...");
                        // $("#szivszogediv").show();

                        setTimeout(function () {
                            $("#szivszogediv").removeClass("collapsed");
                            $("#szivszogediv").stop(true, true).slideDown(300);
                        }, 300);
                        var mapProj = Celestial.mapProjection;
                        if (!mapProj) return; // Biztons√°gi ellen≈ërz√©s

                        // --- A MATEMATIKA ---

                        // 2. Megm√©rj√ºk a VET√úLET (a sz√≠v alak) pontos hely√©t √©s m√©ret√©t
                        // L√©trehozunk egy D3 √∫tvonal gener√°tort az aktu√°lis vet√ºlettel
                        var path = d3.geo.path().projection(mapProj);

                        // L√©trehozunk egy "graticule" (fokh√°l√≥zat) objektumot.
                        // Ennek az "outline" (k√∂rvonal) tulajdons√°ga adja ki a teljes sz√≠v form√°t.
                        var graticule = d3.geo.graticule();
                        var outline = graticule.outline();

                        // A .bounds() visszaadja a befoglal√≥ dobozt: [[x_bal, y_fent], [x_jobb, y_lent]]
                        var bounds = path.bounds(outline);

                        // Kisz√°moljuk, hol van MOST a sz√≠v k√∂zepe f√ºgg≈ëlegesen
                        var mapTop = bounds[0][1];
                        var mapBottom = bounds[1][1];
                        var mapHeight = mapBottom - mapTop;
                        var mapCenterY = mapTop + (mapHeight / 2);

                        // console.log("mapTop", mapTop);
                        // console.log("mapBottom", mapBottom);
                        // console.log("mapHeight", mapHeight);
                        // console.log("mapCenterY", mapCenterY);
                        // 3. Megn√©zz√ºk, hol van a V√ÅSZON k√∂zepe
                        var canvas = document.querySelector('#celestial-map canvas');
                        var canvasHeight = canvas.height;
                        var canvasCenterY = canvasHeight / 2;

                        // 4. Kisz√°moljuk a sz√ºks√©ges ELTOL√ÅST (Delta)
                        // Ha a t√©rk√©p k√∂zepe (mapCenterY) pl. 300, de a v√°szon√© (canvasCenterY) 500,
                        // akkor +200 pixellel kell lejjebb tolni.
                        var deltaY = canvasCenterY - mapCenterY;

                        var deltaY_ = canvasHeight - mapHeight;
                        // console.log("canvasHeight", canvasHeight);
                        // console.log("mapHeight", mapHeight);
                        // console.log("deltaY", deltaY);
                        // console.log("deltaY_", deltaY_);
                        // console.log("mapCenterY", mapCenterY);

                        // console.log(`M√©r√©s: T√©rk√©pK√∂z√©p=${mapCenterY.toFixed(1)}, V√°szonK√∂z√©p=${canvasCenterY.toFixed(1)} -> Eltol√°s=${deltaY.toFixed(1)}px`);


                        // 5. Alkalmazzuk az eltol√°st
                        var currentTranslate = mapProj.translate();
                        // console.log("currentTranslate[0]", currentTranslate[0]);
                        // console.log("currentTranslate[1]", currentTranslate[1]);
                        // console.log("currentTranslate[1] + deltaY", currentTranslate[1] + deltaY);
                        // [X marad (az m√°r j√≥), Y-hoz hozz√°adjuk a sz√°m√≠tott delt√°t]
                        // mapProj.translate([currentTranslate[0], currentTranslate[1] + deltaY]);
                        // mapProj.translate([currentTranslate[0], currentTranslate[1] + ( mapHeight / 2 )]);
                        // mapProj.translate([currentTranslate[0], (mapHeight / 3) * 2]);
                        // console.log("(mapHeight / 3) * 6", (mapHeight / 3) * 6);
                        // console.log("(mapHeight / 3) * 6", mapHeight * 4);
                        // mapProj.translate([currentTranslate[0], mapHeight * 4]);
                        // mapProj.translate([currentTranslate[0], currentTranslate[1]]);
                        // mapProj.translate([currentTranslate[0], mapHeight ]);
                        // mapProj.translate([currentTranslate[0], currentTranslate[1] + (deltaY/5)]);
                        // mapProj.translate([currentTranslate[0], deltaY*1.5]);
                        // mapProj.translate([currentTranslate[0], mapHeight * 1.5]);
                        mapProj.translate([currentTranslate[0], currentTranslate[1] * 1.15]);

                        // 6. √öjrarajzol√°s a t√∂k√©letes poz√≠ci√≥ban
                        Celestial.redraw();
                    }
                    else {
                        $("#szivszogediv").hide();
                    }

                }, 150); // Pici v√°rakoz√°s a resize ut√°n
            }
        }

        // Ablak √°tm√©retez√©sekor is igazodjon (Opcion√°lis, de hasznos)
        $(window).resize(function () {
            // console.log("$(window).resize(function() {");
            // console.log("$(window).resize(function() { myCelestialConf", myCelestialConf);
            // console.log("$(window).resize(function() { Celestial", Celestial);
            // Celestial.resize({width: getOptimalMapSize()});
            // 3. UT√ìLAGOS KORREKCI√ì (Ez fogja helyretenni!)
            // 1. TITKOS √ñSSZETEV≈ê: A vet√ºlet defin√≠ci√≥j√°nak friss√≠t√©se
            // Ezt csin√°lja a sz√∂g √°ll√≠t√≥ gomb is, ez√©rt javul meg t≈ële.
            // Most automatiz√°ljuk!

            // Kiolvassuk a jelenlegi √©rt√©keket (vagy alap√©rtelmezettet)
            var aktSzog = parseFloat($("#szivszoge").val()) || 2.4;
            var aktRatio = 0.88; // Vagy szivratioja v√°ltoz√≥, ha haszn√°lod

            if (Celestial.projections) {
                Celestial.projections().customHeart = {
                    arg: Math.PI / aktSzog,
                    scale: 235, // A change esem√©nyben is 210 volt, tartsuk meg
                    ratio: aktRatio
                };
            }

            // 2. Most j√∂het a m√©retez√©s (M√°r az √∫j defin√≠ci√≥val!)
            // Celestial.resize({width: getOptimalMapSize()});
            // 2. Most j√∂het a m√©retez√©s (M√°r az √∫j defin√≠ci√≥val!)
            // --- JAV√çT√ÅS ITT: Biztons√°gi ellen≈ërz√©s ---
            if (typeof Celestial !== 'undefined' && typeof Celestial.resize === 'function') {
                Celestial.resize({ width: getOptimalMapSize() });
            }
            // ------------------------------------------
            setTimeout(function () {
                // // El≈ësz√∂r m√©retezz√ºk √°t a kont√©nerhez
                // Celestial.resize({width: getOptimalMapSize()});

                // 1. L√©p√©s: M√©retez√©s a kont√©nerhez (Ez reseteli a poz√≠ci√≥t alap√°llapotra)
                // Celestial.resize({width: getOptimalMapSize()});
                // Ha esetleg a fenti nem futott le, itt is ellen≈ërizz√ºk
                if (typeof Celestial !== 'undefined' && typeof Celestial.resize === 'function') {
                    Celestial.resize({ width: getOptimalMapSize() });
                }

                // HA A SZ√çV ALAK VAN KIV√ÅLASZTVA:
                if (myCelestialConf.projection === 'customHeart') {
                    // console.log(">>> Sz√≠v alak PRECIZ√çOS igaz√≠t√°sa...");

                    var mapProj = Celestial.mapProjection;
                    if (!mapProj) return; // Biztons√°gi ellen≈ërz√©s

                    // --- A MATEMATIKA ---

                    // 2. Megm√©rj√ºk a VET√úLET (a sz√≠v alak) pontos hely√©t √©s m√©ret√©t
                    // L√©trehozunk egy D3 √∫tvonal gener√°tort az aktu√°lis vet√ºlettel
                    var path = d3.geo.path().projection(mapProj);

                    // L√©trehozunk egy "graticule" (fokh√°l√≥zat) objektumot.
                    // Ennek az "outline" (k√∂rvonal) tulajdons√°ga adja ki a teljes sz√≠v form√°t.
                    var graticule = d3.geo.graticule();
                    var outline = graticule.outline();

                    // A .bounds() visszaadja a befoglal√≥ dobozt: [[x_bal, y_fent], [x_jobb, y_lent]]
                    var bounds = path.bounds(outline);

                    // Kisz√°moljuk, hol van MOST a sz√≠v k√∂zepe f√ºgg≈ëlegesen
                    var mapTop = bounds[0][1];
                    var mapBottom = bounds[1][1];
                    var mapHeight = mapBottom - mapTop;
                    var mapCenterY = mapTop + (mapHeight / 2);

                    // console.log("mapTop", mapTop);
                    // console.log("mapBottom", mapBottom);
                    // console.log("mapHeight", mapHeight);
                    // console.log("mapCenterY", mapCenterY);
                    // 3. Megn√©zz√ºk, hol van a V√ÅSZON k√∂zepe
                    var canvas = document.querySelector('#celestial-map canvas');
                    var canvasHeight = canvas.height;
                    var canvasCenterY = canvasHeight / 2;

                    // 4. Kisz√°moljuk a sz√ºks√©ges ELTOL√ÅST (Delta)
                    // Ha a t√©rk√©p k√∂zepe (mapCenterY) pl. 300, de a v√°szon√© (canvasCenterY) 500,
                    // akkor +200 pixellel kell lejjebb tolni.
                    var deltaY = canvasCenterY - mapCenterY;

                    var deltaY_ = canvasHeight - mapHeight;
                    // console.log("canvasHeight", canvasHeight);
                    // console.log("mapHeight", mapHeight);
                    // console.log("deltaY", deltaY);
                    // console.log("deltaY_", deltaY_);
                    // console.log("mapCenterY", mapCenterY);

                    // console.log(`M√©r√©s: T√©rk√©pK√∂z√©p=${mapCenterY.toFixed(1)}, V√°szonK√∂z√©p=${canvasCenterY.toFixed(1)} -> Eltol√°s=${deltaY.toFixed(1)}px`);


                    // 5. Alkalmazzuk az eltol√°st
                    var currentTranslate = mapProj.translate();
                    // console.log("currentTranslate[0]", currentTranslate[0]);
                    // console.log("currentTranslate[1]", currentTranslate[1]);
                    // console.log("currentTranslate[1] + deltaY", currentTranslate[1] + deltaY);
                    mapProj.translate([currentTranslate[0], currentTranslate[1] * 1.15]);

                    // 6. √öjrarajzol√°s a t√∂k√©letes poz√≠ci√≥ban
                    Celestial.redraw();
                }

            }, 150); // Pici k√©sleltet√©s kell, hogy a Celestial v√©gezzen az alapbe√°ll√≠t√°ssal
        });

        // Theme functionality moved to fragment5_themes_e_nezet.js

        document.addEventListener('DOMContentLoaded', function () {
            const settingsWrap = document.querySelector('.settingswrap');
            let scrollTimeout;

            if (settingsWrap) {
                settingsWrap.addEventListener('scroll', () => {
                    // Hozz√°adjuk az oszt√°lyt, ami l√°that√≥v√° teszi a s√°vot
                    settingsWrap.classList.add('scrolling');

                    // T√∂r√∂lj√ºk az el≈ëz≈ë id≈ëz√≠t≈ët, ha √©pp g√∂rgetsz
                    clearTimeout(scrollTimeout);

                    // √öj id≈ëz√≠t≈ë: 1000 ms (1 m√°sodperc) m√∫lva elt√ºnteti
                    scrollTimeout = setTimeout(() => {
                        settingsWrap.classList.remove('scrolling');
                    }, 1000);
                });
            }
        });

    </script>
    <!-- Full Screen Preview Modal -->
    <div id="fs-preview-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:10000; background:rgba(0,0,0,0.95); flex-direction:column;">
        <div class="fs-toolbar"
            style="padding:10px; background:rgba(20,20,20,0.8); display:flex; gap:15px; justify-content:center; align-items:center; border-bottom:1px solid #444;">
            <div class="fs-controls" style="display:flex; gap:10px; align-items:center;">
                <button class="btn-glass btn-glass-secondary" onclick="window.setPreviewZoom('fit')">Ablakhoz
                    igaz√≠t</button>
                <button class="btn-glass btn-glass-secondary" onclick="window.setPreviewZoom(1)">1:1
                    M√©ret</button>
                <input type="range" id="fs-zoom-slider" class="slider-glass" min="0.1" max="5" step="0.1" value="1"
                    oninput="window.manualZoom(this.value)" style="width:150px;">
                <span id="fs-zoom-level" style="color:white; font-size:12px; width:40px;">100%</span>
            </div>
            <button class="fs-close"
                style="background:none; border:none; color:white; font-size:24px; cursor:pointer; margin-left:20px;"
                onclick="window.closeFullScreenView()">‚úï</button>
        </div>
        <div id="fs-content-container"
            style="flex:1; overflow:hidden; position:relative; cursor:grab; display:flex; justify-content:center; align-items:center;"
            onmousedown="window.startPan(event)">
            <div id="fs-content-inner"
                style="transform-origin:center center; transition:transform 0.1s ease-out; width:100%; height:100%;">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
</body>

</html>