<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Chart Editor - Theme Selector</title>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s&libraries=places"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script type="text/javascript" src="d3.js"></script>
    <script type="text/javascript" src="d3.geo.projection.min.js"></script>
    <link rel="stylesheet" href="celestial.css">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css">

    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-datepicker/1.13.2/i18n/jquery.ui.datepicker-hu.min.js"></script>
    <script
        src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
    <script
        src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-hu.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-addon-i18n.min.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/save-svg-as-png/1.4.17/saveSvgAsPng.min.js"></script>
    <!-- <script src="fragment5_jo_uj_.js"></script>  -->
    <!-- <script src="fragment5_jo_alap.js"></script> -->
    <!-- <script src="fragment5_jo_copy_apply_refresh_imaget_ad_kisebb_cst_meret_jobb_felbontas.js"></script>  -->
    <!-- <script src="fragment5_themes.js"></script> -->
    <script src="fragment5_themes_e.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Allura&family=Cinzel:wght@400..900&family=Cormorant:ital,wght@0,300..700;1,300..700&family=Dancing+Script:wght@400..700&family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Great+Vibes&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Maven+Pro:wght@400..900&family=MedievalSharp&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Parisienne&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Quicksand:wght@300..700&family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Rye&family=Sacramento&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&family=Special+Elite&family=Tangerine:wght@400;700&family=Uncial+Antiqua&display=swap"
        rel="stylesheet">
    <style type="text/css">
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Space+Grotesk:wght@300;400;500;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap');

        /* --- LIQUID GLASS ENGINE VARIABLES (Onyx Theme - Dark) --- */
        :root {
            /* Onyx Liquid Glass Theme */
            --bg-color: #000000;
            --blob-1: #111111;
            --blob-2: #FFFFFF;
            --blob-3: #333333;

            --glass-surface: rgba(0, 0, 0, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);

            --text-main: #f0f0f0;
            --text-muted: #aaaaaa;
            --accent: #FFFFFF;
            --accent-gradient: linear-gradient(135deg, #FFFFFF 0%, #E0E0E0 100%);

            /* Card/Section backgrounds - these change with theme */
            --card-bg: rgba(40, 40, 40, 0.6);
            --card-bg-hover: rgba(60, 60, 60, 0.7);
            --card-bg-light: rgba(30, 30, 30, 0.6);
            --card-bg-medium: rgba(50, 50, 50, 0.7);
            --modal-bg: rgba(20, 20, 20, 0.95);

            /* Panel/Editor backgrounds */
            --panel-bg: rgba(0, 0, 0, 0.2);
            --panel-border: #444444;
            --divider-color: #444444;
            --text-dim: #888888;
            --text-bright: #ffffff;

            --radius-L: 24px;
            --radius-S: 12px;

            --font-head: 'Playfair Display', serif;
            --font-body: 'Montserrat', sans-serif;

            /* Legacy compatibility */
            --primary-bg: var(--bg-color);
            --secondary-bg: var(--glass-surface);
            --accent-blue: var(--accent);
            --accent-purple: #E0E0E0;
            --accent-cyan: #FFFFFF;
            --text-primary: var(--text-main);
            --text-secondary: var(--text-muted);
            --border-color: rgba(255, 255, 255, 0.1);
            --glow-blue: rgba(255, 255, 255, 0.2);
            --glow-purple: rgba(255, 255, 255, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background 1s ease;
        }

        /* --- LIQUID BACKGROUND (Morphing Blobs) --- */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.6;
        }

        .b1 {
            width: 600px;
            height: 600px;
            background: var(--blob-1);
            top: -100px;
            left: -100px;
            animation: morph 15s ease-in-out infinite alternate, float1 25s ease-in-out infinite;
        }

        .b2 {
            width: 500px;
            height: 500px;
            background: var(--blob-2);
            bottom: -50px;
            right: -50px;
            animation: morph 18s ease-in-out infinite alternate-reverse, float2 30s ease-in-out infinite;
        }

        .b3 {
            width: 300px;
            height: 300px;
            background: var(--blob-3);
            top: 40%;
            left: 40%;
            opacity: 0.4;
            animation: morph 12s ease-in-out infinite alternate, float3 20s ease-in-out infinite;
        }

        /* New blobs on the right side with random movement */
        .b4 {
            width: 400px;
            height: 400px;
            background: #444444;
            /* Gold */
            top: 10%;
            right: 5%;
            opacity: 0.5;
            animation: morph2 14s ease-in-out infinite alternate-reverse, floatRandom1 18s ease-in-out infinite;
        }

        .b5 {
            width: 250px;
            height: 250px;
            background: #666666;
            /* Sage green */
            top: 60%;
            right: 15%;
            opacity: 0.45;
            animation: morph 16s ease-in-out infinite alternate, floatRandom2 22s ease-in-out infinite;
        }

        @keyframes morph {
            0% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }

            25% {
                border-radius: 40% 60% 50% 50% / 40% 50% 60% 50%;
            }

            50% {
                border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
            }

            75% {
                border-radius: 50% 40% 60% 50% / 60% 40% 50% 40%;
            }

            100% {
                border-radius: 40% 60% 40% 60% / 60% 30% 70% 40%;
            }
        }

        @keyframes morph2 {
            0% {
                border-radius: 50% 50% 40% 60% / 40% 60% 50% 50%;
            }

            33% {
                border-radius: 60% 40% 60% 40% / 50% 50% 40% 60%;
            }

            66% {
                border-radius: 40% 60% 50% 50% / 60% 40% 60% 40%;
            }

            100% {
                border-radius: 55% 45% 45% 55% / 45% 55% 45% 55%;
            }
        }

        @keyframes float1 {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            25% {
                transform: translate(80px, 50px) rotate(5deg);
            }

            50% {
                transform: translate(40px, 100px) rotate(-3deg);
            }

            75% {
                transform: translate(100px, 30px) rotate(8deg);
            }
        }

        @keyframes float2 {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            25% {
                transform: translate(-60px, -40px) rotate(-5deg);
            }

            50% {
                transform: translate(-100px, 20px) rotate(3deg);
            }

            75% {
                transform: translate(-30px, -80px) rotate(-8deg);
            }
        }

        @keyframes float3 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(50px, -60px) scale(1.1);
            }

            50% {
                transform: translate(-40px, -30px) scale(0.95);
            }

            75% {
                transform: translate(30px, 50px) scale(1.05);
            }
        }

        /* Random floating animations for right side blobs */
        @keyframes floatRandom1 {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }

            10% {
                transform: translate(-30px, 40px) rotate(10deg) scale(1.05);
            }

            20% {
                transform: translate(50px, 80px) rotate(-5deg) scale(0.95);
            }

            30% {
                transform: translate(-60px, 20px) rotate(15deg) scale(1.1);
            }

            40% {
                transform: translate(40px, -50px) rotate(-10deg) scale(1);
            }

            50% {
                transform: translate(-20px, 100px) rotate(5deg) scale(1.08);
            }

            60% {
                transform: translate(70px, 30px) rotate(-15deg) scale(0.92);
            }

            70% {
                transform: translate(-50px, -40px) rotate(8deg) scale(1.05);
            }

            80% {
                transform: translate(30px, 60px) rotate(-8deg) scale(1);
            }

            90% {
                transform: translate(-40px, -20px) rotate(12deg) scale(1.03);
            }
        }

        @keyframes floatRandom2 {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }

            12% {
                transform: translate(60px, -30px) rotate(-12deg) scale(1.08);
            }

            24% {
                transform: translate(-40px, 70px) rotate(8deg) scale(0.9);
            }

            36% {
                transform: translate(80px, 40px) rotate(-18deg) scale(1.12);
            }

            48% {
                transform: translate(-70px, -50px) rotate(15deg) scale(0.95);
            }

            60% {
                transform: translate(30px, 90px) rotate(-8deg) scale(1.05);
            }

            72% {
                transform: translate(-50px, 20px) rotate(20deg) scale(1.1);
            }

            84% {
                transform: translate(45px, -60px) rotate(-15deg) scale(0.98);
            }
        }

        /* --- FŐ LAYOUT (Liquid Glass) --- */
        .layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            position: relative;
            z-index: 1;
            padding: 20px;
            gap: 20px;
        }

        /* Desktop layout */
        @media (min-width: 769px) {
            .layout {
                flex-direction: row;
            }

            .mapwrap {
                flex: 0 0 65%;
                position: relative;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                background: var(--glass-surface);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: var(--radius-L);
                border: 1px solid var(--glass-border);
                border-top: 1px solid var(--glass-highlight);
                border-left: 1px solid var(--glass-highlight);
                box-shadow: var(--glass-shadow);
            }

            .settingswrap {
                flex: 0 0 calc(35% - 20px);
                background: var(--glass-surface);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: var(--radius-L);
                border: 1px solid var(--glass-border);
                border-top: 1px solid var(--glass-highlight);
                border-left: 1px solid var(--glass-highlight);
                box-shadow: var(--glass-shadow);
                overflow-y: auto;
                padding: 24px;
            }
        }

        /* Mobile layout */
        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }

            .mapwrap {
                flex: 1;
                position: relative;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                background: var(--glass-surface);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: var(--radius-L);
                border: 1px solid var(--glass-border);
                box-shadow: var(--glass-shadow);
            }

            .settingswrap {
                height: 45vh;
                background: var(--glass-surface);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: var(--radius-L);
                border: 1px solid var(--glass-border);
                box-shadow: var(--glass-shadow);
                overflow-y: auto;
                padding: 16px;
            }
        }

        .map {
            width: auto;
            height: auto;
            position: relative;
        }

        .map::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        /* --- GÖRGETŐSÁV (Liquid Glass Style) --- */
        .settingswrap::-webkit-scrollbar {
            width: 6px;
        }

        .settingswrap::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .settingswrap::-webkit-scrollbar-thumb {
            background: var(--accent-gradient);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.15);
        }

        .settingswrap::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #FFFFFF, #E0E0E0);
        }

        /* Hide scrollbar but keep functionality */
        .settingswrap {
            /*            scrollbar-width: thin;*/
            /*            scrollbar-color: var(--accent) transparent;*/
        }

        /* --- FÜLEK (TABS) - Liquid Glass Style --- */
        #tabs,
        #tabs_r,
        #tabss {
            border: none;
            background: transparent;
        }

        /* Közös alapstílus (PC és Mobil is) */
        #mobile_tabs,
        #mobile_tabs_r {
            display: flex;
            gap: 8px;
            padding: 8px;
            list-style: none !important;
            border: none;
            background: var(--card-bg-light);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.3), inset -2px -2px 5px rgba(255, 255, 255, 0.05);
        }

        /* Gombok alapstílusa */
        #mobile_tabs li a,
        #mobile_tabs_r li a {
            display: block;
            padding: 10px 18px;
            text-align: center;
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 12px;
            border-radius: 50px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            background: transparent;
        }

        #mobile_tabs li a:hover,
        #mobile_tabs_r li a:hover {
            background: var(--card-bg);
            color: var(--text-main);
        }

        /* Aktív állapot */
        #mobile_tabs li.ui-tabs-active a,
        #mobile_tabs_r li.ui-tabs-active a {
            background: var(--accent-gradient);
            color: #000000;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* --- PC NÉZET (769px-től) --- */
        @media (min-width: 769px) {

            #mobile_tabs,
            #mobile_tabs_r {
                flex-wrap: wrap;
                justify-content: center;
            }

            #mobile_tabs li,
            #mobile_tabs_r li {
                flex: 1 0 auto;
            }
        }

        /* --- MOBIL NÉZET (768px-ig) --- */
        @media (max-width: 768px) {

            #mobile_tabs,
            #mobile_tabs_r {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start !important;
                width: 100% !important;
                max-width: 100vw !important;
                padding: 8px !important;
                gap: 6px !important;
                scrollbar-width: none;
                -ms-overflow-style: none;
                border-radius: 20px;
            }

            #mobile_tabs::-webkit-scrollbar,
            #mobile_tabs_r::-webkit-scrollbar {
                display: none;
            }

            #mobile_tabs li,
            #mobile_tabs_r li {
                flex: 0 0 auto !important;
                width: auto !important;
                float: none !important;
                margin: 0 !important;
                display: block !important;
            }

            #mobile_tabs li a,
            #mobile_tabs_r li a {
                display: block !important;
                padding: 10px 14px !important;
                font-size: 12px !important;
                line-height: normal !important;
                white-space: nowrap !important;
                text-overflow: clip !important;
                text-align: center;
                text-decoration: none;
                color: var(--text-muted);
                font-weight: 500;
                border-radius: 50px;
                background: transparent;
            }

            #mobile_tabs li.ui-tabs-active a,
            #mobile_tabs_r li.ui-tabs-active a {
                background: var(--accent-gradient) !important;
                color: #000000 !important;
                font-weight: 600 !important;
                box-shadow: 0 4px 12px rgba(139, 95, 101, 0.4);
            }
        }

        /* Panel tartalom */
        .ui-tabs-panel {
            padding: 10px !important;
            overflow-y: visible;
            flex: 1;
            border: none;
            background: transparent;
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- CÍMSOROK ÉS EGYÉB (Liquid Glass) --- */
        h2 {
            font-family: var(--font-head);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 16px;
            position: relative;
            padding-left: 0;
        }

        h2::before {
            display: none;
        }

        h3.small {
            font-family: var(--font-head);
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin: 20px 0 12px 0;
            letter-spacing: 0.5px;
        }

        /* Collapsible Header - Liquid Card Style */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px 20px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .collapsible-header:hover {
            background: var(--card-bg-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .collapsible-header h2 {
            margin: 0;
            font-size: 14px;
            font-family: var(--font-head);
            padding-left: 0;
            color: var(--text-main);
        }

        .collapsible-header h2::before {
            display: none;
        }

        .collapsible-icon {
            font-size: 16px;
            color: var(--accent);
            display: flex;
            flex: 1 1 0%;
            place-content: flex-end;
        }

        .collapsible-icon-icon {
            transition: transform 0.3s ease;
            display: inline-block;
            transform: rotate(0deg);
        }

        .collapsible-header.collapsed .collapsible-icon-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* Section - Liquid Card Style */
        .section {
            background: var(--card-bg-light);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .section:hover {
            background: var(--card-bg-medium);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        }

        /* Override inline styles for gradient editor panels */
        [id*="gradient-editor-panel"],
        #bleed-gradient-editor-panel {
            background: var(--panel-bg) !important;
            border-color: var(--panel-border) !important;
        }

        /* Override inline styles for collapsible headers with background:#333 */
        .collapsible-header[onclick*="togglePresetList"] {
            background: var(--card-bg) !important;
        }

        /* Override inline divider/border colors */
        [style*="border-bottom:1px solid #444"],
        [style*="border-top:1px solid #444"],
        [style*="border: 1px solid #444"] {
            border-color: var(--panel-border) !important;
        }

        /* Override dim text colors */
        [style*="color:#ccc"],
        [style*="color: #ccc"] {
            color: var(--text-muted) !important;
        }

        [style*="color:#888"],
        [style*="color: #888"] {
            color: var(--text-dim) !important;
        }

        [style*="color:white"],
        [style*="color: white"] {
            color: var(--text-bright) !important;
        }

        /* Container backgrounds */
        #bg-presets-container {
            border-color: var(--panel-border) !important;
        }

        /* Mask/Shape option buttons */
        .mask-option {
            background: var(--card-bg) !important;
            border-color: var(--panel-border) !important;
        }

        .mask-option.selected {
            border-color: var(--accent) !important;
        }

        /* Icon buttons in tool panels */
        [onclick*="setCommonMask"],
        [onclick*="setCropMode"] {
            background: var(--card-bg) !important;
        }

        .setting-group {
            margin-bottom: 16px;
        }

        /* Labels - Liquid Style */
        label {
            display: block;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        label:has(input[type="checkbox"]) {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px 15px;
            border-radius: 12px;
            background: var(--card-bg-light);
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            text-transform: none;
            font-weight: 500;
            font-size: 13px;
        }

        label:has(input[type="checkbox"]):hover {
            background: var(--card-bg);
        }

        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        input[type="checkbox"]:checked {
            background: var(--accent-gradient);
            border-color: var(--accent);
        }

        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Inputs - Jelly/Liquid Style */
        input[type=text],
        select,
        input[type=number],
        textarea {
            width: 100%;
            padding: 12px 20px;
            border-radius: 50px;
            border: none;
            background: var(--card-bg);
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.3), inset -2px -2px 5px rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: 500;
            outline: none;
            transition: all 0.3s ease;
        }

        input[type=text]:focus,
        select:focus,
        input[type=number]:focus,
        textarea:focus {
            background: white;
            box-shadow: 0 0 0 3px var(--accent);
        }

        textarea {
            border-radius: 16px;
        }

        input[type=color] {
            width: 100%;
            height: 45px;
            border-radius: 12px;
            border: none;
            background: var(--card-bg);
            cursor: pointer;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Sliders - Droplet Style */
        input[type=range] {
            width: 100%;
            height: 6px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.1);
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.3);
        }

        /* --- DateTimePicker - Liquid Glass Style --- */
        #ui-datepicker-div {
            background: var(--modal-bg) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 20px !important;
            color: var(--text-main) !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2) !important;
            z-index: 10000 !important;
            font-family: var(--font-body) !important;
            overflow: hidden;
        }

        .ui-datepicker-header {
            background: var(--card-bg) !important;
            border: none !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
            color: var(--text-main) !important;
            padding: 15px !important;
        }

        .ui-datepicker-title {
            color: var(--text-main) !important;
            font-weight: 600;
            font-family: var(--font-head) !important;
        }

        .ui-datepicker-prev,
        .ui-datepicker-next {
            background: rgba(255, 255, 255, 0.05) !important;
            border: none !important;
            cursor: pointer;
            top: 12px !important;
            border-radius: 50% !important;
            width: 30px !important;
            height: 30px !important;
        }

        .ui-datepicker-prev:hover,
        .ui-datepicker-next:hover {
            background: var(--accent) !important;
        }

        .ui-datepicker-prev span,
        .ui-datepicker-next span {
            filter: none;
        }

        .ui-datepicker-calendar th {
            color: var(--accent) !important;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }

        .ui-state-default,
        .ui-widget-content .ui-state-default {
            background: var(--card-bg) !important;
            border: 1px solid rgba(0, 0, 0, 0.05) !important;
            color: var(--text-muted) !important;
            text-align: center;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        }

        .ui-state-highlight,
        .ui-widget-content .ui-state-highlight {
            background: var(--accent) !important;
            color: white !important;
            border: 1px solid var(--accent) !important;
            font-weight: bold;
        }

        .ui-state-active,
        .ui-widget-content .ui-state-active {
            background: var(--accent-gradient) !important;
            color: #000000 !important;
            border: 1px solid var(--accent) !important;
        }

        .ui-state-hover,
        .ui-widget-content .ui-state-hover {
            background: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-main) !important;
        }

        /* Időválasztó csúszkák */
        .ui-timepicker-div {
            padding: 15px !important;
            border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
        }

        .ui-timepicker-div .ui-widget-header {
            margin-bottom: 8px;
            background: transparent !important;
            border: none !important;
            color: var(--accent);
            font-size: 12px;
            font-weight: bold;
        }

        .ui-timepicker-div dl {
            display: block;
        }

        .ui-timepicker-div dl dt {
            float: left;
            clear: left;
            width: 50px;
            padding: 5px 0;
            margin: 0;
            color: var(--text-muted);
        }

        .ui-timepicker-div dl dd {
            margin: 0 10px 10px 60px;
            padding-top: 5px;
        }

        .ui-timepicker-div .ui-slider {
            background: rgba(0, 0, 0, 0.1) !important;
            border: none !important;
            height: 6px !important;
            border-radius: 10px;
            position: relative;
            top: 2px;
        }

        .ui-timepicker-div .ui-slider .ui-slider-handle {
            background: var(--accent) !important;
            border: 2px solid white !important;
            width: 16px !important;
            height: 16px !important;
            border-radius: 50%;
            top: -6px !important;
            margin-left: -8px !important;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }

        .ui-datepicker-buttonpane {
            border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
            padding: 10px 15px !important;
            margin-top: 5px !important;
            text-align: right;
        }

        .ui-datepicker-buttonpane button {
            background: var(--accent-gradient) !important;
            border: none !important;
            color: white !important;
            font-weight: 600;
            border-radius: 50px !important;
            padding: 10px 20px !important;
            margin: 2px 0 2px 5px !important;
            cursor: pointer;
            opacity: 1 !important;
            float: none !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .ui-datepicker-buttonpane button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2) !important;
        }

        /* Gombok - Liquid Glass Style */
        button,
        .add-btn {
            padding: 14px 20px;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Primary Button - Glassy Gradient */
        .add-btn.primary,
        button.primary {
            background: var(--accent-gradient);
            color: #000000;
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.15);
        }

        .add-btn.primary:hover,
        button.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(255, 255, 255, 0.25);
        }

        /* Shine effect on hover */
        .add-btn.primary::after,
        button.primary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg) translate(-100%, -100%);
            transition: 0.5s;
        }

        .add-btn.primary:hover::after,
        button.primary:hover::after {
            transform: rotate(45deg) translate(100%, 100%);
        }

        /* Secondary Button */
        .add-btn.secondary,
        button.secondary {
            background: var(--card-bg);
            color: var(--text-main);
            border: 1px solid var(--accent);
            box-shadow: none;
        }

        .add-btn.secondary:hover,
        button.secondary:hover {
            background: var(--accent);
            color: white;
        }

        .add-btn.accent,
        button.accent {
            background: var(--accent-gradient);
            color: #000000;
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.15);
        }

        .export-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .export-btns button {
            background: var(--accent-gradient);
            color: #000000;
            padding: 14px 8px;
            width: 100%;
            font-size: 11px;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
        }

        .export-btns button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
        }

        .grid-2-cols {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        /* --- SABLON RÁCS - Liquid Glass Style --- */
        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .theme-item {
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            background: var(--card-bg-medium);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .theme-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: var(--accent);
        }

        .theme-item.active-theme {
            border: 2px solid var(--accent);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.15);
        }

        .theme-btn {
            width: 100%;
            padding: 12px;
            border: none;
            font-weight: 600;
            text-align: center;
            background: var(--card-bg-hover);
            color: var(--text-main);
            font-size: 12px;
            font-family: var(--font-head);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .theme-preview-img {
            width: 100%;
            height: 180px;
            background-size: contain !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
        }

        /* --- TERVEZŐ NÉZET - Liquid Glass Style --- */
        #full-screen-designer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-color);
            z-index: 9999;
            display: none;
            flex-direction: row;
        }

        #designer-content-wrapper {
            display: flex;
            height: 100%;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        #designer-canvas-area {
            flex: 0 0 65%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-L);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight);
            border-left: 1px solid var(--glass-highlight);
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }

        #canvas-wrapper {
            background: transparent;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, height 0.3s ease;
            transform-origin: center center;
            position: relative;
            z-index: 2;
        }

        /* Bleed Preview Background - positioned BEHIND canvas-wrapper */
        #bleed-preview-bg {
            position: absolute;
            display: none;
            z-index: 1;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        #canvas-container,
        #celestial-map-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #designer-svg,
        #text-overlay-svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        #designer-svg {
            display: block;
            width: 100%;
            height: 100%;
            /* ÚJ ALAPÉRTELMEZETT HÁTTÉR */
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
        }

        #designer-controls {
            flex: 1;
            padding: 6px;
            overflow-y: auto;
        }

        .designer-controls {
            flex: 1;
            padding: 6px;
            overflow-y: auto;
        }

        /* --- MOBIL NÉZET BEÁLLÍTÁSOK - Liquid Glass --- */
        @media (max-width: 768px) {
            #full-screen-designer {
                height: 100vh;
                overflow: hidden;
            }

            #designer-content-wrapper {
                flex-direction: column;
                width: 100%;
                height: 100%;
                padding: 10px;
                gap: 10px;
            }

            #designer-canvas-area {
                flex: 0 0 50%;
                width: 100%;
                height: 50%;
                padding: 10px;
                border-radius: 20px;
            }

            #settings-wrap {
                width: 100%;
                flex: 1;
                padding: 10px;
                border-radius: 20px;
            }

            #settings-wrap_r {
                width: 100%;
                flex: 1;
                padding: 10px;
                border-radius: 20px;
            }

            .export-btns {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Cropper & Modal - Liquid Glass Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--modal-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .img-container {
            max-height: 60vh;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 16px;
        }

        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
        }

        .text-mode-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: var(--card-bg);
            padding: 6px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .text-mode-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .text-mode-tab:hover {
            background: var(--card-bg);
        }

        .text-mode-tab.active {
            background: var(--accent-gradient);
            color: #000000;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        .block-card {
            background: var(--card-bg-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .block-card:hover {
            background: var(--card-bg-medium);
        }

        .block-card.inline {
            border-left: 3px solid var(--accent);
            margin-left: 20px;
        }

        .remove-block {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-block:hover {
            background: #ff4444;
            color: white;
        }

        .settingswrap::-webkit-scrollbar,
        .theme-grid::-webkit-scrollbar,
        .designer-controls::-webkit-scrollbar,
        #photo-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .settingswrap::-webkit-scrollbar-track,
        .theme-grid::-webkit-scrollbar-track,
        .designer-controls::-webkit-scrollbar-track,
        #photo-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .settingswrap::-webkit-scrollbar-thumb,
        .theme-grid::-webkit-scrollbar-thumb,
        .designer-controls::-webkit-scrollbar-thumb,
        #photo-list-container::-webkit-scrollbar-thumb {
            background: var(--accent-gradient);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.15);
        }

        .settingswrap::-webkit-scrollbar-thumb:hover,
        .theme-grid::-webkit-scrollbar-thumb:hover,
        .designer-controls::-webkit-scrollbar-thumb:hover,
        #photo-list-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #FFFFFF, #E0E0E0);
        }

        /* Okospont specifikus stílusok - Liquid Glass */
        .smart-point-container {
            padding: 10px;
        }

        .sp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sp-list-item {
            background: var(--card-bg-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .sp-list-item:hover {
            background: var(--card-bg-medium);
            transform: translateX(3px);
        }

        .sp-list-item.editing {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
        }

        .sp-list-item.selected-move {
            border: 2px dashed #888888;
            background: rgba(136, 136, 136, 0.1);
        }

        .sp-icon {
            font-size: 16px;
            margin-right: 10px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-gradient);
            color: #000000;
            border-radius: 50%;
            font-size: 11px;
        }

        .sp-info {
            flex-grow: 1;
        }

        .sp-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-main);
        }

        .sp-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .sp-actions {
            display: flex;
            gap: 5px;
        }

        .sp-type-btn {
            text-align: left;
            margin-bottom: 5px;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 15px;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        .sp-type-btn:hover {
            background: var(--card-bg-medium);
        }

        .sp-type-btn.active {
            background: var(--accent-gradient);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.15);
        }

        /* Egyedi Alert Stílus - Liquid Glass */
        #custom-sp-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            padding: 30px;
            border-radius: 20px;
            background: var(--modal-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-main);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            display: none;
            text-align: center;
            min-width: 320px;
        }

        #custom-sp-alert.success {
            border-color: #4caf50;
        }

        #custom-sp-alert p {
            margin-bottom: 20px;
            font-weight: 600;
            font-family: var(--font-head);
        }

        /* Animáció a lenyíláshoz */
        .collapse-content {
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapse-content.show {
            display: block;
        }

        /* --- Google Autocomplete - Liquid Glass Style --- */
        .pac-container {
            z-index: 20000 !important;
            font-family: var(--font-body);
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: var(--modal-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            margin-top: 5px;
            overflow: hidden;
        }

        .pac-item {
            color: var(--text-muted);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding: 12px 15px;
            transition: all 0.2s ease;
        }

        .pac-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .pac-item-query {
            color: var(--text-main);
            font-weight: 600;
        }

        /* --- GRADIENS SZERKESZTŐ - Liquid Glass Style --- */
        .grad-stop-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg-light);
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .grad-stop-row:hover {
            background: var(--card-bg-medium);
            border-color: var(--accent);
        }

        /* Színválasztó Input Szépítése */
        .grad-stop-input {
            flex: 1;
            height: 36px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
        }

        /* Chrome/Edge specifikus */
        .grad-stop-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .grad-stop-input::-webkit-color-swatch {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Törlés gomb */
        .grad-remove-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .grad-remove-btn:hover {
            background: #ff4444;
            color: white;
            transform: scale(1.1);
        }

        /* --- MODERN KAPCSOLÓ (SWITCH) - Liquid Glass Style --- */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        /* Az eredeti checkbox elrejtése */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* A csúszka sínje - Liquid Style */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.1);
            -webkit-transition: .4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transition: .4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-radius: 50px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* A csúszka gombja (kör) - Bouncy effect */
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transition: .4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Bekapcsolt állapot */
        input:checked+.slider {
            background: var(--accent);
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(22px);
            -ms-transform: translateX(22px);
            transform: translateX(22px);
        }

        /* Liquid Switch (alternatív stílus) */
        .liquid-switch {
            width: 50px;
            height: 28px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50px;
            position: relative;
            transition: 0.3s;
            cursor: pointer;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .liquid-switch::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        input:checked+.liquid-switch {
            background: var(--accent);
        }

        input:checked+.liquid-switch::after {
            left: 26px;
        }

        /* Gradiens százalék input stílusa - Liquid */
        .grad-stop-percent {
            width: 25% !important;
            height: 36px;
            background: var(--card-bg);
            border: none;
            border-radius: 50px;
            color: var(--text-main);
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Color Dots - Liquid Style */
        .dots-row {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .l-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .l-dot:hover,
        .l-dot.active {
            transform: scale(1.2);
            border-color: var(--text-main);
        }

        /* Check Row - Liquid Style */
        .l-check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .l-check-row:last-child {
            border-bottom: none;
        }

        /* Card Title with Icon - Liquid Style */
        .lc-title {
            font-family: var(--font-head);
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .lc-icon {
            width: 30px;
            height: 30px;
            background: var(--accent-gradient);
            color: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.15);
        }

        /* --- FLOATING THEME SELECTOR --- */
        .theme-fab {
            position: fixed;
            top: 30px;
            left: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-surface);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: var(--text-main);
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 9000;
        }

        .theme-fab:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
        }

        .theme-panel {
            position: fixed;
            top: 90px;
            left: 30px;
            width: 320px;
            max-height: 70vh;
            background: var(--glass-surface);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 8999;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }

        .theme-panel.active {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0) scale(1);
        }

        .theme-panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .theme-panel-header h3 {
            margin: 0;
            font-family: var(--font-head);
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .theme-panel-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .theme-panel-close:hover {
            color: var(--text-main);
        }

        /* Custom Color Picker Section */
        .custom-colors-section {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-colors-section h4 {
            margin: 0 0 12px 0;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .color-picker-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-picker-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .color-picker-item label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .color-picker-item input[type="color"] {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .color-picker-item input[type="color"]:hover {
            transform: scale(1.1);
        }

        .color-picker-item input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker-item input[type="color"]::-webkit-color-swatch {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        /* Theme Grid */
        .theme-grid-scroll {
            max-height: calc(70vh - 200px);
            overflow-y: auto;
            padding: 15px;
        }

        .theme-grid-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .theme-grid-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .theme-grid-scroll::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }

        .theme-category {
            margin-bottom: 15px;
        }

        .theme-category-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .theme-grid-mini {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .theme-card-mini {
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .theme-card-mini:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .theme-card-mini.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .theme-card-mini .t-bar {
            height: 30px;
            display: flex;
        }

        .theme-card-mini .t-b-main {
            flex: 6;
        }

        .theme-card-mini .t-b-sec {
            flex: 3;
        }

        .theme-card-mini .t-b-acc {
            flex: 1;
        }

        .theme-card-mini .t-label {
            padding: 5px;
            text-align: center;
            font-weight: 600;
            font-size: 0.55rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Apply Button */
        .apply-custom-btn {
            width: calc(100% - 40px);
            margin: 10px 20px 15px;
            padding: 12px;
            border: none;
            border-radius: 50px;
            background: var(--accent-gradient);
            color: #000;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .apply-custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* Full Screen Preview Styles */
        #fs-preview-modal {
            backdrop-filter: blur(5px);
        }

        #fs-content-container.panning {
            cursor: grabbing !important;
        }
    </style>
</head>

<body>
    <!-- Liquid Glass Background -->
    <div class="liquid-bg">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
        <div class="blob b4"></div>
        <div class="blob b5"></div>
    </div>

    <!-- Floating Theme Selector -->
    <div class="theme-fab" onclick="toggleThemePanel()" title="Theme Selector">
        <i class="fas fa-palette"></i>
    </div>

    <div class="theme-panel" id="themePanel">
        <div class="theme-panel-header">
            <h3><i class="fas fa-swatchbook"></i> Téma Választó</h3>
            <button class="theme-panel-close" onclick="toggleThemePanel()"><i class="fas fa-times"></i></button>
        </div>

        <!-- Custom Color Pickers -->
        <div class="custom-colors-section">
            <h4><i class="fas fa-sliders-h"></i> Egyedi Színek</h4>
            <div class="color-picker-row">
                <div class="color-picker-item">
                    <input type="color" id="customBgColor" value="#000000" onchange="updateCustomColor()">
                    <label>Háttér</label>
                </div>
                <div class="color-picker-item">
                    <input type="color" id="customBlobColor" value="#111111" onchange="updateCustomColor()">
                    <label>Folt</label>
                </div>
                <div class="color-picker-item">
                    <input type="color" id="customAccentColor" value="#FFFFFF" onchange="updateCustomColor()">
                    <label>Kiemelés</label>
                </div>
            </div>
            <button class="apply-custom-btn" onclick="applyCustomColors()">
                <i class="fas fa-magic"></i> Alkalmazás
            </button>
        </div>

        <!-- Theme Grid -->
        <div class="theme-grid-scroll" id="themeGridScroll">
            <!-- Themes will be injected here by JavaScript -->
        </div>
    </div>

    <div id="full-screen-designer">
        <div id="designer-content-wrapper">

            <div id="designer-canvas-area">
                <!-- Bleed preview background - positioned behind canvas-wrapper -->
                <div id="bleed-preview-bg"></div>
                <div id="canvas-wrapper">
                    <div id="canvas-container celestial-map-container">
                        <svg id="designer-svg" viewBox="0 0 1026 1272" preserveAspectRatio="xMidYMid meet"
                            xmlns="http://www.w3.org/2000/svg" style="background-color: #0a0e27;">
                            <defs>
                                <clipPath id="photo-circle-clip">
                                    <circle id="photo-clip-circle" cx="500" cy="500" r="500" />
                                </clipPath>
                            </defs>

                            <g id="photo-transform-group" style="display:none;">
                                <image id="user-photo-img" width="1000" height="1000"
                                    preserveAspectRatio="xMidYMid slice" clip-path="url(#photo-circle-clip)" />
                            </g>

                            <g id="map-transform-group">
                                <g id="celestial-map-layer"></g>
                            </g>

                            <g id="text-layer"></g>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="settingswrap" id="settings-wrap_r">
                <div id="tabs_r">
                    <ul id="mobile_tabs_r">
                        <li><a href="#fragment_r-1">Vászon</a></li>
                        <li><a href="#fragment_r-2">Kép</a></li>
                        <li><a href="#fragment_r-3">Szövegek</a></li>
                        <li><a href="#fragment_r-4">Kép +</a></li>
                        <li><a href="#fragment_r-5">Sablonok</a></li>
                        <li><a href="#fragment_r-6">Csillagtérkép szerkesztő</a></li>
                        <li><a href="#fragment_r-7">OkosPont +</a></li>
                        <li><a href="#fragment_r-8">Nézet</a></li>
                    </ul>
                    <div id="fragment_r-1">
                        <div class="designer-controls">

                            <!-- 1. VÁSZON BEÁLLÍTÁSOK (Összecsukható) -->
                            <div class="collapsible-header" data-target="canvas-settings-panel">
                                <h2 style="margin:0; font-size:14px;">VÁSZON BEÁLLÍTÁSOK</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                            </div>

                            <div class="collapsible-content" id="canvas-settings-panel">
                                <div class="section" style="margin-top: 0; margin-bottom: 10px;">
                                    <div class="setting-group">
                                        <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="aspect-ratio-lock"
                                                onchange="toggleResizeLock(this)" checked>
                                            <span>🔒 Képarány és Térkép rögzítése</span>
                                        </label>
                                    </div>

                                    <div class="grid-2-cols">
                                        <div class="setting-group" style="margin-bottom: 6px">
                                            <label>Szélesség (cm):</label>
                                            <input type="number" id="canvas-width" value="21" step="0.1"
                                                oninput="handleCanvasParamChange('width', this.value)">
                                        </div>
                                        <div class="setting-group" style="margin-bottom: 6px">
                                            <label>Magasság (cm):</label>
                                            <input type="number" id="canvas-height" value="30" step="0.1"
                                                oninput="handleCanvasParamChange('height', this.value)">
                                        </div>
                                    </div>

                                    <!-- <div class="setting-group" style="margin-bottom: 5px; display: flex; gap: 5%;">
                                      <div style="display: flex;flex: 1;flex-direction: column; justify-content: space-between;">
                                        <label style="display: flex; flex: 1; align-items: flex-end;" for="canvas-bg-color">Háttérszín:</label>
                                        <input type="color" id="canvas-bg-color" value="#0a0e27" oninput="window.updateCanvasBackground(this.value)">
                                      </div>
                                        <div style="display: flex;flex: 1;flex-direction: column;;">
                                        <label>Falad színe (Szimuláció):</label>
                                            <input type="color" id="wall-bg-color" value="#BABABA" 
                                                   oninput="updateWallColor(this.value)">
                                        </div>
                                    </div> -->
                                    <!-- <div class="setting-group" style="margin-bottom: 5px; display: flex; gap: 5%;">
                                      <div style="display: flex; flex: 1; flex-direction: column; justify-content: space-between;">
                                        <label style="display: flex; flex: 1; align-items: flex-end;">Háttér (Szín vagy Gradiens):</label>
                                        <div style="display: flex; gap: 5px; align-items: center;">
                                            <input type="text" id="canvas-bg-text" 
                                                   value="linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%)" 
                                                   onchange="window.updateCanvasBackground(this.value)" 
                                                   style="flex: 1; font-size: 11px;">
                                            
                                            <input type="color" id="canvas-bg-color" value="#0a0e27" 
                                                   oninput="document.getElementById('canvas-bg-text').value = this.value; window.updateCanvasBackground(this.value);" 
                                                   style="width: 30px; padding: 0; border: none;">
                                        </div>
                                      </div>
                                        <div style="display: flex; flex: 1; flex-direction: column;">
                                        <label>Falad színe (Szimuláció):</label>
                                            <input type="color" id="wall-bg-color" value="#BABABA" 
                                                   oninput="updateWallColor(this.value)">
                                        </div>
                                    </div> -->
                                    <!-- <div class="section" style="margin-top: 10px; margin-bottom: 5px;">
                                        <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">HÁTTÉR STÍLUS</h3>
                                        
                                        <div id="bg-presets-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px;">
                                            </div>

                                        <div style="display: flex; align-items: center; gap: 10px; font-size: 11px; color: #aaa;">
                                            <label>Egyéni szín:</label>
                                            <input type="color" id="canvas-bg-color" value="#0a0e27" 
                                                   oninput="window.updateCanvasBackground(this.value)" 
                                                   style="width: 40px; height: 25px; border: none; padding: 0; cursor: pointer;">
                                            <span>(Vagy válassz a fenti listából)</span>
                                        </div>

                                        <div style="display: flex; flex: 1; flex-direction: column;">
                                        <label>Falad színe (Szimuláció):</label>
                                            <input type="color" id="wall-bg-color" value="#BABABA" 
                                                   oninput="updateWallColor(this.value)">
                                        </div>
                                    </div> -->

                                    <!-- <div class="section" style="margin-top: 10px; margin-bottom: 5px;">
                                        <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">HÁTTÉR ÉS FAL</h3>

                                        <div class="setting-group" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                            < ! - - <div id="simple-bg-container" style="flex: 1;">
                                                <label style="font-size:11px; display:block; margin-bottom:3px;">Háttérszín:</label>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="color" id="canvas-simple-color" value="#0a0e27" 
                                                           oninput="window.applySolidColor(this.value)" 
                                                           style="width: 100%; height: 30px; border: 1px solid #444; padding: 0; cursor: pointer;">
                                                </div>
                                            </div> - - >
                                            < ! - - <div class="setting-group" style="margin-bottom: 5px; display: flex; gap: 5%;"> - - >
                                              <div id="simple-bg-container" style="display: flex;flex: 1;flex-direction: column; justify-content: space-between;">
                                                <label style="display: flex; flex: 1; align-items: flex-end;" for="canvas-bg-color">Háttérszín:</label>
                                                <input type="color" id="canvas-bg-color" value="#0a0e27" oninput="window.updateCanvasBackground(this.value);window.applySolidColor(this.value)">
                                              </div>
                                                <div style="display: flex;flex: 1;flex-direction: column;;">
                                                <label>Falad színe (Szimuláció):</label>
                                                    <input type="color" id="wall-bg-color" value="#BABABA" 
                                                           oninput="updateWallColor(this.value)">
                                                </div>
                                            < ! - - </div> - - >
                                           < ! - -  <div style="flex: 1;">
                                                <label style="font-size:11px; display:block; margin-bottom:3px;">Fal színe (Szimuláció):</label>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="color" id="wall-bg-color" value="#BABABA" 
                                                           oninput="updateWallColor(this.value)"
                                                           style="width: 100%; height: 30px; border: 1px solid #444; padding: 0; cursor: pointer;">
                                                </div>
                                            </div> - - >
                                        </div>

                                        <div class="setting-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                            <label class="switch" style="position: relative; display: inline-block; width: 34px; height: 18px;">
                                                <input type="checkbox" id="gradient-toggle" onchange="window.toggleGradientEditor(this.checked)">
                                                <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                                                <style>.slider.round:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--accent-blue); } input:checked + .slider:before { transform: translateX(16px); }</style>
                                            </label>
                                            <span style="font-size: 12px; font-weight: bold;">Többszínű háttér (Gradiens)</span>
                                        </div>

                                        <div id="gradient-editor-panel" style="display: none; padding: 10px; border: 1px solid #444; border-radius: 5px; background: rgba(0,0,0,0.2); margin-bottom: 10px;">
                                            
                                            <div style="margin-bottom: 10px;">
                                                <div style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:3px;">
                                                    <label>Dőlésszög:</label>
                                                    <span id="grad-angle-val">135°</span>
                                                </div>
                                                <input type="range" id="grad-angle-range" min="0" max="360" value="135" 
                                                       oninput="window.updateGradientFromEditor()" style="width:100%;">
                                            </div>

                                            <div style="font-size:11px; color:#aaa; margin-bottom:5px;">Színek sorrendje:</div>
                                            <div id="grad-stops-list" style="display:flex; flex-direction:column; gap:5px; margin-bottom:10px;">
                                                </div>

                                            <button class="add-btn secondary" style="width:100%; padding:5px; font-size:11px;" onclick="window.addGradientStop()">
                                                + Szín hozzáadása
                                            </button>
                                        </div>

                                        <div class="collapsible-header" onclick="window.togglePresetList()" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; background:#333; padding:8px; border-radius:4px; margin-bottom:5px;">
                                            <span style="font-size:12px; font-weight:bold;">🎨 Háttér Sablonok</span>
                                            <span id="preset-arrow">▼</span>
                                        </div>
                                        
                                        <div id="bg-presets-container" style="display: none; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 10px; border: 1px solid #333; border-top:none;">
                                        </div>
                                    </div> -->
                                    <!-- <div class="section" style="margin-top: 10px; margin-bottom: 5px;">
                                        <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">HÁTTÉR ÉS FAL</h3>

                                        < ! - - <div class="setting-group" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;"> - - >
                                            < ! - - <div id="simple-bg-container" style="flex: 1;">
                                                <label style="font-size:11px; display:block; margin-bottom:3px;">Háttérszín:</label>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="color" id="canvas-simple-color" value="#0a0e27" 
                                                           oninput="window.applySolidColor(this.value)" 
                                                           style="width: 100%;  border: 1px solid #444; border-radius:6px; padding: 0; cursor: pointer;">
                                                </div>
                                            </div>

                                            <div style="flex: 1;">
                                                <label style="font-size:11px; display:block; margin-bottom:3px;">Fal színe (Szimuláció):</label>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="color" id="wall-bg-color" value="#BABABA" 
                                                           oninput="updateWallColor(this.value)"
                                                           style="width: 100%;  border: 1px solid #444; border-radius:6px; padding: 0; cursor: pointer;">
                                                </div>
                                            </div> - - >
                                            <div class="setting-group" style="margin-bottom: 5px; display: flex; gap: 5%;">
                                                <div id="simple-bg-container" style="flex: 1; display: flex; flex-direction: column;/* align-content: flex-end; */ justify-content: flex-end;">
                                                    <label>Háttérszín:</label>
                                                    <div style="display:flex; align-items:center; gap:5px;">
                                                        <input type="color" id="canvas-bg-color" value="#0a0e27" 
                                                               oninput="window.applySolidColor(this.value)" 
                                                               >
                                                    </div>
                                                </div>

                                                <div style="display: flex;flex: 1;flex-direction: column;">
                                                <label>Falad színe (Szimuláció):</label>
                                                    <input type="color" id="wall-bg-color" value="#BABABA" 
                                                           oninput="updateWallColor(this.value)">
                                                </div>
                                            </div>
                                    < ! - - <div class="setting-group" style="margin-bottom: 5px; display: flex; gap: 5%;">
                                      <div style="display: flex;flex: 1;flex-direction: column; justify-content: space-between;">
                                        <label style="display: flex; flex: 1; align-items: flex-end;" for="canvas-bg-color">Háttérszín:</label>
                                        <input type="color" id="canvas-bg-color" value="#0a0e27" oninput="window.updateCanvasBackground(this.value)">
                                      </div>
                                        <div style="display: flex;flex: 1;flex-direction: column;;">
                                        <label>Falad színe (Szimuláció):</label>
                                            <input type="color" id="wall-bg-color" value="#BABABA" 
                                                   oninput="updateWallColor(this.value)">
                                        </div>
                                    </div> - - >
                                        < ! - - </div> - - >

                                        <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color);">
                                            <span style="font-size: 13px; font-weight: bold; color: var(--text-primary);">Többszínű háttér (Gradiens)</span>
                                            <label class="switch">
                                                <input type="checkbox" id="gradient-toggle" onchange="window.toggleGradientEditor(this.checked)">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>

                                        <div id="gradient-editor-panel" style="display: none; padding: 12px; border: 1px solid #444; border-radius: 8px; background: rgba(0,0,0,0.3); margin-bottom: 15px;">
                                            
                                            <div style="margin-bottom: 12px;">
                                                <div style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:5px;">
                                                    <label>Dőlésszög:</label>
                                                    <span id="grad-angle-val" style="color:white; font-weight:bold;">135°</span>
                                                </div>
                                                <input type="range" id="grad-angle-range" min="0" max="360" value="135" 
                                                       oninput="window.updateGradientFromEditor()" style="width:100%;">
                                            </div>

                                            <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Színek sorrendje:</div>
                                            <div id="grad-stops-list" style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
                                                </div>

                                            <button class="add-btn secondary" style="width:100%; padding:8px; font-size:12px; border-style:dashed;" onclick="window.addGradientStop()">
                                                + Új szín hozzáadása
                                            </button>
                                        </div>

                                        <div class="collapsible-header" onclick="window.togglePresetList()" style="margin-bottom: 0; border-radius: 8px;">
                                            <h2 style="margin:0; font-size:14px; color: var(--text-primary); padding-left:0;">🎨 Háttér Sablonok</h2>
                                            <span class="collapsible-icon" id="preset-arrow" style="font-size: 12px;">▼</span>
                                        </div>
                                        
                                        <div id="bg-presets-container" style="display: none; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 12px; border: 1px solid var(--border-color); border-top:none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2);">
                                            </div>
                                    </div> -->
                                    <div class="section" style="margin-top: 10px; margin-bottom: 5px;">
                                        <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">HÁTTÉR ÉS FAL</h3>

                                        <div class="setting-group"
                                            style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                            <div id="simple-bg-container" style="flex: 1;">
                                                <label
                                                    style="font-size:11px; display:block; margin-bottom:3px;">Háttérszín:</label>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="color" id="canvas-bg-color" value="#0a0e27"
                                                        oninput="window.applySolidColor(this.value)"
                                                        style="width: 100%; height: 35px; border: 1px solid #444; border-radius:6px; padding: 0; cursor: pointer;">
                                                </div>
                                            </div>

                                            <div style="flex: 1;">
                                                <label style="font-size:11px; display:block; margin-bottom:3px;">Fal
                                                    színe (Szimuláció):</label>
                                                <div style="display:flex; align-items:center; gap:5px;">
                                                    <input type="color" id="wall-bg-color" value="#BABABA"
                                                        oninput="updateWallColor(this.value)"
                                                        style="width: 100%; height: 35px; border: 1px solid #444; border-radius:6px; padding: 0; cursor: pointer;">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color);">
                                            <span style="font-size: 13px; font-weight: bold; color: var(--text-primary);">Többszínű háttér (Gradiens)</span>
                                            <label class="switch">
                                                <input type="checkbox" id="gradient-toggle" onchange="window.toggleGradientEditor(this.checked)">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                        <div id="gradient-editor-panel" style="display: none; padding: 12px; border: 1px solid #444; border-radius: 8px; background: rgba(0,0,0,0.3); margin-bottom: 15px;">
                                            
                                            <div style="margin-bottom: 12px;">
                                                <div style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:5px;">
                                                    <label>Dőlésszög:</label>
                                                    <span id="grad-angle-val" style="color:white; font-weight:bold;">135°</span>
                                                </div>
                                                <input type="range" id="grad-angle-range" min="0" max="360" value="135" 
                                                       oninput="window.updateGradientFromEditor()" style="width:100%;">
                                            </div>

                                            <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Színek és Pozíciók (%):</div>
                                            <div id="grad-stops-list" style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
                                                </div>

                                            <button class="add-btn secondary" style="width:100%; padding:8px; font-size:12px; border-style:dashed;" onclick="window.addGradientStop()">
                                                + Új szín hozzáadása
                                            </button>
                                        </div> -->


                                        <div class="collapsible-header"
                                            style="margin-bottom: 0; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-between; padding-right: 10px;">

                                            <div onclick="window.toggleGradientPanel()"
                                                style="display:flex; align-items:center; gap:10px; flex:1; cursor:pointer;">
                                                <span id="gradient-arrow"
                                                    style="font-size: 12px; transform: rotate(-90deg); transition: transform 0.3s;">▼</span>
                                                <span
                                                    style="font-size: 13px; font-weight: bold; color: var(--text-primary);">Többszínű
                                                    háttér (Gradiens)</span>
                                            </div>

                                            <label class="switch" style="margin-left: 10px;">
                                                <input type="checkbox" id="gradient-toggle"
                                                    onchange="window.toggleGradientActive(this.checked)">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>

                                        <div id="gradient-editor-panel"
                                            style="display: none; padding: 12px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2); margin-bottom: 15px;">

                                            <div style="margin-bottom: 12px;">
                                                <div
                                                    style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:5px;">
                                                    <label>Dőlésszög:</label>
                                                    <span id="grad-angle-val"
                                                        style="color:white; font-weight:bold;">135°</span>
                                                </div>
                                                <input type="range" id="grad-angle-range" min="0" max="360" value="135"
                                                    oninput="window.updateGradientFromEditor()" style="width:100%;">
                                            </div>

                                            <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Színek és
                                                Pozíciók (%):</div>
                                            <div id="grad-stops-list"
                                                style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
                                            </div>

                                            <button class="add-btn secondary"
                                                style="width:100%; padding:8px; font-size:12px; border-style:dashed;"
                                                onclick="window.addGradientStop()">
                                                + Új szín hozzáadása
                                            </button>
                                        </div>

                                        <div class="collapsible-header" onclick="window.togglePresetList()"
                                            style="margin-bottom: 0; border-radius: 8px;">
                                            <h2
                                                style="margin:0; font-size:14px; color: var(--text-primary); padding-left:0;">
                                                🎨 Háttér Sablonok</h2>
                                            <span class="collapsible-icon" id="preset-arrow"
                                                style="font-size: 12px;">▼</span>
                                        </div>

                                        <div id="bg-presets-container"
                                            style="display: none; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 12px; border: 1px solid var(--border-color); border-top:none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2);">
                                        </div>
                                    </div>
                                    <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                                        <label style="font-size:11px;">Elrendezés iránya:</label>
                                        <div style="display: flex; gap: 5px; margin-top:5px;">
                                            <button id="btn-layout-row" class="add-btn primary"
                                                style="flex:1; font-size:11px; padding:8px;"
                                                aria-label="Soros elrendezés">↔
                                                Sor</button>
                                            <button id="btn-layout-column" class="add-btn secondary"
                                                style="flex:1; font-size:11px; padding:8px;"
                                                aria-label="Oszlopos elrendezés">↕
                                                Oszlop</button>
                                        </div>
                                    </div>

                                    <!-- KIFUTÓ (BLEED) BEÁLLÍTÁSOK SZEKCIÓ -->
                                    <div style="margin-top:15px; border-top:1px solid #444; padding-top:15px;">
                                        <h3 class="small" style="margin-top: 0; margin-bottom: 10px;">📐 KIFUTÓ (BLEED)
                                            BEÁLLÍTÁSOK</h3>

                                        <!-- Mód választó -->
                                        <div style="margin-bottom: 12px;">
                                            <label
                                                style="display:flex; align-items:center; margin-bottom: 8px; cursor: pointer; font-size: 12px;">
                                                <input type="radio" name="bleed-mode" value="theme" checked
                                                    style="margin-right: 8px;" onchange="window.setBleedMode('theme')">
                                                <span>🎨 Alapértelmezett (Téma szerinti)</span>
                                            </label>
                                            <label
                                                style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                                <input type="radio" name="bleed-mode" value="custom"
                                                    style="margin-right: 8px;" onchange="window.setBleedMode('custom')">
                                                <span>🖌️ Egyéni kifutó szín</span>
                                            </label>
                                        </div>

                                        <!-- Egyéni kifutó szín panel (alapból rejtett) -->
                                        <div id="custom-bleed-panel"
                                            style="display: none; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: rgba(0,0,0,0.2); margin-bottom: 12px;">

                                            <div class="setting-group" style="margin-bottom: 10px;">
                                                <div id="simple-bleed-container">
                                                    <label
                                                        style="font-size:11px; display:block; margin-bottom:3px;">Kifutó
                                                        szín:</label>
                                                    <input type="color" id="bleed-color-picker" value="#000000"
                                                        oninput="window.updateCustomBleedColor(this.value)"
                                                        style="width: 100%; height: 35px; border: 1px solid #444; border-radius:6px; padding: 0; cursor: pointer;">
                                                </div>
                                            </div>

                                            <!-- Gradiens kapcsoló a kifutóhoz -->
                                            <div class="collapsible-header"
                                                style="margin-bottom: 0; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: rgba(255,255,255,0.05);">
                                                <div onclick="window.toggleBleedGradientPanel()"
                                                    style="display:flex; align-items:center; gap:10px; flex:1; cursor:pointer;">
                                                    <span id="bleed-gradient-arrow"
                                                        style="font-size: 12px; transform: rotate(-90deg); transition: transform 0.3s;">▼</span>
                                                    <span style="font-size: 12px; color: var(--text-primary);">Többszínű
                                                        kifutó (Gradiens)</span>
                                                </div>
                                                <label class="switch" style="margin-left: 10px;">
                                                    <input type="checkbox" id="bleed-gradient-toggle"
                                                        onchange="window.toggleBleedGradientActive(this.checked)">
                                                    <span class="slider round"></span>
                                                </label>
                                            </div>

                                            <div id="bleed-gradient-editor-panel"
                                                style="display: none; padding: 12px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.2);">
                                                <div style="margin-bottom: 12px;">
                                                    <div
                                                        style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-bottom:5px;">
                                                        <label>Dőlésszög:</label>
                                                        <span id="bleed-grad-angle-val"
                                                            style="color:white; font-weight:bold;">135°</span>
                                                    </div>
                                                    <input type="range" id="bleed-grad-angle-range" min="0" max="360"
                                                        value="135" oninput="window.updateBleedGradientFromEditor()"
                                                        style="width:100%;">
                                                </div>

                                                <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Színek és
                                                    Pozíciók (%):</div>
                                                <div id="bleed-grad-stops-list"
                                                    style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;">
                                                </div>

                                                <button class="add-btn secondary"
                                                    style="width:100%; padding:8px; font-size:12px; border-style:dashed;"
                                                    onclick="window.addBleedGradientStop()">
                                                    + Új szín hozzáadása
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Kifutó élőnézet kapcsoló -->
                                        <div
                                            style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                                            <span
                                                style="font-size: 12px; font-weight: bold; color: var(--text-primary);">👁️
                                                Él/Kifutó élőnézet</span>
                                            <label class="switch">
                                                <input type="checkbox" id="bleed-preview-toggle"
                                                    onchange="window.toggleBleedPreview(this.checked)">
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                        <p
                                            style="font-size: 10px; color: var(--text-secondary); margin: 0; line-height: 1.4;">
                                            Bekapcsolva a vászon körül megjelenik a +2 cm-es kifutó terület előnézete.
                                            Ez a nyomtatáshoz szükséges extra terület, ami levágásra kerül.
                                        </p>
                                    </div>
                                </div>
                            </div>


                            <label style="margin-bottom: 4px; margin-top: 15px;">Export:</label>
                            <div class="export-btns">
                                <button onclick="exportCanvas('svg')">SVG (Vektoros)</button>
                                <button onclick="exportCanvas('png')">PNG (Raster)</button>
                                <button onclick="exportCanvas('jpeg')">JPEG (Raster)</button>
                                <button id="copy-button">copy-button</button>
                                <button id="dl-button">dl-button original celestial svg dl</button>
                            </div>
                            <a id="download-link" style="display: none;"></a>

                            <div style="flex-grow: 1;"></div>
                        </div>
                    </div>
                    <div id="fragment_r-2">
                        <!-- 2. ELEM KIVÁLASZTÁSA (Select Option) - ÚJ ID HOZZÁADVA -->
                        <div id="element-selector-container" class="section"
                            style="margin-top: 16px; margin-bottom: 10px; border-left: 4px solid var(--accent-blue);">
                            <label style="color:var(--accent-blue); font-weight:bold; margin-bottom:5px;">Szerkesztett
                                elem:</label>
                            <select id="active-element-selector" onchange="window.handleElementSelection(this.value)"
                                style="width:100%; padding:10px; font-weight:bold;">
                                <!-- JS tölti fel: Térkép 1, Fotó 1, Hold 1... -->
                            </select>
                        </div>
                        <!-- 3. DINAMIKUS BEÁLLÍTÁSOK (Térkép vs Fotó/Hold) -->
                        <div id="dynamic-element-settings">
                            <!-- A) TÉRKÉP SPECIFIKUS (Alapból látható, display:none levéve) -->
                            <div id="settings-group-map">
                                <div class="section" style="margin-top: 0; margin-bottom: 0;">
                                    <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">TÉRKÉP MÉRETE</h3>
                                    <div class="setting-group" style="margin-bottom: 0px;">
                                        <label for="map-width-cm-input">Szélesség (cm):</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="number" id="map-width-cm-input" value="" min="1" step="0.1"
                                                oninput="window.setMapWidth()">
                                            <button onclick="window.fitMapToCanvas()"
                                                style="width: auto; padding: 0 10px; font-size: 12px; background: var(--secondary-bg); border: 1px solid var(--accent-blue); color: var(--accent-blue); cursor: pointer; border-radius: 8px;">Max</button>
                                        </div>
                                        <small style="color: var(--text-secondary); font-size: 11px;">Nem lehet
                                            nagyobb a vászonnál.</small>
                                        <label
                                            style="font-size: 11px; display: flex; align-items: center; gap: 5px; cursor: pointer; margin-bottom: 0px">
                                            <input type="checkbox" id="allow-map-overflow"
                                                onchange="window.setMapWidth()">
                                            <span>Kifutó engedélyezése</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- B) FOTÓ / HOLD SPECIFIKUS (Méret) -->
                            <div id="settings-group-photo" style="display:none;">
                                <div class="section" style="margin-top: 0; margin-bottom: 0;">
                                    <!-- HOLD SZERKESZTŐ (Dátum, Hely) -->
                                    <div id="moon-edit-panel"
                                        style="display:none; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid var(--accent-purple);">
                                        <h3 class="small" style="margin-top:0; color:var(--accent-purple);">Hold
                                            Beállítások</h3>
                                        <div class="setting-group">
                                            <label>Dátum:</label>
                                            <input type="date" id="moon-edit-date" onchange="updateActiveMoonSettings()"
                                                style="width:100%;">
                                        </div>
                                        <div class="setting-group">
                                            <label>Idő (UTC):</label>
                                            <input type="time" id="moon-edit-time" onchange="updateActiveMoonSettings()"
                                                style="width:100%;">
                                        </div>
                                        <div class="setting-group"
                                            style="margin-top:10px; padding-top:10px; border-top:1px solid #444;">
                                            <label>Helyszín (Forgatáshoz):</label>
                                            <input type="text" id="moon-city-search" placeholder="Város keresése..."
                                                style="margin-bottom:5px;">
                                            <div class="grid-2-cols">
                                                <div>
                                                    <label style="font-size:10px; color:#aaa;">Lat:</label>
                                                    <input type="number" id="moon-edit-lat" step="0.0001"
                                                        onchange="updateActiveMoonSettings()">
                                                </div>
                                                <div>
                                                    <label style="font-size:10px; color:#aaa;">Lon:</label>
                                                    <input type="number" id="moon-edit-lon" step="0.0001"
                                                        onchange="updateActiveMoonSettings()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- ÚJ MÉRETEZŐ PANEL (Fotó/Hold) -->
                                    <h3 class="small" style="margin-top: 10px; margin-bottom: 12px;"
                                        id="photo-size-title">KÉP MÉRETE</h3>
                                    <div class="setting-group" style="margin-bottom: 0px;">
                                        <label for="photo-width-cm-input">Szélesség (cm):</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="number" id="photo-width-cm-input" value="20" min="1" step="0.1"
                                                oninput="window.setPhotoWidth()">
                                            <button onclick="window.fitPhotoToCanvas()"
                                                style="width: auto; padding: 0 10px; font-size: 12px; background: var(--secondary-bg); border: 1px solid var(--accent-blue); color: var(--accent-blue); cursor: pointer; border-radius: 8px;">Max</button>
                                        </div>
                                        <small style="color: var(--text-secondary); font-size: 11px;">Nem lehet
                                            nagyobb a vászonnál.</small>
                                        <label
                                            style="font-size: 11px; display: flex; align-items: center; gap: 5px; cursor: pointer; margin-bottom: 0px">
                                            <input type="checkbox" id="allow-photo-overflow"
                                                onchange="window.setPhotoWidth()">
                                            <span>Kifutó engedélyezése</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- C) KÖZÖS: POZÍCIÓ (Igazítás) -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">POZÍCIÓ IGAZÍTÁSA</h3>
                                <div class="setting-group">
                                    <div style="display: flex; gap: 10px;">
                                        <!-- A gombok ID-ja megmaradt, a JS kezeli a logikát attól függően mi aktív -->
                                        <button id="btn-align-top" class="add-btn secondary" style="flex:1;"
                                            aria-label="Igazítás felülre">⬆ Fent</button>
                                        <button id="btn-align-center" class="add-btn secondary" style="flex:1;"
                                            aria-label="Igazítás középre">• Közép</button>
                                        <button id="btn-align-bottom" class="add-btn secondary" style="flex:1;"
                                            aria-label="Igazítás alulra">⬇ Lent</button>
                                    </div>
                                    <!-- Margók (Dinamikus ID-k) -->
                                    <div id="element-margin-top-container" style="display: none; margin-top: 10px;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <label id="lbl-element-margin-top"
                                                style="font-size: 11px; color: #aaa;">Felső Margó (cm):</label>
                                        </div>
                                        <input type="number" id="element-margin-top" value="0" step="0.5"
                                            oninput="window.updateElementMargin('top', this.value)"
                                            style="width: 100%;">
                                    </div>
                                    <div id="element-margin-bottom-container" style="display: none; margin-top: 5px;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <label id="lbl-element-margin-bottom"
                                                style="font-size: 11px; color: #aaa;">Alsó Margó (cm):</label>
                                        </div>
                                        <input type="number" id="element-margin-bottom" value="0" step="0.5"
                                            oninput="window.updateElementMargin('bottom', this.value)"
                                            style="width: 100%;">
                                    </div>
                                </div>
                            </div>
                            <!-- D) KÖZÖS: MASZK ÉS ALAK -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">♥ Szív Alak és Méret
                                </h3>
                                <div
                                    style="display: flex; gap: 8px; justify-content: center; margin-top: 5px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <!-- Maszk gombok - JS kezeli a 'setCommonMask'-ot -->
                                    <div class="mask-option selected" id="c-mask-btn-none" role="button" tabindex="0"
                                        aria-label="Eredeti kör alak"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 50%; border: 2px solid #4a9eff; display: flex; align-items: center; justify-content: center;"
                                        title="Eredeti (Kör)">
                                        <span style="font-size: 18px;">○</span>
                                    </div>
                                    <div class="mask-option" id="c-mask-btn-classic" role="button" tabindex="0"
                                        aria-label="Klasszikus szív alak"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 4px; border: 1px solid #555; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                            <path
                                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                        </svg>
                                    </div>
                                    <div class="mask-option" id="c-mask-btn-elegant" role="button" tabindex="0"
                                        aria-label="Elegáns szív alak"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 4px; border: 1px solid #555; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="2">
                                            <path
                                                d="M12 21s-8-5.5-8-11.5C4 5.5 8 3.5 12 8c4-4.5 8-2.5 8 1.5C20 15.5 12 21 12 21z" />
                                        </svg>
                                    </div>
                                    <div onclick="window.setCommonMask('round')" class="mask-option"
                                        id="c-mask-btn-round"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 4px; border: 1px solid #555; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                            <path
                                                d="M12 20.5C6 16 3 13 3 9.5 3 7 5 5 7.5 5c1.5 0 3 .5 4.5 2 1.5-1.5 3-2 4.5-2 2.5 0 4.5 2 4.5 4.5 0 3.5-3 6.5-9 11z" />
                                        </svg>
                                    </div>
                                    <div onclick="window.setCommonMask('modern')" class="mask-option"
                                        id="c-mask-btn-modern"
                                        style="cursor: pointer; width: 35px; height: 35px; background: #333; border-radius: 4px; border: 1px solid #555; display: flex; align-items: center; justify-content: center;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                            <path
                                                d="M12 21L3 10a5 5 0 0 1 8-4 5 5 0 0 1 1 1 5 5 0 0 1 1-1 5 5 0 0 1 8 4L12 21z" />
                                        </svg>
                                    </div>
                                </div>
                                <div id="common-mask-scale-container" style="display:none; margin-top: 10px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                        <label style="font-size: 11px; color: #aaa;">Szív Mérete:</label>
                                        <span style="font-size: 11px; color: #fff;">+/-</span>
                                    </div>
                                    <input type="range" id="common-mask-scale-slider" min="50" max="130" value="100"
                                        oninput="window.updateCommonMaskScale(this.value)"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                            </div>
                            <!-- E) KÖZÖS: KERET & SZÉLEK -->
                            <div class="section" style="margin-top: 16px; margin-bottom: 0;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px;">KERET & SZÉLEK</h3>
                                <div class="setting-group">
                                    <label>Kép Szélének Elmosása: <span id="common-edge-blur-disp"
                                            style="float:right; color:#aaa;">0px</span></label>
                                    <input type="range" id="common-edge-blur-input" min="0" max="100" value="0"
                                        oninput="window.updateCommonBorderProp('edgeBlur', this.value)">
                                </div>
                                <div class="setting-group"
                                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">
                                    <input type="checkbox" id="common-border-check"
                                        onchange="window.updateCommonBorderProp('enabled', this.checked)"
                                        style="width:16px; height:16px; margin:0;">
                                    <label for="common-border-check"
                                        style="margin:0; cursor:pointer; font-size: 12px; flex: 1;">Keret
                                        bekapcsolása</label>
                                    <input type="color" id="common-border-color" value="#ffffff"
                                        oninput="window.updateCommonBorderProp('color', this.value)"
                                        style="width:30px; height:25px; padding:0; margin:0; border:none;">
                                </div>
                                <div id="common-border-settings-wrapper" style="display:none;">
                                    <div class="setting-group">
                                        <label>Keret Vastagság: <span id="common-border-disp"
                                                style="float:right; color:#aaa;">0px</span></label>
                                        <input type="range" id="common-border-input" min="0" max="50" value="0"
                                            oninput="window.updateCommonBorderProp('width', this.value)">
                                    </div>
                                    <div class="setting-group">
                                        <label>Keret Távolság (Offset): <span id="common-border-offset-disp"
                                                style="float:right; color:#aaa;">0px</span></label>
                                        <input type="range" id="common-border-offset-input" min="-60" max="60" value="0"
                                            step="1" oninput="window.updateCommonBorderProp('offset', this.value)">
                                    </div>
                                    <div class="setting-group">
                                        <label>Keret Elmosódás (Blur): <span id="common-border-blur-disp"
                                                style="float:right; color:#aaa;">0px</span></label>
                                        <input type="range" id="common-border-blur-input" min="0" max="50" value="0"
                                            oninput="window.updateCommonBorderProp('blur', this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="grid-2-cols" style="margin-top:15px;" id="btn-delete-element-container">
                                <button onclick="window.deleteActiveElement()" class="add-btn accent"
                                    style="background:#ff4444; width:100%;">🗑️ Elem Törlése</button>
                            </div>
                        </div>
                    </div>
                    <div id="fragment_r-3">
                        <div class="designer-controls">

                            <div class="text-mode-tabs" style="display: none">
                                <button class="text-mode-tab active" onclick="switchTextContext('map')"
                                    id="tab-context-map">Csillagtérkép</button>
                                <button class="text-mode-tab" onclick="switchTextContext('photo')"
                                    id="tab-context-photo" style="display:none;">Fotó Oldal</button>
                                <button class="text-mode-tab common-tab" onclick="switchTextContext('common')"
                                    id="tab-context-common" style="display:none;">Közös (Széles)</button>
                            </div>

                            <div class="collapsible-header" data-target="top-text-settings">
                                <h2 id="top-zone-title">📝 FELSŐ ZÓNA (Térkép)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                            </div>

                            <div class="collapsible-content" id="top-text-settings">
                                <div class="section" style="margin-bottom: 0;">

                                    <div id="top-common-toggle-container"
                                        style="display:none; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #444;">
                                        <label><input type="checkbox" id="chk-common-top"
                                                onchange="toggleCommonZone('top', this.checked)"> 🔗 Közös Felső
                                            Szövegdoboz használata</label>
                                    </div>

                                    <div class="setting-group">

                                        <label>Zóna Függőleges Igazítása:</label>
                                        <div style="margin-top: 5px; margin-bottom: 5px;">
                                            <select id="zone-top-align" onchange="setZoneAlign('top', this.value)">
                                                <option value="top">⬆ Lap tetejéhez</option>
                                                <option value="center" selected>• Középre</option>
                                                <option value="bottom">⬇ Térképhez</option>
                                            </select>
                                        </div>

                                        <div id="zone-top-margin-container" style="display:none; margin-bottom: 10px;">
                                            <label style="font-size: 10px; color: #aaa;">Margó (cm):</label>
                                            <input id="zone-top-margin-input" type="number"
                                                oninput="updateZoneMargin('top', this.value)" value="0" step="0.1"
                                                style="width: 100%;">
                                        </div>
                                    </div>
                                    <div id="top-blocks-container"></div>

                                </div>
                            </div>

                            <div class="collapsible-header" data-target="bottom-text-settings">
                                <h2 id="bottom-zone-title">📝 ALSÓ ZÓNA (Térkép)</h2>
                                <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                            </div>
                            <div class="collapsible-content" id="bottom-text-settings">
                                <div class="section" style="margin-bottom: 0;">

                                    <div id="bottom-common-toggle-container"
                                        style="display:none; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #444;">
                                        <label><input type="checkbox" id="chk-common-bottom"
                                                onchange="toggleCommonZone('bottom', this.checked)"> 🔗 Közös Alsó
                                            Szövegdoboz használata</label>
                                    </div>

                                    <div class="setting-group">
                                        <label>Zóna Függőleges Igazítása:</label>
                                        <div style="margin-top: 5px; margin-bottom: 5px;">
                                            <select id="zone-bottom-align"
                                                onchange="setZoneAlign('bottom', this.value)">
                                                <option value="top">⬆ Térképhez</option>
                                                <option value="center" selected>• Középre</option>
                                                <option value="bottom">⬇ Lap aljához</option>
                                            </select>
                                        </div>

                                        <div id="zone-bottom-margin-container"
                                            style="display:none; margin-bottom: 10px;">
                                            <label style="font-size: 10px; color: #aaa;">Margó (cm):</label>
                                            <input id="zone-bottom-margin-input" type="number"
                                                oninput="updateZoneMargin('bottom', this.value)" value="0" step="0.1"
                                                style="width: 100%;">
                                        </div>
                                    </div>

                                    <div id="bottom-blocks-container"></div>

                                </div>
                            </div>

                            <div id="symbol-picker"
                                style="display:none; position:fixed; z-index:1000; background:var(--secondary-bg); padding:10px; border:1px solid var(--accent-blue); border-radius:10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
                                <div
                                    style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; font-size:20px;">
                                    <button onclick="window.insertSymbol('♥')">♥</button>
                                    <button onclick="window.insertSymbol('♡')">♡</button>
                                    <button onclick="window.insertSymbol('★')">★</button>
                                    <button onclick="window.insertSymbol('☆')">☆</button>
                                    <button onclick="window.insertSymbol('—')">—</button>
                                    <button onclick="window.insertSymbol('•')">•</button>
                                    <button onclick="window.insertSymbol('∞')">∞</button>
                                    <button onclick="window.insertSymbol('&')">&</button>
                                    <button onclick="window.insertSymbol('+')">+</button>
                                    <button onclick="window.insertSymbol('|')">|</button>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div id="fragment_r-4">
                        <div class="designer-controls">

                            <!-- 1. FŐ VÁLASZTÓ: MIT SZERETNÉL? -->
                            <div class="section" style="margin-top: 0; margin-bottom: 16px; text-align:center;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 12px; color:var(--accent-blue);">
                                    ÚJ ELEM HOZZÁADÁSA</h3>
                                <div class="grid-3-cols" style="gap:10px;">
                                    <button onclick="toggleAddPanel('photo')" id="btn-mode-photo"
                                        class="add-btn primary" style="height:60px; font-size:14px;">
                                        📸 SAJÁT FOTÓ
                                    </button>
                                    <button onclick="toggleAddPanel('moon')" id="btn-mode-moon"
                                        class="add-btn secondary" style="height:60px; font-size:14px;">
                                        🌔 HOLDFÁZIS
                                    </button>
                                    <button onclick="toggleAddPanel('map')" id="btn-mode-map" class="add-btn secondary"
                                        style="height:60px; font-size:12px; border-color: #546e7a;">
                                        ✨ CSILLAGTÉRKÉP
                                    </button>
                                </div>
                            </div>

                            <!-- 2. TARTALOM PANELEK (Váltakoznak) -->

                            <!-- A) FOTÓ FELTÖLTÉS -->
                            <div id="panel-photo-upload" style="display: none !important">
                                <div class="section" style="margin-bottom: 16px;">
                                    <input type="file" id="photo-upload" accept="image/*" style="display: none;"
                                        onchange="initCropperFromFile(this)">
                                    <button onclick="document.getElementById('photo-upload').click()"
                                        class="add-btn accent" style="width:100%; padding:15px;">
                                        Fájl Kiválasztása...
                                    </button>
                                </div>
                            </div>
                            <!-- B) HOLD GENERÁTOR (NASA API) -->
                            <div id="panel-moon-gen" style="display:none;">
                                <div class="section" style="margin-bottom: 16px;">

                                    <!-- 1. ADATOK (FENT) -->
                                    <div
                                        style="font-size:11px; line-height:1.4; color:#ccc; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #444;">
                                        <div id="moon-data-phase"
                                            style="font-weight:bold; color:var(--accent-blue); margin-bottom:5px; font-size:14px; text-transform:uppercase;">
                                            -</div>
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <span>Megvilágítottság:</span>
                                            <span id="moon-data-illum" style="color:white; font-weight:bold;">-</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <span>Hold kora:</span>
                                            <span id="moon-data-age" style="color:white;">-</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                            <span>Csillagjegy:</span>
                                            <span id="moon-data-zodiac" style="color:white;">-</span>
                                        </div>
                                        <div style="margin-top:5px; font-size:10px; color:#888;">
                                            <div>Következő Újhold: <span id="moon-data-nextnew">-</span></div>
                                            <div>Következő Telihold: <span id="moon-data-nextfull">-</span></div>
                                        </div>
                                    </div>

                                    <!-- 2. KÉP (ALATT) -->
                                    <div style="text-align:center; margin-bottom:15px;">
                                        <img id="moon-preview-img" src=""
                                            style="width:120px; height:120px; border-radius:50%; /*background:#000;*/ display:inline-block; box-shadow: 0 0 15px rgba(255,255,255,0.1);">
                                    </div>

                                    <div class="setting-group">
                                        <label>Dátum:</label>
                                        <input type="date" id="moon-date" onchange="updateMoonPreview()"
                                            style="width:100%;">
                                    </div>
                                    <div class="setting-group">
                                        <label>Idő (UTC):</label>
                                        <input type="time" id="moon-time" value="12:00" onchange="updateMoonPreview()"
                                            style="width:100%;">
                                    </div>
                                    <div class="setting-group">
                                        <label>Szöveg megjelenítése a kép alatt:</label>
                                        <input type="checkbox" id="moon-text-check" checked>
                                    </div>
                                </div>
                            </div>
                            <!-- 3. HOZZÁADÁS HELYE (KÖZÖS) -->
                            <div class="section" style="margin-bottom: 16px;">
                                <h3 class="small" style="margin-top: 0; margin-bottom: 8px;">HOZZÁADÁS HELYE</h3>
                                <div
                                    style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:11px; color:#aaa;">
                                    <span>Jelenlegi elrendezés:</span>
                                    <span id="layout-dir-display" style="color:white; font-weight:bold;">SOR (↔)</span>
                                </div>
                                <div class="grid-2-cols" id="add-buttons-container">
                                    <button onclick="addCurrentItem('start')" class="add-btn secondary"
                                        id="btn-add-start">
                                        ⬅ BALRA (Elejére)
                                    </button>
                                    <button onclick="addCurrentItem('end')" class="add-btn secondary" id="btn-add-end">
                                        ➡ JOBBRA (Végére)
                                    </button>
                                </div>

                                <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                                    <label style="font-size:11px;">Elrendezés iránya:</label>
                                    <div style="display: flex; gap: 5px; margin-top:5px;">
                                        <button onclick="setLayoutDirection('row')" id="btn-layout-row_"
                                            class="add-btn primary" style="flex:1; font-size:11px; padding:8px;">↔
                                            Sor</button>
                                        <button onclick="setLayoutDirection('column')" id="btn-layout-column_"
                                            class="add-btn secondary" style="flex:1; font-size:11px; padding:8px;">↕
                                            Oszlop</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- <div id="fragment_r-4">
                        <div id="designer-tab-templates">
                            <h3 style="margin-top:0;">Stílus & Háttér</h3>
                            <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">
                                Válassz stílust! Ez egyszerre állítja be a csillagtérkép színeit és a poszter hátterét.
                            </p>
                            <div style="margin-bottom: 15px;">
                                <button onclick="if(typeof restoreUserState === 'function') restoreUserState();" class="add-btn accent" style="width: 100%; background: #546e7a;">
                                    ↺ Visszaállítás (Saját Szerkesztés)
                                </button>
                            </div>
                            
                            <div id="designer-templates-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                        </div>
                    </div> -->
                    <!-- <div id="fragment_r-4">
                        <div id="designer-tab-templates">
                            <h3 style="margin-top:0;">Stílus & Háttér</h3>
                            
                            <div class="section" style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.2);">
                                <label style="display:block; font-weight:bold; color: var(--accent-cyan); margin-bottom: 8px;">
                                    Háttér beállítása sablon váltáskor:
                                </label>
                                
                                <label style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer;">
                                    <input type="radio" name="bg-mode" value="global" checked style="margin-right: 8px;">
                                    <span>🌍 Teljes vászon (Globális)</span>
                                </label>
                                
                                <label style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer;">
                                    <input type="radio" name="bg-mode" value="local" style="margin-right: 8px;">
                                    <span>🖼️ Csak a térkép mögött (Lokális)</span>
                                </label>
                                
                                <label style="display:flex; align-items:center; cursor: pointer;">
                                    <input type="radio" name="bg-mode" value="none" style="margin-right: 8px;">
                                    <span>🚫 Ne változzon a háttér</span>
                                </label>
                            </div>

                            <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">
                                Válassz stílust! A fenti beállítás dönti el, hogy a háttér hogyan változzon.
                            </p>
                            
                            <div style="margin-bottom: 15px;">
                                <button onclick="if(typeof restoreUserState === 'function') restoreUserState();" class="add-btn accent" style="width: 100%; background: #546e7a;">
                                    ↺ Visszaállítás (Saját Szerkesztés)
                                </button>
                            </div>
                            
                            <div id="designer-templates-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                        </div>
                    </div> -->
                    <div id="fragment_r-5">
                        <div id="designer-tab-templates">
                            <h3 style="margin-top:0;">Stílus & Háttér</h3>

                            <!-- <div class="section" style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.2);">
                                <label style="display:block; font-weight:bold; color: var(--accent-cyan); margin-bottom: 8px;">
                                    Háttér beállítása sablon váltáskor:
                                </label>
                                
                                <label style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer;">
                                    <input type="radio" name="bg-mode-right" value="global" checked style="margin-right: 8px;">
                                    <span>🌍 Teljes vászon (Globális)</span>
                                </label>
                                
                                <label style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer;">
                                    <input type="radio" name="bg-mode-right" value="local" style="margin-right: 8px;">
                                    <span>🖼️ Csak a térkép mögött (Lokális)</span>
                                </label>
                                
                                <label style="display:flex; align-items:center; cursor: pointer;">
                                    <input type="radio" name="bg-mode-right" value="none" style="margin-right: 8px;">
                                    <span>🚫 Ne változzon a háttér</span>
                                </label>
                            </div> -->

                            <!-- ELEM VÁLASZTÓ A SABLONOK MENÜBEN -->
                            <div id="template-element-selector-container" class="section"
                                style="margin-bottom: 10px; padding: 10px; border: 1px solid var(--accent-purple); background: rgba(0,0,0,0.2); border-radius: 8px; display:none;">
                                <label
                                    style="color:var(--accent-purple); font-weight:bold; margin-bottom:5px; font-size: 11px; display:block;">KIVÁLASZTOTT
                                    ELEM:</label>
                                <select id="template-element-selector"
                                    onchange="window.handleTemplateElementSelection(this.value)"
                                    style="width:100%; padding:8px; font-weight:bold; background:rgba(0,0,0,0.3); color:white; border:1px solid #444; border-radius:4px; cursor:pointer;">
                                    <!-- JS tölti fel -->
                                </select>
                            </div>
                            <div class="section"
                                style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <label
                                    style="display:block; font-weight:bold; color: var(--accent-cyan); margin-bottom: 8px; font-size: 11px;">
                                    ALKALMAZÁS MÓDJA:
                                </label>

                                <label
                                    style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                    <input type="radio" name="bg-mode-right" value="global" checked
                                        style="margin-right: 8px;">
                                    <span>🌍 Teljes vászonkép (Minden elem)</span>
                                </label>

                                <label
                                    style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                    <input type="radio" name="bg-mode-right" value="local" style="margin-right: 8px;">
                                    <span>🖼️ Csak a kiválasztott kép (Háttérrel)</span>
                                </label>

                                <label style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                    <input type="radio" name="bg-mode-right" value="none" style="margin-right: 8px;">
                                    <span>🚫 Csak a kiválasztott csillagtérkép (Stílus)</span>
                                </label>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <button onclick="if(typeof restoreUserState === 'function') restoreUserState();"
                                    class="add-btn accent" style="width: 100%; background: #546e7a;">
                                    ↺ Visszaállítás
                                </button>
                            </div>

                            <div id="designer-templates-grid"
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                        </div>
                    </div>
                    <div id="fragment_r-6">
                    </div>
                    <div id="fragment_r-7">

                        <div class="designer-controls">
                            <div class="section">
                                <div class="sp-header">
                                    <h3 class="small" style="margin:0;">Adj hozzá Okospontot</h3>
                                    <button class="add-btn secondary" style="padding: 5px 10px;"
                                        onclick="$('#smartpoint-section-content').slideToggle()">▼</button>
                                </div>

                                <!-- Egyedi Alert Doboz -->
                                <div id="custom-sp-alert" class="shadow">
                                    <p id="sp-alert-text">Üzenet szövege</p>
                                    <button onclick="$('#custom-sp-alert').fadeOut(200)" class="add-btn secondary"
                                        style="padding: 5px 15px; font-size: 12px;">Bezárás</button>
                                </div>

                                <div id="smartpoint-section-content">

                                    <!-- Fő vezérlők -->
                                    <div style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px;">
                                        <button id="btnAddSmartpoint" class="add-btn accent" style="width:100%;"
                                            onclick="startAddSmartpoint()">
                                            <span style="margin-right:5px;">+</span> Új Okospont hozzáadása
                                        </button>

                                        <div style="display: flex; gap: 8px;">
                                            <button id="btnToggleSmartpoints" class="add-btn secondary"
                                                style="flex: 1; font-size: 11px;"
                                                onclick="toggleSmartpointsVisibility()">
                                                👁️ Elrejtés
                                            </button>
                                            <!-- <button id="btnMoveSmartpoints" class="add-btn secondary" style="flex: 1; font-size: 11px;" onclick="toggleSmartpointsMoveMode()">✥ Áthelyezés</button> -->
                                        </div>
                                    </div>

                                    <!-- Típus választó -->
                                    <div id="sp-type-selector"
                                        style="display: none; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                                        <label
                                            style="margin-bottom: 10px; display: block; font-weight: bold; color: var(--accent-blue);">1.
                                            Válassz típust:</label>
                                        <button class="add-btn secondary sp-type-btn"
                                            onclick="selectSPType('audio', this)">🎵 Hangfájl</button>
                                        <button class="add-btn secondary sp-type-btn"
                                            onclick="selectSPType('video', this)">🎥 Videó</button>
                                        <button class="add-btn secondary sp-type-btn"
                                            onclick="selectSPType('image', this)">🖼️ Kép</button>
                                        <!-- <button class="add-btn secondary sp-type-btn" onclick="selectSPType('youtube', this)">▶️ YouTube</button> -->
                                        <!-- <button class="add-btn secondary sp-type-btn" onclick="selectSPType('youtube', this)"><i class="fab fa-youtube me-2" style=" color: red;"></i> YouTube URL</button> -->
                                        <button class="add-btn secondary sp-type-btn"
                                            onclick="selectSPType('youtube', this)"><i class="fab fa-youtube me-2"
                                                style=" color: red;"></i><i class="fa-brands fa-youtube"
                                                style="color: #ff0000;"></i><i class="bi bi-youtube"></i> <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.-->
                                                <path fill="#ff0000"
                                                    d="M581.7 188.1C575.5 164.4 556.9 145.8 533.4 139.5C490.9 128 320.1 128 320.1 128C320.1 128 149.3 128 106.7 139.5C83.2 145.8 64.7 164.4 58.4 188.1C47 231 47 320.4 47 320.4C47 320.4 47 409.8 58.4 452.7C64.7 476.3 83.2 494.2 106.7 500.5C149.3 512 320.1 512 320.1 512C320.1 512 490.9 512 533.5 500.5C557 494.2 575.5 476.3 581.8 452.7C593.2 409.8 593.2 320.4 593.2 320.4C593.2 320.4 593.2 231 581.8 188.1zM264.2 401.6L264.2 239.2L406.9 320.4L264.2 401.6z" />
                                            </svg> YouTube URL &#xF62B;</button>
                                        <button class="add-btn secondary sp-type-btn"
                                            onclick="selectSPType('spotify', this)"><i class="fab fa-spotify"
                                                style="color: #1DB954"></i> Spotify</button>
                                        <button class="add-btn secondary sp-type-btn"
                                            onclick="selectSPType('url', this)">🔗 URL / Link</button>
                                    </div>

                                    <!-- Tartalom megadása -->
                                    <div id="sp-content-input"
                                        style="display: none; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                                        <label
                                            style="margin-bottom: 10px; display: block; font-weight: bold; color: var(--accent-blue);">2.
                                            Tartalom:</label>

                                        <div id="sp-input-url-group" style="display:none;">
                                            <input type="text" id="sp-input-url" placeholder="https://..."
                                                style="width: 100%; margin-bottom: 10px;">
                                        </div>
                                        <div id="sp-input-file-group" style="display:none;">
                                            <input type="file" id="sp-input-file"
                                                style="width: 100%; margin-bottom: 10px; color: #aaa;">
                                        </div>

                                        <div class="grid-2-cols">
                                            <button id="btn-sp-save" class="add-btn primary"
                                                aria-label="Okospont mentése">Mentés</button>
                                            <button id="btn-sp-cancel" class="add-btn secondary"
                                                aria-label="Okospont mentésének megszakítása">Mégse</button>
                                        </div>
                                    </div>

                                    <!-- Lista -->
                                    <div id="smartpoints-list">
                                        <div
                                            style="text-align: center; color: #888; font-style: italic; padding: 10px;">
                                            Még nincs okospont.</div>
                                    </div>

                                    <!-- Koordináta Export Info (Rejtett, de a kódban elérhető) -->
                                    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                                        <p style="font-size: 10px; color: #666;">
                                            * Az okospontok helyzete (CM-ben a középponttól) mentésre kerül a
                                            konfigurációba.
                                            Nyomtatáskor nem látszanak.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="fragment_r-8">
                    <div class="designer-controls">
                        <div class="section">
                            <!-- NEW: Active Element Selector for Preview -->
                            <div id="preview-element-selector-container" class="section"
                                style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-purple); background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <label
                                    style="color:var(--accent-purple); font-weight:bold; margin-bottom:5px; font-size: 11px; display:block;">KIVÁLASZTOTT
                                    ELEM:</label>
                                <select id="active-element-selector-preview"
                                    onchange="window.handleUnifiedSelection(this.value)"
                                    style="width:100%; padding:8px; font-weight:bold; background:rgba(0,0,0,0.3); color:white; border:1px solid #444; border-radius:4px; cursor:pointer;">
                                </select>
                            </div>

                            <h2>🔎 Részletes Nézet</h2>
                            <p style="font-size:12px; color:#aaa;">Ellenőrizd a terved minden apró részletét nagy
                                felbontásban.</p>

                            <div class="setting-group">
                                <label>Mit szeretnél látni?</label>
                                <div class="radio-group" style="display:flex; gap:10px; margin-top:5px;">
                                    <label class="radio-btn active" style="font-size:12px; cursor:pointer;">
                                        <input type="radio" name="view-mode" value="all" checked
                                            onchange="window.fsViewMode='all'"> Teljes Vászon
                                    </label>
                                    <label class="radio-btn" style="font-size:12px; cursor:pointer;">
                                        <input type="radio" name="view-mode" value="selected"
                                            onchange="window.fsViewMode='selected'"> Kijelölt Elem
                                    </label>
                                </div>
                            </div>

                            <button id="btn-open-fullscreen" class="add-btn primary"
                                style="margin-top:15px; width:100%; padding:15px; font-size:14px;"
                                onclick="window.openFullScreenView()">
                                ⛶ Megnyitás Teljes Képernyőn
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="layout" id="main-layout">
        <div class="mapwrap" id="map-wrap">
            <div class="map" id="celestial-map">
            </div>
        </div>

        <div class="settingswrap" id="settings-wrap">
            <div id="tabs">
                <ul id="mobile_tabs">
                    <li><a href="#fragment-1">Térkép Beállítások</a></li>
                    <li><a href="#fragment-2">Tejút & Égbolt</a></li>
                    <li><a href="#fragment-3">Csillagok & Csillagképek</a></li>
                    <li><a href="#fragment-4">Háló & Vonalak</a></li>
                    <li><a href="#fragment-5">Sablonok</a></li>
                    <li><a href="#fragment-6">Tervező</a></li>
                </ul>

                <div id="fragment-1">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="location-settings">
                            <h2>📍 HELY & IDŐ</h2>
                            <div id="font-tests"></div>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div>
                        <div class="collapsible-content" id="location-settings">
                            <div class="section" style="padding-bottom: 0px;">
                                <div class="setting-group">
                                    <label for="city" style="">Helyszín</label>
                                    <input type="text" id="city" placeholder="Város keresése...">
                                    <label for="" style=" margin-top: 8px;">Koordináták</label>
                                    <div class="row" style="display: flex;">
                                        <div class="col">
                                            <input placeholder="Szélességi fok" type="text" id="coord_lat">
                                        </div>
                                        <div class="col">
                                            <input placeholder="Hosszúsági fok" type="text" id="coord_lon">
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-group" style="display: flex;">
                                    <label for="datetimepicker" style="">Dátum & Idő</label>
                                    <input type="text" id="datetimepicker" placeholder="Válassz dátumot és időt">
                                </div>
                            </div>
                        </div>
                        <!-- <div class="collapsible-header" data-target="projection-settings">
                            <h2>🌍 Projekció</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div> -->
                        <div class="collapsible-content" id="projection-settings">
                            <div class="setting-group">
                                <!-- <label for="projection_">Projekció</label> -->
                                <h2>🌍 Projekció</h2>

                                <select id="projection_">
                                    <option value="stereographic">Stereographic (hemi)</option>
                                    <option value="myHeart2025">myHeart2025 (hemi)</option>
                                    <option value="customHeart">SZÍV ALAKÚ (Egyedi)</option>
                                    <option value="customHeartt">tttSZÍV ALAKÚ (Egyedi)</option>
                                    <option value="werner">WERNER (igazából Bonne)</option>
                                    <option value="orthographic">Orthographic (hemi)</option>
                                    <option value="airy">Airy’s Minimum Error (hemi)</option>
                                    <option value="azimuthalEqualArea">Azimuthal Equal Area (hemi)</option>
                                    <option value="azimuthalEquidistant">Azimuthal Equidistant (hemi)</option>
                                    <option value="berghaus">Berghaus Star (hemi)</option>
                                    <option value="cassini">Cassini (hemi)</option>
                                    <option value="twoPointEquidistant">Two-Point Equidistant (hemi)</option>
                                    <option value="wiechel">Wiechel (hemi)</option>
                                    <option value="guyou">Guyou</option>
                                    <option value="butterfly">Butterfly</option>
                                    <option value="mtFlatPolarParabolic">mtFlatPolarParabolic</option>
                                    <option value="bonne">bonne</option>
                                </select>
                            </div>
                            <div class="setting-group" style="display:none;" id="szivszogediv">
                                <label for="szivszoge">Szív szöge</label>
                                <input id="szivszoge" type="number" min="1.8" max="3.2" step="0.1" value="2.4">
                            </div>
                        </div>
                        <!-- ... maradék html tartalom változatlan ... -->
                        <!-- <div class="collapsible-header" data-target="zodiacsign-settings">
                            <h2>♎︎ Csillagjegyek</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div> -->

                        <div class="collapsible-content" id="zodiacsign-settings">
                            <div class="setting-group">
                                <!-- <label for="zodiacsigns">Csillagjegyek</label> -->
                                <h2>♎︎ Csillagjegyek</h2>

                                <select id="zodiacsigns">
                                    <option value="nincs">Nincs kiválasztva (Visszaállítás)</option>
                                    <option value="Cap">Bak (december 22. – január 20.)</option>
                                    <option value="Aqr">Vízöntő (január 21. – február 19. )</option>
                                    <option value="Psc">Halak (február 20. – március 20.)</option>
                                    <option value="Ari">Kos (március 21. – április 19.)</option>
                                    <option value="Tau">Bika (április 20. – május 20.)</option>
                                    <option value="Gem">Ikrek (május 21. – június 20.)</option>
                                    <option value="Cnc">Rák (június 21. – július 22.)</option>
                                    <option value="Leo">Oroszlán (július 23. – augusztus 22.)</option>
                                    <option value="Vir">Szűz (augusztus 23. – szeptember 22.)</option>
                                    <option value="Lib">Mérleg (szeptember 23. – október 22.)</option>
                                    <option value="Sco">Skorpió (október 23. – november 22.)</option>
                                    <option value="Sgr">Nyilas (november 23. – december 21.)</option>
                                </select>
                            </div>
                        </div>

                        <!-- ÚJ SZEKCIÓ: Egyedi Kiemelések -->
                        <div class="collapsible-header" data-target="highlight-settings">
                            <h2>♋︎ Csillagképek Kiemelése</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div>

                        <div class="collapsible-content" id="highlight-settings">
                            <div class="section">
                                <!-- 1. SELECT (Mindig látszik, ez a belépési pont) -->
                                <div class="setting-group" style="margin-bottom: 10px;">
                                    <label style="color: var(--accent-cyan); font-weight:bold; margin-bottom:5px;">Új
                                        csillagkép
                                        kiemelése:</label>
                                    <select id="hl-constellation-select"
                                        style="background: rgba(0,0,0,0.4); border: 1px solid var(--accent-blue);">
                                        <option value="">-- Válassz a listából --</option>
                                        <option value="And">Androméda</option>
                                        <option value="Aqr">Vízöntő</option>
                                        <option value="Aql">Sas</option>
                                        <option value="Ari">Kos</option>
                                        <option value="Aur">Szekeres</option>
                                        <option value="Boo">Ökörhajcsár</option>
                                        <option value="Cnc">Rák</option>
                                        <option value="CMa">Nagy Kutya</option>
                                        <option value="CMi">Kis Kutya</option>
                                        <option value="Cap">Bak</option>
                                        <option value="Cas">Kassziopeia</option>
                                        <option value="Cep">Cefeusz</option>
                                        <option value="Cet">Cethal</option>
                                        <option value="Cyg">Hattyú</option>
                                        <option value="Dra">Sárkány</option>
                                        <option value="Gem">Ikrek</option>
                                        <option value="Her">Herkules</option>
                                        <option value="Hya">Északi Vízikígyó</option>
                                        <option value="Leo">Oroszlán</option>
                                        <option value="Lib">Mérleg</option>
                                        <option value="Lyr">Lant</option>
                                        <option value="Mon">Egyszarvú</option>
                                        <option value="Oph">Kígyótartó</option>
                                        <option value="Ori">Orion</option>
                                        <option value="Peg">Pegazus</option>
                                        <option value="Per">Perszeusz</option>
                                        <option value="Psc">Halak</option>
                                        <option value="Sgr">Nyilas</option>
                                        <option value="Sco">Skorpió</option>
                                        <option value="Tau">Bika</option>
                                        <option value="UMa">Nagy Medve</option>
                                        <option value="UMi">Kis Medve</option>
                                        <option value="Vir">Szűz</option>
                                        <!-- Továbbiak igény szerint... -->
                                    </select>
                                </div>

                                <!-- 2. AKTÍV KIEMELÉSEK LISTÁJA (Csak akkor látszik, ha van) -->
                                <div id="active-highlights-container" style="display:none; margin-bottom: 10px;">
                                    <label style="font-size:11px; color:#aaa; margin-bottom:5px; display:block;">Aktív
                                        kiemelések (Kattints a szerkesztéshez):</label>
                                    <div id="active-highlights-list"
                                        style="display:flex; flex-direction:column; gap:5px;">
                                    </div>
                                </div>

                                <!-- 3. SZERKESZTŐ PANEL (Csak kiválasztáskor látszik) -->
                                <div id="hl-settings-panel" class="settings-panel"
                                    style="display:none; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-top: 10px; position:relative;">
                                    <div
                                        style="margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                                        <span id="hl-editing-title"
                                            style="color: var(--accent-cyan); font-weight:bold; font-size:13px;">Szerkesztés...</span>
                                        <button onclick="closeHighlightSettings()"
                                            style="background:none; border:none; color:#aaa; cursor:pointer; font-size:16px; padding:0;">×</button>
                                    </div>

                                    <div class="setting-group">
                                        <label>Szín:</label>
                                        <input type="color" id="hl-color" value="#ffcc00">
                                    </div>

                                    <div class="grid-2-cols" style="margin-top: 5px;">
                                        <div>
                                            <label>Vastagság:</label>
                                            <input type="number" id="hl-width" value="3" min="0.5" step="0.5">
                                        </div>
                                        <div>
                                            <label>Áttetszőség:</label>
                                            <input type="number" id="hl-opacity" value="1" min="0" max="1" step="0.1">
                                        </div>
                                    </div>

                                    <label
                                        style="margin-top: 8px; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="hl-dash-check">
                                        Szaggatott vonal
                                    </label>

                                    <div id="hl-dash-settings"
                                        style="display:none; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; margin-top: 5px;">
                                        <div class="grid-2-cols" style="gap: 5px;">
                                            <label style="font-size: 11px;">Vonal (px): <input type="number"
                                                    id="hl-dash-1" value="4" min="0" style="width: 100%;"></label>
                                            <label style="font-size: 11px;">Szünet (px): <input type="number"
                                                    id="hl-dash-2" value="4" min="0" style="width: 100%;"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-2">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="milkyway-settings">
                            <h2>🌌 TEJÚT</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div>
                        <div class="collapsible-content" id="milkyway-settings">
                            <div class="section">
                                <label><input id="mw_show" type="checkbox" checked> Tejút megjelenítése</label>
                                <div id="mw_show_settings" class="settings-panel">
                                    <label for="mw_style_fill">Szín</label>
                                    <input id="mw_style_fill" type="color" value="#ffffff">
                                    <label for="mw_style_opacity">Áttetszőség</label>
                                    <input id="mw_style_opacity" type="number" min="0.01" max="1" step="0.01"
                                        value="0.15">
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-header" data-target="sky-settings">
                            <h2>🌌 ÉGBOLT</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div>
                        <div class="collapsible-content" id="sky-settings">
                            <div class="section settings-panel">
                                <label for="background_fill">Ég színe</label>
                                <input id="background_fill" type="color" value="#000000">
                                <label for="background_opacity">Áttetszőség</label>
                                <input id="background_opacity" type="number" min="0.01" max="1" step="0.01" value="1">
                                <label for="background_stroke">Körvonal színe</label>
                                <input id="background_stroke" type="color" value="#FFFFFF">
                                <label for="background_stroke_width">Körvonal vastagsága</label>
                                <input id="background_stroke_width" type="number" min="0" max="100" step="0.1"
                                    value="1.5">
                                <label style="margin-top: 8px; display: flex; align-items: center; cursor: pointer;">
                                    <input id="background_stroke_dash_check" type="checkbox"> Szaggatott körvonal
                                </label>
                                <div id="background_stroke_dash_settings"
                                    style="display:none; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;">
                                    <div class="grid-2-cols" style="gap: 5px;">
                                        <label style="font-size: 11px;">Vonal (px): <input type="number"
                                                id="background_stroke_dash_1" value="4" min="0"
                                                style="width: 100%;"></label>
                                        <label style="font-size: 11px;">Szünet (px): <input type="number"
                                                id="background_stroke_dash_2" value="4" min="0"
                                                style="width: 100%;"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-3">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="constellation-settings">
                            <h2>✨ CSILLAGKÉPEK</h2>
                            <span class="collapsible-icon">▼</span>
                        </div>
                        <div class="collapsible-content" id="constellation-settings">
                            <div class="section">
                                <label><input id="const_show" type="checkbox" checked>Csillagképek vonalai</label>
                                <div id="const_show_settings" class="settings-panel">

                                    <label for="constellation_lineStyle_opacity">Áttetszőség</label>
                                    <input id="constellation_lineStyle_opacity" type="number" min="0.01" max="1"
                                        step="0.01" value="0.6">
                                    <label for="constellation_lineStyle_stroke">Vonalak színe</label>
                                    <input id="constellation_lineStyle_stroke" type="color" value="#cccccc">
                                    <label for="constellation_lineStyle_stroke_width">Vonalak vastagsága</label>
                                    <input id="constellation_lineStyle_stroke_width" type="number" min="0" max="100"
                                        step="0.1" value="1.5">
                                    <label
                                        style="margin-top: 8px; display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="constellation_lineStyle_dash_check">
                                        Szaggatott vonalak
                                    </label>
                                    <div id="constellation_lineStyle_dash_settings"
                                        style="display:none; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;">
                                        <div class="grid-2-cols" style="gap: 5px;">
                                            <label style="font-size: 11px;">Vonal (px): <input type="number"
                                                    id="constellation_lineStyle_dash_1" value="4" min="0"
                                                    style="width: 100%;"></label>
                                            <label style="font-size: 11px;">Szünet (px): <input type="number"
                                                    id="constellation_lineStyle_dash_2" value="4" min="0"
                                                    style="width: 100%;"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="collapsible-header" data-target="stars-settings">
                            <h2>⭐ CSILLAGOK</h2>
                            <span class="collapsible-icon">▼</span>
                        </div>
                        <div class="collapsible-content" id="stars-settings">
                            <div class="section">
                                <label><input type="checkbox" id="stars_show" checked> Csillagok megjelenítése</label>
                                <div id="stars_show_settings" class="settings-panel">
                                    <label>Fényesség limit</label>
                                    <input id="stars_limit" type="number" min="0" max="6" step="0.1" value="6">
                                    <label>Méret</label>
                                    <input id="stars_size" type="number" value="7" min="5" max="100" step="0.1">
                                    <label>Kitevő</label>
                                    <input id="stars_exponent" type="number" value="-0.28" min="-1" max="3" step="0.01">

                                    <label><input type="checkbox" id="stars_colors" checked> Színes csillagok</label>
                                    <div id="stars_colors_settings" style="display: none">
                                        <label for="stars_style_fill">Csillagok színe</label>
                                        <input id="stars_style_fill" type="color" value="#FFFFFF">
                                        <label for="stars_style_opacity">Csillagok áttetszősége</label>
                                        <input id="stars_style_opacity" type="number" value="1" min="0" max="1"
                                            step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fragment-4">

                    <div class="designer-controls">
                        <div id="graticule-wrapper">
                            <div class="collapsible-header" data-target="graticule-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding:0px">
                                    <input id="lines_graticule" type="checkbox" checked>
                                    <span style="margin-left: 10px;">⚪ Fokhálózat</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon">▼</i></span>
                            </div>
                            <div class="collapsible-content" id="graticule-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_graticule_color">Szín</label>
                                        <input id="lines_graticule_color" type="color" value="#cccccc">
                                        <label for="lines_graticule_size">Vastagság</label>
                                        <input id="lines_graticule_size" type="number" min="0.1" max="6" step="0.1"
                                            value="0.6">
                                        <label for="lines_graticule_opacity">Áttetszőség</label>
                                        <input id="lines_graticule_opacity" type="number" min="0.01" max="1" step="0.01"
                                            value="0.8">
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div id="equatorial-wrapper">
                            <div class="collapsible-header collapsed" data-target="equatorial-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_equatorial" type="checkbox">
                                    <span style="margin-left: 10px;">⚪️ Egyenlítői</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">▼</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="equatorial-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_equatorial_color">Szín</label>
                                        <input id="lines_equatorial_color" type="color" value="#aaaaaa">
                                        <label for="lines_equatorial_size">Vastagság</label>
                                        <input id="lines_equatorial_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_equatorial_opacity">Áttetszőség</label>
                                        <input id="lines_equatorial_opacity" type="number" min="0.01" max="1"
                                            step="0.01" value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="ecliptic-wrapper">
                            <div class="collapsible-header collapsed" data-target="ecliptic-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_ecliptic" type="checkbox">
                                    <span style="margin-left: 10px;">🟢 Ekliptika</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">▼</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="ecliptic-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_ecliptic_color">Szín</label>
                                        <input id="lines_ecliptic_color" type="color" value="#66cc66">
                                        <label for="lines_ecliptic_size">Vastagság</label>
                                        <input id="lines_ecliptic_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_ecliptic_opacity">Áttetszőség</label>
                                        <input id="lines_ecliptic_opacity" type="number" min="0.01" max="1" step="0.01"
                                            value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="galactic-wrapper">
                            <div class="collapsible-header collapsed" data-target="galactic-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_galactic" type="checkbox">
                                    <span style="margin-left: 10px;">🔴 Galaktikus</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">▼</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="galactic-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_galactic_color">Szín</label>
                                        <input id="lines_galactic_color" type="color" value="#cc6666">
                                        <label for="lines_galactic_size">Vastagság</label>
                                        <input id="lines_galactic_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_galactic_opacity">Áttetszőség</label>
                                        <input id="lines_galactic_opacity" type="number" min="0.01" max="1" step="0.01"
                                            value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="supergalactic-wrapper">
                            <div class="collapsible-header collapsed" data-target="supergalactic-section"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="header-label"
                                    style="flex-grow: 1; cursor: pointer; display: flex; align-items: center; margin: 0;padding: 0px">
                                    <input id="lines_supergalactic" type="checkbox">
                                    <span style="margin-left: 10px;">🟣 Szupergalaktikus</span>
                                </label>
                                <span class="collapsible-icon" style="padding: 0px; cursor: pointer;"><i
                                        class="collapsible-icon-icon" style="transform: rotate(-90deg);">▼</i></span>
                            </div>
                            <div class="collapsible-content collapsed" id="supergalactic-section">
                                <div class="section">
                                    <div class="settings-panel">
                                        <label for="lines_supergalactic_color">Szín</label>
                                        <input id="lines_supergalactic_color" type="color" value="#cc66cc">
                                        <label for="lines_supergalactic_size">Vastagság</label>
                                        <input id="lines_supergalactic_size" type="number" min="0.1" max="6" step="0.1"
                                            value="1.3">
                                        <label for="lines_supergalactic_opacity">Áttetszőség</label>
                                        <input id="lines_supergalactic_opacity" type="number" min="0.01" max="1"
                                            step="0.01" value="0.7">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- <div id="fragment-5">
                    <div class="designer-controls">
                                <div class="collapsible-header" data-target="theme-settings">
                                    <h2>🎨 Témák (Presets)</h2>
                                    <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                                </div>
                                <div class="collapsible-content" id="theme-settings">
                                    <div class="section">
                                        <div style="margin-top: 10px;">
                                            <button onclick="downloadAllThemesSequence()" class="add-btn accent" style="width: 100%; background: #b24aff;">
                                                🤖 Összes Téma Képének Generálása & Letöltése
                                            </button>
                                        </div>
                                        <div style="margin-top: 10px; margin-bottom: 10px;">
                                            <button onclick="restoreUserState()" class="add-btn accent" style="width: 100%; background: #546e7a;">
                                                ↺ Saját Beállítások Visszaállítása
                                            </button>
                                        </div>
                                        <div class="theme-grid" id="theme-grid-container"></div>
                                        
                                        <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                                            <button onclick="downloadAllThemesSequence()" class="add-btn accent" style="width: 100%; background: #b24aff;">
                                                📸 Thumbnail Generátor Indítása
                                            </button>
                                            <p style="font-size:10px; color:#aaa; text-align:center; margin-top:5px;">
                                                A letöltött képeket másold be az <b>images/themes/</b> mappába!
                                            </p>
                                        </div>

                                    </div>
                                </div>
                    </div>
                </div> -->
                <div id="fragment-5">
                    <div class="designer-controls">
                        <div class="collapsible-header" data-target="theme-settings-left">
                            <h2>🎨 Témák (Presets)</h2>
                            <span class="collapsible-icon"><i class="collapsible-icon-icon">▼</i></span>
                        </div>
                        <div class="collapsible-content" id="theme-settings-left">
                            <div class="section">
                                <div
                                    style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--accent-blue); background: rgba(0,0,0,0.2); border-radius: 8px;">
                                    <label
                                        style="display:block; font-weight:bold; color: var(--accent-cyan); margin-bottom: 8px; font-size: 11px;">
                                        ALKALMAZÁS MÓDJA:
                                    </label>

                                    <label
                                        style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-left" value="global" checked
                                            style="margin-right: 8px;">
                                        <span>🌍 Teljes vászonkép (Minden elem)</span>
                                    </label>

                                    <label
                                        style="display:flex; align-items:center; margin-bottom: 5px; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-left" value="local"
                                            style="margin-right: 8px;">
                                        <span>🖼️ Csak a kiválasztott kép (Háttérrel)</span>
                                    </label>

                                    <label style="display:flex; align-items:center; cursor: pointer; font-size: 12px;">
                                        <input type="radio" name="bg-mode-left" value="none" style="margin-right: 8px;">
                                        <span>🚫 Csak a kiválasztott csillagtérkép (Stílus)</span>
                                    </label>
                                </div>

                                <div style="margin-top: 10px; margin-bottom: 10px;">
                                    <button onclick="restoreUserState()" class="add-btn accent"
                                        style="width: 100%; background: #546e7a;">
                                        ↺ Saját Beállítások Visszaállítása
                                    </button>
                                </div>

                                <div class="theme-grid" id="theme-grid-container-left"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="fragment-6">
                    <p style="text-align: center; padding: 50px; color: var(--text-secondary);">A Tervező felület
                        megnyílt a teljes képernyőn.</p>
                </div>

            </div>
        </div>
    </div>
    <div id="cropper-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:white;">Kép méretre vágása</h3>
            <div class="img-container">
                <img id="image-to-crop" src="" alt="Kép vágása">
            </div>
            <div class="grid-2-cols">
                <button onclick="closeCropper()" class="add-btn secondary">Mégse</button>
                <button onclick="performCrop()" class="add-btn primary">✂️ Kivágás & Hozzáadás</button>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="celestial_jo_uj_lassankesz_rov_2_cc.js"></script>

    <script type="text/javascript">
        var szivszoge = 2.4;
        var szivratioja = 0.88;
        $("#tabs").tabs();
        $("#tabs_left").tabs();
        $("#tabs_r").tabs();
        $(document).on('change', '#szivszoge', function (e) {
            szivszoge = $(this).val();
            console.log("szivszoge", szivszoge);
            Celestial.projections().customHeart = {
                arg: Math.PI / szivszoge, scale: 235, ratio: szivratioja
            };
            myCelestialConf.projection = "customHeart";
            console.log("myCelestialConf", myCelestialConf);
            changeProjection(myCelestialConf.projection);
        });
        function leftfrag(nr) {
            $("#tabs_left").tabs("option", "active", nr);
        }
        // --- 1. OKOS KEZELÉS: Ha a Checkbox/Label részre kattintunk ---
        // Logika: Pipa be -> Nyitás | Pipa ki -> Zárás
        $(document).on('click', '.header-label', function (e) {
            e.stopPropagation(); // Megállítjuk, hogy ne fusson le a sima toggle

            const header = $(this).closest('.collapsible-header');
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');
            const checkbox = $(this).find('input');

            // Pici késleltetés kell, hogy a böngésző frissítse a checkbox állapotát a kattintás után
            setTimeout(() => {
                const isChecked = checkbox.is(':checked');

                if (isChecked) {
                    // HA BEPIPÁLTUK -> MINDENKÉPP NYITÁS
                    if (header.hasClass('collapsed')) {
                        header.removeClass('collapsed');
                        content.removeClass('collapsed').slideDown(300);
                        icon.css('transform', 'rotate(0deg)');
                    }
                } else {
                    // HA KIVETTÜK A PIPÁT -> MINDENKÉPP ZÁRÁS
                    if (!header.hasClass('collapsed')) {
                        header.addClass('collapsed');
                        content.addClass('collapsed').slideUp(300);
                        icon.css('transform', 'rotate(-90deg)');
                    }
                }
            }, 20);
        });

        // --- 2. ÁLTALÁNOS KEZELÉS: Csak a nyílra (vagy üres helyre) kattintva ---
        // Logika: Sima váltás (Toggle), függetlenül a pipától
        $(document).on('click', '.collapsible-header', function () {
            const header = $(this);
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');

            // Sima váltás (Toggle)
            if (header.hasClass('collapsed')) {
                // Nyitás
                header.removeClass('collapsed');
                content.removeClass('collapsed').slideDown(300);
                icon.css('transform', 'rotate(0deg)');
            } else {
                // Zárás
                header.addClass('collapsed');
                content.addClass('collapsed').slideUp(300);
                icon.css('transform', 'rotate(-90deg)');
            }
        });

        // --- 1. EGYESÍTETT TÉMA ADATBÁZIS (Config + Háttér) ---
        const mapThemes = {
            "midnight": {
                name: "Midnight Blue",
                // Ez a background megy a #map-wrap-re és a Designer-re is:
                image: "images/themes/thumb_midnight.png",
                background: "linear-gradient(135deg, #0B1026 0%, #1a2542 100%)",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#0B1026", opacity: 1, stroke: "#ffffff", width: 2, dash: [null, null] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6, size: 7, exponent: -0.28, colors: true },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#4a9eff", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#2c3e50", opacity: 0.6, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.12 } }
                }
            },
            "minimal": {
                name: "Clean White",
                image: "images/themes/thumb_minimal.png",
                background: "#ffffff",
                textColor: "#000000",
                config: {
                    background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3, dash: [null, null] },
                    stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5, size: 7, exponent: -0.28, colors: true },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#333333", width: 1.5, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#cccccc", opacity: 0.5, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
                }
            },
            "vintage": {
                name: "Vintage Paper",
                image: "images/themes/thumb_vintage.png",
                background: "#f0e6d2",
                textColor: "#4a3b2a",
                config: {
                    background: { fill: "#f0e6d2", opacity: 1, stroke: "#8b5a2b", width: 4, dash: [null, null] },
                    stars: { show: true, style: { fill: "#4a3b2a", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#8b5a2b", width: 1.5, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#a67c52", opacity: 0.4, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#4a3b2a", opacity: 0.08 } }
                }
            },
            "cosmic": {
                name: "Cosmic Love",
                image: "images/themes/thumb_cosmic.png",
                background: "linear-gradient(135deg, #2d0a1e 0%, #4a1230 100%)",
                textColor: "#ffb7c5",
                config: {
                    background: { fill: "#2d0a1e", opacity: 1, stroke: "#ffb7c5", width: 1.5, dash: [null, null] },
                    stars: { show: true, style: { fill: "#ffb7c5", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9eb5", width: 1.3, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#804060", opacity: 0.4, width: 1.5, dash: [0, 0] } },
                    mw: { show: true, style: { fill: "#ffb7c5", opacity: 0.15 } }
                }
            },
            "forest": {
                name: "Forest Night",
                image: "images/themes/thumb_forest.png",
                background: "#0a220a",
                textColor: "#e8f5e9",
                config: {
                    background: { fill: "#0a220a", opacity: 1, stroke: "#8fbc8f", width: 2 },
                    stars: { show: true, style: { fill: "#e8f5e9", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#8fbc8f", width: 1.2, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#1e3b1e", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#8fbc8f", opacity: 0.1 } }
                }
            },
            "monochrome": {
                name: "Mono Charcoal",
                image: "images/themes/thumb_monochrome.png",
                // style: "background: #222222; color: #ffffff;",
                background: "#222222",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#222222", opacity: 1, stroke: "#555555", width: 1 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 5.8 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#999999", width: 1, opacity: 0.9, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#444444", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.08 } }
                }
            },
            "golden": {
                name: "Golden Hour",
                image: "images/themes/thumb_golden.png",
                background: "#4a2511",
                textColor: "#ffcc00",
                config: {
                    background: { fill: "#4a2511", opacity: 1, stroke: "#ffcc00", width: 2.5 },
                    stars: { show: true, style: { fill: "#ffffcc", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.4, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#7a4521", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffcc00", opacity: 0.15 } }
                }
            },
            "ocean": {
                name: "Deep Ocean",
                image: "images/themes/thumb_ocean.png",
                background: "linear-gradient(to bottom, #001f3f 0%, #003366 100%)",
                textColor: "#7FDBFF",
                config: {
                    background: { fill: "#001f3f", opacity: 1, stroke: "#7FDBFF", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#7FDBFF", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#39CCCC", opacity: 0.3, width: 1.5 } },
                    mw: { show: true, style: { fill: "#7FDBFF", opacity: 0.1 } }
                }
            },
            "matrix": {
                name: "Cyber Matrix",
                image: "images/themes/thumb_matrix.png",
                // style: "background: #000000; color: #00ff00; border: 1px solid #00ff00;",
                background: "#000000",
                textColor: "#00ff00",
                config: {
                    background: { fill: "#000000", opacity: 1, stroke: "#00ff00", width: 1.5 },
                    stars: { show: true, style: { fill: "#ccffcc", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#00ff00", width: 1.2, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#003300", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#00ff00", opacity: 0.05 } }
                }
            },
            "aurora": {
                name: "Northern Lights",
                image: "images/themes/thumb_aurora.png",
                // style: "background: #022c22; color: #6ee7b7;",
                background: "linear-gradient(135deg, #022c22 0%, #064e3b 100%)",
                textColor: "#6ee7b7",
                config: {
                    background: { fill: "#022c22", opacity: 1, stroke: "#34d399", width: 2 },
                    stars: { show: true, style: { fill: "#d1fae5", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#10b981", width: 1.3, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#064e3b", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#34d399", opacity: 0.15 } }
                }
            },
            "royal": {
                name: "Royal Amethyst",
                image: "images/themes/thumb_royal.png",
                // style: "background: #240046; color: #ff9e00;",
                background: "linear-gradient(135deg, #240046 0%, #3c096c 100%)",
                textColor: "#ff9e00",
                config: {
                    background: { fill: "#240046", opacity: 1, stroke: "#ff9e00", width: 2 },
                    stars: { show: true, style: { fill: "#e0aaff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff9e00", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#5a189a", opacity: 0.4, width: 1.5 } },
                    mw: { show: true, style: { fill: "#e0aaff", opacity: 0.12 } }
                }
            },
            "sweetheart": {
                name: "Sweetheart",
                image: "images/themes/thumb_sweetheart.png",
                background: "linear-gradient(135deg, #ffe4e1 0%, #ffc0cb 100%)",
                textColor: "#ff1493",
                config: {
                    background: { fill: "#ffe4e1", opacity: 1, stroke: "#ff1493", width: 2.5 },
                    stars: { show: true, style: { fill: "#ff69b4", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ff1493", width: 1.5, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#ffb6c1", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ff1493", opacity: 0.05 } }
                }
            },
            "redvelvet": {
                name: "Red Velvet",
                image: "images/themes/thumb_redvelvet.png",
                background: "linear-gradient(135deg, #4a0404 0%, #6d0707 100%)",
                textColor: "#ffd700",
                config: {
                    background: { fill: "#4a0404", opacity: 1, stroke: "#ffd700", width: 1.5 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1.2, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#800000", opacity: 0.6, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffd700", opacity: 0.1 } }
                }
            },
            "rosegold": {
                name: "Rose Gold",
                image: "images/themes/thumb_rosegold.png",
                background: "#fff0f5",
                textColor: "#b76e79",
                config: {
                    background: { fill: "#fff0f5", opacity: 1, stroke: "#b76e79", width: 3 },
                    stars: { show: true, style: { fill: "#b76e79", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#b76e79", width: 1.5, opacity: 0.9, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#e6e6fa", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#b76e79", opacity: 0.05 } }
                }
            },
            // --- ÚJ MONOKRÓM TÉMÁK ---
            "ink": {
                name: "Tinta (Fekete-Fehér)",
                image: "images/themes/thumb_ink.png", // Generáld le hozzá a képet!
                background: "#ffffff",
                textColor: "#000000",
                config: {
                    background: { fill: "#ffffff", opacity: 1, stroke: "#000000", width: 3 },
                    stars: { show: true, style: { fill: "#000000", opacity: 1 }, limit: 5.5 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#000000", width: 1.5, opacity: 1, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#dddddd", opacity: 0.8, width: 1.5 } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.03 } }
                }
            },
            "slate": {
                name: "Palatábla (Krétarajz)",
                image: "images/themes/thumb_slate.png",
                background: "#2b2b2b",
                textColor: "#f0f0f0",
                config: {
                    background: { fill: "#2b2b2b", opacity: 1, stroke: "#ffffff", width: 2 },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffffff", width: 1.2, opacity: 0.7, dash: [8, 8] } },
                    lines: { graticule: { show: true, stroke: "#555555", opacity: 0.5, width: 1.5 } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.1 } }
                },
            },
            "silhouette": {
                name: "Sziluett (Silhouette)",
                image: "images/themes/thumb_silhouette.png",
                background: "#000000",
                textColor: "#ffffff",
                config: {
                    background: { fill: "#000000", opacity: 1, stroke: "#ffffff", width: 1, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffffff", width: 1, opacity: 0.5, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#333333", opacity: 0.5, width: 1, dash: [2, 2] } },
                    mw: { show: true, style: { fill: "#ffffff", opacity: 0.15 } }
                }
            },
            "foggy": {
                name: "Ködös Reggel (Foggy)",
                image: "images/themes/thumb_foggy.png",
                background: "#e0e0e0",
                textColor: "#333333",
                config: {
                    background: { fill: "#e0e0e0", opacity: 1, stroke: "#555555", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#333333", opacity: 1 }, limit: 5.8 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#555555", width: 1.2, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#ffffff", opacity: 0.6, width: 1.5, dash: [] } },
                    mw: { show: true, style: { fill: "#000000", opacity: 0.05 } }
                }
            },

            // --- SZERELMES TÉMÁK ---
            "blush": {
                name: "Rózsaszín Álom (Blush)",
                image: "images/themes/thumb_blush.png",
                background: "linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%)",
                textColor: "#d81b60",
                config: {
                    background: { fill: "#fff0f5", opacity: 1, stroke: "#d81b60", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#d81b60", opacity: 0.8 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d81b60", width: 1.5, opacity: 0.5, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#ffc0cb", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#d81b60", opacity: 0.05 } }
                }
            },
            "passion": {
                name: "Szenvedély (Passion)",
                image: "images/themes/thumb_passion.png",
                background: "linear-gradient(135deg, #4a0000 0%, #2a0000 100%)",
                textColor: "#ffcc00",
                config: {
                    background: { fill: "#4a0000", opacity: 1, stroke: "#ff0000", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#ffcc00", width: 1.2, opacity: 0.8, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#800000", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#ff0000", opacity: 0.1 } }
                }
            },

            // --- ELEGÁNS TÉMÁK ---
            "royal_gold": {
                name: "Királyi Arany (Royal)",
                image: "images/themes/thumb_royalgold.png",
                background: "#051e3e",
                textColor: "#d4af37",
                config: {
                    background: { fill: "#051e3e", opacity: 1, stroke: "#d4af37", width: 3, dash: [] },
                    stars: { show: true, style: { fill: "#d4af37", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#d4af37", width: 1, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#1a3a6e", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#d4af37", opacity: 0.1 } }
                }
            },
            "silver": {
                name: "Ezüstös (Silver)",
                image: "images/themes/thumb_silver.png",
                background: "linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%)",
                textColor: "#2c3e50",
                config: {
                    background: { fill: "#e6e9f0", opacity: 1, stroke: "#bdc3c7", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#2c3e50", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#7f8c8d", width: 1.2, opacity: 0.8, dash: [2, 2] } },
                    lines: { graticule: { show: true, stroke: "#ecf0f1", opacity: 1, width: 1.5, dash: [] } },
                    mw: { show: true, style: { fill: "#2c3e50", opacity: 0.05 } }
                }
            },
            "emerald": {
                name: "Smaragd (Emerald)",
                image: "images/themes/thumb_emerald.png",
                background: "#064e3b",
                textColor: "#d1fae5",
                config: {
                    background: { fill: "#064e3b", opacity: 1, stroke: "#34d399", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#ffffff", opacity: 0.9 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#34d399", width: 1.3, opacity: 0.6, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#047857", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#34d399", opacity: 0.1 } }
                }
            },
            "copper": {
                name: "Réz & Bronz (Copper)",
                image: "images/themes/thumb_copper.png",
                background: "#2a1b15",
                textColor: "#e2a07d",
                config: {
                    background: { fill: "#2a1b15", opacity: 1, stroke: "#cd7f32", width: 2, dash: [] },
                    stars: { show: true, style: { fill: "#e2a07d", opacity: 1 }, limit: 6 },
                    constellations: { show: false, lines: true, lineStyle: { stroke: "#cd7f32", width: 1.2, opacity: 0.7, dash: [0, 0] } },
                    lines: { graticule: { show: true, stroke: "#5c3a2e", opacity: 0.5, width: 1, dash: [] } },
                    mw: { show: true, style: { fill: "#e2a07d", opacity: 0.1 } }
                }
            }
        };

        // --- 2. SAJÁT BEÁLLÍTÁSOK MENTÉSE (OBJECTBE) ---
        let userSavedState = null;
        let activeThemeKey = "custom";
        let activeVariant = "normal";

        // --- MENTÉS FRISSÍTÉSE ---
        function saveUserState() {
            if (activeThemeKey !== 'custom') return;
            console.log("function saveUserState() {");
            if (typeof initUserData === 'function' && (!myCelestialConf || !myCelestialConf.userData)) {
                initUserData();
            }

            // --- JAVÍTOTT KÓD KEZDETE ---
            // Mentsünk mindent, ami a vizualitáshoz kell (gradiens háttér, fal színe)
            const currentVisualBackground = document.getElementById('designer-svg') ?
                (document.getElementById('designer-svg').style.background || document.getElementById('designer-svg').style.backgroundColor) :
                $("#background_fill").val();

            userSavedState = {
                config: JSON.parse(JSON.stringify(myCelestialConf)),
                userData: JSON.parse(JSON.stringify(myCelestialConf.userData)),
                highlights: JSON.parse(JSON.stringify(Celestial.highlightList || {})),

                // EXTRA META ADATOK A TELJES VISSZAÁLLÍTÁSHOZ
                meta: {
                    activeTheme: activeThemeKey,
                    visualBackground: currentVisualBackground, // Ez tárolja a gradienst is!
                    wallColor: $("#wall-bg-color").val(),      // Fal színe
                    timestamp: Date.now()
                }
            };
            // --- JAVÍTOTT KÓD VÉGE ---

            console.log("Saját beállítások (MINDEN) elmentve:", userSavedState);
        }
        // --- JAVÍTOTT VISSZAÁLLÍTÁS (HÁTTÉRREL EGYÜTT) ---
        function restoreUserState() {
            if (!userSavedState) {
                alert("Nincs elmentett saját beállítás!");
                return;
            }
            console.log("function restoreUserState() {");
            console.log("Saját beállítások visszaállítása...");
            // --- JAVÍTOTT KÓD KEZDETE ---
            // 1. Config visszaállítása
            myCelestialConf = JSON.parse(JSON.stringify(userSavedState.config));
            activeThemeKey = userSavedState.meta ? userSavedState.meta.activeTheme : "custom";
            activeVariant = "normal";
            // --- JAVÍTOTT KÓD VÉGE ---
            console.log("function restoreUserState() { myCelestialConf", myCelestialConf);

            // 2. UI INPUTOK SZINKRONIZÁLÁSA
            // Tejút
            $("#mw_style_fill").val(myCelestialConf.mw.style.fill);
            $("#mw_style_opacity").val(myCelestialConf.mw.style.opacity);
            $("#mw_show").prop('checked', myCelestialConf.mw.show);


            // --- DASH checkboxok frissítése a téma alapján ---
            // 1. Háttér (Körvonal)
            var bgDash = myCelestialConf.background.dash; // Ez egy tömb, pl. [4, 4] vagy []
            var hasBgDash = bgDash && bgDash.length > 0;

            // Checkbox beállítása
            $("#background_stroke_dash_check").prop('checked', hasBgDash);

            // Panel nyitása/csukása és értékek beírása
            if (hasBgDash) {
                $("#background_stroke_dash_settings").slideDown();
                $("#background_stroke_dash_1").val(bgDash[0]); // Vonal hossza
                $("#background_stroke_dash_2").val(bgDash[1]); // Szünet hossza
            } else {
                $("#background_stroke_dash_settings").slideUp();
            }
            // 2. Csillagképek
            var constDash = myCelestialConf.constellations.lineStyle.dash;
            var hasConstDash = constDash && constDash.length > 0;

            $("#constellation_lineStyle_dash_check").prop('checked', hasConstDash);
            if (hasConstDash) {
                $("#constellation_lineStyle_dash_settings").slideDown();
                $("#constellation_lineStyle_dash_1").val(constDash[0]);
                $("#constellation_lineStyle_dash_2").val(constDash[1]);
            } else {
                $("#constellation_lineStyle_dash_settings").slideUp();
            }
            // 3. Fokhálózat (Graticule)
            var gratDash = myCelestialConf.lines.graticule.dash;
            var hasGratDash = gratDash && gratDash.length > 0;

            $("#lines_graticule_dash_check").prop('checked', hasGratDash);
            if (hasGratDash) {
                $("#lines_graticule_dash_settings").slideDown();
                $("#lines_graticule_dash_1").val(gratDash[0]);
                $("#lines_graticule_dash_2").val(gratDash[1]);
            } else {
                $("#lines_graticule_dash_settings").slideUp();
            }


            // Tejút
            if (myCelestialConf.mw.show) $("#mw_show_settings").slideDown(); else $("#mw_show_settings").slideUp();


            // Háttér INPUTOK
            $("#background_fill").val(myCelestialConf.background.fill);
            $("#background_opacity").val(myCelestialConf.background.opacity);
            $("#background_stroke").val(myCelestialConf.background.stroke);
            $("#background_stroke_width").val(myCelestialConf.background.width);

            console.log("myCelestialConf.constellations.lineStyle.stroke", myCelestialConf.constellations.lineStyle.stroke);
            console.log("myCelestialConf.constellations.lineStyle.opacity", myCelestialConf.constellations.lineStyle.opacity);
            console.log("myCelestialConf.constellations.lineStyle.width", myCelestialConf.constellations.lineStyle.width);

            // --- JAVÍTOTT: Csillagképek UI visszaállítása (Tömbkezeléssel) ---
            var cStyle = myCelestialConf.constellations.lineStyle;

            // Szín, Áttetszőség, Vastagság: Ha tömb, akkor az első elemet vesszük
            var cStroke = Array.isArray(cStyle.stroke) ? cStyle.stroke[0] : cStyle.stroke;
            var cOpacity = Array.isArray(cStyle.opacity) ? cStyle.opacity[0] : cStyle.opacity;
            var cWidth = Array.isArray(cStyle.width) ? cStyle.width[0] : cStyle.width;

            $("#constellation_lineStyle_stroke").val(cStroke);
            $("#constellation_lineStyle_opacity").val(cOpacity);
            $("#constellation_lineStyle_stroke_width").val(cWidth);

            // Szaggatott vonalak (Dash)
            var cDash = cStyle.dash;
            // Ha a dash is tömbösítve lett (pl. [[4,4], [4,4], [4,4]]), akkor kivesszük az elsőt
            if (Array.isArray(cDash) && cDash.length > 0 && Array.isArray(cDash[0])) {
                cDash = cDash[0];
            }

            var hasConstDash = cDash && cDash.length > 0; // Most már sima tömb (pl. [4,4]) vagy null

            $("#constellation_lineStyle_dash_check").prop('checked', hasConstDash);
            if (hasConstDash) {
                $("#constellation_lineStyle_dash_settings").slideDown();
                $("#constellation_lineStyle_dash_1").val(cDash[0]);
                $("#constellation_lineStyle_dash_2").val(cDash[1]);
            } else {
                $("#constellation_lineStyle_dash_settings").slideUp();
            }

            $("#const_show").prop('checked', myCelestialConf.constellations.lines);
            // ------------------------------------------------------------------
            if (myCelestialConf.constellations.lines) $("#const_show_settings").slideDown(); else $("#const_show_settings").slideUp();

            // Csillagok
            $("#stars_limit").val(myCelestialConf.stars.limit);
            $("#stars_size").val(myCelestialConf.stars.size);
            $("#stars_style_fill").val(myCelestialConf.stars.style.fill);
            $("#stars_style_opacity").val(myCelestialConf.stars.style.opacity);
            $("#stars_show").prop('checked', myCelestialConf.stars.show);
            if (myCelestialConf.stars.show) $("#stars_show_settings").slideDown(); else $("#stars_show_settings").slideUp();

            // Rács
            $("#lines_graticule_color").val(myCelestialConf.lines.graticule.stroke);
            $("#lines_graticule_size").val(myCelestialConf.lines.graticule.width);
            $("#lines_graticule_opacity").val(myCelestialConf.lines.graticule.opacity);
            $("#lines_graticule").prop('checked', myCelestialConf.lines.graticule.show);

            // 3. Alkalmazás a térképre
            change(myCelestialConf);
            changeProjection(myCelestialConf.projection);

            // 4. HÁTTÉR VISSZAÁLLÍTÁSA (CSS + Rect) EZ LEHET NEM KELL
            // Ez a rész kezeli a szerkesztő (#map-wrap) és a tervező (#designer-svg) hátterét is
            if (userSavedState.background) {
                $("#map-wrap").css("background", userSavedState.background);
                $("#designer-svg").css("background", userSavedState.background);

                // Export rect kezelése
                if (window.updateCanvasBackground) {
                    window.updateCanvasBackground(userSavedState.background);
                }
            }

            // 3. Alkalmazás a térképre
            // change(myCelestialConf);
            // changeProjection(myCelestialConf.projection);

            // --- JAVÍTOTT KÓD KEZDETE ---
            // 4. HÁTTÉR ÉS FAL VISSZAÁLLÍTÁSA
            // Ha van meta adatunk, használjuk azt, mert az pontosabb (gradiens)
            let bgToRestore = userSavedState.meta && userSavedState.meta.visualBackground ?
                userSavedState.meta.visualBackground :
                (userSavedState.background || "#000000");

            $("#map-wrap").css("background", bgToRestore);
            $("#designer-svg").css("background", bgToRestore);

            if (window.updateCanvasBackground) {
                if (bgToRestore.includes("gradient")) {
                    document.getElementById('designer-svg').style.background = bgToRestore;
                } else {
                    window.updateCanvasBackground(bgToRestore);
                }
            }

            // Fal színe
            if (userSavedState.meta && userSavedState.meta.wallColor) {
                $("#wall-bg-color").val(userSavedState.meta.wallColor);
                if (typeof window.updateWallColor === 'function') {
                    window.updateWallColor(userSavedState.meta.wallColor);
                }
            }
            // --- JAVÍTOTT KÓD VÉGE ---

            // 5. Szövegek és Beállítások visszaállítása (JAVÍTOTT)
            if (userSavedState.userData) {
                // A teljes userData-t visszaállítjuk
                myCelestialConf.userData = JSON.parse(JSON.stringify(userSavedState.userData));

                // Frissítjük a nézeteket
                if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                if (typeof renderZoneUI === 'function') {
                    renderZoneUI('top');
                    renderZoneUI('bottom');
                }

                // Frissítjük a vászon méretét és a térkép pozícióját is az adatokból
                if (typeof window.updateCanvasSize === 'function') window.updateCanvasSize();
                if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
            }


            // 5. --- ÚJ: KIEMELÉSEK VISSZAÁLLÍTÁSA ---
            if (userSavedState.highlights) {
                Celestial.highlightList = JSON.parse(JSON.stringify(userSavedState.highlights));
                Celestial.redraw();
                renderActiveHighlights();

                // --- JAVÍTOTT KÓD KEZDETE ---
                if (typeof closeHighlightSettings === 'function') closeHighlightSettings(); // Panel bezárása
            } else {
                if (typeof Celestial.clearHighlights === 'function') Celestial.clearHighlights();
                if (typeof renderActiveHighlights === 'function') renderActiveHighlights();
            }
            // --- JAVÍTOTT KÓD VÉGE ---


            $('.theme-item').removeClass('active-theme');
            $('#custom-theme-card').addClass('active-theme');
            // --- ÚJ RÉSZ: Tervező nézet azonnali frissítése ---
            // Ez másolja át a helyreállított térképet a Tervezőbe
            setTimeout(function () {
                if (typeof window.copyMapToDesigner === 'function') {
                    window.copyMapToDesigner();
                }
                // Ez igazítja helyre a pozíciót és méretet
                if (typeof window.refreshMapTransform === 'function') {
                    window.refreshMapTransform();
                }
            }, 200); // Pici késleltetés, hogy a Celestial.redraw() biztosan végezzen
        }


        // --- ÚJ SEGÉDFÜGGVÉNY: Melyik háttér mód van kiválasztva? ---
        function getActiveBackgroundMode() {
            // 1. Megnézzük, melyik fül/panel látható éppen
            const isDesignerTabVisible = $("#tabs_r").is(":visible") && $("#fragment_r-5").is(":visible");
            const isEditorTabVisible = $("#fragment-5").is(":visible"); // Bal oldali panel

            let mode = 'global'; // Alapértelmezett

            if (isDesignerTabVisible) {
                // Ha a jobb oldali Tervező fülön vagyunk, olvassuk a 'bg-mode-right' rádiókat
                const radios = document.getElementsByName('bg-mode-right');
                for (let r of radios) if (r.checked) mode = r.value;
                console.log("Háttér mód (Designer panel):", mode);
            } else if (isEditorTabVisible) {
                // Ha a bal oldali Szerkesztő fülön vagyunk, olvassuk a 'bg-mode-left' rádiókat
                const radios = document.getElementsByName('bg-mode-left');
                for (let r of radios) if (r.checked) mode = r.value;
                console.log("Háttér mód (Editor panel):", mode);
            } else {
                // Ha egyik sem egyértelmű (pl. script hívja), megnézzük mindkettőt, 
                // és amelyik nem 'global', azt vesszük figyelembe (prioritás).
                const rRight = document.querySelector('input[name="bg-mode-right"]:checked');
                const rLeft = document.querySelector('input[name="bg-mode-left"]:checked');

                if (rRight && rRight.value !== 'global') mode = rRight.value;
                else if (rLeft && rLeft.value !== 'global') mode = rLeft.value;
            }

            return mode;
        }

        // --- ÚJ: Rádiógombok állapotának frissítése az elem típusa alapján ---
        // Fotó és Hold elemeknél a "Csak stílus" opció nem elérhető
        window.updateThemeModeRadioState = function () {
            if (!myCelestialConf.userData) return;

            const uiState = myCelestialConf.userData.uiState;
            const selectedId = uiState.selectedElementId;
            const selectedEl = myCelestialConf.userData.elements.find(e => e.id == selectedId);

            console.log(`🔘 updateThemeModeRadioState: selectedId=${selectedId}, type=${selectedEl ? selectedEl.type : 'N/A'}`);

            // Meghatározzuk, hogy térkép-e az elem
            const isMapElement = selectedEl && selectedEl.type === 'map';

            // Mindkét panel rádióinak kezelése
            const radioNames = ['bg-mode-left', 'bg-mode-right'];

            radioNames.forEach(radioName => {
                const radios = document.getElementsByName(radioName);
                radios.forEach(radio => {
                    if (radio.value === 'none') {
                        const label = radio.closest('label');
                        if (isMapElement) {
                            // Térkép - engedélyezve
                            radio.disabled = false;
                            if (label) {
                                label.style.opacity = '1';
                                label.style.cursor = 'pointer';
                                label.title = '';
                            }
                            console.log(`🔘 Enabled 'none' radio for ${radioName}`);
                        } else {
                            // Fotó/Hold - letiltva
                            radio.disabled = true;
                            if (label) {
                                label.style.opacity = '0.4';
                                label.style.cursor = 'not-allowed';
                                label.title = 'Ez az opció csak csillagtérképeknél elérhető';
                            }
                            console.log(`🔘 Disabled 'none' radio for ${radioName}`);

                            // Ha a 'none' volt kiválasztva, váltsunk 'global'-ra
                            if (radio.checked) {
                                const globalRadio = document.querySelector(`input[name="${radioName}"][value="global"]`);
                                if (globalRadio) {
                                    globalRadio.checked = true;
                                    console.log(`🔘 Switched from 'none' to 'global' for ${radioName}`);
                                }
                            }
                        }
                    }
                });
            });
        };

        function createCardHTML(key, theme, variant, sourceSide = 'right') {
            const isHeart = variant === 'heart';

            const card = document.createElement('div');
            card.className = 'theme-item';
            card.style.cursor = "pointer";

            // Fejléc (Név)
            const label = document.createElement('div');
            label.className = "theme-btn";
            label.dataset.key = key;
            label.dataset.variant = variant;

            // Szív ikon a névhez, ha szív mód
            label.innerText = isHeart ? `♥ ${theme.name}` : theme.name;

            // Stílusok
            label.style.background = isHeart ? "#ffebee" : "#fff"; // Halvány rózsaszín a szívnek
            label.style.color = isHeart ? "#d81b60" : "#000";

            // Kép (Preview)
            const preview = document.createElement('div');
            preview.className = 'theme-preview-img';

            // Kép URL manipuláció a szív verzióhoz
            let imgUrl = theme.image;
            if (isHeart && imgUrl) {
                // Feltételezzük, hogy van _heart végű kép, pl. thumb_midnight_heart.png
                // Ha nincs, a .replace nem rontja el, csak ha talál .png-t
                imgUrl = imgUrl.replace('.png', '_heart.png');
            }

            if (imgUrl) {
                preview.style.backgroundImage = `url('${imgUrl}')`;
                // Fallback: háttérszín + kép
                preview.style.background = `url('${imgUrl}') center/contain no-repeat, ${theme.background}`;
            } else {
                preview.style.background = theme.background;
            }

            card.appendChild(label);
            card.appendChild(preview);

            card.onclick = function () {
                loadTheme(key, variant, sourceSide);
            };

            return card;
        }
        // Segédfüggvény a kártya létrehozásához
        function createThemeCard(container, key, theme, variant) {
            const isHeart = (variant === 'heart');

            const card = document.createElement('div');
            card.className = 'theme-item';
            card.style.cursor = "pointer";
            card.style.background = "#fff";
            card.style.overflow = "hidden";
            card.style.borderRadius = "8px";
            card.style.border = "1px solid #ddd";

            // FEJLÉC
            const label = document.createElement('div');
            // Ha szív, tegyünk jelet a névhez
            label.innerText = isHeart ? `♥ ${theme.name}` : theme.name;
            label.className = "theme-btn";
            // Tároljuk az adatokat a gombban a kiválasztáshoz
            label.dataset.key = key;
            label.dataset.variant = variant;

            label.style.padding = "8px";
            label.style.textAlign = "center";
            label.style.fontSize = "13px";
            label.style.fontWeight = "bold";
            label.style.background = isHeart ? "#ffebee" : "#fff"; // Szívnél halvány rózsaszín fejléc
            label.style.color = isHeart ? "#d81b60" : "#000";
            label.style.borderBottom = "1px solid #eee";

            // KÉP (Preview)
            const preview = document.createElement('div');
            preview.className = 'theme-preview-img';

            // Kép URL logikája:
            // Normál: theme.image (pl. thumb_midnight.png)
            // Szív: theme.image cserélve (pl. thumb_midnight_heart.png)
            let imgUrl = theme.image;
            if (isHeart && imgUrl) {
                imgUrl = imgUrl.replace('.png', '_heart.png');
            }

            if (imgUrl) {
                // Background + Kép
                preview.style.background = `url('${imgUrl}') center/contain no-repeat, ${theme.background}`;
            } else {
                preview.style.background = theme.background;
            }

            preview.style.width = "100%";
            preview.style.height = "160px"; // Kicsit kisebb, hogy több kiférjen

            // Kattintás esemény
            card.onclick = function (e) {
                e.preventDefault();
                loadTheme(key, variant);
            };

            card.appendChild(label);
            card.appendChild(preview);
            container.appendChild(card);
        }

        // --- TÉMA BETÖLTÉS (A CORE FUNKCIÓ) ---
        // ============================================================
        // --- STABIL TÉMA BETÖLTÉS (ADAT MÓDOSÍTÁS -> RENDER SOR) ---
        // ============================================================
        window.loadTheme = function (key, variant = 'normal', sourceSide = 'right') {
            if (typeof window.logDebug !== 'function') {
                window.logDebug = function (msg) {
                    console.log("DEBUG_THEME: " + msg);
                    let dbg = document.getElementById('debug-theme-log');
                    if (!dbg) {
                        dbg = document.createElement('div');
                        dbg.id = 'debug-theme-log';
                        dbg.style.cssText = "position:fixed; top:0; left:0; width:400px; max-height:50vh; overflow:auto; background:rgba(0,0,0,0.85); color:#0f0; z-index:99999; font-family:monospace; font-size:11px; padding:5px; pointer-events:none;";
                        document.body.appendChild(dbg);
                    }
                    dbg.innerHTML += "<div>" + msg + "</div>";
                    dbg.scrollTop = dbg.scrollHeight;
                }
            }
            window.logDebug(`LOADTHEME CALLED: key=${key}, variant=${variant}, sourceSide=${sourceSide}`);

            console.log(`🎨 Téma kiválasztva: ${key} (${variant})`);

            if (!myCelestialConf.userData) initUserData();

            // 1. Melyik az aktív elem?
            const uiState = myCelestialConf.userData.uiState;
            let targetId = uiState.selectedElementId;
            let selectedEl = myCelestialConf.userData.elements.find(e => e.id == targetId);

            window.logDebug(`TargetID from UIState: ${targetId}`);
            console.log(`🎯 loadTheme: Selected element ID: ${targetId}, type: ${selectedEl ? selectedEl.type : 'N/A'}, subType: ${selectedEl ? selectedEl.subType : 'N/A'}`);

            // Ellenőrizzük az elem típusát (map, photo, moon)
            const isMapElement = selectedEl && selectedEl.type === 'map';
            const isPhotoElement = selectedEl && selectedEl.type === 'photo' && selectedEl.subType !== 'moon';
            const isMoonElement = selectedEl && selectedEl.type === 'photo' && selectedEl.subType === 'moon';

            console.log(`🔍 loadTheme: isMap=${isMapElement}, isPhoto=${isPhotoElement}, isMoon=${isMoonElement}`);

            // Ha nincs kiválasztva elem, keressük az első térképet
            if (!selectedEl) {
                window.logDebug(`Selected element not found. Falling back to first map.`);
                selectedEl = myCelestialConf.userData.elements.find(e => e.type === 'map');
                if (selectedEl) targetId = selectedEl.id;
            }

            if (!selectedEl) {
                window.logDebug("ERROR: No element found!");
                alert("Nincs kiválasztva elem!");
                return;
            }

            window.logDebug(`Final Selected Element ID: ${selectedEl.id}, Type: ${selectedEl.type}, SubType: ${selectedEl.subType || 'N/A'}`);

            // 2. Téma betöltése
            const theme = mapThemes[key];
            if (!theme) return;

            activeThemeKey = key;
            activeVariant = variant;

            // Alap config előkészítése (Kényszerített 1000px)
            let themeConfig = JSON.parse(JSON.stringify(theme.config));
            themeConfig.width = 1000;

            // Projekció kezelése
            if (variant === 'heart') {
                themeConfig.projection = "customHeart";
                selectedEl.mask = 'none';
            } else {
                themeConfig.projection = "stereographic";
            }

            // 3. MÓD KIVÁLASZTÁSA
            // Használjuk a közonti, robusztus függvényt a mód meghatározására
            let bgMode = 'global';
            // Ellenőrizzük, hogy elérhető-e a helper függvény (mivel külső JS-ben lehet)
            if (typeof window.getActiveBackgroundMode === 'function') {
                bgMode = window.getActiveBackgroundMode();
            } else if (typeof getActiveBackgroundMode === 'function') {
                bgMode = getActiveBackgroundMode();
            } else {
                // Fallback (ha valamiért nem elérhető a fv)
                let radioName = (sourceSide === 'left') ? 'bg-mode-left' : 'bg-mode-right';
                let selectedRadio = document.querySelector(`input[name="${radioName}"]:checked`);
                // Ha nincs találat, megnézzük a másik oldalt is (Fallback)
                if (!selectedRadio) {
                    const otherRadioName = (sourceSide === 'left') ? 'bg-mode-right' : 'bg-mode-left';
                    selectedRadio = document.querySelector(`input[name="${otherRadioName}"]:checked`);
                }
                if (selectedRadio) bgMode = selectedRadio.value;
            }

            console.log("LoadTheme detected mode:", bgMode, "SourceSide:", sourceSide);

            // --- ADATBÁZIS FRISSÍTÉSE (MÉG NEM RAJZOLUNK!) ---
            const mapsToRender = []; // Ebbe gyűjtjük azokat az ID-kat, akiket újra kell generálni

            if (bgMode === 'global') {
                // 🌍 GLOBÁLIS:
                console.log("🌍 loadTheme: GLOBAL mode - applying to ALL elements");
                // 1. Vászon háttér beállítása
                window.updateCanvasBackground(theme.background);

                // 2. Minden elem módosítása
                myCelestialConf.userData.elements.forEach(el => {
                    el.localBackground = null; // Globálisnál töröljük a lokális hátteret
                    console.log(`🌍 Processing element: ${el.id}, type: ${el.type}, subType: ${el.subType || 'N/A'}`);

                    if (el.type === 'map') {
                        // Config frissítése (megtartva a helyadatokat)
                        updateElementConfig(el, themeConfig);
                        // Szövegek színezése
                        updateZoneColors(el.id, theme.textColor);
                        // Hozzáadás a renderelési listához
                        mapsToRender.push(el);
                        window.logDebug(`Added MAP element to mapsToRender (Global Mode): ${el.id}`);
                    } else if (el.type === 'photo') {
                        // Fotó vagy Hold elem - szövegek színezése
                        console.log(`📷 Processing photo/moon element: ${el.id}, subType: ${el.subType || 'photo'}`);
                        updateZoneColors(el.id, theme.textColor);
                        window.logDebug(`Updated text colors for PHOTO/MOON element (Global Mode): ${el.id}`);
                    }
                });

                // Fotó/Hold elemek megjelenítésének frissítése (Global mode)
                const hasPhotoElements = myCelestialConf.userData.elements.some(e => e.type === 'photo');
                if (hasPhotoElements) {
                    setTimeout(() => {
                        if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
                        if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                        console.log(`📷 Refreshed display for photo/moon elements (Global Mode)`);
                    }, 100);
                }

            } else if (bgMode === 'local') {
                // 🖼️ LOKÁLIS:
                console.log(`🖼️ loadTheme: LOCAL mode - applying to selected element: ${selectedEl.id}, type: ${selectedEl.type}`);
                window.logDebug("EXECUTING LOCAL MODE LOGIC");

                // 1. Csak a kijelölt elem háttere
                selectedEl.localBackground = theme.background;
                console.log(`🖼️ Set localBackground for ${selectedEl.id}: ${theme.background}`);

                if (selectedEl.type === 'map') {
                    // 2. Config frissítése (csak térképnél)
                    updateElementConfig(selectedEl, themeConfig);
                    // Hozzáadás a renderelési listához
                    mapsToRender.push(selectedEl);
                    window.logDebug(`Added selectedEl to mapsToRender (Local Mode): ${selectedEl.id}`);
                } else {
                    console.log(`📷 Photo/Moon element - skipping celestial config update, triggering refresh`);
                    // Fotó/Hold elemnél nincs térkép renderelés, de frissíteni kell a megjelenítést
                    setTimeout(() => {
                        if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
                        if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                        console.log(`📷 Refreshed display for photo/moon element: ${selectedEl.id}`);
                    }, 100);
                }

                // 3. Szövegek színezése (mindegyik elemtípusnál)
                updateZoneColors(selectedEl.id, theme.textColor);
                console.log(`🖼️ Updated text colors for element: ${selectedEl.id}`);

            } else if (bgMode === 'none') {
                // 🚫 CSAK STÍLUS (CSAK TÉRKÉPEKHEZ!):
                console.log(`🚫 loadTheme: STYLE ONLY mode - element type: ${selectedEl.type}`);

                // Ellenőrizzük, hogy térkép-e az elem
                if (selectedEl.type !== 'map') {
                    console.warn(`⚠️ loadTheme: STYLE ONLY mode is not available for ${selectedEl.type} elements!`);
                    alert("A 'Csak stílus' mód csak csillagtérképeknél elérhető!\nVálassz másik alkalmazási módot.");
                    return;
                }

                window.logDebug("EXECUTING STYLE ONLY MODE LOGIC");

                // 1. Csak a localBackground-ot mentjük (slot háttér)
                // A celestialConfig.background (térkép kör kitöltése) VÁLTOZHAT!
                const existingLocalBackground = selectedEl.localBackground;

                // 2. Config frissítése (térkép stílus változik az új témára)
                updateElementConfig(selectedEl, themeConfig);

                // 3. Csak a localBackground-ot állítjuk vissza (slot háttér megmarad)
                // A celestialConfig.background az új téma szerinti lesz!
                selectedEl.localBackground = existingLocalBackground;

                // 4. Szövegekhez nem nyúlunk (nincs updateZoneColors hívás)

                // 5. Hozzáadás a renderelési listához
                mapsToRender.push(selectedEl);
                window.logDebug(`Added selectedEl to mapsToRender (Style Only Mode): ${selectedEl.id}`);
            }

            // --- RENDERELÉS INDÍTÁSA (QUEUE) ---
            window.logDebug(`Calling processRenderQueue with ${mapsToRender.length} elements.`);
            // Ez a függvény fogja egyesével, biztonságosan végrehajtani a rajzolást
            processRenderQueue(mapsToRender, 0);
        };

        // --- SEGÉDFÜGGVÉNY: Elem konfigurációjának frissítése ---
        function updateElementConfig(el, newBaseConfig) {
            // Másolat készítése az új alapról
            let finalConfig = JSON.parse(JSON.stringify(newBaseConfig));

            // Meglévő adatok (Hely, Idő) átmentése, ha vannak
            if (el.celestialConfig) {
                if (el.celestialConfig.Ido) finalConfig.Ido = el.celestialConfig.Ido;
                if (el.celestialConfig.Varos) finalConfig.Varos = el.celestialConfig.Varos;
                if (el.celestialConfig.Lokacio) finalConfig.Lokacio = el.celestialConfig.Lokacio;
                if (el.celestialConfig.geopos) finalConfig.geopos = el.celestialConfig.geopos;
                // Kiemelések megőrzése
                if (el.celestialConfig.highlights) finalConfig.highlights = el.celestialConfig.highlights;
            }

            el.celestialConfig = finalConfig;
        }

        // --- SEGÉDFÜGGVÉNY: Szövegzónák színezése ---
        function updateZoneColors(elementId, newColor) {
            if (!newColor) return;
            const zones = myCelestialConf.userData.zones;

            // Próbáljuk meg mindkét formátumot: map_ és photo_
            // main-map speciális eset: 'map' kulcs
            const possibleKeys = [];
            if (elementId === 'main-map') {
                possibleKeys.push('map');
            } else {
                possibleKeys.push(`map_${elementId}`);
                possibleKeys.push(`photo_${elementId}`);
            }

            console.log(`🎨 updateZoneColors: elementId=${elementId}, possibleKeys=${possibleKeys.join(', ')}`);

            possibleKeys.forEach(zoneKey => {
                if (zones[zoneKey]) {
                    console.log(`🎨 Found zone: ${zoneKey}`);
                    ['top', 'bottom'].forEach(z => {
                        if (zones[zoneKey][z] && zones[zoneKey][z].blocks) {
                            zones[zoneKey][z].blocks.forEach(block => {
                                block.color = newColor;
                            });
                            console.log(`🎨 Updated ${zones[zoneKey][z].blocks.length} blocks in ${zoneKey}.${z}`);
                        }
                    });
                }
            });
        }

        // ============================================================
        // --- RENDER QUEUE (JAVÍTOTT: REFERENCIA MENTÉSSEL) ---
        // ============================================================
        function processRenderQueue(elementsList, index) {
            // 1. KILÉPÉSI FELTÉTEL
            if (index >= elementsList.length) {
                console.log("✅ Minden térkép generálása kész.");

                // Visszaállítjuk a teljes UserDatát (Most már tartalmazza a frissítéseket!)
                if (window.savedFullUserData) {
                    myCelestialConf.userData = window.savedFullUserData;
                    window.savedFullUserData = null;
                }

                // Végső UI frissítés
                if (typeof window.refreshMapTransform === 'function') window.refreshMapTransform();
                if (typeof window.renderFixedTexts === 'function') window.renderFixedTexts();
                if (typeof window.renderZoneUI === 'function') {
                    window.renderZoneUI('top');
                    window.renderZoneUI('bottom');
                }

                // Kijelölés frissítése (mindkét panelen)
                $('.theme-item').removeClass('active-theme');
                const activeBtns = document.querySelectorAll(`.theme-btn[data-key="${activeThemeKey}"][data-variant="${activeVariant}"]`);
                activeBtns.forEach(btn => btn.closest('.theme-item').classList.add('active-theme'));

                return;
            }

            // 2. ELŐKÉSZÜLETEK
            const el = elementsList[index];
            console.log(`⏳ Generálás: ${el.id} (${index + 1}/${elementsList.length})`);

            // --- JAVÍTÁS: CSAK REFERENCIÁT MENTÜNK, NEM MÁSOLATOT! ---
            if (index === 0 && !window.savedFullUserData) {
                window.savedFullUserData = myCelestialConf.userData;
            }
            // ---------------------------------------------------------

            // 3. ISOLÁCIÓ (Becsapjuk a rendszert)
            // Az elem configját másoljuk, hogy ne legyen gond
            myCelestialConf = JSON.parse(JSON.stringify(el.celestialConfig));

            // De a UserDatába az EREDETI elem referenciáját tesszük!
            // Így ha a handleVectorExport ír bele, az megmarad.
            myCelestialConf.userData = {
                uiState: {
                    selectedElementId: el.id,
                    zoneFlags: window.savedFullUserData.uiState.zoneFlags || {}
                },
                elements: [el], // <--- Eredeti referencia!
                zones: window.savedFullUserData.zones,
                canvas: window.savedFullUserData.canvas
            };

            // 4. GENERÁLÁS
            if (typeof Celestial !== 'undefined') {
                Celestial.resize({ width: 1000 });
                Celestial.apply(myCelestialConf);

                if (myCelestialConf.Ido) Celestial.date(new Date(myCelestialConf.Ido));
                if (myCelestialConf.geopos) Celestial.location(myCelestialConf.geopos);

                if (el.highlights) Celestial.highlightList = el.highlights;
                else Celestial.highlightList = {};

                Celestial.redraw();

                // Callback
                window.onVectorExportFinished = function () {
                    processRenderQueue(elementsList, index + 1);
                };

                setTimeout(() => {
                    if (typeof window.updateActiveMapSnapshot === 'function') {
                        window.updateActiveMapSnapshot();
                    }
                }, 150);
            } else {
                processRenderQueue(elementsList, index + 1);
            }
        }

        // --- TÉMA VÁLASZTÓ GENERÁLÁSA ---
        window.initThemeSelectors = function () {
            console.log("initThemeSelectors futtatása...");

            const containers = [
                'theme-grid-container-left', // Editor (Bal)
                'designer-templates-grid'    // Designer (Jobb)
            ];

            const themesSource = (typeof mapThemes !== 'undefined') ? mapThemes : {};

            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;

                const sourceSide = (containerId === 'theme-grid-container-left') ? 'left' : 'right';

                container.innerHTML = ''; // Törlés

                for (const [key, theme] of Object.entries(themesSource)) {
                    // A) Normál kártya
                    const normalCard = createCardHTML(key, theme, 'normal', sourceSide);
                    container.appendChild(normalCard);
                    // B) Szív kártya
                    const heartCard = createCardHTML(key, theme, 'heart', sourceSide);
                    container.appendChild(heartCard);
                }
            });
        };

        // --- JAVÍTOTT MENTÉS: HÁTTÉRREL EGYÜTT ---
        function saveMapThumbnail(forcedName) {
            const sourceCanvas = document.querySelector('#celestial-map canvas');
            if (!sourceCanvas) return;

            // 1. Aktív téma hátterének lekérése
            const theme = mapThemes[activeThemeKey];
            const bgStyle = theme ? theme.background : "#000000";

            // 2. Ideiglenes vászon
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');

            // 3. Háttér festése
            if (bgStyle.includes('gradient')) {
                // Gradiens színek kinyerése
                const colors = bgStyle.match(/#[a-fA-F0-9]{6}|rgb\([^)]+\)/g);
                if (colors && colors.length >= 2) {
                    const gradient = ctx.createLinearGradient(0, 0, exportCanvas.width, exportCanvas.height);
                    gradient.addColorStop(0, colors[0]);
                    gradient.addColorStop(1, colors[colors.length - 1]);
                    ctx.fillStyle = gradient;
                } else {
                    ctx.fillStyle = "#000000";
                }
            } else {
                ctx.fillStyle = bgStyle;
            }
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

            // 4. Térkép ráfestése
            ctx.drawImage(sourceCanvas, 0, 0);

            // 5. Letöltés
            const link = document.createElement('a');
            link.download = forcedName || `thumb_${activeThemeKey}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- TÖMEGES GENERÁLÓ ROBOT 🤖 ---
        function downloadAllThemesSequence() {
            const keys = Object.keys(mapThemes);
            let index = 0;

            if (!confirm(`Figyelem! Ez a folyamat sorban letölti mind a(z) ${keys.length} képet.\n\nNe nyúlj az egérhez, amíg nem végez!`)) {
                return;
            }

            function processNext() {
                if (index >= keys.length) {
                    alert("Kész! Minden téma képe letöltve. 🥂\nMost másold be őket az 'images/themes/' mappába!");
                    return;
                }

                const key = keys[index];
                console.log(`Generálás: ${key} (${index + 1}/${keys.length})`);
                let variant = 'normal';
                // 1. Téma betöltése (ez frissíti a map-wrap hátterét és a térképet is)
                loadTheme(key, variant);

                // 2. Várakozás (800ms elég kell legyen a rajzoláshoz)
                setTimeout(() => {
                    // 3. Mentés: thumb_midnight.png, thumb_vintage.png, stb.
                    saveMapThumbnail(`thumb_${key}.png`);

                    index++;
                    processNext(); // Következő
                }, 800);
            }

            // Indítás
            processNext();
        }


        var myCelestialConf = null;
        var timeZone = 60;
        var lat = 47.4979;
        var lng = 19.0402;
        var date = new Date();

        window.preConstellationConfig = null;

        // --- ÚJ: DEBOUNCE SEGÉDFÜGGVÉNY ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Késleltetett alkalmazás (Redraw)
        // 50ms késleltetés: elég gyors, de megvárja míg a csúszka "megpihen"
        // const debouncedCelestialApply = debounce(function(conf) {
        //     Celestial.apply(conf);
        // }, 50);
        const debouncedCelestialApply = debounce(function (conf) {
            Celestial.apply(conf);
            // ÚJ: Snapshot frissítése a változás után
            if (typeof window.updateActiveMapSnapshot === 'function') {
                window.updateActiveMapSnapshot();
            }
        }, 50);

        // --- ÚJ: GUI FRISSÍTŐ FÜGGVÉNY (JS hívja meg térkép váltáskor) ---
        window.updateGUIFromConfig = function (conf) {
            console.log("GUI Frissítése konfigurációból...", conf);

            // 1. Checkboxok és Panelek
            const setCheck = (id, val, settingsId) => {
                // Ha a val undefined, akkor false-nak vesszük
                const isChecked = !!val;
                $(id).prop('checked', isChecked);
                if (settingsId) { if (isChecked) $(settingsId).slideDown(); else $(settingsId).slideUp(); }
            };

            // Biztonságos hozzáférés a config elemekhez
            const safeConf = (path) => {
                return path ? path : {};
            };

            // --- JAVÍTOTT RÉSZ: Biztonságos ellenőrzések ---
            setCheck("#const_show", conf.constellations ? conf.constellations.lines : false, "#const_show_settings");
            setCheck("#mw_show", conf.mw ? conf.mw.show : false, "#mw_show_settings");
            setCheck("#stars_show", conf.stars ? conf.stars.show : false, "#stars_show_settings");

            // Vonalak biztonságos kezelése (Itt volt a hiba)
            const lines = conf.lines || {};
            setCheck("#lines_graticule", lines.graticule ? lines.graticule.show : false);
            setCheck("#lines_equatorial", lines.equatorial ? lines.equatorial.show : false);
            setCheck("#lines_ecliptic", lines.ecliptic ? lines.ecliptic.show : false);
            setCheck("#lines_galactic", lines.galactic ? lines.galactic.show : false);
            setCheck("#lines_supergalactic", lines.supergalactic ? lines.supergalactic.show : false);
            // ------------------------------------------------

            // 2. Értékek
            if (conf.mw && conf.mw.style) {
                $("#mw_style_fill").val(conf.mw.style.fill);
                $("#mw_style_opacity").val(conf.mw.style.opacity);
            }

            if (conf.background) {
                $("#background_fill").val(conf.background.fill);
                $("#background_opacity").val(conf.background.opacity);
                $("#background_stroke").val(conf.background.stroke);
                $("#background_stroke_width").val(conf.background.width);
            }

            // Stílusok (tömbkezeléssel)
            if (conf.constellations && conf.constellations.lineStyle) {
                const cStyle = conf.constellations.lineStyle;
                $("#constellation_lineStyle_stroke").val(Array.isArray(cStyle.stroke) ? cStyle.stroke[0] : cStyle.stroke);
                $("#constellation_lineStyle_opacity").val(Array.isArray(cStyle.opacity) ? cStyle.opacity[0] : cStyle.opacity);
                $("#constellation_lineStyle_stroke_width").val(Array.isArray(cStyle.width) ? cStyle.width[0] : cStyle.width);
            }

            if (conf.stars) {
                $("#stars_limit").val(conf.stars.limit);
                $("#stars_size").val(conf.stars.size);
                if (conf.stars.style) {
                    $("#stars_style_fill").val(conf.stars.style.fill);
                }
            }

            // 3. Dátum és Hely
            if (conf.Ido) {
                let d = new Date(conf.Ido);
                if (!isNaN(d.getTime())) {
                    $("#datetimepicker").datetimepicker('setDate', d);
                    if (typeof date !== 'undefined') date = d;
                }
            }

            if (conf.Varos) $("#city").val(conf.Varos);

            if (conf.geopos) {
                $("#coord_lat").val(conf.geopos[0]);
                $("#coord_lon").val(conf.geopos[1]);
                if (typeof lat !== 'undefined') lat = conf.geopos[0];
                if (typeof lng !== 'undefined') lng = conf.geopos[1];
            }
        };
        function change(opts) {
            console.log("change");
            var ujCelesConf = deepMerge(myCelestialConf, opts);
            myCelestialConf = ujCelesConf;
            console.log("myCelestialConf", myCelestialConf);
            console.log("opts", opts);

            // JAVÍTÁS: A közvetlen hívás helyett a debounced verziót használjuk
            // Celestial.apply(myCelestialConf); 
            debouncedCelestialApply(myCelestialConf);
        }


        $(document).on('change', '#const_show', function (e) {
            if ($(this).is(':checked')) {
                $("#const_show_settings").slideDown(300);
            }
            else {
                $("#const_show_settings").slideUp(300);
            }
            change({ constellations: { lines: $(this).is(':checked') } });
        });

        $(document).on('change', '#mw_show', function (e) {
            if ($(this).is(':checked')) {
                $("#mw_show_settings").slideDown(300);
            }
            else {
                $("#mw_show_settings").slideUp(300);
            }
            change({ mw: { show: $(this).is(':checked') } });
        });

        $(document).on('change', '#mw_style_fill', function (e) {
            change({
                mw: {
                    style: {
                        fill: $("#mw_style_fill").val(),
                        opacity: $("#mw_style_opacity").val()
                    }
                }
            });
        });

        $(document).on('change', '#mw_style_opacity', function (e) {
            change({
                mw: {
                    style: {
                        fill: $("#mw_style_fill").val(),
                        opacity: $("#mw_style_opacity").val()
                    }
                }
            });
        });

        $(document).on('change', '#background_fill', function (e) {
            change({
                background: {
                    fill: $("#background_fill").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#background_opacity', function (e) {
            change({
                background: {
                    opacity: $("#background_opacity").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#background_stroke', function (e) {
            change({
                background: {
                    stroke: $("#background_stroke").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#background_stroke_width', function (e) {
            change({
                background: {
                    width: $("#background_stroke_width").val(),
                    dash: $("#background_stroke_dash_check").prop("checked") == true ?
                        [$("#background_stroke_dash_1").val(), $("#background_stroke_dash_2").val()] :
                        [null, null]
                }
            });
        });

        $(document).on('change', '#constellation_lineStyle_opacity', function (e) {
            // alert("constellation_lineStyle_opacity")
            // if ($("#constellation_lineStyle_dash_check").prop("checked") == true) {
            // alert("dash")
            change({
                constellations: {
                    lineStyle: {
                        opacity: $("#constellation_lineStyle_opacity").val(),
                        stroke: $("#constellation_lineStyle_stroke").val(),
                        width: $("#constellation_lineStyle_stroke_width").val(),
                        dash: $("#constellation_lineStyle_dash_check").prop("checked") == true ?
                            [$("#constellation_lineStyle_dash_1").val(), $("#constellation_lineStyle_dash_2").val()] :
                            [null, null]
                    }
                }
            });
            // } else {
            //   alert("nemdash")
            //   change({ constellations: { lineStyle: {
            //       opacity: $("#constellation_lineStyle_opacity").val(),
            //       stroke: $("#constellation_lineStyle_stroke").val(),
            //       width: $("#constellation_lineStyle_stroke_width").val() ,
            //       dash: [null,  null]
            //       }}
            //   });
            // }

        });

        $(document).on('change', '#constellation_lineStyle_stroke', function (e) {
            change({
                constellations: {
                    lineStyle: {
                        opacity: $("#constellation_lineStyle_opacity").val(),
                        stroke: $("#constellation_lineStyle_stroke").val(),
                        width: $("#constellation_lineStyle_stroke_width").val(),
                        dash: $("#constellation_lineStyle_dash_check").prop("checked") == true ?
                            [$("#constellation_lineStyle_dash_1").val(), $("#constellation_lineStyle_dash_2").val()] :
                            [null, null]
                    }
                }
            });
        });

        $(document).on('change', '#constellation_lineStyle_stroke_width', function (e) {
            change({
                constellations: {
                    lineStyle: {
                        opacity: $("#constellation_lineStyle_opacity").val(),
                        stroke: $("#constellation_lineStyle_stroke").val(),
                        width: $("#constellation_lineStyle_stroke_width").val(),
                        dash: $("#constellation_lineStyle_dash_check").prop("checked") == true ?
                            [$("#constellation_lineStyle_dash_1").val(), $("#constellation_lineStyle_dash_2").val()] :
                            [null, null]
                    }
                }
            });
        });


        $(document).on('change', '#stars_show', function (e) {
            if ($(this).is(':checked')) {
                $("#stars_show_settings").slideDown(300);
            }
            else {
                $("#stars_show_settings").slideUp(300);
            }
            change({ stars: { show: $(this).is(':checked') } });
        });

        $(document).on('input', '#stars_limit', function (e) {
            change({ stars: { limit: parseFloat($(this).val()) } });
        });

        $(document).on('change', '#stars_size', function (e) {
            change({ stars: { size: parseFloat($(this).val()) } });
        });

        $(document).on('change', '#stars_exponent', function (e) {
            change({ stars: { exponent: parseFloat($(this).val()) } });
        });

        $(document).on('change', '#stars_colors', function (e) {
            if (!$(this).is(':checked')) {
                $("#stars_colors_settings").slideDown(300);
            }
            else {
                $("#stars_colors_settings").slideUp(300);
            }
            change({ stars: { colors: $(this).is(':checked') } });
        });

        $(document).on('change', '#stars_style_fill', function (e) {
            change({
                stars: {
                    style: {
                        fill: $("#stars_style_fill").val(),
                        opacity: $("#stars_style_opacity").val()
                    }
                }
            });
        });
        $(document).on('change', '#stars_style_opacity', function (e) {
            change({
                stars: {
                    style: {
                        fill: $("#stars_style_fill").val(),
                        opacity: $("#stars_style_opacity").val()
                    }
                }
            });
        });

        $(document).on('change', '#planets_show', function (e) {
            change({ planets: { show: $(this).is(':checked'), symbolType: "disk" } });
        });


        $(document).on('change', '#lines_graticule_color', function (e) {
            console.log("lines_graticule_color")
            if ($("#lines_graticule_dash_check").prop("checked") == true) {

                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [$("#lines_graticule_dash_1").val(), $("#lines_graticule_dash_2").val()]
                        }
                    }
                });
            } else {
                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [null, null]
                        }
                    }
                });

            }
        });

        $(document).on('change', '#lines_graticule_size', function (e) {
            if ($("#lines_graticule_dash_check").prop("checked") == true) {

                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [$("#lines_graticule_dash_1").val(), $("#lines_graticule_dash_2").val()]
                        }
                    }
                });
            } else {
                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: []
                        }
                    }
                });
            }
        });

        $(document).on('change', '#lines_graticule_opacity', function (e) {
            if ($("#lines_graticule_dash_check").prop("checked") == true) {

                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [$("#lines_graticule_dash_1").val(), $("#lines_graticule_dash_2").val()]
                        }
                    }
                });
            } else {
                change({
                    lines: {
                        graticule: {
                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: []
                        }
                    }
                });

            }
        });


        $(document).on('change', '#lines_equatorial_color', function (e) {
            change({
                lines: {
                    equatorial: {
                        show: $("#lines_equatorial").is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_equatorial_size', function (e) {
            change({
                lines: {
                    equatorial: {
                        show: $("#lines_equatorial").is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_equatorial_opacity', function (e) {
            change({
                lines: {
                    equatorial: {
                        show: $("#lines_equatorial").is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });


        $(document).on('change', '#lines_ecliptic_color', function (e) {
            change({
                lines: {
                    ecliptic: {
                        show: $("#lines_ecliptic").is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_ecliptic_size', function (e) {
            change({
                lines: {
                    ecliptic: {
                        show: $("#lines_ecliptic").is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_ecliptic_opacity', function (e) {
            change({
                lines: {
                    ecliptic: {
                        show: $("#lines_ecliptic").is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });


        $(document).on('change', '#lines_galactic_color', function (e) {
            change({
                lines: {
                    galactic: {
                        show: $("#lines_galactic").is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_galactic_size', function (e) {
            change({
                lines: {
                    galactic: {
                        show: $("#lines_galactic").is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_galactic_opacity', function (e) {
            change({
                lines: {
                    galactic: {
                        show: $("#lines_galactic").is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });


        $(document).on('change', '#lines_supergalactic_color', function (e) {
            change({
                lines: {
                    supergalactic: {
                        show: $("#lines_supergalactic").is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_supergalactic_size', function (e) {
            change({
                lines: {
                    supergalactic: {
                        show: $("#lines_supergalactic").is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_supergalactic_opacity', function (e) {
            change({
                lines: {
                    supergalactic: {
                        show: $("#lines_supergalactic").is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });

        // Master checkboxok a wrapper megjelenítésére
        $(document).on('change', '#lines_graticule_master', function (e) {
            if ($(this).is(':checked')) {
                $("#graticule-wrapper").slideDown(300);
                $("#lines_graticule").prop('checked', true).trigger('change');
            } else {
                $("#graticule-wrapper").slideUp(300);
                $("#lines_graticule").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_equatorial_master', function (e) {
            if ($(this).is(':checked')) {
                $("#equatorial-wrapper").slideDown(300);
                $("#lines_equatorial").prop('checked', true).trigger('change');
            } else {
                $("#equatorial-wrapper").slideUp(300);
                $("#lines_equatorial").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_ecliptic_master', function (e) {
            if ($(this).is(':checked')) {
                $("#ecliptic-wrapper").slideDown(300);
                $("#lines_ecliptic").prop('checked', true).trigger('change');
            } else {
                $("#ecliptic-wrapper").slideUp(300);
                $("#lines_ecliptic").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_galactic_master', function (e) {
            if ($(this).is(':checked')) {
                $("#galactic-wrapper").slideDown(300);
                $("#lines_galactic").prop('checked', true).trigger('change');
            } else {
                $("#galactic-wrapper").slideUp(300);
                $("#lines_galactic").prop('checked', false).trigger('change');
            }
        });

        $(document).on('change', '#lines_supergalactic_master', function (e) {
            if ($(this).is(':checked')) {
                $("#supergalactic-wrapper").slideDown(300);
                $("#lines_supergalactic").prop('checked', true).trigger('change');
            } else {
                $("#supergalactic-wrapper").slideUp(300);
                $("#lines_supergalactic").prop('checked', false).trigger('change');
            }
        });



        // A belső checkboxok változásai
        $(document).on('change', '#lines_graticule', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    graticule: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_graticule_color").val(),
                        width: parseFloat($("#lines_graticule_size").val()),
                        opacity: parseFloat($("#lines_graticule_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_equatorial', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    equatorial: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_equatorial_color").val(),
                        width: parseFloat($("#lines_equatorial_size").val()),
                        opacity: parseFloat($("#lines_equatorial_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_ecliptic', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    ecliptic: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_ecliptic_color").val(),
                        width: parseFloat($("#lines_ecliptic_size").val()),
                        opacity: parseFloat($("#lines_ecliptic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_galactic', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    galactic: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_galactic_color").val(),
                        width: parseFloat($("#lines_galactic_size").val()),
                        opacity: parseFloat($("#lines_galactic_opacity").val())
                    }
                }
            });
        });

        $(document).on('change', '#lines_supergalactic', function (e) {
            e.stopPropagation();
            change({
                lines: {
                    supergalactic: {
                        show: $(this).is(':checked'),
                        stroke: $("#lines_supergalactic_color").val(),
                        width: parseFloat($("#lines_supergalactic_size").val()),
                        opacity: parseFloat($("#lines_supergalactic_opacity").val())
                    }
                }
            });
        });
        // // 1. Háttér (Körvonal) Dash
        // $(document).on('change', '#background_stroke_dash', function(e) {
        //     var isDashed = $(this).is(':checked');
        //     // [4, 4] = 4px vonal, 4px szünet. 
        //     // Ha nem szaggatott, üres tömböt [] kell küldeni.
        //     change({ background: { dash: isDashed ? [4, 4] : [] } });
        // });
        // 1. HÁTTÉR (KÖRVONAL)
        $(document).on('change', '#background_stroke_dash_check', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#background_stroke_dash_settings').slideDown();
                var v1 = parseFloat($('#background_stroke_dash_1').val()) || 4;
                var v2 = parseFloat($('#background_stroke_dash_2').val()) || 4;
                change({ background: { dash: [v1, v2] } });
            } else {
                $('#background_stroke_dash_settings').slideUp();
                change({ background: { dash: [null, null] } });
            }
        });
        // Input változás figyelése
        $(document).on('input', '#background_stroke_dash_1, #background_stroke_dash_2', function () {
            if ($('#background_stroke_dash_check').is(':checked')) {
                var v1 = parseFloat($('#background_stroke_dash_1').val()) || 4;
                var v2 = parseFloat($('#background_stroke_dash_2').val()) || 4;
                change({ background: { dash: [v1, v2] } });
            }
        });

        // // 2. Csillagképek Dash
        // $(document).on('change', '#constellation_lineStyle_dash', function(e) {
        //     var isDashed = $(this).is(':checked');
        //     change({ constellations: { lineStyle: { dash: isDashed ? [4, 4] : [] } } });
        // });

        // // 3. Fokhálózat (Graticule) Dash
        // $(document).on('change', '#lines_graticule_dash', function(e) {
        //     var isDashed = $(this).is(':checked');
        //     // A rácsnál finomabb szaggatást használunk [2, 2]
        //     change({ lines: { graticule: { dash: isDashed ? [2, 2] : [] } } });
        // });
        // 2. CSILLAGKÉPEK
        $(document).on('change', '#constellation_lineStyle_dash_check', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#constellation_lineStyle_dash_settings').slideDown();
                var v1 = parseFloat($('#constellation_lineStyle_dash_1').val()) || 4;
                var v2 = parseFloat($('#constellation_lineStyle_dash_2').val()) || 4;
                change({
                    constellations: {
                        lineStyle:
                        {
                            opacity: $("#constellation_lineStyle_opacity").val(),
                            stroke: $("#constellation_lineStyle_stroke").val(),
                            width: $("#constellation_lineStyle_stroke_width").val(),
                            dash: [v1, v2]
                        }
                    }
                });
            } else {
                $('#constellation_lineStyle_dash_settings').slideUp();

                change({
                    constellations: {
                        lineStyle:
                        {
                            opacity: $("#constellation_lineStyle_opacity").val(),
                            stroke: $("#constellation_lineStyle_stroke").val(),
                            width: $("#constellation_lineStyle_stroke_width").val(),
                            dash: [null, null]
                        }
                    }
                });
            }
        });
        $(document).on('input', '#constellation_lineStyle_dash_1, #constellation_lineStyle_dash_2', function () {
            if ($('#constellation_lineStyle_dash_check').is(':checked')) {
                var v1 = parseFloat($('#constellation_lineStyle_dash_1').val()) || 4;
                var v2 = parseFloat($('#constellation_lineStyle_dash_2').val()) || 4;
                change({
                    constellations: {
                        lineStyle:
                        {
                            opacity: $("#constellation_lineStyle_opacity").val(),
                            stroke: $("#constellation_lineStyle_stroke").val(),
                            width: $("#constellation_lineStyle_stroke_width").val(),
                            dash: [v1, v2]
                        }
                    }
                });
            }
        });

        // 3. FOKHÁLÓZAT (GRATICULE)
        $(document).on('change', '#lines_graticule_dash_check', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#lines_graticule_dash_settings').slideDown();
                var v1 = parseFloat($('#lines_graticule_dash_1').val()) || 2;
                var v2 = parseFloat($('#lines_graticule_dash_2').val()) || 2;
                change({
                    lines: {
                        graticule: {

                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [v1, v2]
                        }
                    }
                });
            } else {
                $('#lines_graticule_dash_settings').slideUp();
                change({
                    lines: {
                        graticule: {

                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [null, null]
                        }
                    }
                });
            }
        });
        $(document).on('input', '#lines_graticule_dash_1, #lines_graticule_dash_2', function () {
            if ($('#lines_graticule_dash_check').is(':checked')) {
                var v1 = parseFloat($('#lines_graticule_dash_1').val()) || 2;
                var v2 = parseFloat($('#lines_graticule_dash_2').val()) || 2;
                change({
                    lines: {
                        graticule: {

                            show: $("#lines_graticule").is(':checked'),
                            stroke: $("#lines_graticule_color").val(),
                            width: parseFloat($("#lines_graticule_size").val()),
                            opacity: parseFloat($("#lines_graticule_opacity").val()),
                            dash: [v1, v2]
                        }
                    }
                });
            }
        });
        // Collapsible header kattintás - ne triggerelje a checkboxot
        $(document).on('click', '.checkbox-header', function (e) {
            // Ha a checkbox-ra kattintottak, ne csukjuk be/ki
            if ($(e.target).is('input[type="checkbox"]')) {
                return;
            }

            const header = $(this);
            const targetId = header.data('target');
            const content = $('#' + targetId);
            const icon = header.find('.collapsible-icon-icon');

            header.toggleClass('collapsed');
            content.toggleClass('collapsed');

            if (header.hasClass('collapsed')) {
                icon.css('transform', 'rotate(-90deg)');
            } else {
                icon.css('transform', 'rotate(0deg)');
            }
        });

        $(document).ready(function () {

            // initThemeSelectors();
            setTimeout(() => {
                saveUserState(); // Mentsük el az alapállapotot
                // Frissítsük a téma mód rádiógombokat az aktuális elem típusa alapján
                if (typeof window.updateThemeModeRadioState === 'function') {
                    window.updateThemeModeRadioState();
                    console.log("🔘 Initial updateThemeModeRadioState called");
                }
            }, 1000);
            // initThemeSelectors();
            // --- 1. PROJEKCIÓ DEFINIÁLÁSA (SZÍV ALAK JAVÍTVA) ---
            // Fontos: Itt felülírjuk a beépített werner-t, hogy a te menüddel működjön
            if (d3.geo && d3.geo.bonne) {
                d3.geo.werner = function () { return d3.geo.bonne(); };

                d3.geo.werner.raw = function (phi0) {
                    var rawBonne = d3.geo.bonne.raw(phi0);

                    function rawWerner(lambda, phi) {
                        var xy = rawBonne(lambda, phi);

                        // JAVÍTÁS: += jelet használunk! Ez tolja LEFELÉ a térképet.
                        // 0.2 = Kb. a szív magasságának 20%-ával lejjebb toljuk.
                        // xy[1] += 0.2; 
                        xy[1] += 1;
                        return xy;
                    }

                    rawWerner.invert = function (x, y) {
                        // Az invertálásnál ki kell vonni, amit hozzáadtunk
                        // return rawBonne.invert(x, y - 0.2);
                        return rawBonne.invert(x, y - 1);
                    };

                    return rawWerner;
                };
            }

            if (Celestial.projections) {
                Celestial.projections().werner = {
                    n: "Werner (Szív)",
                    arg: Math.PI / 1,
                    scale: 210,  // Kicsit kisebb méret, hogy biztosan kiférjen
                    ratio: 1   // Magasabb vászon (kisebb szám = magasabb), hogy az alja is ráférjen
                };
            }
            // 1. Definiáljuk az ÚJ vetületet a D3 rendszerében (nem írjuk felül a régit)
            if (d3.geo && d3.geo.bonne) {
                d3.geo.customHeart = function () {
                    // console.log("d3.geo.customHeart = function(phi0)")
                    return d3.geo.bonne();
                };

                d3.geo.customHeart.raw = function (phi0) {
                    // console.log("d3.geo.customHeart.raw = function(phi0)")
                    // Az alap Bonne vetületet használjuk
                    var rawBonne = d3.geo.bonne.raw(phi0);

                    function rawCustom(lambda, phi) {
                        // console.log("rawCustom")
                        var xy = rawBonne(lambda, phi);

                        // --- IGAZÍTÁS ---
                        // Itt tudod tologatni a rajzot a vásznon belül!
                        // xy[1] a függőleges tengely.
                        // += tolja LEFELÉ, -= tolja FELFELÉ.
                        // Ha a szív a vászon tetejére tapad, növeld ezt az értéket!

                        xy[1] -= 0.6;  // Próbáld ki: 0.2, 0.4 vagy akár 0.6

                        return xy;
                    }

                    rawCustom.invert = function (x, y) {
                        // console.log("rawCustom.invert")
                        // Az invertálásnál az ellentétét kell csinálni
                        return rawBonne.invert(x, y + 0.6);
                    };

                    return rawCustom;
                };
            }

            // 2. Beregisztráljuk a Celestial-ba az új néven
            if (Celestial.projections) {
                Celestial.projections().customHeart = {
                    n: "Szív Alakú (Középre Igazított)",
                    arg: Math.PI / szivszoge,
                    scale: 235,
                    ratio: szivratioja // A te jól bevált arányod
                };
            }
            const cityInput = document.getElementById('city');
            const autocomplete = new google.maps.places.Autocomplete(cityInput, {
                types: ['(cities)'],
                fields: ['geometry', 'name']
            });

            autocomplete.addListener('place_changed', async () => {
                const place = autocomplete.getPlace();
                console.log("autocomplete change place", place);
                console.log("autocomplete change place.name", place.name);
                if (!place.geometry) {
                    console.log('No details available for input: ', place.name);
                    return;
                }

                lat = place.geometry.location.lat();
                lng = place.geometry.location.lng();
                console.log("autocomplete change lat", lat);
                console.log("autocomplete change lng", lng);
                $("#coord_lat").val(lat.toString().replace(".", ","));
                $("#coord_lon").val(lng.toString().replace(".", ","));

                date = $("#datetimepicker").datetimepicker("getDate");
                console.log("autocomplete change date", date);
                var tttz = await getTimezoneOffset_(lat, lng);
                console.log("autocomplete change tttz", tttz);
                Celestial.skyview({ date: date, location: [lat, lng], timezone: tttz });
                myCelestialConf.Varos = place.name;
                myCelestialConf.Ido = date;
                myCelestialConf.Lokacio = [lat, lng];
                myCelestialConf.Idozona = tttz;
                myCelestialConf.geopos = [lat, lng];
                // 3. ADATBÁZIS MENTÉS (A JAVÍTÁS LÉNYEGE)
                // Megkeressük, melyik térkép van kijelölve, és abba mentjük az adatokat!
                if (myCelestialConf.userData && myCelestialConf.userData.uiState) {
                    const activeId = myCelestialConf.userData.uiState.selectedElementId;
                    const activeEl = myCelestialConf.userData.elements.find(e => e.id == activeId);

                    // Csak akkor mentünk, ha az aktív elem tényleg egy TÉRKÉP
                    if (activeEl && activeEl.type === 'map') {
                        if (!activeEl.celestialConfig) activeEl.celestialConfig = {};

                        // Adatok átvezetése a tárolóba
                        activeEl.celestialConfig.Varos = place.name;
                        activeEl.celestialConfig.Ido = date;
                        activeEl.celestialConfig.Lokacio = [lat, lng];
                        activeEl.celestialConfig.Idozona = tttz;
                        activeEl.celestialConfig.geopos = [lat, lng];

                        console.log(`✅ Helyszín mentve a(z) ${activeId} azonosítójú térképbe.`);
                    }
                }

                // 4. TERVEZŐ NÉZET FRISSÍTÉSE (Szövegek)
                if (typeof window.updateDesignerFromCelestial === 'function') {
                    window.updateDesignerFromCelestial();
                }
            });

            console.log("celestialConfig_ elott qwe");
            var celestialConfig_ = {
                container: 'celestial-map',
                disableAnimations: false,
                form: false,
                // width: 0,
                // width: document.getElementById('map-wrap') ? document.getElementById('map-wrap').clientWidth : 600,

                width: getOptimalMapSize(),
                datapath: "https://ofrohn.github.io/data/",
                geopos: [47.4979, 19.0402],
                interactive: false,
                alignCelestialMap: "center",
                formFields: {
                    location: true,
                    general: true,
                    stars: true,
                    dsos: false,
                    constellations: false,
                    lines: true,
                    other: true,
                    download: true
                },
                stars: {
                    show: true,
                    limit: 6,
                    size: 7,
                    exponent: -0.28,
                    colors: true,
                    style: {
                        fill: "#ffffff",
                        opacity: 1
                    },
                    designation: false,
                    designationType: "desig",
                    designationStyle: {
                        fill: "#ddbbbb",
                        font: "11px 'Palatino Linotype', Georgia, Times, 'Times Roman', serif",
                        align: "left",
                        baseline: "top"
                    },
                    propername: false,
                    propernameType: "name",
                    propernameStyle: {
                        fill: "#ddbbbb",
                        font: "13px 'Palatino Linotype', Georgia, Times, 'Times Roman', serif",
                        align: "right",
                        baseline: "bottom"
                    }
                },
                // projection: "orthographic",
                projection: "stereographic",
                lines: {
                    graticule: {
                        show: true, stroke: "#cccccc", width: 0.6, opacity: 0.8,
                        lon: { pos: [], fill: "#eee", font: "10px 'Lucida Sans Unicode', Helvetica, Arial, sans-serif" },
                        lat: { pos: [], fill: "#eee", font: "10px 'Lucida Sans Unicode', Helvetica, Arial, sans-serif" }
                    },
                    equatorial: { show: false, stroke: "#aaaaaa", width: 1.3, opacity: 0.7 },
                    ecliptic: { show: false, stroke: "#66cc66", width: 1.3, opacity: 0.7 },
                    galactic: { show: false, stroke: "#cc6666", width: 1.3, opacity: 0.7 },
                    supergalactic: { show: false, stroke: "#cc66cc", width: 1.3, opacity: 0.7 }
                },
                mw: {
                    show: true,
                    style: { fill: "#ffffff", opacity: "0.15" }
                },
                background: {
                    fill: "#000000",
                    opacity: 1,
                    stroke: "#FFFFFF",
                    width: 1.5,
                    dash: []
                },

                dsos: {
                    show: false,
                    names: false,
                },
                constellations: {
                    names: false,
                    namesType: "iau",
                    nameStyle: {
                        fill: "#cccc99",
                        align: "center",
                        baseline: "middle",
                        font: ["14px Helvetica, Arial, sans-serif", "12px Helvetica, Arial, sans-serif", "11px Helvetica, Arial, sans-serif"]
                    },
                    lines: true,
                    lineStyle: {
                        stroke: "#cccccc",
                        width: 1.5,
                        opacity: 0.6
                    },
                    bounds: false,
                    boundStyle: {
                        stroke: "#cccc00",
                        width: 0.5,
                        opacity: 0.8,
                        dash: [2, 4]
                    }
                },
            }
            myCelestialConf = celestialConfig_;

            Celestial.display(celestialConfig_);

            $("#datetimepicker").datetimepicker({
                showAnim: "slideDown",
                showOtherMonths: true,
                selectOtherMonths: true,
                showButtonPanel: true,
                changeMonth: true,
                changeYear: true,
                format: "yy-mm-dd hh:mm:ss",
                dateFormat: "yy-mm-dd",
                timeFormat: "HH:mm",
                showOn: "both",
                buttonImageOnly: false,
                buttonText: "📅",
                firstDay: 1,
                currentText: "Most",
                closeText: "Bezár",
                regional: $.datepicker.regional["hu"],
                showSecond: false,
                showTimezone: false,
                onSelect: function () {
                    date = $(this).datetimepicker("getDate");
                    console.log("datetimepicker change date", date);
                    Celestial.skyview({ date: date, location: [lat, lng], timezone: timeZone });
                    // Globális config
                    myCelestialConf.Ido = date;

                    // ADATBÁZIS MENTÉS (SZINKRONIZÁCIÓ)
                    if (myCelestialConf.userData && myCelestialConf.userData.uiState) {
                        const activeId = myCelestialConf.userData.uiState.selectedElementId;
                        const activeEl = myCelestialConf.userData.elements.find(e => e.id == activeId);

                        if (activeEl && activeEl.type === 'map') {
                            if (!activeEl.celestialConfig) activeEl.celestialConfig = {};
                            activeEl.celestialConfig.Ido = date;
                            console.log(`✅ Dátum mentve a(z) ${activeId} azonosítójú térképbe.`);
                        }
                    }

                    // Tervező frissítése
                    if (typeof window.updateDesignerFromCelestial === 'function') {
                        window.updateDesignerFromCelestial();
                    }
                },
                // minDate: -20,
                // minDate: new Date(1900, 0, 1),
                // maxDate: new Date(2100, 0, 1),
                minDate: "-300y",
                maxDate: "+300y",
                yearRange: '1725:2325'
            });
            $("#datetimepicker").datetimepicker('setDate', new Date());


        });

        async function getTimezoneOffset_(lt, ln) {
            console.log("getTimezoneOffset lt", lt);
            console.log("getTimezoneOffset ln", ln);

            if (!lt || !ln) {
                return;
            }

            const timestamp = Math.floor(Date.now() / 1000);

            const API_KEY = "AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s";
            const url = 'https://maps.googleapis.com/maps/api/timezone/json?location=' + lt + ',' + ln + '&timestamp=' + timestamp + '&key=' + API_KEY;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === "OK") {
                    const rawOffsetSeconds = data.rawOffset;
                    const dstOffsetSeconds = data.dstOffset;

                    const totalOffsetSeconds = rawOffsetSeconds + dstOffsetSeconds;

                    const totalOffsetMinutes = totalOffsetSeconds / 60;

                    timeZone = totalOffsetMinutes;
                    console.log("timeZone", timeZone);
                    return totalOffsetMinutes;

                } else {
                    let errorMessage = data.errorMessage || 'Ismeretlen hiba történt.';
                }
            } catch (error) {
                console.error("Hiba történt:", error);
            }
        }

        $(document).on('click', '.ui-datepicker-current', function (e) {
            console.log("datetimepicker click .ui-datepicker-current");
            var date = new Date();
            var datestr = date.toString();
            console.log("datetimepicker change datestr", datestr);
            var reg = /([\+?\-?]\d\d\d\d)/g;
            var matches = datestr.match(reg);
            console.log("datetimepicker change matches", matches);
            console.log("datetimepicker change matches[0]", matches[0]);

            timeZoneMin = convertTimezoneOffset(matches[0]);
            $("#datetimepicker").datetimepicker('setDate', new Date());
        });

        function convertTimezoneOffset(offsetString) {
            const regex = /^([+-])(\d{2})(\d{2})$/;
            const match = offsetString.match(regex);

            if (!match) {
                console.error("Érvénytelen időzóna formátum. Példa: '+0200' vagy '-0400'");
                return null;
            }

            const sign = match[1];
            const hours = parseInt(match[2], 10);

            let totalMinutes = hours * 60;

            if (sign === '-') {
                totalMinutes = -totalMinutes;
            }

            return totalMinutes;
        }

        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] instanceof Object && key in target && target[key] instanceof Object) {
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        function copyCelestialToSVG() {
            const celestialContainer = document.getElementById('celestial-map');
            const canvas = celestialContainer.querySelector('canvas');

            if (!canvas) {
                console.error('Nem található Canvas a Celestial térképben');
                return;
            }

            // Canvas tartalom konvertálása data URL-lé
            const dataURL = canvas.toDataURL('image/png');

            // Új SVG létrehozása
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);

            // Image elem létrehozása a canvas tartalommal
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('href', dataURL);
            image.setAttribute('width', canvas.width);
            image.setAttribute('height', canvas.height);
            image.setAttribute('x', '0');
            image.setAttribute('y', '0');

            svg.appendChild(image);

            // SVG hozzáadása a cél konténerhez
            // const targetContainer = document.getElementById('svg-container');
            // const targetContainer = document.getElementById('text-overlay-svg');
            const targetContainer = document.getElementById('designer-svg');
            targetContainer.innerHTML = '';
            targetContainer.appendChild(svg);

            console.log('Celestial térkép sikeresen másolva SVG-be!');
        }
        // Update settings when form controls change
        document.getElementById('zodiacsigns').addEventListener('change', (e) => {
            console.log("zodiacsigns change e", e);
            console.log("zodiacsigns change e.target.value", e.target.value);
            //         myCelestialConf.Csillagjegy = e.target.value;
            // Celestial.showConstellation(e.target.value)


            // --- JAVÍTÁS: Állapot mentése és Visszaállítása (myCelestialConf-ban) ---
            if (e.target.value === "nincs") {
                // 1. VISSZAÁLLÍTÁS

                // Ellenőrizzük, hogy van-e mentett állapot a konfigban
                if (myCelestialConf.preConstellationConfig) {
                    console.log("Visszaállítás mentett állapotból (myCelestialConf)...");

                    // Visszatöltjük a mentett konfigot egy ideiglenes változóba
                    var savedConfig = myCelestialConf.preConstellationConfig;

                    // Visszaállítjuk a teljes konfigot a mentett állapotra
                    myCelestialConf = JSON.parse(JSON.stringify(savedConfig));

                    // Alkalmazzuk a Celestial-ra
                    Celestial.apply(myCelestialConf);

                    // Töröljük a mentett property-t, mivel már nem kell (visszaálltunk)
                    // (Bár a savedConfig-ban eleve nem volt benne, ha jól csináltuk a mentést, 
                    // de a biztonság kedvéért explicit törölhetjük a mostani objektumból)
                    delete myCelestialConf.preConstellationConfig;
                }

                myCelestialConf.Csillagjegy = null;

                // 2. KÉNYSZERÍTETT ÁTMÉRETEZÉS (Ez a kulcs a Zoom Reset-hez!)
                Celestial.resize({ width: getOptimalMapSize() });

                // 3. POZÍCIÓ VISSZAÁLLÍTÁSA
                Celestial.skyview({ date: date, location: [lat, lng], timezone: timeZone });

            } else {
                // 1. MENTÉS (Csak ha még nincs mentve)
                if (!myCelestialConf.preConstellationConfig) {
                    console.log("Jelenlegi állapot mentése zoom előtt a myCelestialConf-ba...");

                    // Mély másolat készítése a jelenlegi állapotról
                    var configToSave = JSON.parse(JSON.stringify(myCelestialConf));

                    // Eltávolítjuk a mentésből a mentést (hogy ne legyen rekurzió vagy felesleges adat)
                    // Bár még nincs benne, de a biztonság kedvéért.
                    delete configToSave.preConstellationConfig;

                    // Elmentjük a fő objektumba
                    myCelestialConf.preConstellationConfig = configToSave;
                }

                // 2. CSILLAGJEGY MEGJELENÍTÉSE
                myCelestialConf.Csillagjegy = e.target.value;
                Celestial.showConstellation(e.target.value);
            }
        });

        // --- ÚJ LOGIKA: AZONNALI SZERKESZTÉS (JAVÍTOTT VERZIÓ) ---

        let currentlyEditingId = null; // Tároljuk, hogy épp melyiket szerkesztjük

        // 1. SELECT ESEMÉNY (Új hozzáadása)
        $('#hl-constellation-select').on('change', function () {
            const id = $(this).val();
            if (!id) return;

            // Ha még nincs a listában, hozzáadjuk alapértelmezett stílussal
            if (!Celestial.highlightList || !Celestial.highlightList[id]) {
                const defaultStyle = {
                    stroke: "#ffcc00",
                    width: 3,
                    opacity: 1,
                    dash: []
                };
                Celestial.highlight(id, defaultStyle);
            }

            // Azonnal megnyitjuk szerkesztésre
            startEditingHighlight(id);

            // UI frissítés (lista)
            renderActiveHighlights();

            // Select visszaállítása alaphelyzetbe
            $(this).val('');

            // Auto-save
            if (typeof activeThemeKey !== 'undefined' && activeThemeKey === 'custom') saveUserState();
        });

        // 2. SZERKESZTÉS INDÍTÁSA (Panel betöltése)
        function startEditingHighlight(id) {
            // Ha már ez van megnyitva, akkor bezárjuk (Toggle)
            if (currentlyEditingId === id) {
                closeHighlightSettings();
                return;
            }

            currentlyEditingId = id;
            const style = Celestial.highlightList[id];
            if (!style) return;

            // Panel címe
            const nameText = $(`#hl-constellation-select option[value="${id}"]`).text() || id;
            $('#hl-editing-title').text(nameText + " szerkesztése");

            // Értékek betöltése az inputokba
            $('#hl-color').val(style.stroke);
            $('#hl-width').val(style.width);
            $('#hl-opacity').val(style.opacity);

            if (style.dash && style.dash.length > 0) {
                $('#hl-dash-check').prop('checked', true);
                $('#hl-dash-settings').show();
                $('#hl-dash-1').val(style.dash[0]);
                $('#hl-dash-2').val(style.dash[1]);
            } else {
                $('#hl-dash-check').prop('checked', false);
                $('#hl-dash-settings').hide();
            }

            // Panel megjelenítése
            $('#hl-settings-panel').slideDown();

            // Lista vizuális frissítése (hogy látszódjon, melyik aktív)
            renderActiveHighlights();
        }

        // 3. SZERKESZTÉS BEZÁRÁSA
        window.closeHighlightSettings = function () {
            currentlyEditingId = null;
            $('#hl-settings-panel').slideUp();
            renderActiveHighlights(); // Kijelölés eltűntetése a listáról
        };

        // 4. INPUTOK ESEMÉNYEI (Azonnali frissítés mentés nélkül)
        const updateCurrentHighlight = () => {
            if (!currentlyEditingId) return;

            const newStyle = {
                stroke: $('#hl-color').val(),
                width: parseFloat($('#hl-width').val()),
                opacity: parseFloat($('#hl-opacity').val()),
                dash: $('#hl-dash-check').is(':checked') ?
                    [parseFloat($('#hl-dash-1').val()), parseFloat($('#hl-dash-2').val())] :
                    []
            };

            // Frissítés a Celestialban (Redraw)
            Celestial.highlight(currentlyEditingId, newStyle);

            // Frissítjük a lista elem szélét is (színjelölő)
            renderActiveHighlights();

            // Auto-save
            if (typeof activeThemeKey !== 'undefined' && activeThemeKey === 'custom') saveUserState();
        };

        // Eseményfigyelők az inputokra (input = azonnali, change = véglegesítés)
        $('#hl-color, #hl-width, #hl-opacity, #hl-dash-1, #hl-dash-2').on('input', updateCurrentHighlight);
        $('#hl-dash-check').on('change', function () {
            if ($(this).is(':checked')) $('#hl-dash-settings').slideDown();
            else $('#hl-dash-settings').slideUp();
            updateCurrentHighlight();
        });

        // 5. LISTA RENDERELÉSE (JAVÍTOTT CSS SORRENDDEL)
        function renderActiveHighlights() {
            const listContainer = $('#active-highlights-list');
            const mainContainer = $('#active-highlights-container');
            listContainer.empty();

            // Ha nincs highlight, elrejtjük az egész listát és a szerkesztőt
            if (!Celestial.highlightList || Object.keys(Celestial.highlightList).length === 0) {
                mainContainer.hide();
                if (currentlyEditingId) closeHighlightSettings();
                return;
            }

            mainContainer.show();

            for (const [id, style] of Object.entries(Celestial.highlightList)) {
                // Név kinyerése a selectből
                let nameText = id;
                const option = $(`#hl-constellation-select option[value="${id}"]`);
                if (option.length > 0) nameText = option.text();

                // Aktív elem jelölése
                const isActive = (id === currentlyEditingId);
                const bg = isActive ? 'rgba(74, 158, 255, 0.2)' : 'rgba(0,0,0,0.2)';

                // --- A JAVÍTÁS ITT VAN: ---
                // Az általános border legyen átlátszó vagy kék, DE a border-left-color-t 
                // külön felülírjuk a végén a stílus színével!
                const baseBorder = isActive ? '1px solid var(--accent-blue)' : '1px solid transparent';

                const item = $(`
                    <div class="hl-item" data-id="${id}" 
                         style="display:flex; justify-content:space-between; align-items:center; 
                                background:${bg}; padding:8px; border-radius:6px; cursor:pointer; 
                                margin-bottom: 5px;
                                border: ${baseBorder}; 
                                border-left: 4px solid ${style.stroke};">
                        <div style="flex-grow:1;">
                            <div style="font-weight:bold; font-size:12px; color:${isActive ? '#fff' : '#ddd'};">${nameText}</div>
                        </div>
                        <button class="remove-hl-btn" data-id="${id}" style="background:none; border:none; color:#ff4444; cursor:pointer; font-weight:bold; padding:5px; font-size: 16px;">×</button>
                    </div>
                `);

                // Kattintás az elemre -> Szerkesztés (vagy bezárás)
                item.on('click', function (e) {
                    if ($(e.target).hasClass('remove-hl-btn')) return; // Ha a törlésre kattintott, ne nyissa meg
                    startEditingHighlight(id);
                });

                listContainer.append(item);
            }

            // Törlés gombok eseménykezelője
            $('.remove-hl-btn').on('click', function (e) {
                e.stopPropagation(); // Ne nyissa meg a szerkesztőt
                const idToRemove = $(this).data('id');

                // Ha épp ezt szerkesztettük, zárjuk be a panelt
                if (currentlyEditingId === idToRemove) {
                    closeHighlightSettings();
                }

                Celestial.highlight(idToRemove, null); // Null stílussal hívva töröl
                renderActiveHighlights(); // Újrarajzoljuk a listát

                if (typeof activeThemeKey !== 'undefined' && activeThemeKey === 'custom') {
                    saveUserState();
                }
            });
        }

        // const GOOGLE_API_KEY = "AIzaSyAksFO9HeXBhjzvKKzCPndnr-jxy1JPGwE"; csak fontshoz
        const GOOGLE_API_KEY = "AIzaSyAr_4epSip7RawdJpTYHy5Mq7tfoE-Ot2s";
        // Kért betűtípusok
        // const fontNames = ['Merriweather', 'Montserrat', 'Roboto', 'Open Sans'];
        const fontNames = [
            'Montserrat',
            'Roboto',
            'Open Sans',
            'Merriweather',
            'Playfair Display',
            'Raleway',
            'Inter',
            'Source Sans Pro',
            'Source Sans 3',
            'Source Code Pro',
            'Noto Sans',
            'Abril Fatface',
            'Cormorant',
            'JetBrains Mono',
            'EB Garamond',
            'Cinzel',
            'MedievalSharp',
            'Uncial Antiqua',
            'Great Vibes',
            'Tangerine',
            'Special Elite',
            'Dancing Script',
            'Allura',
            'Sacramento',
            'Quicksand',
            'Parisienne'
        ];

        // Font variánsok lekérdezése
        async function loadAndDisplayFonts() {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/webfonts/v1/webfonts?key=${GOOGLE_API_KEY}`
                );

                if (!response.ok) throw new Error('API hiba');

                const data = await response.json();
                const container = document.getElementById('font-tests');

                fontNames.forEach(fontName => {
                    const font = data.items.find(f => f.family === fontName);
                    if (font) {
                        const fontSection = document.createElement('div');
                        fontSection.className = 'font-test';

                        var fonts_opt = document.createElement('option');
                        var fff = `${font.variants.map(variant => `
                                    <option style="font-family: '${fontName}';font-weight: ${getVariantInfo(variant).weight};font-style: ${getVariantInfo(variant).style};" value="${fontName}_${getVariantInfo(variant).name}">Szeretettel Tőlem Neked!
                                    </option>
                                `).join('')}
                        `;

                        $("#font_").append(fff)
                    }
                });

            } catch (error) {
                console.error('Hiba:', error);
                document.getElementById('font-tests').innerHTML =
                    '<p>Hiba a betűtípusok betöltésében. Ellenőrizd az API kulcsot.</p>';
            }
        }

        function getVariantInfo(variant) {
            const weightNames = {
                100: 'Thin 100',
                200: 'ExtraLight 200',
                300: 'Light 300',
                400: 'Regular 400',
                500: 'Medium 500',
                600: 'SemiBold 600',
                700: 'Bold 700',
                800: 'ExtraBold 800',
                900: 'Black 900'
            };

            let weight = 400;
            let style = 'normal';
            let name = '';

            if (variant === 'regular') {
                weight = 400;
                style = 'normal';
                name = 'Regular 400';
            } else if (variant === 'italic') {
                weight = 400;
                style = 'italic';
                name = 'Regular 400 Italic';
            } else if (variant.includes('italic')) {
                weight = parseInt(variant.replace('italic', ''));
                style = 'italic';
                name = `${weightNames[weight]} Italic`;
            } else {
                weight = parseInt(variant);
                style = 'normal';
                name = weightNames[weight];
            }

            return { weight, style, name };
        }
        // Globális változó a helyes méret tárolására
        window.lastValidMapWidth = null;
        // --- JAVÍTOTT MÉRETEZÉS (Képarány figyelembevételével) ---
        function getOptimalMapSize() {
            console.log("function getOptimalMapSize() {");
            console.log("function getOptimalMapSize() { myCelestialConf", myCelestialConf);
            console.log("function getOptimalMapSize() { Celestial", Celestial);
            var container = $("#map-wrap");
            var windowHeight = $(window).height();
            var containerHeight = container.height();
            var proj = "stereographic";
            console.log("function getOptimalMapSize() { container", container);
            console.log("function getOptimalMapSize() { windowHeight", windowHeight);
            console.log("function getOptimalMapSize() { containerHeight", containerHeight);
            // 1. Megnézzük az aktuális projekció arányát (Ratio)
            var currentRatio = 1.0;
            // BIZTONSÁGI ELLENŐRZÉS: 
            // Csak akkor kérdezzük le a projekciót, ha a konfig már létezik és nem null!
            if (typeof myCelestialConf !== 'undefined' &&
                myCelestialConf !== null &&  // <--- EZ HIÁNYZOTT! (Null check)
                myCelestialConf.projection &&
                Celestial.projections()[myCelestialConf.projection]) {

                console.log("myCelestialConf !== null");
                proj = myCelestialConf.projection;
                var p = Celestial.projections()[myCelestialConf.projection];
                if (p.ratio) currentRatio = p.ratio;
            }
            // 2. Számítás, ha látható a konténer
            if (container.is(':visible') && container.width() > 0) {
                console.log("container.is(':visible') && container.width() > 0");
                var containerWidth = container.width();

                // Kiszámoljuk, mekkora a maximális szélesség, ami befér:

                // A) A konténer szélessége korlátozza:
                var maxW_by_Width = containerWidth;

                // B) Az ablak magassága korlátozza:
                // Mivel Height = Width / Ratio  =>  Width = Height * Ratio
                // Tehát a szélesség nem lehet több, mint (AblakMagasság * Ratio)
                // var maxW_by_Height = windowHeight * currentRatio; 
                // var maxW_by_Height = windowHeight * 1; 
                var maxW_by_Height = containerHeight * 1;

                // A kettő közül a SZIGORÚBBAT (kisebbet) választjuk
                var calculatedSize = proj == "customHeart" ? Math.min(maxW_by_Width, maxW_by_Height) * 0.93 : Math.min(maxW_by_Width, maxW_by_Height) * 0.95;
                // var calculatedSize = Math.min(maxW_by_Width, maxW_by_Height); // * 0.95;

                // Elmentjük a későbbi (Tervező nézet) használatra
                window.lastValidMapWidth = calculatedSize;

                console.log("container.is(':visible') && container.width() > 0 calculatedSize", calculatedSize);
                return calculatedSize;
            }

            // 3. Ha a térkép rejtett (Tervező nézet), a mentett értéket adjuk vissza
            if (window.lastValidMapWidth) {
                console.log("if (window.lastValidMapWidth) {");
                console.log("if (window.lastValidMapWidth) { window.lastValidMapWidth", window.lastValidMapWidth);
                return window.lastValidMapWidth;
            }

            // 4. Fallback (Vészhelyzeti becslés aránnyal)
            var ratio = ($(window).width() > 768) ? 0.7 : 1.0;
            var estWidth = $(window).width() * ratio;
            // Itt is alkalmazzuk az arányt:
            // return Math.min(estWidth, windowHeight * currentRatio) * 0.95;
            console.log("4. Fallback (Vészhelyzeti becslés aránnyal)");
            console.log("4. Fallback (Vészhelyzeti becslés aránnyal) Math.min(estWidth, windowHeight * currentRatio) * 0.95", Math.min(estWidth, windowHeight * currentRatio) * 0.95);
            return Math.min(estWidth, windowHeight * currentRatio) * 0.95;
        }

        // --- 1. INDÍTÁSKOR MÉRETEZÉS ---
        setTimeout(function () {
            console.log("setTimeout(function(){ qwe");
            // Celestial.resize({width: getOptimalMapSize()});

            // Ha esetleg a fenti nem futott le, itt is ellenőrizzük
            if (typeof Celestial !== 'undefined' && typeof Celestial.resize === 'function') {
                Celestial.resize({ width: getOptimalMapSize() });
            }
        }, 100);

        // --- 2. PROJEKCIÓ VÁLTÁSKOR ÚJRAMÉRETEZÉS ÉS IGAZÍTÁS ---
        document.getElementById('projection_').addEventListener('change', (e) => {
            // console.log("Projekció váltás:", e.target.value);

            changeProjection(e.target.value);
        });

        function changeProjection(mire) {
            console.log("Projekció váltás: qwe", mire);

            // 1. Projekció beállítása
            myCelestialConf.projection = mire;
            myCelestialConf.width = getOptimalMapSize();

            // 2. Kirajzolás
            Celestial.display(myCelestialConf);

            // 3. UTÓLAGOS KORREKCIÓ (Precíziós igazítás)
            setTimeout(function () {
                // 1. Lépés: Méretezés a konténerhez (Ez reseteli a pozíciót alapállapotra)
                Celestial.resize({ width: getOptimalMapSize() });

                // HA A SZÍV ALAK VAN KIVÁLASZTVA:
                if (myCelestialConf.projection === 'customHeart') {
                    console.log(">>> Szív alak PRECIZÍOS igazítása...");
                    $("#szivszogediv").show();
                    var mapProj = Celestial.mapProjection;
                    if (!mapProj) return; // Biztonsági ellenőrzés

                    // --- A MATEMATIKA ---

                    // 2. Megmérjük a VETÜLET (a szív alak) pontos helyét és méretét
                    // Létrehozunk egy D3 útvonal generátort az aktuális vetülettel
                    var path = d3.geo.path().projection(mapProj);

                    // Létrehozunk egy "graticule" (fokhálózat) objektumot.
                    // Ennek az "outline" (körvonal) tulajdonsága adja ki a teljes szív formát.
                    var graticule = d3.geo.graticule();
                    var outline = graticule.outline();

                    // A .bounds() visszaadja a befoglaló dobozt: [[x_bal, y_fent], [x_jobb, y_lent]]
                    var bounds = path.bounds(outline);

                    // Kiszámoljuk, hol van MOST a szív közepe függőlegesen
                    var mapTop = bounds[0][1];
                    var mapBottom = bounds[1][1];
                    var mapHeight = mapBottom - mapTop;
                    var mapCenterY = mapTop + (mapHeight / 2);

                    console.log("mapTop", mapTop);
                    console.log("mapBottom", mapBottom);
                    console.log("mapHeight", mapHeight);
                    console.log("mapCenterY", mapCenterY);
                    // 3. Megnézzük, hol van a VÁSZON közepe
                    var canvas = document.querySelector('#celestial-map canvas');
                    var canvasHeight = canvas.height;
                    var canvasCenterY = canvasHeight / 2;

                    // 4. Kiszámoljuk a szükséges ELTOLÁST (Delta)
                    // Ha a térkép közepe (mapCenterY) pl. 300, de a vászoné (canvasCenterY) 500,
                    // akkor +200 pixellel kell lejjebb tolni.
                    var deltaY = canvasCenterY - mapCenterY;

                    var deltaY_ = canvasHeight - mapHeight;
                    console.log("canvasHeight", canvasHeight);
                    console.log("mapHeight", mapHeight);
                    console.log("deltaY", deltaY);
                    console.log("deltaY_", deltaY_);
                    // console.log("mapCenterY", mapCenterY);

                    console.log(`Mérés: TérképKözép=${mapCenterY.toFixed(1)}, VászonKözép=${canvasCenterY.toFixed(1)} -> Eltolás=${deltaY.toFixed(1)}px`);


                    // 5. Alkalmazzuk az eltolást
                    var currentTranslate = mapProj.translate();
                    console.log("currentTranslate[0]", currentTranslate[0]);
                    console.log("currentTranslate[1]", currentTranslate[1]);
                    console.log("currentTranslate[1] + deltaY", currentTranslate[1] + deltaY);
                    // [X marad (az már jó), Y-hoz hozzáadjuk a számított deltát]
                    // mapProj.translate([currentTranslate[0], currentTranslate[1] + deltaY]);
                    // mapProj.translate([currentTranslate[0], currentTranslate[1] + ( mapHeight / 2 )]);
                    // mapProj.translate([currentTranslate[0], (mapHeight / 3) * 2]);
                    console.log("(mapHeight / 3) * 6", (mapHeight / 3) * 6);
                    console.log("(mapHeight / 3) * 6", mapHeight * 4);
                    // mapProj.translate([currentTranslate[0], mapHeight * 4]);
                    // mapProj.translate([currentTranslate[0], currentTranslate[1]]);
                    // mapProj.translate([currentTranslate[0], mapHeight ]);
                    // mapProj.translate([currentTranslate[0], currentTranslate[1] + (deltaY/5)]);
                    // mapProj.translate([currentTranslate[0], deltaY*1.5]);
                    // mapProj.translate([currentTranslate[0], mapHeight * 1.5]);
                    mapProj.translate([currentTranslate[0], currentTranslate[1] * 1.15]);

                    // 6. Újrarajzolás a tökéletes pozícióban
                    Celestial.redraw();
                }
                else {
                    $("#szivszogediv").hide();
                }

            }, 150); // Pici várakozás a resize után
        }

        // Ablak átméretezésekor is igazodjon (Opcionális, de hasznos)
        $(window).resize(function () {
            console.log("$(window).resize(function() {");
            console.log("$(window).resize(function() { myCelestialConf", myCelestialConf);
            console.log("$(window).resize(function() { Celestial", Celestial);
            // Celestial.resize({width: getOptimalMapSize()});
            // 3. UTÓLAGOS KORREKCIÓ (Ez fogja helyretenni!)
            // 1. TITKOS ÖSSZETEVŐ: A vetület definíciójának frissítése
            // Ezt csinálja a szög állító gomb is, ezért javul meg tőle.
            // Most automatizáljuk!

            // Kiolvassuk a jelenlegi értékeket (vagy alapértelmezettet)
            var aktSzog = parseFloat($("#szivszoge").val()) || 2.4;
            var aktRatio = 0.88; // Vagy szivratioja változó, ha használod

            if (Celestial.projections) {
                Celestial.projections().customHeart = {
                    arg: Math.PI / aktSzog,
                    scale: 235, // A change eseményben is 210 volt, tartsuk meg
                    ratio: aktRatio
                };
            }

            // 2. Most jöhet a méretezés (Már az új definícióval!)
            // Celestial.resize({width: getOptimalMapSize()});
            // 2. Most jöhet a méretezés (Már az új definícióval!)
            // --- JAVÍTÁS ITT: Biztonsági ellenőrzés ---
            if (typeof Celestial !== 'undefined' && typeof Celestial.resize === 'function') {
                Celestial.resize({ width: getOptimalMapSize() });
            }
            // ------------------------------------------
            setTimeout(function () {
                // // Először méretezzük át a konténerhez
                // Celestial.resize({width: getOptimalMapSize()});

                // 1. Lépés: Méretezés a konténerhez (Ez reseteli a pozíciót alapállapotra)
                // Celestial.resize({width: getOptimalMapSize()});
                // Ha esetleg a fenti nem futott le, itt is ellenőrizzük
                if (typeof Celestial !== 'undefined' && typeof Celestial.resize === 'function') {
                    Celestial.resize({ width: getOptimalMapSize() });
                }

                // HA A SZÍV ALAK VAN KIVÁLASZTVA:
                if (myCelestialConf.projection === 'customHeart') {
                    console.log(">>> Szív alak PRECIZÍOS igazítása...");

                    var mapProj = Celestial.mapProjection;
                    if (!mapProj) return; // Biztonsági ellenőrzés

                    // --- A MATEMATIKA ---

                    // 2. Megmérjük a VETÜLET (a szív alak) pontos helyét és méretét
                    // Létrehozunk egy D3 útvonal generátort az aktuális vetülettel
                    var path = d3.geo.path().projection(mapProj);

                    // Létrehozunk egy "graticule" (fokhálózat) objektumot.
                    // Ennek az "outline" (körvonal) tulajdonsága adja ki a teljes szív formát.
                    var graticule = d3.geo.graticule();
                    var outline = graticule.outline();

                    // A .bounds() visszaadja a befoglaló dobozt: [[x_bal, y_fent], [x_jobb, y_lent]]
                    var bounds = path.bounds(outline);

                    // Kiszámoljuk, hol van MOST a szív közepe függőlegesen
                    var mapTop = bounds[0][1];
                    var mapBottom = bounds[1][1];
                    var mapHeight = mapBottom - mapTop;
                    var mapCenterY = mapTop + (mapHeight / 2);

                    console.log("mapTop", mapTop);
                    console.log("mapBottom", mapBottom);
                    console.log("mapHeight", mapHeight);
                    console.log("mapCenterY", mapCenterY);
                    // 3. Megnézzük, hol van a VÁSZON közepe
                    var canvas = document.querySelector('#celestial-map canvas');
                    var canvasHeight = canvas.height;
                    var canvasCenterY = canvasHeight / 2;

                    // 4. Kiszámoljuk a szükséges ELTOLÁST (Delta)
                    // Ha a térkép közepe (mapCenterY) pl. 300, de a vászoné (canvasCenterY) 500,
                    // akkor +200 pixellel kell lejjebb tolni.
                    var deltaY = canvasCenterY - mapCenterY;

                    var deltaY_ = canvasHeight - mapHeight;
                    console.log("canvasHeight", canvasHeight);
                    console.log("mapHeight", mapHeight);
                    console.log("deltaY", deltaY);
                    console.log("deltaY_", deltaY_);
                    // console.log("mapCenterY", mapCenterY);

                    console.log(`Mérés: TérképKözép=${mapCenterY.toFixed(1)}, VászonKözép=${canvasCenterY.toFixed(1)} -> Eltolás=${deltaY.toFixed(1)}px`);


                    // 5. Alkalmazzuk az eltolást
                    var currentTranslate = mapProj.translate();
                    console.log("currentTranslate[0]", currentTranslate[0]);
                    console.log("currentTranslate[1]", currentTranslate[1]);
                    console.log("currentTranslate[1] + deltaY", currentTranslate[1] + deltaY);
                    mapProj.translate([currentTranslate[0], currentTranslate[1] * 1.15]);

                    // 6. Újrarajzolás a tökéletes pozícióban
                    Celestial.redraw();
                }

            }, 150); // Pici késleltetés kell, hogy a Celestial végezzen az alapbeállítással
        });

        // ============================================
        // THEME SELECTOR FUNCTIONALITY
        // ============================================

        const themes = [
            // --- MISTY / LIGHT SETS ---
            { name: "Misty Original", colors: ["#FDFBFB", "#FFFFFF", "#C5A059"], dark: false, category: "light" },
            { name: "Rose Gold", colors: ["#FFF0F5", "#FFFFFF", "#D4AF37"], dark: false, category: "light" },
            { name: "Vintage Blush", colors: ["#F4E1E1", "#FFFAFA", "#8B5F65"], dark: false, category: "light" },
            { name: "Soft Romance", colors: ["#FFF5F7", "#FFFFFF", "#E6C2C2"], dark: false, category: "light" },
            { name: "Dusty Rose", colors: ["#E0D0D5", "#F5EBEB", "#5C4033"], dark: false, category: "light" },
            { name: "Porcelain Pink", colors: ["#FFFEFE", "#FFE4E1", "#708090"], dark: false, category: "light" },
            { name: "Misty Copper", colors: ["#FFE4E1", "#FFF", "#B87333"], dark: false, category: "light" },
            { name: "Champagne", colors: ["#FAF0E6", "#FFF5EE", "#C5A059"], dark: false, category: "light" },

            // --- MODERN / MINIMAL ---
            { name: "Scandi", colors: ["#F7F7F7", "#FFFFFF", "#333333"], dark: false, category: "modern" },
            { name: "Cream & Gold", colors: ["#F5F5DC", "#FFFFF0", "#DAA520"], dark: false, category: "modern" },
            { name: "Arctic", colors: ["#F0F8FF", "#FFFFFF", "#4682B4"], dark: false, category: "modern" },
            { name: "Urban", colors: ["#F0F0F0", "#FFFFFF", "#FF4500"], dark: false, category: "modern" },
            { name: "Latte", colors: ["#EBE0D6", "#FFF8F0", "#6F4E37"], dark: false, category: "modern" },
            { name: "Pure Gold", colors: ["#FAFAFA", "#FFFFFF", "#FFD700"], dark: false, category: "modern" },
            { name: "Marble", colors: ["#E5E5E5", "#F9F9F9", "#000000"], dark: false, category: "modern" },
            { name: "Sage", colors: ["#F0FFF0", "#FFFFFF", "#556B2F"], dark: false, category: "modern" },
            { name: "Lavender", colors: ["#F3E5F5", "#FFFFFF", "#9370DB"], dark: false, category: "modern" },

            // --- DARK / PREMIUM ---
            { name: "Onyx", colors: ["#000000", "#111111", "#FFFFFF"], dark: true, category: "dark" },
            { name: "Midnight", colors: ["#0B1026", "#151B3B", "#C5A059"], dark: true, category: "dark" },
            { name: "Deep Space", colors: ["#121212", "#1E1E1E", "#BB86FC"], dark: true, category: "dark" },
            { name: "Emerald", colors: ["#04291C", "#083D2A", "#D4AF37"], dark: true, category: "dark" },
            { name: "Royal", colors: ["#1A0526", "#2D0A3D", "#E6C200"], dark: true, category: "dark" },
            { name: "Cosmic", colors: ["#121212", "#1E1E1E", "#BB86FC"], dark: true, category: "dark" },
            { name: "Chocolate", colors: ["#3E2723", "#4E342E", "#D7CCC8"], dark: true, category: "dark" },
            { name: "Gunmetal", colors: ["#263238", "#37474F", "#00BCD4"], dark: true, category: "dark" },
            { name: "Velvet Red", colors: ["#4A0404", "#600606", "#FFD700"], dark: true, category: "dark" },
            { name: "Space Grey", colors: ["#1C1C1E", "#2C2C2E", "#0A84FF"], dark: true, category: "dark" },
            { name: "Vampire", colors: ["#1A0000", "#2E0000", "#FF0000"], dark: true, category: "dark" },

            // --- EXTRA / VIBRANT ---
            { name: "Ocean", colors: ["#E0F7FA", "#4DD0E1", "#006064"], dark: false, category: "vibrant" },
            { name: "Sunset", colors: ["#FFF3E0", "#FFB74D", "#E65100"], dark: false, category: "vibrant" },
            { name: "Mint", colors: ["#E0F2F1", "#4DB6AC", "#004D40"], dark: false, category: "vibrant" },
            { name: "Berry", colors: ["#FCE4EC", "#F06292", "#880E4F"], dark: false, category: "vibrant" },
            { name: "Steel", colors: ["#ECEFF1", "#90A4AE", "#263238"], dark: false, category: "vibrant" },
            { name: "Cyber", colors: ["#0d0d0d", "#1a1a1a", "#00ffcc"], dark: true, category: "vibrant" },
            { name: "Miami", colors: ["#222", "#333", "#ff00ff"], dark: true, category: "vibrant" },
            { name: "Forest", colors: ["#1b2e1b", "#2a422a", "#55aa55"], dark: true, category: "vibrant" },
            { name: "Lemonade", colors: ["#FFFDE7", "#FFF59D", "#FBC02D"], dark: false, category: "vibrant" },
            { name: "Ice", colors: ["#E3F2FD", "#90CAF9", "#1565C0"], dark: false, category: "vibrant" },
            { name: "Ruby", colors: ["#2b0a0a", "#4a1212", "#ff3333"], dark: true, category: "vibrant" }
        ];

        let activeThemeIndex = themes.findIndex(t => t.name === "Onyx");

        function toggleThemePanel() {
            document.getElementById('themePanel').classList.toggle('active');
        }

        function initThemeGrid() {
            const container = document.getElementById('themeGridScroll');
            const categories = {
                light: { title: "Világos / Pasztell", themes: [] },
                modern: { title: "Modern / Minimál", themes: [] },
                dark: { title: "Sötét / Prémium", themes: [] },
                vibrant: { title: "Vibráló / Extra", themes: [] }
            };

            themes.forEach((t, i) => {
                categories[t.category].themes.push({ ...t, index: i });
            });

            let html = '';
            for (const [key, cat] of Object.entries(categories)) {
                html += `<div class="theme-category">
                    <div class="theme-category-title">${cat.title}</div>
                    <div class="theme-grid-mini">`;

                cat.themes.forEach(t => {
                    const isActive = t.index === activeThemeIndex ? 'active' : '';
                    html += `
                        <div class="theme-card-mini ${isActive}" data-index="${t.index}" onclick="selectTheme(${t.index})">
                            <div class="t-bar">
                                <div class="t-b-main" style="background:${t.colors[0]}"></div>
                                <div class="t-b-sec" style="background:${t.colors[1]}"></div>
                                <div class="t-b-acc" style="background:${t.colors[2]}"></div>
                            </div>
                            <div class="t-label">${t.name}</div>
                        </div>`;
                });

                html += `</div></div>`;
            }

            container.innerHTML = html;
        }

        function selectTheme(index) {
            activeThemeIndex = index;
            const t = themes[index];
            applyTheme(t);

            // Update color pickers
            document.getElementById('customBgColor').value = t.colors[0];
            document.getElementById('customBlobColor').value = t.colors[1];
            document.getElementById('customAccentColor').value = t.colors[2];

            // Update active state in grid
            document.querySelectorAll('.theme-card-mini').forEach(card => {
                card.classList.remove('active');
                if (parseInt(card.dataset.index) === index) {
                    card.classList.add('active');
                }
            });
        }

        function applyTheme(t) {
            const root = document.documentElement;

            // Background and blobs
            root.style.setProperty('--bg-color', t.colors[0]);
            root.style.setProperty('--blob-1', t.colors[1]);
            root.style.setProperty('--blob-2', t.colors[2]);
            root.style.setProperty('--blob-3', t.dark ? t.colors[1] : adjustColor(t.colors[1], 30));

            // Adjust for dark/light themes
            if (t.dark) {
                root.style.setProperty('--glass-surface', 'rgba(0, 0, 0, 0.4)');
                root.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.1)');
                root.style.setProperty('--glass-highlight', 'rgba(255, 255, 255, 0.15)');
                root.style.setProperty('--text-main', '#f0f0f0');
                root.style.setProperty('--text-muted', '#aaaaaa');
                // Card backgrounds for dark themes
                root.style.setProperty('--card-bg', 'rgba(40, 40, 40, 0.6)');
                root.style.setProperty('--card-bg-hover', 'rgba(60, 60, 60, 0.7)');
                root.style.setProperty('--card-bg-light', 'rgba(30, 30, 30, 0.6)');
                root.style.setProperty('--card-bg-medium', 'rgba(50, 50, 50, 0.7)');
                root.style.setProperty('--modal-bg', 'rgba(20, 20, 20, 0.95)');
                // Panel/Editor backgrounds for dark themes
                root.style.setProperty('--panel-bg', 'rgba(0, 0, 0, 0.2)');
                root.style.setProperty('--panel-border', '#444444');
                root.style.setProperty('--divider-color', '#444444');
                root.style.setProperty('--text-dim', '#888888');
                root.style.setProperty('--text-bright', '#ffffff');
            } else {
                root.style.setProperty('--glass-surface', 'rgba(255, 255, 255, 0.35)');
                root.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.5)');
                root.style.setProperty('--glass-highlight', 'rgba(255, 255, 255, 0.8)');
                root.style.setProperty('--text-main', '#2F2022');
                root.style.setProperty('--text-muted', '#6B5B5B');
                // Card backgrounds for light themes
                root.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.4)');
                root.style.setProperty('--card-bg-hover', 'rgba(255, 255, 255, 0.6)');
                root.style.setProperty('--card-bg-light', 'rgba(255, 255, 255, 0.3)');
                root.style.setProperty('--card-bg-medium', 'rgba(255, 255, 255, 0.5)');
                root.style.setProperty('--modal-bg', 'rgba(245, 245, 245, 0.95)');
                // Panel/Editor backgrounds for light themes
                root.style.setProperty('--panel-bg', 'rgba(255, 255, 255, 0.3)');
                root.style.setProperty('--panel-border', '#cccccc');
                root.style.setProperty('--divider-color', '#dddddd');
                root.style.setProperty('--text-dim', '#888888');
                root.style.setProperty('--text-bright', '#333333');
            }

            // Accent color
            root.style.setProperty('--accent', t.colors[2]);
            root.style.setProperty('--accent-gradient', `linear-gradient(135deg, ${t.colors[2]} 0%, ${adjustColor(t.colors[2], 20)} 100%)`);
        }

        function updateCustomColor() {
            // Just for live preview - doesn't apply until button clicked
        }

        function applyCustomColors() {
            const bgColor = document.getElementById('customBgColor').value;
            const blobColor = document.getElementById('customBlobColor').value;
            const accentColor = document.getElementById('customAccentColor').value;

            // Determine if it's a dark theme based on background luminance
            const isDark = getLuminance(bgColor) < 0.5;

            const customTheme = {
                name: "Custom",
                colors: [bgColor, blobColor, accentColor],
                dark: isDark,
                category: "custom"
            };

            applyTheme(customTheme);

            // Deselect all preset themes
            document.querySelectorAll('.theme-card-mini').forEach(card => {
                card.classList.remove('active');
            });
        }

        function adjustColor(hex, percent) {
            // Lighten or darken a hex color
            hex = hex.replace('#', '');
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }

            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);

            r = Math.min(255, Math.max(0, r + (r * percent / 100)));
            g = Math.min(255, Math.max(0, g + (g * percent / 100)));
            b = Math.min(255, Math.max(0, b + (b * percent / 100)));

            return '#' + Math.round(r).toString(16).padStart(2, '0') +
                Math.round(g).toString(16).padStart(2, '0') +
                Math.round(b).toString(16).padStart(2, '0');
        }

        function getLuminance(hex) {
            hex = hex.replace('#', '');
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            const r = parseInt(hex.substring(0, 2), 16) / 255;
            const g = parseInt(hex.substring(2, 4), 16) / 255;
            const b = parseInt(hex.substring(4, 6), 16) / 255;
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }

        // Initialize theme grid on page load
        document.addEventListener('DOMContentLoaded', function () {
            initThemeGrid();
            // Apply Onyx theme by default (it's already styled for it)
            selectTheme(activeThemeIndex);
        });

    </script>
    <!-- Full Screen Preview Modal -->
    <div id="fs-preview-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:10000; background:rgba(0,0,0,0.95); flex-direction:column;">
        <div class="fs-toolbar"
            style="padding:10px; background:rgba(20,20,20,0.8); display:flex; gap:15px; justify-content:center; align-items:center; border-bottom:1px solid #444;">
            <div class="fs-controls" style="display:flex; gap:10px; align-items:center;">
                <button class="add-btn secondary" style="padding:5px 15px;"
                    onclick="window.setPreviewZoom('fit')">Ablakhoz igazít</button>
                <button class="add-btn secondary" style="padding:5px 15px;" onclick="window.setPreviewZoom(1)">1:1
                    Méret</button>
                <input type="range" id="fs-zoom-slider" min="0.1" max="5" step="0.1" value="1"
                    oninput="window.manualZoom(this.value)" style="width:150px;">
                <span id="fs-zoom-level" style="color:white; font-size:12px; width:40px;">100%</span>
            </div>
            <button class="fs-close"
                style="background:none; border:none; color:white; font-size:24px; cursor:pointer; margin-left:20px;"
                onclick="window.closeFullScreenView()">✕</button>
        </div>
        <div id="fs-content-container"
            style="flex:1; overflow:hidden; position:relative; cursor:grab; display:flex; justify-content:center; align-items:center;"
            onmousedown="window.startPan(event)">
            <div id="fs-content-inner"
                style="transform-origin:center center; transition:transform 0.1s ease-out; width:100%; height:100%;">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>
</body>

</html>