<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Print ‚Äì Term√©k Tervez≈ë</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --color-primary: #1E1E1E;         
            --color-secondary: #A23E48;       
            --color-accent: #2872BA;          
            --color-light-bg: #FFE4E1;        
            --color-neutral-bg: #FFFFFF;      
            --canvas-border-color: #333333;
        }

        body {
            background-color: var(--color-light-bg); 
            color: var(--color-primary); 
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .text-primary { color: var(--color-primary) !important; }
        .text-secondary { color: var(--color-secondary) !important; }
        .text-accent { color: var(--color-accent) !important; }
        .bg-primary { background-color: var(--color-primary) !important; }
        .bg-light-bg { background-color: var(--color-light-bg) !important; }
        .bg-neutral-bg { background-color: var(--color-neutral-bg) !important; }
        .border-accent { border-color: var(--color-accent) !important; }

        .navbar {
            background-color: var(--color-neutral-bg) !important;
            border-bottom: 3px solid var(--color-secondary);
        }

        .editor-container {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            height: calc(100vh - 180px);
            min-height: 600px;
        }

        .left-column {
            flex: 0 0 70%;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .right-column {
            flex: 0 0 30%;
            padding: 2rem;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .right-column::-webkit-scrollbar {
            width: 10px;
        }
        
        .right-column::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .right-column::-webkit-scrollbar-thumb {
            background: var(--color-secondary);
            border-radius: 10px;
        }
        
        .right-column::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent);
        }

        @media (max-width: 991px) {
            .editor-container {
                flex-direction: column;
                height: auto;
            }
            
            .left-column, .right-column {
                flex: 1 1 auto;
            }
            
            .left-column {
                min-height: 400px;
            }
            
            .right-column {
                overflow-y: visible;
            }
        }

        .preview-area {
            height: 100%;
            width: 100%;
            max-width: 100%;
            background-color: #f0f0f0;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 400px;
            border: 4px dashed var(--color-secondary); 
            padding: 0;
        }

        #main-canvas {
            display: none;
            max-width: 100%;
            max-height: 100%;
        }

        .preview-area.has-image {
            border-radius: 0px;
            border: none; 
            background-color: var(--color-neutral-bg);
            cursor: default;
            box-shadow: none !important;
        }

        .preview-area.placing-smartpoint {
            cursor: crosshair !important;
        }

        .preview-area.drag-over:not(.has-image) {
            border-color: var(--color-accent) !important;
            box-shadow: 0 0 15px 3px color-mix(in srgb, var(--color-accent), transparent 50%);
            background-color: var(--color-neutral-bg);
        }
        
        .btn-accent {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
            color: var(--color-neutral-bg) !important;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .btn-accent:hover {
            background-color: color-mix(in srgb, var(--color-accent), black 10%); 
            border-color: color-mix(in srgb, var(--color-accent), black 10%);
        }
        
        .btn-toggle.active {
            background-color: #a2d1ff !important;
            border-color: #a2d1ff !important;
            color: var(--color-neutral-bg) !important;
        }
        .btn-toggle-secondary.active {
            background-color: var(--color-secondary) !important;
            border-color: var(--color-secondary) !important;
            color: var(--color-neutral-bg) !important;
        }

        #custom-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--color-secondary);
            color: var(--color-neutral-bg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            text-align: center;
        }

        .smartpoint-item {
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }

        .smartpoint-item.placing {
            border-color: var(--color-secondary);
            background-color: #ffe4e1;
        }

        .collapse-header {
            cursor: pointer;
            user-select: none;
        }

        .collapse-header:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html"><span class="text-accent">üñºÔ∏è</span> SMART PRINT EDITOR</a>
            <div class="ms-auto text-primary fw-bold">
                <span id="current-price">0 Ft</span>
            </div>
        </div>
    </nav>
    
    <main class="container-fluid py-4">
        <h1 class="text-center fw-bold mb-4 text-primary">Tervezd meg a nyomatodat</h1>

        <div class="editor-container bg-neutral-bg mx-3">
            
            <div class="left-column">
                <div class="preview-area shadow-lg" id="drop-zone">
                    <canvas id="main-canvas" width="600" height="400"></canvas>
                    <p id="placeholder-text" class="text-secondary fw-bold" style="opacity: 0.6;"><i class="fa-solid fa-cloud-arrow-up me-2"></i> K√©p felt√∂lt√©s√©hez h√∫zd ide, vagy kattints ide!</p>
                </div>
            </div>
            
            <div class="right-column">
                <form id="editor-form">
                    
                    <div id="print-view-section">
                    
                    <p class="mb-3 text-center text-primary fw-bold p-2 rounded bg-light-bg" id="size_nemkif_" style="display:none">
                        A V√ÅSZONK√âP M√âRETE: <span id="display-width">60</span> x <span id="display-height">40</span> cm
                    </p>
                    <p class="mb-3 text-center text-primary fw-bold p-2 rounded bg-light-bg" id="size_kif_">
                        A V√ÅSZONK√âP M√âRETE: <span id="mid-width">60</span> x <span id="mid-height">40</span> cm
                    </p>

                    <div class="row g-3" id="size_nemkif" style="display:none">
                        <div class="col-6">
                            <label for="input-width" class="form-label text-secondary">Sz√©less√©g (cm)</label>
                            <input type="number" id="input-width" class="form-control" min="1" max="30000" value="60">
                        </div>
                        <div class="col-6">
                            <label for="input-height" class="form-label text-secondary">Magass√°g (cm)</label>
                            <input type="number" id="input-height" class="form-control" min="1" max="30000" value="40">
                        </div>
                    </div>
                    <div class="row g-3" id="size_kif" style="text-align: center;">
                        <div class="col-6">
                            <label for="input-widthS" class="form-label text-secondary">Sz√©less√©g (cm)</label>
                            <input type="number" id="input-widthS" class="form-control" min="1" max="30000" value="60" size="5">
                        </div>
                        <div class="col-6">
                            <label for="input-heightS" class="form-label text-secondary">Magass√°g (cm)</label>
                            <input type="number" id="input-heightS" class="form-control" min="1" max="30000" value="40" size="5">
                        </div>
                    </div>
                    
                    <div class="form-check mt-3 mb-4" style="display:none">
                        <input class="form-check-input" type="checkbox" value="" id="lock-aspect-ratio" checked>
                        <label class="form-check-label text-primary" for="lock-aspect-ratio">
                            K√©par√°ny megtart√°sa (ar√°nyos m√©retez√©s)
                        </label>
                    </div>
                    <div style="margin-bottom: 1.5rem !important;"></div>

                        <button id="printViewButton" type="button" class="btn btn-outline-secondary w-100 mb-3 btn-toggle active" data-mode="standard">
                            <p class="fw-bold" style="margin-bottom: 0px"> √âl el≈ën√©zet: <span id="printViewStatus" class="fw-bold text-accent">BE</span></p>
                            <p id="printViewStatusBe" class="" style="margin-bottom: 0px">A nyomat kiter√≠tve l√°tszik: K√∂z√©pen "a v√°szonk√©p", az oldalai pedig mellette, elhalv√°ny√≠tva.<br>A k√©sz v√°szonk√©pen nem lesz elhalv√°ny√≠tva, ezt csak az el≈ën√©zet kedv√©√©rt √≠gy jelezz√ºk a k√©pen.<br>Ha szeretn√©d halv√°ny√≠t√°s n√©lk√ºl megn√©zni a kiter√≠tett el≈ën√©zetet, kattints az "Halv√°ny√≠t√°s elrejt√©se" gombra.</p>
                            <p id="printViewStatusKi" class="" style="margin-bottom: 0px; display: none">Most csak "a v√°szonk√©p" l√°tszik szemb≈ël, ahogy a faladon lesz. </p>
                        </button>
                    
                        <div id="edge-options-group" class="p-3 border rounded mb-4" >
                            
                            <div class="mb-3" style="text-align: center;">
                                <button id="standardEdgesButton" type="button" class="btn btn-outline-secondary w-100 mb-2 btn-toggle-secondary active" data-edge-mode="standard">Kifut√≥s √âlek</button>
                                <button id="eyeButton" type="button" class="btn btn-outline-secondary w-100 mb-2 btn-toggle-secondary active" data-edge-mode="eye" style="width: auto !important; display:none">Halv√°ny√≠t√°s elrejt√©se</button>
                            </div>
                            <div class="mb-3">
                                <button id="colorEdgesButton" type="button" class="btn btn-outline-secondary w-100 mb-2 btn-toggle-secondary" data-edge-mode="color">Sz√≠nes √âlek</button>
                                <div id="szineselSzinDiv" class="d-flex align-items-center mt-2" style="display:none !important; justify-content: center;">
                                    <input type="color" id="szele" name="szele" value="#FF0000" class="form-control form-control-color me-2">
                                    <label for="szele" class="text-primary">A sz√©l√©nek a sz√≠ne</label>
                                </div>
                            </div>
                            
                            <div class="btn-group w-100" role="group">
                                <button id="mirroredEdgesButton" type="button" class="btn btn-outline-secondary w-50 btn-toggle-secondary" data-edge-mode="mirrored1">T√ºkr√∂z√∂tt √âlek</button>
                                <button id="mirroredEdges2Button" type="button" class="btn btn-outline-secondary w-50 btn-toggle-secondary" data-edge-mode="mirrored2">Megkett≈ëz√∂tt √âlek</button>
                            </div>

                            <input type="hidden" id="edgeMode" value="standard">
                        </div>
                    </div>


                    <!-- Okospont szekci√≥ -->
                    <div class="p-3 border rounded mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h8 class="fw-bold text-primary mb-0">Adj hozz√° Okospontot</h8>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#smartPointCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapse" id="smartPointCollapse">
                            <div class="mb-3">
                                <button type="button" id="add-smart-point-btn" class="btn btn-outline-secondary w-100 mb-2">
                                    <i class="fas fa-plus me-2"></i>√öj Okospont hozz√°ad√°sa
                                </button>
                                
                                <div id="smart-point-type-selector" class="mb-3" style="display: none;">
                                    <label class="form-label text-secondary">V√°laszd ki az Okospont t√≠pus√°t:</label>
                                    <div class="btn-group-vertical w-100" role="group">
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="audio">
                                            <i class="fas fa-music me-2"></i>Hangf√°jl felt√∂lt√©se
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="video">
                                            <i class="fas fa-video me-2"></i>Vide√≥ felt√∂lt√©se
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="image">
                                            <i class="fas fa-image me-2"></i>K√©p felt√∂lt√©se
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="images">
                                            <i class="fas fa-images me-2"></i>K√©pek felt√∂lt√©se
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="youtube">
                                            <i class="fab fa-youtube me-2"></i>YouTube URL
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="spotify">
                                            <i class="fab fa-spotify me-2"></i>Spotify URL
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary text-start smart-point-type" data-type="url">
                                            <i class="fas fa-link me-2"></i>B√°rmilyen URL
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="smart-point-content-input" class="mb-3" style="display: none;">
                                    <div id="smart-point-url-input" class="mb-2">
                                        <label class="form-label text-secondary">URL:</label>
                                        <input type="url" id="smart-point-url" class="form-control" placeholder="https://...">
                                    </div>
                                    <div id="smart-point-file-input" class="mb-2" style="display: none;">
                                        <label class="form-label text-secondary">F√°jl felt√∂lt√©se:</label>
                                        <input type="file" id="smart-point-file" class="form-control" accept="audio/*,video/*,image/*">
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" id="save-smart-point-btn" class="btn btn-accent btn-sm">
                                            <i class="fas fa-save me-1"></i>Ment√©s
                                        </button>
                                        <button type="button" id="cancel-smart-point-btn" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-times me-1"></i>M√©gse
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="smart-points-list" class="mb-3">
                                <!-- Ide ker√ºlnek a l√©trehozott okospontok -->
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" id="place-smart-point-btn" class="btn btn-outline-secondary">
                                    <i class="fas fa-map-marker-alt me-2"></i>Okospont lehelyez√©se
                                </button>
                                <button type="button" id="move-smart-point-btn" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-arrows-alt me-2"></i>Okospont √°thelyez√©se
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- OKOSPONT SZEKCI√ì -->
                    <div class="p-3 border rounded mb-4">
                        <div class="collapse-header p-2 rounded" data-bs-toggle="collapse" data-bs-target="#smartpointSection">
                            <h5 class="text-center fw-bold mb-0 text-primary">
                                <i class="fa-solid fa-circle-dot me-2"></i>Adj hozz√° Okospontot 
                                <i class="fa-solid fa-chevron-down float-end"></i>
                            </h5>
                        </div>
                        
                        <div class="collapse" id="smartpointSection">
                            <div class="mt-3">
                                <button type="button" id="addSmartpointBtn" class="btn btn-accent w-100 mb-3">
                                    <i class="fa-solid fa-plus me-2"></i>√öj Okospont hozz√°ad√°sa
                                </button>

                                <button type="button" id="toggleSmartpointsBtn" class="btn btn-outline-secondary w-100 mb-3" style="display:none;">
                                    <i class="fa-solid fa-eye me-2"></i><span id="toggleSmartpointsText">Okospontok elrejt√©se</span>
                                </button>

                                <div id="smartpointsList"></div>
                            </div>
                        </div>
                    </div>

                    <input type="file" id="image-upload" accept="image/jpeg, image/png" style="display: none;">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light-bg rounded">
                        <span class="text-primary fw-bold">V√©g√∂sszeg:</span>
                        <span id="final-price" class="fs-4 fw-bolder text-accent">0 Ft</span>
                    </div>
                    <button type="submit" class="btn btn-accent btn-lg w-100 fw-bold shadow-lg"><i class="fa-solid fa-cart-shopping me-2"></i> Kos√°rba √©s Tov√°bb</button>

                    <div id="image-control-group" class="mt-4 p-3 border rounded" style="display: none;">
                        <button id="change-image-btn" class="btn btn-secondary w-100 mb-3" type="button">
                            <i class="fa-solid fa-sync-alt me-2"></i> K√©p cser√©je
                        </button>
                        <div class="text-center small">
                            <p class="mb-1 text-primary">
                                Felt√∂lt√∂tt m√©ret: <span id="display-px-width" class="fw-bold">0</span> x <span id="display-px-height" class="fw-bold">0</span> px
                            </p>
                            <p class="mb-0 text-secondary">
                                K√©p DPI-je (Nyomtat√°si felbont√°s): <span id="display-dpi" class="fw-bold">70</span> DPI
                            </p>
                        </div>
                    </div>
                    
                </form>
            </div>
        </div>
    </main>
    
    <div id="custom-message" class="shadow">
        <p id="message-text" class="fw-bold mb-1"></p>
        <button id="close-message-btn" class="btn btn-sm btn-outline-light mt-2">Bez√°r√°s</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const pricing = {
            'V√°szonk√©p': 0.00035,
            'Okosk√©p': 0.00045,
            'Alapd√≠j': 500,
            'Okosk√©pFel√°r': 1500
        };
        
        const DPI_ASSUMPTION = 70;
        const INCH_TO_CM = 2.54;
        const PAGE_WIDTH_CM = 2;
        const SMARTPOINT_RADIUS_CM = 1;
        
        let originalImage = null;
        let originalWidthPx = 0;
        let originalHeightPx = 0;
        let canvas, ctx;
        let isImageLoaded = false;
        let printViewActive = true;
        let effectiveDpi = DPI_ASSUMPTION;
        let originalImageURL = "";
        let originalImageName = "";
        let eyeButton = true;
        
        let smartpoints = [];
        let nextSmartpointId = 1;
        let placingSmartpointId = null;
        let showSmartpoints = true;
        
        function calculatePrice(product, width, height) {
            if (!width || !height || width <= 0 || height <= 0) return 0;
            const area = width * height;
            const rate = pricing[product] || 0;
            let price = pricing.Alapd√≠j + (area * rate); 
            if (product === 'Okosk√©p') {
                price += pricing.Okosk√©pFel√°r;
            }
            return Math.round(price);
        }
        
        function calculateInitialCM(pixels, dpi = DPI_ASSUMPTION) {
            const finalDpi = dpi > 0 ? dpi : DPI_ASSUMPTION;
            return (pixels / finalDpi) * INCH_TO_CM;
        }

        function calculateCropSizePx() {
            const imageWidthCm = parseFloat($('#input-width').val()) || 1;
            const imageHeightCm = parseFloat($('#input-height').val()) || 1;
            
            if (originalWidthPx <= 0 || imageWidthCm <= 0 || originalHeightPx <= 0 || imageHeightCm <= 0) {
                 return 50;
            }
            //const cropSize = ( originalWidthPx / imageWidthCm ) * pageWidth;
            console.log("imageWidthCm", imageWidthCm);
            console.log("imageHeightCm", imageHeightCm);
            
            const ratioX = originalWidthPx / imageWidthCm;
            const ratioY = originalHeightPx / imageHeightCm;
            console.log("ratioX", ratioX);
            console.log("ratioY", ratioY);
            const cropSizeX = ratioX * PAGE_WIDTH_CM;
            const cropSizeY = ratioY * PAGE_WIDTH_CM;
            console.log("cropSizeX", cropSizeX);
            console.log("cropSizeY", cropSizeY);
            const cropSize = Math.min(cropSizeX, cropSizeY);
            console.log("cropSize", cropSize);
            return cropSize;
        }

        function calculateSmartpointRadiusPx() {
            const imageWidthCm = parseFloat($('#input-width').val()) || 1;
            if (originalWidthPx <= 0 || imageWidthCm <= 0) return 20;
            const pxPerCm = originalWidthPx / imageWidthCm;
            return pxPerCm * SMARTPOINT_RADIUS_CM;
        }

        function showMessage(text) {
            $('#message-text').text(text);
            $('#custom-message').fadeIn(300);
        }

        function drawCanvas() {
            if (!isImageLoaded || !originalImage) {
                $('#main-canvas').hide();
                $('#placeholder-text').show();
                return;
            }

            const CROP_SIZE_PX = calculateCropSizePx();
            const imgW = originalWidthPx;
            const imgH = originalHeightPx;
            const edgeMode = $('#edgeMode').val();
            const t = CROP_SIZE_PX;
            console.log("t = CROP_SIZE_PX t", t);

            $('#main-canvas').show();
            $('#placeholder-text').hide();
            
            if (!printViewActive && (edgeMode === 'standard' || edgeMode === 'eye')) {
                const totalW = imgW - (2 * t);
                const totalH = imgH - (2 * t);
                canvas.width = totalW;
                canvas.height = totalH;
                ctx.clearRect(0, 0, totalW, totalH);
                ctx.drawImage(originalImage, t, t, totalW, totalH, 0, 0, totalW, totalH);
                drawSmartpoints();
                updatePreviewAreaOrientation(totalW, totalH);
                return; 
            }

            if (!printViewActive && edgeMode !== 'standard' && edgeMode !== 'eye') {
                const totalW = imgW;
                const totalH = imgH;
                canvas.width = totalW;
                canvas.height = totalH;
                ctx.clearRect(0, 0, totalW, totalH);
                ctx.drawImage(originalImage, 0, 0, totalW, totalH, 0, 0, totalW, totalH);
                drawSmartpoints();
                updatePreviewAreaOrientation(totalW, totalH);
                return; 
            }

            if ((printViewActive && (edgeMode === 'standard' || edgeMode === 'eye')) && eyeButton) {
                canvas.width = imgW;
                canvas.height = imgH;
                ctx.clearRect(0, 0, imgW, imgH);
                ctx.drawImage(originalImage, 0, 0, imgW, imgH);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                
                const imageWidthCm = parseFloat($("#input-width").val());
                const originalWidthPx = imgW;
                var pageWidth = 2;
                const cropSize = ( originalWidthPx / imageWidthCm ) * pageWidth;

                ctx.fillRect(0, 0, canvas.width, cropSize);
                ctx.fillRect(0, canvas.height - cropSize, canvas.width, cropSize);
                ctx.fillRect(0, 0, cropSize, canvas.height);
                ctx.fillRect(canvas.width - cropSize, 0, cropSize, canvas.height);

                drawSmartpoints();
                updatePreviewAreaOrientation(imgW, imgH);
                return;
            }

            if ((printViewActive && (edgeMode === 'standard' || edgeMode === 'eye')) && !eyeButton) {
                canvas.width = imgW;
                canvas.height = imgH;
                ctx.clearRect(0, 0, imgW, imgH);
                ctx.drawImage(originalImage, 0, 0, imgW, imgH);
                drawSmartpoints();
                updatePreviewAreaOrientation(imgW, imgH);
                return;
            }

            const totalW = imgW + (2 * t);
            const totalH = imgH + (2 * t);
            canvas.width = totalW;
            canvas.height = totalH;
            ctx.clearRect(0, 0, totalW, totalH);
            
            if (edgeMode === 'color') {
                const color = $('#szele').val(); 
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, totalW, totalH);
            } else if (printViewActive && edgeMode.startsWith('mirrored')) {
                const drawEdgeChunk = (sx, sy, sw, sh, dx, dy, dw, dh, flipX = 1, flipY = 1) => {
                    ctx.save();
                    ctx.translate(dx + (dw / 2), dy + (dh / 2));
                    ctx.scale(flipX, flipY);
                    ctx.drawImage(originalImage, sx, sy, sw, sh, -dw / 2, -dh / 2, dw, dh);
                    ctx.restore();
                };

                const flipX = edgeMode === 'mirrored1' ? -1 : 1;
                const flipY = edgeMode === 'mirrored1' ? -1 : 1;
                
                drawEdgeChunk(imgW - t, 0, t, imgH, imgW + t, t, t, imgH, flipX, 1);
                drawEdgeChunk(0, 0, t, imgH, 0, t, t, imgH, flipX, 1);
                drawEdgeChunk(0, imgH - t, imgW, t, t, imgH + t, imgW, t, 1, flipY);
                drawEdgeChunk(0, 0, imgW, t, t, 0, imgW, t, 1, flipY);
            }

            ctx.drawImage(originalImage, t, t, imgW, imgH);
            drawSmartpoints(t);
            updatePreviewAreaOrientation(totalW, totalH);
        }

        function drawSmartpoints(offset = 0) {
            if (!showSmartpoints || smartpoints.length === 0) return;

            const radius = calculateSmartpointRadiusPx();
            
            smartpoints.forEach(sp => {
                if (!sp.x || !sp.y) return;
                
                const x = sp.x + offset;
                const y = sp.y + offset;
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold ' + (radius * 1.2) + 'px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(sp.id, x, y);
            });
        }

        function updatePreviewAreaOrientation(imgW, imgH) {
             const aspectRatio = imgW / imgH;
             const dropZone = $('#drop-zone');
             dropZone.removeClass('orientation-landscape orientation-portrait');
             if (aspectRatio >= 1) {
                 dropZone.addClass('orientation-landscape');
             } else {
                 dropZone.addClass('orientation-portrait');
             }
        }

        function addSmartpoint() {
            const id = nextSmartpointId++;
            const smartpoint = {
                id: id,
                type: null,
                content: null,
                x: null,
                y: null,
                placed: false
            };
            smartpoints.push(smartpoint);
            renderSmartpointsList();
            updateToggleSmartpointsButton();
            return id;
        }

        function removeSmartpoint(id) {
            smartpoints = smartpoints.filter(sp => sp.id !== id);
            if (placingSmartpointId === id) {
                placingSmartpointId = null;
                $('#drop-zone').removeClass('placing-smartpoint');
            }
            renderSmartpointsList();
            updateToggleSmartpointsButton();
            drawCanvas();
        }

        function updateToggleSmartpointsButton() {
            const btn = $('#toggleSmartpointsBtn');
            if (smartpoints.length > 0) {
                btn.show();
                const text = smartpoints.length === 1 ? 'Okospont' : 'Okospontok';
                const action = showSmartpoints ? 'elrejt√©se' : 'mutat√°sa';
                $('#toggleSmartpointsText').text(`${text} ${action}`);
            } else {
                btn.hide();
            }
        }

        function renderSmartpointsList() {
            const container = $('#smartpointsList');
            container.empty();
            
            if (smartpoints.length === 0) {
                container.html('<p class="text-center text-secondary small">M√©g nincs Okospont hozz√°adva</p>');
                return;
            }
            
            smartpoints.forEach(sp => {
                const isPlacing = placingSmartpointId === sp.id;
                const placeButtonText = sp.placed ? 'Okospont √°thelyez√©se' : 'Okospont lehelyez√©se';
                const placeButtonClass = isPlacing ? 'btn-warning' : 'btn-primary';
                
                const item = $(`
                    <div class="smartpoint-item ${isPlacing ? 'placing' : ''}" data-id="${sp.id}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="text-accent">${sp.id}. Okospont</strong>
                            <button type="button" class="btn btn-sm btn-danger remove-smartpoint" data-id="${sp.id}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                        

                        <select class="form-select form-select-sm mb-2 smartpoint-type" data-id="${sp.id}">
                            <option value="">V√°lassz t√≠pust...</option>
                            <option value="audio" ${sp.type === 'audio' ? 'selected' : ''}>Hangf√°jl felt√∂lt√©se</option>
                            <option value="video" ${sp.type === 'video' ? 'selected' : ''}>Vide√≥ felt√∂lt√©se</option>
                            <option value="image" ${sp.type === 'image' ? 'selected' : ''}>K√©p felt√∂lt√©se</option>
                            <option value="images" ${sp.type === 'images' ? 'selected' : ''}>K√©pek felt√∂lt√©se</option>
                            <option value="youtube" ${sp.type === 'youtube' ? 'selected' : ''}>YouTube URL</option>
                            <option value="spotify" ${sp.type === 'spotify' ? 'selected' : ''}>Spotify URL</option>
                            <option value="url" ${sp.type === 'url' ? 'selected' : ''}>B√°rmilyen URL</option>
                        </select>
                        
                        <div class="smartpoint-content mb-2" data-id="${sp.id}">
                            ${renderSmartpointContent(sp)}
                        </div>
                        
                        <button type="button" class="btn btn-sm ${placeButtonClass} w-100 place-smartpoint" data-id="${sp.id}">
                            <i class="fa-solid fa-map-pin me-1"></i>${placeButtonText}
                        </button>
                        ${sp.placed ? `<small class="text-success d-block mt-1 text-center"><i class="fa-solid fa-check-circle"></i> Lehelyezve</small>` : ''}
                    </div>
                `);
                
                container.append(item);
            });
        }

        function renderSmartpointContent(sp) {
            if (!sp.type) {
                return '<small class="text-muted">V√°lassz t√≠pust a tartalomhoz</small>';
            }
            
            if (sp.type === 'audio' || sp.type === 'video' || sp.type === 'image' || sp.type === 'images') {
                return `
                    <input type="file" class="form-control form-control-sm smartpoint-file" 
                           data-id="${sp.id}" 
                           accept="${getAcceptType(sp.type)}"
                           ${sp.type === 'images' ? 'multiple' : ''}>
                    ${sp.content ? `<small class="text-success mt-1 d-block"><i class="fa-solid fa-check"></i> F√°jl felt√∂ltve</small>` : ''}
                `;
            } else {
                const placeholder = sp.type === 'youtube' ? 'https://youtube.com/watch?v=...' :
                                  sp.type === 'spotify' ? 'https://open.spotify.com/...' :
                                  'https://...';
                return `
                    <input type="url" class="form-control form-control-sm smartpoint-url" 
                           data-id="${sp.id}" 
                           placeholder="${placeholder}"
                           value="${sp.content || ''}">
                `;
            }
        }

        function getAcceptType(type) {
            switch(type) {
                case 'audio': return 'audio/*';
                case 'video': return 'video/*';
                case 'image':
                case 'images': return 'image/*';
                default: return '*/*';
            }
        }

        function processImageFile(file) {
            console.log("processImageFile");
            if (!file || !file.type.match('image/jpeg|image/png')) {
                showMessage("A f√°jl nem megfelel≈ë k√©p form√°tum√∫! K√©rj√ºk, JPG vagy PNG f√°jlt t√∂lts√∂n fel.");
                return;
            }
          
            originalImageName = file.name;
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const dataUrl = event.target.result;
                originalImageURL = event.target.result;
                originalImage = new Image();
                originalImage.onload = function() {
                    isImageLoaded = true;
                    originalWidthPx = originalImage.width;
                    originalHeightPx = originalImage.height;
                    const aspectRatio = originalWidthPx / originalHeightPx;
                    
                    let isDefaultDpi = true;
                    
                    EXIF.getData(file, function() {
                        const xResolutionTag = EXIF.getTag(this, "XResolution");
                        const yResolutionTag = EXIF.getTag(this, "YResolution"); 
                        const resolutionUnit = EXIF.getTag(this, "ResolutionUnit"); 

                        let dpiValue = 0;
                        const resolutionToUse = xResolutionTag || yResolutionTag;

                        if (resolutionToUse) {
                            if (resolutionToUse.numerator && resolutionToUse.denominator) {
                                dpiValue = resolutionToUse.numerator / resolutionToUse.denominator;
                            } else {
                                dpiValue = resolutionToUse;
                            }

                            if (dpiValue > 0) {
                                if (resolutionUnit === 2 || !resolutionUnit) {
                                    effectiveDpi = dpiValue;
                                }
                                else if (resolutionUnit === 3) {
                                    effectiveDpi = dpiValue * INCH_TO_CM;
                                }
                                isDefaultDpi = false; 
                            }
                        } 
                        
                        if (isDefaultDpi) {
                            console.warn(`EXIF: Felbont√°si adatok hi√°nyoznak. Az alap√©rtelmezett ${DPI_ASSUMPTION} DPI √©rt√©k haszn√°lata.`);
                        }
                        
                        const initialWidthCm = calculateInitialCM(originalWidthPx, effectiveDpi);
                        const initialHeightCm = calculateInitialCM(originalHeightPx, effectiveDpi);
                        const initialWidthSCm = initialWidthCm - 4;
                        const initialHeightSCm = initialHeightCm - 4;
                        
                        $('#main-canvas').css('display', 'block');
                        $('#placeholder-text').hide();
                        $('#drop-zone').removeClass('drag-over').addClass('has-image').css('min-height', 0); 
                        
                        $('#image-control-group').slideDown(200); 
                        $('#eyeButton').slideDown(200); 
                        setTimeout( function () {
                            $('#eyeButton').addClass("active"); 
                        }, 10);
                        $('#print-view-section').show();
                        
                        $('#display-px-width').text(originalWidthPx);
                        $('#display-px-height').text(originalHeightPx);
                        $('#display-dpi').text(Math.round(effectiveDpi));

                        $('#editor-form').data('aspectRatio', aspectRatio);
                        
                        const currentWidth = parseFloat($('#input-width').val());
                        const currentHeight = parseFloat($('#input-height').val());
                        
                        if ((currentWidth === 60 && currentHeight === 40) || currentWidth === 0 || currentHeight === 0) {
                            $('#input-width').val(initialWidthCm);
                            $('#input-height').val(initialHeightCm);
                            $('#input-widthS').val(initialWidthSCm);
                            $('#input-heightS').val(initialHeightSCm);
                        }
                        
                        handleDimensionChange('input-width'); 
                        printViewActive = true;
                        setEdgeMode('standard'); 
                        drawCanvas();
                        updateUI(); 
                    });
                };
                originalImage.src = dataUrl;
            }
            reader.readAsDataURL(file);
        }

        function setEdgeMode(newMode) {
            $('#edgeMode').val(newMode);
            $('.btn-toggle-secondary[data-edge-mode]').removeClass('active');
            $(`.btn-toggle-secondary[data-edge-mode="${newMode}"]`).addClass('active');
            if (newMode == "eye") {
                $(`.btn-toggle-secondary[data-edge-mode="standard"]`).addClass('active');
                $(`.btn-toggle-secondary[data-edge-mode="eye"]`).addClass('active');
            }
            drawCanvas();
        }

        function handleDimensionChange(changedInputId) {
            const isLocked = $('#lock-aspect-ratio').is(':checked');
            const aspectRatio = $('#editor-form').data('aspectRatio');
            
            if (isLocked && aspectRatio) {
                let width = parseFloat($('#input-width').val());
                let height = parseFloat($('#input-height').val());
                let widthS = parseFloat($('#input-widthS').val());
                let heightS = parseFloat($('#input-heightS').val());
                
                if (changedInputId === 'input-width' && width > 0) {
                    height = Math.max(1, width / aspectRatio);
                    $('#input-height').val(height);
                    $('#input-heightS').val(height - 4);
                    $('#input-widthS').val(width - 4);
                } else if (changedInputId === 'input-height' && height > 0) {
                    width = Math.max(1, height * aspectRatio);
                    $('#input-width').val(width);
                    $('#input-widthS').val(width - 4);
                    $('#input-heightS').val(height - 4);
                }

                if (changedInputId === 'input-widthS' && widthS > 0) {
                    widthS = $('#input-widthS').val();
                    $('#input-width').val(parseInt(widthS) + 4).trigger('input');
                } else if (changedInputId === 'input-heightS' && heightS > 0) {
                    heightS = $('#input-heightS').val();
                    $('#input-height').val(parseInt(heightS) + 4).trigger('input');
                }
            }
            
            const minVal = 1;
            const maxVal = 30000;
            if (parseFloat($('#input-width').val()) < minVal) { $('#input-width').val(minVal); }
            if (parseFloat($('#input-height').val()) < minVal) { $('#input-height').val(minVal); }
            if (parseFloat($('#input-width').val()) > maxVal) { $('#input-width').val(maxVal); }
            if (parseFloat($('#input-height').val()) > maxVal) { $('#input-height').val(maxVal); }

            updateUI();
            if (isImageLoaded) {
                 drawCanvas();
            }
        }

        function updateUI() {
            const width = Math.max(1, parseFloat($('#input-width').val()) || 0);
            const height = Math.max(1, parseFloat($('#input-height').val()) || 0);
            const widthS = Math.max(1, parseFloat($('#input-widthS').val()) || 0);
            const heightS = Math.max(1, parseFloat($('#input-heightS').val()) || 0);
            const productType = $('input[name="productType"]:checked').val();
            
            const rawPrice = calculatePrice(productType, width, height);
            const formattedPrice = rawPrice.toLocaleString('hu-HU') + ' Ft';

            $('#current-price').text(formattedPrice);
            $('#final-price').text(formattedPrice);

            const edgeMode = $('#edgeMode').val();
            
            if (edgeMode !== 'standard') {
                $('#display-width').text(width.toFixed(2).replace(/\.00$/, ''));
                $('#display-height').text(height.toFixed(2).replace(/\.00$/, ''));
                $('#mid-width').text(widthS.toFixed(2).replace(/\.00$/, ''));
                $('#mid-height').text(heightS.toFixed(2).replace(/\.00$/, ''));
            }
            if (edgeMode === 'standard') {
                $('#display-width').text(width.toFixed(2).replace(/\.00$/, ''));
                $('#display-height').text(height.toFixed(2).replace(/\.00$/, ''));
                $('#mid-width').text(widthS.toFixed(2).replace(/\.00$/, ''));
                $('#mid-height').text(heightS.toFixed(2).replace(/\.00$/, ''));
            }
        }

        $(document).ready(function() {
            canvas = document.getElementById('main-canvas');
            ctx = canvas.getContext('2d');

            $('#editor-form').data('aspectRatio', 60 / 40); 

            $('#editor-form').on('change', 'input[name="productType"], #lock-aspect-ratio', function() {
                updateUI();
                drawCanvas(); 
            });
            
            // OKOSPONT ESEM√âNYEK
            $('#addSmartpointBtn').on('click', function() {
                if (!isImageLoaded) {
                    showMessage("K√©rj√ºk, el≈ësz√∂r t√∂lts fel egy k√©pet!");
                    return;
                }
                addSmartpoint();
            });

            $('#toggleSmartpointsBtn').on('click', function() {
                showSmartpoints = !showSmartpoints;
                updateToggleSmartpointsButton();
                drawCanvas();
            });

            $(document).on('click', '.remove-smartpoint', function() {
                const id = parseInt($(this).data('id'));
                removeSmartpoint(id);
            });

            $(document).on('change', '.smartpoint-type', function() {
                const id = parseInt($(this).data('id'));
                const type = $(this).val();
                const sp = smartpoints.find(s => s.id === id);
                if (sp) {
                    sp.type = type;
                    sp.content = null;
                    renderSmartpointsList();
                }
            });

            $(document).on('change', '.smartpoint-file', function() {
                const id = parseInt($(this).data('id'));
                const files = this.files;
                const sp = smartpoints.find(s => s.id === id);
                if (sp && files.length > 0) {
                    sp.content = files.length === 1 ? files[0].name : `${files.length} f√°jl`;
                    renderSmartpointsList();
                }
            });

            $(document).on('input', '.smartpoint-url', function() {
                const id = parseInt($(this).data('id'));
                const url = $(this).val();
                const sp = smartpoints.find(s => s.id === id);
                if (sp) {
                    sp.content = url;
                }
            });

            $(document).on('click', '.place-smartpoint', function() {
                const id = parseInt($(this).data('id'));
                const sp = smartpoints.find(s => s.id === id);
                
                if (!sp) return;
                
                if (placingSmartpointId === id) {
                    placingSmartpointId = null;
                    $('#drop-zone').removeClass('placing-smartpoint');
                    renderSmartpointsList();
                    showMessage("Okospont lehelyez√©s megszak√≠tva");
                } else {
                    placingSmartpointId = id;
                    $('#drop-zone').addClass('placing-smartpoint');
                    renderSmartpointsList();
                    showMessage(`Kattints a k√©pre, hogy lehelyezd a ${id}. Okospontot!`);
                }
            });

            $('#drop-zone').on('click', function(e) {
                if (!isImageLoaded) {
                    if (!$(this).hasClass('has-image')) {
                        $('#image-upload').click();
                    }
                    return;
                }
                
                if (placingSmartpointId !== null) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const x = (e.clientX - rect.left) * scaleX;
                    const y = (e.clientY - rect.top) * scaleY;
                    
                    const sp = smartpoints.find(s => s.id === placingSmartpointId);
                    if (sp) {
                        sp.x = x;
                        sp.y = y;
                        sp.placed = true;
                        placingSmartpointId = null;
                        $('#drop-zone').removeClass('placing-smartpoint');
                        renderSmartpointsList();
                        drawCanvas();
                        showMessage(`${sp.id}. Okospont sikeresen lehelyezve!`);
                    }
                    e.stopPropagation();
                }
            });


            // √öj okospont hozz√°ad√°sa gomb
            $('#add-smart-point-btn').on('click', function() {
                $('#smart-point-type-selector').slideDown(200);
            });

            // Okospont t√≠pus kiv√°laszt√°sa
            $('.smart-point-type').on('click', function() {
                const type = $(this).data('type');
                selectSmartPointType(type);
            });

            // Okospont ment√©se
            $('#save-smart-point-btn').on('click', function() {
                saveSmartPoint();
            });

            // Okospont hozz√°ad√°s√°nak megszak√≠t√°sa
            $('#cancel-smart-point-btn').on('click', function() {
                $('#smart-point-type-selector').slideUp(200);
                $('#smart-point-content-input').slideUp(200);
                currentSmartPointType = null;
                currentSmartPointContent = null;
            });

            // Okospont lehelyez√©se gomb
            $('#place-smart-point-btn').on('click', function() {
                if (placingSmartPoint) {
                    deactivateSmartPointMode();
                } else {
                    activatePlacementMode();
                }
            });

            // Okospont √°thelyez√©se gomb
            $('#move-smart-point-btn').on('click', function() {
                if (movingSmartPoint) {
                    deactivateSmartPointMode();
                } else {
                    activateMoveMode();
                }
            });

            // Okospont elt√°vol√≠t√°sa
            $(document).on('click', '.remove-smart-point', function() {
                const id = $(this).data('id');
                removeSmartPoint(id);
            });

            // √âL BE√ÅLL√çT√ÅSOK
            $('#printViewButton').on('click', function() {
                if (!isImageLoaded) {
                    showMessage("K√©rj√ºk, t√∂lts fel egy k√©pet az √©l n√©zet aktiv√°l√°s√°hoz!");
                    return;
                }
                
                printViewActive = !printViewActive;

                if (printViewActive) {
                     $("#printViewStatusBe").show();
                     $("#printViewStatusKi").hide();
                    $(this).addClass('active').find('#printViewStatus').text('BE');
                } else {
                     $("#printViewStatusBe").hide();
                     $("#printViewStatusKi").show();
                    $(this).removeClass('active').find('#printViewStatus').text('KI');
                }
                drawCanvas();
                updateUI();
            });

            $('#szele').on('input', function() {
                 if (!isImageLoaded) return;
                 $('#printViewButton').addClass('active').find('#printViewStatus').text('BE');
                 printViewActive = true;
                eyeButton = false;
                 setEdgeMode('color'); 
                updateUI();
            });

            $('#standardEdgesButton').on('click', function() {
                if (!isImageLoaded) return;
                $('#printViewButton').addClass('active').find('#printViewStatus').text('BE');
                $("#printViewStatusBe").show();
                $("#printViewStatusKi").hide();
                printViewActive = true;
                eyeButton = true;
                setTimeout( function () {
                    $('#eyeButton').addClass("active"); 
                }, 10);
                setEdgeMode('standard');
                $("#size_nemkif").hide();
                $("#size_kif").show();
                $("#size_nemkif_").hide();
                $("#size_kif_").show();
                $('#eyeButton').slideDown(200); 
                $('#szineselSzinDiv').slideUp(200, function() {
                    this.style.setProperty('display', 'none', 'important');
                });
                $('#printViewStatusBe').html('A nyomat kiter√≠tve l√°tszik: K√∂z√©pen "a v√°szonk√©p", az oldalai pedig mellette, elhalv√°ny√≠tva.<br>A k√©sz v√°szonk√©pen nem lesz elhalv√°ny√≠tva, ezt csak az el≈ën√©zet kedv√©√©rt √≠gy jelezz√ºk a k√©pen.<br>Ha szeretn√©d halv√°ny√≠t√°s n√©lk√ºl megn√©zni a kiter√≠tett el≈ën√©zetet, kattints az "Halv√°ny√≠t√°s elrejt√©se" gombra.');
                updateUI();
            });

            $('#eyeButton').on('click', function() {
                $('#printViewButton').addClass('active').find('#printViewStatus').text('BE');
                $("#printViewStatusBe").show();
                $("#printViewStatusKi").hide();
                printViewActive = true;
                eyeButton = !eyeButton;
                if (eyeButton){
                    $("#eyeButton").text("Halv√°ny√≠t√°s elrejt√©se");
                    $('#eyeButton').addClass('active');
                    setEdgeMode('eye');
                }
                else {
                    $("#eyeButton").text("Halv√°ny√≠t√°s mutat√°sa");
                    $('#eyeButton').removeClass('active');
                    setEdgeMode('standard');
                }
                updateUI();
            });

            $('#colorEdgesButton').on('click', function() {
                if (!isImageLoaded) return;
                $('#printViewButton').addClass('active').find('#printViewStatus').text('BE');
                printViewActive = true;
                eyeButton = false;
                setEdgeMode('color');
                $("#size_kif").hide();
                $("#size_nemkif").show();
                $("#size_kif_").hide();
                $("#size_nemkif_").show();
                $('#eyeButton').slideUp(200);
                $('#szineselSzinDiv').slideDown(200);
                $('#printViewStatusBe').show();
                $('#printViewStatusKi').hide();
                updateUI(); 
                $('#printViewStatusBe').html('A nyomat kiter√≠tve l√°tszik: K√∂z√©pen "a v√°szonk√©p", a sz√≠nes oldalai pedig mellette.<br>A k√©sz v√°szonk√©pen a sz√≠nes oldalak a v√°szonk√©p oldalaira esnek majd, √≠gy szemb≈ël nem l√°tsz√≥dnak.');
            });

            $('#mirroredEdgesButton').on('click', function() {
                if (!isImageLoaded) return;
                $('#printViewButton').addClass('active').find('#printViewStatus').text('BE');
                printViewActive = true;
                eyeButton = false;
                setEdgeMode('mirrored1');
                $("#size_kif").hide();
                $("#size_nemkif").show();
                $("#size_kif_").hide();
                $("#size_nemkif_").show();
                $('#eyeButton').slideUp(200);
                $('#szineselSzinDiv').slideUp(200, function() {
                    this.style.setProperty('display', 'none', 'important');
                });
                $('#printViewStatusBe').show();
                $('#printViewStatusKi').hide();
                $('#printViewStatusBe').html('A nyomat kiter√≠tve l√°tszik: K√∂z√©pen "a v√°szonk√©p", a t√ºkr√∂z√∂tt oldalai pedig mellette.<br>A k√©sz v√°szonk√©pen a sz√≠nes oldalak a v√°szonk√©p oldalaira esnek majd, √≠gy szemb≈ël nem l√°tsz√≥dnak.');
                updateUI();
            });

            $('#mirroredEdges2Button').on('click', function() {
                if (!isImageLoaded) return;
                $('#printViewButton').addClass('active').find('#printViewStatus').text('BE');
                printViewActive = true;
                eyeButton = false;
                setEdgeMode('mirrored2');
                $("#size_kif").hide();
                $("#size_nemkif").show();
                $("#size_kif_").hide();
                $("#size_nemkif_").show();
                $('#eyeButton').slideUp(200);
                $('#szineselSzinDiv').slideUp(200, function() {
                    this.style.setProperty('display', 'none', 'important');
                });
                $('#printViewStatusBe').show();
                $('#printViewStatusKi').hide();
                $('#printViewStatusBe').html('A nyomat kiter√≠tve l√°tszik: K√∂z√©pen "a v√°szonk√©p", a megkett≈ëz√∂tt oldalai pedig mellette.<br>A k√©sz v√°szonk√©pen a sz√≠nes oldalak a v√°szonk√©p oldalaira esnek majd, √≠gy szemb≈ël nem l√°tsz√≥dnak.');
                updateUI();
            });

            $('#input-width, #input-widthS, #input-height, #input-heightS').on('input', function() {
                handleDimensionChange(this.id);
            });
            
            const imageUploadInput = $('#image-upload');
            const dropZone = $('#drop-zone');
            
            imageUploadInput.on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    processImageFile(file);
                }
                $(this).val(''); 
            });
            
            $('#change-image-btn').on('click', function() {
                imageUploadInput.click();
            });

            $(document).on('dragenter dragover drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });

            dropZone.on('dragenter', function(e) {
                e.preventDefault();
                if (!dropZone.hasClass('has-image')) {
                    dropZone.addClass('drag-over');
                }
            });

            dropZone.on('dragleave', function(e) {
                e.preventDefault();
                dropZone.removeClass('drag-over');
            });
            
            dropZone.on('drop', function(e) {
                e.preventDefault();
                dropZone.removeClass('drag-over');
                const files = e.originalEvent.dataTransfer.files;
                if (files.length) {
                    processImageFile(files[0]);
                }
            });

            $('#close-message-btn').on('click', function() {
                $('#custom-message').fadeOut(300);
            });

            $('#editor-form').on('submit', function(e) {
                e.preventDefault();
                
                const width = parseFloat($('#input-width').val());
                const height = parseFloat($('#input-height').val());
                const productType = $('input[name="productType"]:checked').val();
                const edgeMode = $('#edgeMode').val();
                const edgeColor = (edgeMode === 'color') ? $('#szele').val() : '';
                const price = calculatePrice(productType, width, height);
                
                if (!isImageLoaded) {
                    showMessage("K√©rj√ºk, t√∂lts fel egy k√©pet a folytat√°shoz!");
                    return;
                }
                
                const smartpointsData = JSON.stringify(smartpoints);
                
                console.log("Kos√°rba rak√°s - Okospontok:", smartpointsData);
                showMessage("A KOS√ÅRBA RAK√ÅS sikeres!");
            });

            updateUI();
            setEdgeMode($('#edgeMode').val());
        });

        /**
         * Okospont t√≠pus kiv√°laszt√°sa
         */
        function selectSmartPointType(type) {
            currentSmartPointType = type;
            
            // Be√°ll√≠tjuk a tartalom beviteli mez≈ëket a t√≠pus alapj√°n
            if (type === 'audio' || type === 'video' || type === 'image' || type === 'images') {
                $('#smart-point-file-input').show();
                $('#smart-point-url-input').hide();
                $('#smart-point-file').attr('accept', 
                    type === 'audio' ? 'audio/*' : 
                    type === 'video' ? 'video/*' : 
                    'image/*'
                );
            } else {
                $('#smart-point-file-input').hide();
                $('#smart-point-url-input').show();
                
                // El≈ëre kit√∂ltj√ºk a placeholder-t a t√≠pus alapj√°n
                const placeholders = {
                    'youtube': 'https://youtube.com/watch?v=...',
                    'spotify': 'https://open.spotify.com/track/...',
                    'url': 'https://...'
                };
                
                $('#smart-point-url').attr('placeholder', placeholders[type] || 'https://...');
            }
            
            $('#smart-point-content-input').slideDown(200);
        }
        
        /**
         * Okospont ment√©se
         */
        function saveSmartPoint() {
            let content = '';
            
            if (currentSmartPointType === 'audio' || currentSmartPointType === 'video' || currentSmartPointType === 'image' || currentSmartPointType === 'images') {
                const fileInput = $('#smart-point-file')[0];
                if (!fileInput.files.length) {
                    showMessage("K√©rj√ºk, v√°lassz ki egy f√°jlt!");
                    return;
                }
                
                // Itt a val√≥s alkalmaz√°sban felt√∂lten√©d a f√°jlt a szerverre
                // Most csak a f√°jl nev√©t t√°roljuk
                content = fileInput.files[0].name;
            } else {
                content = $('#smart-point-url').val();
                if (!content) {
                    showMessage("K√©rj√ºk, add meg az URL-t!");
                    return;
                }
            }
            
            currentSmartPointContent = content;
            
            // Vissza√°ll√≠tjuk a formot
            $('#smart-point-type-selector').slideUp(200);
            $('#smart-point-content-input').slideUp(200);
            $('#smart-point-url').val('');
            $('#smart-point-file').val('');
            
            // Aktiv√°ljuk a lehelyez√©si m√≥dot
            activatePlacementMode();
        }

        /**
         * Okospont lehelyez√©s m√≥d aktiv√°l√°sa
         */
        function activatePlacementMode() {
            if (!isImageLoaded) {
                showMessage("K√©rj√ºk, el≈ësz√∂r t√∂lts√∂n fel egy k√©pet!");
                return;
            }
            
            if (!currentSmartPointType) {
                showMessage("K√©rj√ºk, v√°lassza ki az okospont t√≠pus√°t el≈ësz√∂r!");
                return;
            }
            
            placingSmartPoint = true;
            movingSmartPoint = false;
            $('#drop-zone').addClass('placement-active');
            $('#place-smart-point-btn').text('Kattints a k√©pre az okospont lehelyez√©s√©hez').addClass('btn-accent');
            showMessage("Kattints oda a k√©pre, ahov√° az okospontot szeretn√©d helyezni!");
        }



    </script>
</body>
</html>